[
{
  "model": "desktop.document2",
  "pk": 162405,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "SALDO CREDOR DIME",
    "description": "",
    "uuid": "52e2a199-c127-bbdf-db69-3c3cca071fc8",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 162405, \"uuid\": \"52e2a199-c127-bbdf-db69-3c3cca071fc8\", \"name\": \"SALDO CREDOR DIME\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": null, \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"6f863f8b-245d-4a7d-7a4d-c0977405b424\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": {\"row\": 185, \"column\": 33}, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": true, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"default\", \"currentQueryTab\": \"queryResults\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 1, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"DROP TABLE IF EXISTS teste.credito_dime;\\r\\n\\r\\n-- Criando a tabela teste.credito_dime aprimorada\\r\\nCREATE TABLE IF NOT EXISTS teste.credito_dime AS\\r\\nWITH periodos AS (\\r\\n  -- Gerando todos os per\\u00edodos de refer\\u00eancia de 202101 at\\u00e9 202502\\r\\n  SELECT periodo AS nu_per_ref\\r\\n  FROM (\\r\\n    SELECT 202101 AS periodo UNION ALL SELECT 202102 UNION ALL SELECT 202103 UNION ALL SELECT 202104 UNION ALL\\r\\n    SELECT 202105 UNION ALL SELECT 202106 UNION ALL SELECT 202107 UNION ALL SELECT 202108 UNION ALL\\r\\n    SELECT 202109 UNION ALL SELECT 202110 UNION ALL SELECT 202111 UNION ALL SELECT 202112 UNION ALL\\r\\n    SELECT 202201 UNION ALL SELECT 202202 UNION ALL SELECT 202203 UNION ALL SELECT 202204 UNION ALL\\r\\n    SELECT 202205 UNION ALL SELECT 202206 UNION ALL SELECT 202207 UNION ALL SELECT 202208 UNION ALL\\r\\n    SELECT 202209 UNION ALL SELECT 202210 UNION ALL SELECT 202211 UNION ALL SELECT 202212 UNION ALL\\r\\n    SELECT 202301 UNION ALL SELECT 202302 UNION ALL SELECT 202303 UNION ALL SELECT 202304 UNION ALL\\r\\n    SELECT 202305 UNION ALL SELECT 202306 UNION ALL SELECT 202307 UNION ALL SELECT 202308 UNION ALL\\r\\n    SELECT 202309 UNION ALL SELECT 202310 UNION ALL SELECT 202311 UNION ALL SELECT 202312 UNION ALL\\r\\n    SELECT 202401 UNION ALL SELECT 202402 UNION ALL SELECT 202403 UNION ALL SELECT 202404 UNION ALL\\r\\n    SELECT 202405 UNION ALL SELECT 202406 UNION ALL SELECT 202407 UNION ALL SELECT 202408 UNION ALL\\r\\n    SELECT 202409 UNION ALL SELECT 202410 UNION ALL SELECT 202411 UNION ALL SELECT 202412 UNION ALL\\r\\n    SELECT 202501 UNION ALL SELECT 202502\\r\\n  ) p\\r\\n),\\r\\n\\r\\ndados_filtrados AS (\\r\\n  -- Filtrando os dados conforme requisitos\\r\\n  SELECT \\r\\n    d.nu_cnpj,\\r\\n    d.nu_per_ref,\\r\\n    d.vl_cred_mes_anterior,\\r\\n    d.vl_cred_mes_seguinte\\r\\n  FROM \\r\\n    usr_sat_ods.ods_decl_dime_raw d\\r\\n  JOIN \\r\\n    periodos p ON d.nu_per_ref = p.nu_per_ref\\r\\n  WHERE \\r\\n    d.vl_cred_mes_anterior > 0\\r\\n    AND d.vl_cred_mes_seguinte > 0\\r\\n),\\r\\n\\r\\nvalores_iguais_base AS (\\r\\n  -- Identificando onde vl_cred_mes_anterior = vl_cred_mes_seguinte\\r\\n  SELECT\\r\\n    nu_cnpj,\\r\\n    nu_per_ref,\\r\\n    vl_cred_mes_anterior AS valor\\r\\n  FROM \\r\\n    dados_filtrados\\r\\n  WHERE \\r\\n    vl_cred_mes_anterior = vl_cred_mes_seguinte\\r\\n),\\r\\n\\r\\nvalores_iguais AS (\\r\\n  -- Adicionando a numera\\u00e7\\u00e3o de sequ\\u00eancia em uma CTE separada\\r\\n  SELECT\\r\\n    nu_cnpj,\\r\\n    nu_per_ref,\\r\\n    valor,\\r\\n    ROW_NUMBER() OVER (PARTITION BY nu_cnpj ORDER BY nu_per_ref DESC) AS seq_periodo_desc\\r\\n  FROM \\r\\n    valores_iguais_base\\r\\n),\\r\\n\\r\\ncontagem_iguais AS (\\r\\n  -- Contagem de per\\u00edodos onde valores s\\u00e3o iguais\\r\\n  SELECT\\r\\n    nu_cnpj,\\r\\n    COUNT(*) AS contagem_periodos_iguais\\r\\n  FROM \\r\\n    valores_iguais_base\\r\\n  GROUP BY \\r\\n    nu_cnpj\\r\\n),\\r\\n\\r\\nperiodos_max_ordenados AS (\\r\\n  -- Construindo string de per\\u00edodos ordenados para valores m\\u00e1ximos\\r\\n  SELECT\\r\\n    vi.nu_cnpj,\\r\\n    MAX(vi.valor) AS valor_maximo,\\r\\n    GROUP_CONCAT(DISTINCT CAST(vi.nu_per_ref AS STRING)) AS periodos_max\\r\\n  FROM \\r\\n    valores_iguais_base vi\\r\\n  JOIN (\\r\\n    SELECT nu_cnpj, MAX(valor) AS max_valor\\r\\n    FROM valores_iguais_base\\r\\n    GROUP BY nu_cnpj\\r\\n  ) max_val ON vi.nu_cnpj = max_val.nu_cnpj AND vi.valor = max_val.max_valor\\r\\n  GROUP BY \\r\\n    vi.nu_cnpj\\r\\n),\\r\\n\\r\\nperiodos_min_ordenados AS (\\r\\n  -- Construindo string de per\\u00edodos ordenados para valores m\\u00ednimos\\r\\n  SELECT\\r\\n    vi.nu_cnpj,\\r\\n    MIN(vi.valor) AS valor_minimo,\\r\\n    GROUP_CONCAT(DISTINCT CAST(vi.nu_per_ref AS STRING)) AS periodos_min\\r\\n  FROM \\r\\n    valores_iguais_base vi\\r\\n  JOIN (\\r\\n    SELECT nu_cnpj, MIN(valor) AS min_valor\\r\\n    FROM valores_iguais_base\\r\\n    GROUP BY nu_cnpj\\r\\n  ) min_val ON vi.nu_cnpj = min_val.nu_cnpj AND vi.valor = min_val.min_valor\\r\\n  GROUP BY \\r\\n    vi.nu_cnpj\\r\\n),\\r\\n\\r\\nultima_sequencia_base AS (\\r\\n  -- Identificando o \\u00faltimo valor para cada CNPJ\\r\\n  SELECT \\r\\n    vi.nu_cnpj,\\r\\n    vi.valor AS ultimo_valor,\\r\\n    MAX(vi.nu_per_ref) AS ultimo_periodo\\r\\n  FROM \\r\\n    valores_iguais vi\\r\\n  WHERE \\r\\n    vi.seq_periodo_desc = 1\\r\\n  GROUP BY \\r\\n    vi.nu_cnpj, \\r\\n    vi.valor\\r\\n),\\r\\n\\r\\nsequencia_ultimos_meses AS (\\r\\n  -- Identificando a sequ\\u00eancia dos \\u00faltimos meses com valores iguais\\r\\n  SELECT\\r\\n    usb.nu_cnpj,\\r\\n    COUNT(*) AS qtde_ultimos_meses_iguais,\\r\\n    MIN(vi.nu_per_ref) AS periodo_inicial_seq,\\r\\n    usb.ultimo_periodo AS periodo_final_seq,\\r\\n    usb.ultimo_valor AS valor_seq\\r\\n  FROM \\r\\n    ultima_sequencia_base usb\\r\\n  JOIN \\r\\n    valores_iguais_base vi ON usb.nu_cnpj = vi.nu_cnpj \\r\\n                        AND usb.ultimo_valor = vi.valor\\r\\n                        AND vi.nu_per_ref <= usb.ultimo_periodo  -- Garantindo que pegamos apenas per\\u00edodos at\\u00e9 o \\u00faltimo\\r\\n  GROUP BY \\r\\n    usb.nu_cnpj,\\r\\n    usb.ultimo_periodo,\\r\\n    usb.ultimo_valor\\r\\n)\\r\\n\\r\\n-- Consulta final juntando todas as informa\\u00e7\\u00f5es\\r\\nSELECT \\r\\n  df.nu_cnpj,\\r\\n  -- Dados do cadastro do contribuinte\\r\\n  c.nm_razao_social,\\r\\n  c.nm_fantasia,\\r\\n  c.nm_sit_cadastral,\\r\\n  c.dt_sit_cadastral,\\r\\n  c.dt_constituicao_empresa,\\r\\n  c.nm_gerfe,\\r\\n  c.de_cnae,\\r\\n  c.nm_contador,\\r\\n  -- Contagem e valores\\r\\n  COALESCE(ci.contagem_periodos_iguais, 0) AS valor_igual,\\r\\n  -- Valor m\\u00e1ximo com formata\\u00e7\\u00e3o e per\\u00edodos\\r\\n  REPLACE(CAST(COALESCE(pmax.valor_maximo, 0) AS STRING), '.', ',') AS valor_maximo,\\r\\n  COALESCE(pmax.periodos_max, '') AS periodos_valor_maximo,\\r\\n  -- Valor m\\u00ednimo com formata\\u00e7\\u00e3o e per\\u00edodos\\r\\n  REPLACE(CAST(COALESCE(pmin.valor_minimo, 0) AS STRING), '.', ',') AS valor_minimo,\\r\\n  COALESCE(pmin.periodos_min, '') AS periodos_valor_minimo,\\r\\n  -- Informa\\u00e7\\u00f5es da sequ\\u00eancia dos \\u00faltimos meses\\r\\n  COALESCE(seq.qtde_ultimos_meses_iguais, 0) AS qtde_ultimos_meses_iguais,\\r\\n  CAST(COALESCE(seq.periodo_inicial_seq, 0) AS STRING) AS periodo_inicial_sequencia,\\r\\n  CAST(COALESCE(seq.periodo_final_seq, 0) AS STRING) AS periodo_final_sequencia,\\r\\n  REPLACE(CAST(COALESCE(seq.valor_seq, 0) AS STRING), '.', ',') AS valor_sequencia,\\r\\n  -- Campo que indica se m\\u00e1ximo e m\\u00ednimo existem\\r\\n  CASE \\r\\n    WHEN pmax.valor_maximo IS NOT NULL AND pmin.valor_minimo IS NOT NULL THEN 1\\r\\n    ELSE 0\\r\\n  END AS max_min_iguais\\r\\nFROM \\r\\n  (SELECT DISTINCT nu_cnpj FROM dados_filtrados) df\\r\\nLEFT JOIN \\r\\n  usr_sat_ods.vw_ods_contrib c ON df.nu_cnpj = c.nu_cnpj\\r\\nLEFT JOIN \\r\\n  contagem_iguais ci ON df.nu_cnpj = ci.nu_cnpj\\r\\nLEFT JOIN \\r\\n  periodos_max_ordenados pmax ON df.nu_cnpj = pmax.nu_cnpj\\r\\nLEFT JOIN \\r\\n  periodos_min_ordenados pmin ON df.nu_cnpj = pmin.nu_cnpj\\r\\nLEFT JOIN \\r\\n  sequencia_ultimos_meses seq ON df.nu_cnpj = seq.nu_cnpj;\\r\\nselect * from teste.credito_dime;\", \"statementsList\": [\"DROP TABLE IF EXISTS teste.credito_dime;\", \"\\r\\n\\r\\n-- Criando a tabela teste.credito_dime aprimorada\\r\\nCREATE TABLE IF NOT EXISTS teste.credito_dime AS\\r\\nWITH periodos AS (\\r\\n  -- Gerando todos os per\\u00edodos de refer\\u00eancia de 202101 at\\u00e9 202502\\r\\n  SELECT periodo AS nu_per_ref\\r\\n  FROM (\\r\\n    SELECT 202101 AS periodo UNION ALL SELECT 202102 UNION ALL SELECT 202103 UNION ALL SELECT 202104 UNION ALL\\r\\n    SELECT 202105 UNION ALL SELECT 202106 UNION ALL SELECT 202107 UNION ALL SELECT 202108 UNION ALL\\r\\n    SELECT 202109 UNION ALL SELECT 202110 UNION ALL SELECT 202111 UNION ALL SELECT 202112 UNION ALL\\r\\n    SELECT 202201 UNION ALL SELECT 202202 UNION ALL SELECT 202203 UNION ALL SELECT 202204 UNION ALL\\r\\n    SELECT 202205 UNION ALL SELECT 202206 UNION ALL SELECT 202207 UNION ALL SELECT 202208 UNION ALL\\r\\n    SELECT 202209 UNION ALL SELECT 202210 UNION ALL SELECT 202211 UNION ALL SELECT 202212 UNION ALL\\r\\n    SELECT 202301 UNION ALL SELECT 202302 UNION ALL SELECT 202303 UNION ALL SELECT 202304 UNION ALL\\r\\n    SELECT 202305 UNION ALL SELECT 202306 UNION ALL SELECT 202307 UNION ALL SELECT 202308 UNION ALL\\r\\n    SELECT 202309 UNION ALL SELECT 202310 UNION ALL SELECT 202311 UNION ALL SELECT 202312 UNION ALL\\r\\n    SELECT 202401 UNION ALL SELECT 202402 UNION ALL SELECT 202403 UNION ALL SELECT 202404 UNION ALL\\r\\n    SELECT 202405 UNION ALL SELECT 202406 UNION ALL SELECT 202407 UNION ALL SELECT 202408 UNION ALL\\r\\n    SELECT 202409 UNION ALL SELECT 202410 UNION ALL SELECT 202411 UNION ALL SELECT 202412 UNION ALL\\r\\n    SELECT 202501 UNION ALL SELECT 202502\\r\\n  ) p\\r\\n),\\r\\n\\r\\ndados_filtrados AS (\\r\\n  -- Filtrando os dados conforme requisitos\\r\\n  SELECT \\r\\n    d.nu_cnpj,\\r\\n    d.nu_per_ref,\\r\\n    d.vl_cred_mes_anterior,\\r\\n    d.vl_cred_mes_seguinte\\r\\n  FROM \\r\\n    usr_sat_ods.ods_decl_dime_raw d\\r\\n  JOIN \\r\\n    periodos p ON d.nu_per_ref = p.nu_per_ref\\r\\n  WHERE \\r\\n    d.vl_cred_mes_anterior > 0\\r\\n    AND d.vl_cred_mes_seguinte > 0\\r\\n),\\r\\n\\r\\nvalores_iguais_base AS (\\r\\n  -- Identificando onde vl_cred_mes_anterior = vl_cred_mes_seguinte\\r\\n  SELECT\\r\\n    nu_cnpj,\\r\\n    nu_per_ref,\\r\\n    vl_cred_mes_anterior AS valor\\r\\n  FROM \\r\\n    dados_filtrados\\r\\n  WHERE \\r\\n    vl_cred_mes_anterior = vl_cred_mes_seguinte\\r\\n),\\r\\n\\r\\nvalores_iguais AS (\\r\\n  -- Adicionando a numera\\u00e7\\u00e3o de sequ\\u00eancia em uma CTE separada\\r\\n  SELECT\\r\\n    nu_cnpj,\\r\\n    nu_per_ref,\\r\\n    valor,\\r\\n    ROW_NUMBER() OVER (PARTITION BY nu_cnpj ORDER BY nu_per_ref DESC) AS seq_periodo_desc\\r\\n  FROM \\r\\n    valores_iguais_base\\r\\n),\\r\\n\\r\\ncontagem_iguais AS (\\r\\n  -- Contagem de per\\u00edodos onde valores s\\u00e3o iguais\\r\\n  SELECT\\r\\n    nu_cnpj,\\r\\n    COUNT(*) AS contagem_periodos_iguais\\r\\n  FROM \\r\\n    valores_iguais_base\\r\\n  GROUP BY \\r\\n    nu_cnpj\\r\\n),\\r\\n\\r\\nperiodos_max_ordenados AS (\\r\\n  -- Construindo string de per\\u00edodos ordenados para valores m\\u00e1ximos\\r\\n  SELECT\\r\\n    vi.nu_cnpj,\\r\\n    MAX(vi.valor) AS valor_maximo,\\r\\n    GROUP_CONCAT(DISTINCT CAST(vi.nu_per_ref AS STRING)) AS periodos_max\\r\\n  FROM \\r\\n    valores_iguais_base vi\\r\\n  JOIN (\\r\\n    SELECT nu_cnpj, MAX(valor) AS max_valor\\r\\n    FROM valores_iguais_base\\r\\n    GROUP BY nu_cnpj\\r\\n  ) max_val ON vi.nu_cnpj = max_val.nu_cnpj AND vi.valor = max_val.max_valor\\r\\n  GROUP BY \\r\\n    vi.nu_cnpj\\r\\n),\\r\\n\\r\\nperiodos_min_ordenados AS (\\r\\n  -- Construindo string de per\\u00edodos ordenados para valores m\\u00ednimos\\r\\n  SELECT\\r\\n    vi.nu_cnpj,\\r\\n    MIN(vi.valor) AS valor_minimo,\\r\\n    GROUP_CONCAT(DISTINCT CAST(vi.nu_per_ref AS STRING)) AS periodos_min\\r\\n  FROM \\r\\n    valores_iguais_base vi\\r\\n  JOIN (\\r\\n    SELECT nu_cnpj, MIN(valor) AS min_valor\\r\\n    FROM valores_iguais_base\\r\\n    GROUP BY nu_cnpj\\r\\n  ) min_val ON vi.nu_cnpj = min_val.nu_cnpj AND vi.valor = min_val.min_valor\\r\\n  GROUP BY \\r\\n    vi.nu_cnpj\\r\\n),\\r\\n\\r\\nultima_sequencia_base AS (\\r\\n  -- Identificando o \\u00faltimo valor para cada CNPJ\\r\\n  SELECT \\r\\n    vi.nu_cnpj,\\r\\n    vi.valor AS ultimo_valor,\\r\\n    MAX(vi.nu_per_ref) AS ultimo_periodo\\r\\n  FROM \\r\\n    valores_iguais vi\\r\\n  WHERE \\r\\n    vi.seq_periodo_desc = 1\\r\\n  GROUP BY \\r\\n    vi.nu_cnpj, \\r\\n    vi.valor\\r\\n),\\r\\n\\r\\nsequencia_ultimos_meses AS (\\r\\n  -- Identificando a sequ\\u00eancia dos \\u00faltimos meses com valores iguais\\r\\n  SELECT\\r\\n    usb.nu_cnpj,\\r\\n    COUNT(*) AS qtde_ultimos_meses_iguais,\\r\\n    MIN(vi.nu_per_ref) AS periodo_inicial_seq,\\r\\n    usb.ultimo_periodo AS periodo_final_seq,\\r\\n    usb.ultimo_valor AS valor_seq\\r\\n  FROM \\r\\n    ultima_sequencia_base usb\\r\\n  JOIN \\r\\n    valores_iguais_base vi ON usb.nu_cnpj = vi.nu_cnpj \\r\\n                        AND usb.ultimo_valor = vi.valor\\r\\n                        AND vi.nu_per_ref <= usb.ultimo_periodo  -- Garantindo que pegamos apenas per\\u00edodos at\\u00e9 o \\u00faltimo\\r\\n  GROUP BY \\r\\n    usb.nu_cnpj,\\r\\n    usb.ultimo_periodo,\\r\\n    usb.ultimo_valor\\r\\n)\\r\\n\\r\\n-- Consulta final juntando todas as informa\\u00e7\\u00f5es\\r\\nSELECT \\r\\n  df.nu_cnpj,\\r\\n  -- Dados do cadastro do contribuinte\\r\\n  c.nm_razao_social,\\r\\n  c.nm_fantasia,\\r\\n  c.nm_sit_cadastral,\\r\\n  c.dt_sit_cadastral,\\r\\n  c.dt_constituicao_empresa,\\r\\n  c.nm_gerfe,\\r\\n  c.de_cnae,\\r\\n  c.nm_contador,\\r\\n  -- Contagem e valores\\r\\n  COALESCE(ci.contagem_periodos_iguais, 0) AS valor_igual,\\r\\n  -- Valor m\\u00e1ximo com formata\\u00e7\\u00e3o e per\\u00edodos\\r\\n  REPLACE(CAST(COALESCE(pmax.valor_maximo, 0) AS STRING), '.', ',') AS valor_maximo,\\r\\n  COALESCE(pmax.periodos_max, '') AS periodos_valor_maximo,\\r\\n  -- Valor m\\u00ednimo com formata\\u00e7\\u00e3o e per\\u00edodos\\r\\n  REPLACE(CAST(COALESCE(pmin.valor_minimo, 0) AS STRING), '.', ',') AS valor_minimo,\\r\\n  COALESCE(pmin.periodos_min, '') AS periodos_valor_minimo,\\r\\n  -- Informa\\u00e7\\u00f5es da sequ\\u00eancia dos \\u00faltimos meses\\r\\n  COALESCE(seq.qtde_ultimos_meses_iguais, 0) AS qtde_ultimos_meses_iguais,\\r\\n  CAST(COALESCE(seq.periodo_inicial_seq, 0) AS STRING) AS periodo_inicial_sequencia,\\r\\n  CAST(COALESCE(seq.periodo_final_seq, 0) AS STRING) AS periodo_final_sequencia,\\r\\n  REPLACE(CAST(COALESCE(seq.valor_seq, 0) AS STRING), '.', ',') AS valor_sequencia,\\r\\n  -- Campo que indica se m\\u00e1ximo e m\\u00ednimo existem\\r\\n  CASE \\r\\n    WHEN pmax.valor_maximo IS NOT NULL AND pmin.valor_minimo IS NOT NULL THEN 1\\r\\n    ELSE 0\\r\\n  END AS max_min_iguais\\r\\nFROM \\r\\n  (SELECT DISTINCT nu_cnpj FROM dados_filtrados) df\\r\\nLEFT JOIN \\r\\n  usr_sat_ods.vw_ods_contrib c ON df.nu_cnpj = c.nu_cnpj\\r\\nLEFT JOIN \\r\\n  contagem_iguais ci ON df.nu_cnpj = ci.nu_cnpj\\r\\nLEFT JOIN \\r\\n  periodos_max_ordenados pmax ON df.nu_cnpj = pmax.nu_cnpj\\r\\nLEFT JOIN \\r\\n  periodos_min_ordenados pmin ON df.nu_cnpj = pmin.nu_cnpj\\r\\nLEFT JOIN \\r\\n  sequencia_ultimos_meses seq ON df.nu_cnpj = seq.nu_cnpj;\", \"\\r\\nselect * from teste.credito_dime;\"], \"aceSize\": 100, \"status\": \"available\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"DROP TABLE IF EXISTS teste.credito_dime;\\r\\n\\r\\n-- Criando a tabela teste.credito_dime aprimorada\\r\\nCREATE TABLE IF NOT EXISTS teste.credito_dime AS\\r\\nWITH periodos AS (\\r\\n  -- Gerando todos os per\\u00edodos de refer\\u00eancia de 202101 at\\u00e9 202502\\r\\n  SELECT periodo AS nu_per_ref\\r\\n  FROM (\\r\\n    SELECT 202101 AS periodo UNION ALL SELECT 202102 UNION ALL SELECT 202103 UNION ALL SELECT 202104 UNION ALL\\r\\n    SELECT 202105 UNION ALL SELECT 202106 UNION ALL SELECT 202107 UNION ALL SELECT 202108 UNION ALL\\r\\n    SELECT 202109 UNION ALL SELECT 202110 UNION ALL SELECT 202111 UNION ALL SELECT 202112 UNION ALL\\r\\n    SELECT 202201 UNION ALL SELECT 202202 UNION ALL SELECT 202203 UNION ALL SELECT 202204 UNION ALL\\r\\n    SELECT 202205 UNION ALL SELECT 202206 UNION ALL SELECT 202207 UNION ALL SELECT 202208 UNION ALL\\r\\n    SELECT 202209 UNION ALL SELECT 202210 UNION ALL SELECT 202211 UNION ALL SELECT 202212 UNION ALL\\r\\n    SELECT 202301 UNION ALL SELECT 202302 UNION ALL SELECT 202303 UNION ALL SELECT 202304 UNION ALL\\r\\n    SELECT 202305 UNION ALL SELECT 202306 UNION ALL SELECT 202307 UNION ALL SELECT 202308 UNION ALL\\r\\n    SELECT 202309 UNION ALL SELECT 202310 UNION ALL SELECT 202311 UNION ALL SELECT 202312 UNION ALL\\r\\n    SELECT 202401 UNION ALL SELECT 202402 UNION ALL SELECT 202403 UNION ALL SELECT 202404 UNION ALL\\r\\n    SELECT 202405 UNION ALL SELECT 202406 UNION ALL SELECT 202407 UNION ALL SELECT 202408 UNION ALL\\r\\n    SELECT 202409 UNION ALL SELECT 202410 UNION ALL SELECT 202411 UNION ALL SELECT 202412 UNION ALL\\r\\n    SELECT 202501 UNION ALL SELECT 202502\\r\\n  ) p\\r\\n),\\r\\n\\r\\ndados_filtrados AS (\\r\\n  -- Filtrando os dados conforme requisitos\\r\\n  SELECT \\r\\n    d.nu_cnpj,\\r\\n    d.nu_per_ref,\\r\\n    d.vl_cred_mes_anterior,\\r\\n    d.vl_cred_mes_seguinte\\r\\n  FROM \\r\\n    usr_sat_ods.ods_decl_dime_raw d\\r\\n  JOIN \\r\\n    periodos p ON d.nu_per_ref = p.nu_per_ref\\r\\n  WHERE \\r\\n    d.vl_cred_mes_anterior > 0\\r\\n    AND d.vl_cred_mes_seguinte > 0\\r\\n),\\r\\n\\r\\nvalores_iguais_base AS (\\r\\n  -- Identificando onde vl_cred_mes_anterior = vl_cred_mes_seguinte\\r\\n  SELECT\\r\\n    nu_cnpj,\\r\\n    nu_per_ref,\\r\\n    vl_cred_mes_anterior AS valor\\r\\n  FROM \\r\\n    dados_filtrados\\r\\n  WHERE \\r\\n    vl_cred_mes_anterior = vl_cred_mes_seguinte\\r\\n),\\r\\n\\r\\nvalores_iguais AS (\\r\\n  -- Adicionando a numera\\u00e7\\u00e3o de sequ\\u00eancia em uma CTE separada\\r\\n  SELECT\\r\\n    nu_cnpj,\\r\\n    nu_per_ref,\\r\\n    valor,\\r\\n    ROW_NUMBER() OVER (PARTITION BY nu_cnpj ORDER BY nu_per_ref DESC) AS seq_periodo_desc\\r\\n  FROM \\r\\n    valores_iguais_base\\r\\n),\\r\\n\\r\\ncontagem_iguais AS (\\r\\n  -- Contagem de per\\u00edodos onde valores s\\u00e3o iguais\\r\\n  SELECT\\r\\n    nu_cnpj,\\r\\n    COUNT(*) AS contagem_periodos_iguais\\r\\n  FROM \\r\\n    valores_iguais_base\\r\\n  GROUP BY \\r\\n    nu_cnpj\\r\\n),\\r\\n\\r\\nperiodos_max_ordenados AS (\\r\\n  -- Construindo string de per\\u00edodos ordenados para valores m\\u00e1ximos\\r\\n  SELECT\\r\\n    vi.nu_cnpj,\\r\\n    MAX(vi.valor) AS valor_maximo,\\r\\n    GROUP_CONCAT(DISTINCT CAST(vi.nu_per_ref AS STRING)) AS periodos_max\\r\\n  FROM \\r\\n    valores_iguais_base vi\\r\\n  JOIN (\\r\\n    SELECT nu_cnpj, MAX(valor) AS max_valor\\r\\n    FROM valores_iguais_base\\r\\n    GROUP BY nu_cnpj\\r\\n  ) max_val ON vi.nu_cnpj = max_val.nu_cnpj AND vi.valor = max_val.max_valor\\r\\n  GROUP BY \\r\\n    vi.nu_cnpj\\r\\n),\\r\\n\\r\\nperiodos_min_ordenados AS (\\r\\n  -- Construindo string de per\\u00edodos ordenados para valores m\\u00ednimos\\r\\n  SELECT\\r\\n    vi.nu_cnpj,\\r\\n    MIN(vi.valor) AS valor_minimo,\\r\\n    GROUP_CONCAT(DISTINCT CAST(vi.nu_per_ref AS STRING)) AS periodos_min\\r\\n  FROM \\r\\n    valores_iguais_base vi\\r\\n  JOIN (\\r\\n    SELECT nu_cnpj, MIN(valor) AS min_valor\\r\\n    FROM valores_iguais_base\\r\\n    GROUP BY nu_cnpj\\r\\n  ) min_val ON vi.nu_cnpj = min_val.nu_cnpj AND vi.valor = min_val.min_valor\\r\\n  GROUP BY \\r\\n    vi.nu_cnpj\\r\\n),\\r\\n\\r\\nultima_sequencia_base AS (\\r\\n  -- Identificando o \\u00faltimo valor para cada CNPJ\\r\\n  SELECT \\r\\n    vi.nu_cnpj,\\r\\n    vi.valor AS ultimo_valor,\\r\\n    MAX(vi.nu_per_ref) AS ultimo_periodo\\r\\n  FROM \\r\\n    valores_iguais vi\\r\\n  WHERE \\r\\n    vi.seq_periodo_desc = 1\\r\\n  GROUP BY \\r\\n    vi.nu_cnpj, \\r\\n    vi.valor\\r\\n),\\r\\n\\r\\nsequencia_ultimos_meses AS (\\r\\n  -- Identificando a sequ\\u00eancia dos \\u00faltimos meses com valores iguais\\r\\n  SELECT\\r\\n    usb.nu_cnpj,\\r\\n    COUNT(*) AS qtde_ultimos_meses_iguais,\\r\\n    MIN(vi.nu_per_ref) AS periodo_inicial_seq,\\r\\n    usb.ultimo_periodo AS periodo_final_seq,\\r\\n    usb.ultimo_valor AS valor_seq\\r\\n  FROM \\r\\n    ultima_sequencia_base usb\\r\\n  JOIN \\r\\n    valores_iguais_base vi ON usb.nu_cnpj = vi.nu_cnpj \\r\\n                        AND usb.ultimo_valor = vi.valor\\r\\n                        AND vi.nu_per_ref <= usb.ultimo_periodo  -- Garantindo que pegamos apenas per\\u00edodos at\\u00e9 o \\u00faltimo\\r\\n  GROUP BY \\r\\n    usb.nu_cnpj,\\r\\n    usb.ultimo_periodo,\\r\\n    usb.ultimo_valor\\r\\n)\\r\\n\\r\\n-- Consulta final juntando todas as informa\\u00e7\\u00f5es\\r\\nSELECT \\r\\n  df.nu_cnpj,\\r\\n  -- Dados do cadastro do contribuinte\\r\\n  c.nm_razao_social,\\r\\n  c.nm_fantasia,\\r\\n  c.nm_sit_cadastral,\\r\\n  c.dt_sit_cadastral,\\r\\n  c.dt_constituicao_empresa,\\r\\n  c.nm_gerfe,\\r\\n  c.de_cnae,\\r\\n  c.nm_contador,\\r\\n  -- Contagem e valores\\r\\n  COALESCE(ci.contagem_periodos_iguais, 0) AS valor_igual,\\r\\n  -- Valor m\\u00e1ximo com formata\\u00e7\\u00e3o e per\\u00edodos\\r\\n  REPLACE(CAST(COALESCE(pmax.valor_maximo, 0) AS STRING), '.', ',') AS valor_maximo,\\r\\n  COALESCE(pmax.periodos_max, '') AS periodos_valor_maximo,\\r\\n  -- Valor m\\u00ednimo com formata\\u00e7\\u00e3o e per\\u00edodos\\r\\n  REPLACE(CAST(COALESCE(pmin.valor_minimo, 0) AS STRING), '.', ',') AS valor_minimo,\\r\\n  COALESCE(pmin.periodos_min, '') AS periodos_valor_minimo,\\r\\n  -- Informa\\u00e7\\u00f5es da sequ\\u00eancia dos \\u00faltimos meses\\r\\n  COALESCE(seq.qtde_ultimos_meses_iguais, 0) AS qtde_ultimos_meses_iguais,\\r\\n  CAST(COALESCE(seq.periodo_inicial_seq, 0) AS STRING) AS periodo_inicial_sequencia,\\r\\n  CAST(COALESCE(seq.periodo_final_seq, 0) AS STRING) AS periodo_final_sequencia,\\r\\n  REPLACE(CAST(COALESCE(seq.valor_seq, 0) AS STRING), '.', ',') AS valor_sequencia,\\r\\n  -- Campo que indica se m\\u00e1ximo e m\\u00ednimo existem\\r\\n  CASE \\r\\n    WHEN pmax.valor_maximo IS NOT NULL AND pmin.valor_minimo IS NOT NULL THEN 1\\r\\n    ELSE 0\\r\\n  END AS max_min_iguais\\r\\nFROM \\r\\n  (SELECT DISTINCT nu_cnpj FROM dados_filtrados) df\\r\\nLEFT JOIN \\r\\n  usr_sat_ods.vw_ods_contrib c ON df.nu_cnpj = c.nu_cnpj\\r\\nLEFT JOIN \\r\\n  contagem_iguais ci ON df.nu_cnpj = ci.nu_cnpj\\r\\nLEFT JOIN \\r\\n  periodos_max_ordenados pmax ON df.nu_cnpj = pmax.nu_cnpj\\r\\nLEFT JOIN \\r\\n  periodos_min_ordenados pmin ON df.nu_cnpj = pmin.nu_cnpj\\r\\nLEFT JOIN \\r\\n  sequencia_ultimos_meses seq ON df.nu_cnpj = seq.nu_cnpj;\\r\\nselect * from teste.credito_dime;\", \"result\": {\"id\": \"0533f75f-e243-4dfb-355d-ac924a86dfbc\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"+h2J2uFpTmy/6Eh29/bzKA==\", \"guid\": \"fHDkfuViTjoAAAAAdHdcYg==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"d344c1c8a74b95a3:c68ebf2bfbd1a1aa\", \"session_id\": 21441, \"session_type\": \"impala\", \"statement_id\": 2, \"has_more_statements\": false, \"statements_count\": 3, \"previous_statement_hash\": \"c877d6fb36d1ed86eed4bb4b8d6aa4eb3a5297ea81c379926614dfd7\", \"start\": {\"row\": 185, \"column\": 0}, \"end\": {\"row\": 185, \"column\": 32}, \"statement\": \"select * from teste.credito_dime\"}, \"meta\": [], \"rows\": 48623, \"hasMore\": true, \"statement_id\": 2, \"statement_range\": {\"start\": {\"row\": 185, \"column\": 0}, \"end\": {\"row\": 185, \"column\": 32}}, \"statements_count\": 3, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": 19, \"filteredMeta\": [{\"type\": \"int\", \"name\": \"\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 0}, {\"name\": \"nu_cnpj\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 1}, {\"name\": \"nm_razao_social\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 2}, {\"name\": \"nm_fantasia\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 3}, {\"name\": \"nm_sit_cadastral\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 4}, {\"name\": \"dt_sit_cadastral\", \"type\": \"timestamp\", \"comment\": null, \"cssClass\": \"sort-date\", \"checked\": true, \"originalIndex\": 5}, {\"name\": \"dt_constituicao_empresa\", \"type\": \"timestamp\", \"comment\": null, \"cssClass\": \"sort-date\", \"checked\": true, \"originalIndex\": 6}, {\"name\": \"nm_gerfe\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 7}, {\"name\": \"de_cnae\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 8}, {\"name\": \"nm_contador\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 9}, {\"name\": \"valor_igual\", \"type\": \"bigint\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 10}, {\"name\": \"valor_maximo\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 11}, {\"name\": \"periodos_valor_maximo\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 12}, {\"name\": \"valor_minimo\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 13}, {\"name\": \"periodos_valor_minimo\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 14}, {\"name\": \"qtde_ultimos_meses_iguais\", \"type\": \"bigint\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 15}, {\"name\": \"periodo_inicial_sequencia\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 16}, {\"name\": \"periodo_final_sequencia\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 17}, {\"name\": \"valor_sequencia\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 18}, {\"name\": \"max_min_iguais\", \"type\": \"tinyint\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 19}], \"fetchedOnce\": false, \"startTime\": \"2025-10-10T21:16:55.813Z\", \"endTime\": \"2025-10-10T21:16:57.148Z\", \"executionTime\": 1335, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 3, \"hasSomeResults\": true}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": 1019, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": \"nu_cnpj\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [\"qtde_ultimos_meses_iguais\"], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": true, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"summary\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": 1084, \"getLogsTimeout\": 1142, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1760131015586, \"lastAceSelectionRowOffset\": 0, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"lastExecutedStatements\": \"DROP TABLE IF EXISTS teste.credito_dime;\\r\\n\\r\\n-- Criando a tabela teste.credito_dime aprimorada\\r\\nCREATE TABLE IF NOT EXISTS teste.credito_dime AS\\r\\nWITH periodos AS (\\r\\n  -- Gerando todos os per\\u00edodos de refer\\u00eancia de 202101 at\\u00e9 202502\\r\\n  SELECT periodo AS nu_per_ref\\r\\n  FROM (\\r\\n    SELECT 202101 AS periodo UNION ALL SELECT 202102 UNION ALL SELECT 202103 UNION ALL SELECT 202104 UNION ALL\\r\\n    SELECT 202105 UNION ALL SELECT 202106 UNION ALL SELECT 202107 UNION ALL SELECT 202108 UNION ALL\\r\\n    SELECT 202109 UNION ALL SELECT 202110 UNION ALL SELECT 202111 UNION ALL SELECT 202112 UNION ALL\\r\\n    SELECT 202201 UNION ALL SELECT 202202 UNION ALL SELECT 202203 UNION ALL SELECT 202204 UNION ALL\\r\\n    SELECT 202205 UNION ALL SELECT 202206 UNION ALL SELECT 202207 UNION ALL SELECT 202208 UNION ALL\\r\\n    SELECT 202209 UNION ALL SELECT 202210 UNION ALL SELECT 202211 UNION ALL SELECT 202212 UNION ALL\\r\\n    SELECT 202301 UNION ALL SELECT 202302 UNION ALL SELECT 202303 UNION ALL SELECT 202304 UNION ALL\\r\\n    SELECT 202305 UNION ALL SELECT 202306 UNION ALL SELECT 202307 UNION ALL SELECT 202308 UNION ALL\\r\\n    SELECT 202309 UNION ALL SELECT 202310 UNION ALL SELECT 202311 UNION ALL SELECT 202312 UNION ALL\\r\\n    SELECT 202401 UNION ALL SELECT 202402 UNION ALL SELECT 202403 UNION ALL SELECT 202404 UNION ALL\\r\\n    SELECT 202405 UNION ALL SELECT 202406 UNION ALL SELECT 202407 UNION ALL SELECT 202408 UNION ALL\\r\\n    SELECT 202409 UNION ALL SELECT 202410 UNION ALL SELECT 202411 UNION ALL SELECT 202412 UNION ALL\\r\\n    SELECT 202501 UNION ALL SELECT 202502\\r\\n  ) p\\r\\n),\\r\\n\\r\\ndados_filtrados AS (\\r\\n  -- Filtrando os dados conforme requisitos\\r\\n  SELECT \\r\\n    d.nu_cnpj,\\r\\n    d.nu_per_ref,\\r\\n    d.vl_cred_mes_anterior,\\r\\n    d.vl_cred_mes_seguinte\\r\\n  FROM \\r\\n    usr_sat_ods.ods_decl_dime_raw d\\r\\n  JOIN \\r\\n    periodos p ON d.nu_per_ref = p.nu_per_ref\\r\\n  WHERE \\r\\n    d.vl_cred_mes_anterior > 0\\r\\n    AND d.vl_cred_mes_seguinte > 0\\r\\n),\\r\\n\\r\\nvalores_iguais_base AS (\\r\\n  -- Identificando onde vl_cred_mes_anterior = vl_cred_mes_seguinte\\r\\n  SELECT\\r\\n    nu_cnpj,\\r\\n    nu_per_ref,\\r\\n    vl_cred_mes_anterior AS valor\\r\\n  FROM \\r\\n    dados_filtrados\\r\\n  WHERE \\r\\n    vl_cred_mes_anterior = vl_cred_mes_seguinte\\r\\n),\\r\\n\\r\\nvalores_iguais AS (\\r\\n  -- Adicionando a numera\\u00e7\\u00e3o de sequ\\u00eancia em uma CTE separada\\r\\n  SELECT\\r\\n    nu_cnpj,\\r\\n    nu_per_ref,\\r\\n    valor,\\r\\n    ROW_NUMBER() OVER (PARTITION BY nu_cnpj ORDER BY nu_per_ref DESC) AS seq_periodo_desc\\r\\n  FROM \\r\\n    valores_iguais_base\\r\\n),\\r\\n\\r\\ncontagem_iguais AS (\\r\\n  -- Contagem de per\\u00edodos onde valores s\\u00e3o iguais\\r\\n  SELECT\\r\\n    nu_cnpj,\\r\\n    COUNT(*) AS contagem_periodos_iguais\\r\\n  FROM \\r\\n    valores_iguais_base\\r\\n  GROUP BY \\r\\n    nu_cnpj\\r\\n),\\r\\n\\r\\nperiodos_max_ordenados AS (\\r\\n  -- Construindo string de per\\u00edodos ordenados para valores m\\u00e1ximos\\r\\n  SELECT\\r\\n    vi.nu_cnpj,\\r\\n    MAX(vi.valor) AS valor_maximo,\\r\\n    GROUP_CONCAT(DISTINCT CAST(vi.nu_per_ref AS STRING)) AS periodos_max\\r\\n  FROM \\r\\n    valores_iguais_base vi\\r\\n  JOIN (\\r\\n    SELECT nu_cnpj, MAX(valor) AS max_valor\\r\\n    FROM valores_iguais_base\\r\\n    GROUP BY nu_cnpj\\r\\n  ) max_val ON vi.nu_cnpj = max_val.nu_cnpj AND vi.valor = max_val.max_valor\\r\\n  GROUP BY \\r\\n    vi.nu_cnpj\\r\\n),\\r\\n\\r\\nperiodos_min_ordenados AS (\\r\\n  -- Construindo string de per\\u00edodos ordenados para valores m\\u00ednimos\\r\\n  SELECT\\r\\n    vi.nu_cnpj,\\r\\n    MIN(vi.valor) AS valor_minimo,\\r\\n    GROUP_CONCAT(DISTINCT CAST(vi.nu_per_ref AS STRING)) AS periodos_min\\r\\n  FROM \\r\\n    valores_iguais_base vi\\r\\n  JOIN (\\r\\n    SELECT nu_cnpj, MIN(valor) AS min_valor\\r\\n    FROM valores_iguais_base\\r\\n    GROUP BY nu_cnpj\\r\\n  ) min_val ON vi.nu_cnpj = min_val.nu_cnpj AND vi.valor = min_val.min_valor\\r\\n  GROUP BY \\r\\n    vi.nu_cnpj\\r\\n),\\r\\n\\r\\nultima_sequencia_base AS (\\r\\n  -- Identificando o \\u00faltimo valor para cada CNPJ\\r\\n  SELECT \\r\\n    vi.nu_cnpj,\\r\\n    vi.valor AS ultimo_valor,\\r\\n    MAX(vi.nu_per_ref) AS ultimo_periodo\\r\\n  FROM \\r\\n    valores_iguais vi\\r\\n  WHERE \\r\\n    vi.seq_periodo_desc = 1\\r\\n  GROUP BY \\r\\n    vi.nu_cnpj, \\r\\n    vi.valor\\r\\n),\\r\\n\\r\\nsequencia_ultimos_meses AS (\\r\\n  -- Identificando a sequ\\u00eancia dos \\u00faltimos meses com valores iguais\\r\\n  SELECT\\r\\n    usb.nu_cnpj,\\r\\n    COUNT(*) AS qtde_ultimos_meses_iguais,\\r\\n    MIN(vi.nu_per_ref) AS periodo_inicial_seq,\\r\\n    usb.ultimo_periodo AS periodo_final_seq,\\r\\n    usb.ultimo_valor AS valor_seq\\r\\n  FROM \\r\\n    ultima_sequencia_base usb\\r\\n  JOIN \\r\\n    valores_iguais_base vi ON usb.nu_cnpj = vi.nu_cnpj \\r\\n                        AND usb.ultimo_valor = vi.valor\\r\\n                        AND vi.nu_per_ref <= usb.ultimo_periodo  -- Garantindo que pegamos apenas per\\u00edodos at\\u00e9 o \\u00faltimo\\r\\n  GROUP BY \\r\\n    usb.nu_cnpj,\\r\\n    usb.ultimo_periodo,\\r\\n    usb.ultimo_valor\\r\\n)\\r\\n\\r\\n-- Consulta final juntando todas as informa\\u00e7\\u00f5es\\r\\nSELECT \\r\\n  df.nu_cnpj,\\r\\n  -- Dados do cadastro do contribuinte\\r\\n  c.nm_razao_social,\\r\\n  c.nm_fantasia,\\r\\n  c.nm_sit_cadastral,\\r\\n  c.dt_sit_cadastral,\\r\\n  c.dt_constituicao_empresa,\\r\\n  c.nm_gerfe,\\r\\n  c.de_cnae,\\r\\n  c.nm_contador,\\r\\n  -- Contagem e valores\\r\\n  COALESCE(ci.contagem_periodos_iguais, 0) AS valor_igual,\\r\\n  -- Valor m\\u00e1ximo com formata\\u00e7\\u00e3o e per\\u00edodos\\r\\n  REPLACE(CAST(COALESCE(pmax.valor_maximo, 0) AS STRING), '.', ',') AS valor_maximo,\\r\\n  COALESCE(pmax.periodos_max, '') AS periodos_valor_maximo,\\r\\n  -- Valor m\\u00ednimo com formata\\u00e7\\u00e3o e per\\u00edodos\\r\\n  REPLACE(CAST(COALESCE(pmin.valor_minimo, 0) AS STRING), '.', ',') AS valor_minimo,\\r\\n  COALESCE(pmin.periodos_min, '') AS periodos_valor_minimo,\\r\\n  -- Informa\\u00e7\\u00f5es da sequ\\u00eancia dos \\u00faltimos meses\\r\\n  COALESCE(seq.qtde_ultimos_meses_iguais, 0) AS qtde_ultimos_meses_iguais,\\r\\n  CAST(COALESCE(seq.periodo_inicial_seq, 0) AS STRING) AS periodo_inicial_sequencia,\\r\\n  CAST(COALESCE(seq.periodo_final_seq, 0) AS STRING) AS periodo_final_sequencia,\\r\\n  REPLACE(CAST(COALESCE(seq.valor_seq, 0) AS STRING), '.', ',') AS valor_sequencia,\\r\\n  -- Campo que indica se m\\u00e1ximo e m\\u00ednimo existem\\r\\n  CASE \\r\\n    WHEN pmax.valor_maximo IS NOT NULL AND pmin.valor_minimo IS NOT NULL THEN 1\\r\\n    ELSE 0\\r\\n  END AS max_min_iguais\\r\\nFROM \\r\\n  (SELECT DISTINCT nu_cnpj FROM dados_filtrados) df\\r\\nLEFT JOIN \\r\\n  usr_sat_ods.vw_ods_contrib c ON df.nu_cnpj = c.nu_cnpj\\r\\nLEFT JOIN \\r\\n  contagem_iguais ci ON df.nu_cnpj = ci.nu_cnpj\\r\\nLEFT JOIN \\r\\n  periodos_max_ordenados pmax ON df.nu_cnpj = pmax.nu_cnpj\\r\\nLEFT JOIN \\r\\n  periodos_min_ordenados pmin ON df.nu_cnpj = pmin.nu_cnpj\\r\\nLEFT JOIN \\r\\n  sequencia_ultimos_meses seq ON df.nu_cnpj = seq.nu_cnpj;\\r\\nselect * from teste.credito_dime;\", \"lastExecutedSelectionRange\": {\"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 185, \"column\": 33}}, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"lastCheckStatusRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"query_status\\\": {\\\"status\\\": \\\"available\\\"}}\", \"responseJSON\": {\"status\": 0, \"query_status\": {\"status\": \"available\"}}, \"status\": 200, \"statusText\": \"OK\"}, \"lastGetLogsRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"logs\\\": \\\"Query 3a4e62e57ee4707c:625c777400000000: 87% Complete (7 out of 8)\\\", \\\"progress\\\": 100, \\\"jobs\\\": [{\\\"name\\\": \\\"3a4e62e57ee4707c:625c777400000000\\\", \\\"url\\\": \\\"/hue/jobbrowser#!id=3a4e62e57ee4707c:625c777400000000\\\", \\\"started\\\": true, \\\"finished\\\": false, \\\"percentJob\\\": 100}], \\\"isFullLogs\\\": false}\", \"responseJSON\": {\"status\": 0, \"logs\": \"Query 3a4e62e57ee4707c:625c777400000000: 87% Complete (7 out of 8)\", \"progress\": 100, \"jobs\": [{\"name\": \"3a4e62e57ee4707c:625c777400000000\", \"url\": \"/hue/jobbrowser#!id=3a4e62e57ee4707c:625c777400000000\", \"started\": true, \"finished\": false, \"percentJob\": 100}], \"isFullLogs\": false}, \"status\": 200, \"statusText\": \"OK\"}}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 9701, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 117, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": null, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "DROP TABLE IF EXISTS teste.credito_dime;\r\n\r\n-- Criando a tabela teste.credito_dime aprimorada\r\nCREATE TABLE IF NOT EXISTS teste.credito_dime AS\r\nWITH periodos AS (\r\n  -- Gerando todos os períodos de referência de 202101 até 202502\r\n  SELECT periodo AS nu_per_ref\r\n  FROM (\r\n    SELECT 202101 AS periodo UNION ALL SELECT 202102 UNION ALL SELECT 202103 UNION ALL SELECT 202104 UNION ALL\r\n    SELECT 202105 UNION ALL SELECT 202106 UNION ALL SELECT 202107 UNION ALL SELECT 202108 UNION ALL\r\n    SELECT 202109 UNION ALL SELECT 202110 UNION ALL SELECT 202111 UNION ALL SELECT 202112 UNION ALL\r\n    SELECT 202201 UNION ALL SELECT 202202 UNION ALL SELECT 202203 UNION ALL SELECT 202204 UNION ALL\r\n    SELECT 202205 UNION ALL SELECT 202206 UNION ALL SELECT 202207 UNION ALL SELECT 202208 UNION ALL\r\n    SELECT 202209 UNION ALL SELECT 202210 UNION ALL SELECT 202211 UNION ALL SELECT 202212 UNION ALL\r\n    SELECT 202301 UNION ALL SELECT 202302 UNION ALL SELECT 202303 UNION ALL SELECT 202304 UNION ALL\r\n    SELECT 202305 UNION ALL SELECT 202306 UNION ALL SELECT 202307 UNION ALL SELECT 202308 UNION ALL\r\n    SELECT 202309 UNION ALL SELECT 202310 UNION ALL SELECT 202311 UNION ALL SELECT 202312 UNION ALL\r\n    SELECT 202401 UNION ALL SELECT 202402 UNION ALL SELECT 202403 UNION ALL SELECT 202404 UNION ALL\r\n    SELECT 202405 UNION ALL SELECT 202406 UNION ALL SELECT 202407 UNION ALL SELECT 202408 UNION ALL\r\n    SELECT 202409 UNION ALL SELECT 202410 UNION ALL SELECT 202411 UNION ALL SELECT 202412 UNION ALL\r\n    SELECT 202501 UNION ALL SELECT 202502\r\n  ) p\r\n),\r\n\r\ndados_filtrados AS (\r\n  -- Filtrando os dados conforme requisitos\r\n  SELECT \r\n    d.nu_cnpj,\r\n    d.nu_per_ref,\r\n    d.vl_cred_mes_anterior,\r\n    d.vl_cred_mes_seguinte\r\n  FROM \r\n    usr_sat_ods.ods_decl_dime_raw d\r\n  JOIN \r\n    periodos p ON d.nu_per_ref = p.nu_per_ref\r\n  WHERE \r\n    d.vl_cred_mes_anterior > 0\r\n    AND d.vl_cred_mes_seguinte > 0\r\n),\r\n\r\nvalores_iguais_base AS (\r\n  -- Identificando onde vl_cred_mes_anterior = vl_cred_mes_seguin",
    "last_modified": "2025-10-10T18:17:15.199",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "98247874-ca8f-489a-b757-bbfeafccd369",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 162460,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "SALDO CREDOR: Claude",
    "description": "",
    "uuid": "1e642fb0-fdcb-52b0-adc9-41f747a106cb",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 162460, \"uuid\": \"b5f4ed4b-e418-4fdc-9847-b4d798ee1d34\", \"name\": \"SALDO CREDOR: Claude\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": \"1e642fb0-fdcb-52b0-adc9-41f747a106cb\", \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"5d067b02-9118-d30b-2365-52bee5bcec28\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": {\"row\": 584, \"column\": 80}, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": true, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"default\", \"currentQueryTab\": \"queryResults\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 3, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"DROP TABLE IF EXISTS teste.credito_dime_completo;\\r\\n\\r\\nCREATE TABLE IF NOT EXISTS teste.credito_dime_completo AS\\r\\n\\r\\nWITH periodos AS (\\r\\n  SELECT periodo AS nu_per_ref\\r\\n  FROM (\\r\\n    SELECT 202101 AS periodo UNION ALL SELECT 202102 UNION ALL SELECT 202103 UNION ALL SELECT 202104 UNION ALL\\r\\n    SELECT 202105 UNION ALL SELECT 202106 UNION ALL SELECT 202107 UNION ALL SELECT 202108 UNION ALL\\r\\n    SELECT 202109 UNION ALL SELECT 202110 UNION ALL SELECT 202111 UNION ALL SELECT 202112 UNION ALL\\r\\n    SELECT 202201 UNION ALL SELECT 202202 UNION ALL SELECT 202203 UNION ALL SELECT 202204 UNION ALL\\r\\n    SELECT 202205 UNION ALL SELECT 202206 UNION ALL SELECT 202207 UNION ALL SELECT 202208 UNION ALL\\r\\n    SELECT 202209 UNION ALL SELECT 202210 UNION ALL SELECT 202211 UNION ALL SELECT 202212 UNION ALL\\r\\n    SELECT 202301 UNION ALL SELECT 202302 UNION ALL SELECT 202303 UNION ALL SELECT 202304 UNION ALL\\r\\n    SELECT 202305 UNION ALL SELECT 202306 UNION ALL SELECT 202307 UNION ALL SELECT 202308 UNION ALL\\r\\n    SELECT 202309 UNION ALL SELECT 202310 UNION ALL SELECT 202311 UNION ALL SELECT 202312 UNION ALL\\r\\n    SELECT 202401 UNION ALL SELECT 202402 UNION ALL SELECT 202403 UNION ALL SELECT 202404 UNION ALL\\r\\n    SELECT 202405 UNION ALL SELECT 202406 UNION ALL SELECT 202407 UNION ALL SELECT 202408 UNION ALL\\r\\n    SELECT 202409 UNION ALL SELECT 202410 UNION ALL SELECT 202411 UNION ALL SELECT 202412 UNION ALL\\r\\n    SELECT 202501 UNION ALL SELECT 202502 UNION ALL SELECT 202503 UNION ALL SELECT 202504 UNION ALL\\r\\n    SELECT 202505 UNION ALL SELECT 202506 UNION ALL SELECT 202507 UNION ALL SELECT 202508 UNION ALL\\r\\n    SELECT 202509\\r\\n  ) p\\r\\n),\\r\\n\\r\\n-- Base: empresas com cr\\u00e9ditos na DIME\\r\\ndados_filtrados AS (\\r\\n  SELECT \\r\\n    d.nu_cnpj,\\r\\n    d.nu_per_ref,\\r\\n    d.vl_cred_mes_anterior,\\r\\n    d.vl_cred_mes_seguinte\\r\\n  FROM \\r\\n    usr_sat_ods.ods_decl_dime_raw d\\r\\n  WHERE \\r\\n    d.nu_per_ref IN (SELECT nu_per_ref FROM periodos)\\r\\n    AND d.vl_cred_mes_anterior > 0\\r\\n    AND d.vl_cred_mes_seguinte > 0\\r\\n),\\r\\n\\r\\n-- Padr\\u00e3o: valores iguais\\r\\nvalores_iguais_base AS (\\r\\n  SELECT\\r\\n    nu_cnpj,\\r\\n    nu_per_ref,\\r\\n    vl_cred_mes_anterior AS valor\\r\\n  FROM \\r\\n    dados_filtrados\\r\\n  WHERE \\r\\n    vl_cred_mes_anterior = vl_cred_mes_seguinte\\r\\n),\\r\\n\\r\\n-- Contagem total de per\\u00edodos com valores iguais\\r\\ncontagem_iguais AS (\\r\\n  SELECT\\r\\n    nu_cnpj,\\r\\n    COUNT(*) AS contagem_periodos_iguais,\\r\\n    AVG(valor) AS valor_medio_repetido,\\r\\n    MIN(nu_per_ref) AS primeiro_periodo_igual,\\r\\n    MAX(nu_per_ref) AS ultimo_periodo_igual\\r\\n  FROM \\r\\n    valores_iguais_base\\r\\n  GROUP BY \\r\\n    nu_cnpj\\r\\n),\\r\\n\\r\\n-- Sequ\\u00eancia dos \\u00faltimos meses\\r\\nsequencia_ultimos_meses AS (\\r\\n  SELECT\\r\\n    vi.nu_cnpj,\\r\\n    COUNT(*) AS qtde_ultimos_meses_iguais,\\r\\n    MIN(vi.nu_per_ref) AS periodo_inicial_seq,\\r\\n    MAX(vi.nu_per_ref) AS periodo_final_seq,\\r\\n    AVG(vi.valor) AS valor_sequencia\\r\\n  FROM \\r\\n    valores_iguais_base vi\\r\\n  WHERE \\r\\n    vi.nu_per_ref >= 202409  -- \\u00daltimos 13 meses\\r\\n  GROUP BY \\r\\n    vi.nu_cnpj\\r\\n  HAVING COUNT(*) >= 3  -- Pelo menos 3 meses seguidos\\r\\n),\\r\\n\\r\\n-- Saldo credor (OPCIONAL - pode n\\u00e3o existir)\\r\\nsaldo_credor_atual AS (\\r\\n  SELECT \\r\\n    c.nu_cnpj_grupo,\\r\\n    c.nu_cnpj,\\r\\n    SUM(q9.item.vlr) AS saldo_credor_acumulado_atual\\r\\n  FROM \\r\\n    dime.dime my_dime\\r\\n  JOIN \\r\\n    my_dime.infdime.quadro_09 AS q9\\r\\n  JOIN \\r\\n    usr_sat_ods.vw_ods_contrib c ON c.nu_ie = CAST(my_dime.infdime.nr_inscricao AS VARCHAR)\\r\\n  WHERE \\r\\n    q9.item.item = 998\\r\\n    AND my_dime.infdime.prd_ref_decl = 202509\\r\\n    AND my_dime.dime_ativa = 1\\r\\n  GROUP BY \\r\\n    c.nu_cnpj_grupo, c.nu_cnpj\\r\\n),\\r\\n\\r\\n-- Evolu\\u00e7\\u00e3o do saldo (se existir)\\r\\nevolucao_saldo AS (\\r\\n  SELECT \\r\\n    c.nu_cnpj_grupo,\\r\\n    MIN(CASE WHEN my_dime.infdime.prd_ref_decl = 202409 THEN q9.item.vlr END) AS saldo_13m_atras,\\r\\n    MAX(CASE WHEN my_dime.infdime.prd_ref_decl = 202509 THEN q9.item.vlr END) AS saldo_atual\\r\\n  FROM \\r\\n    dime.dime my_dime\\r\\n  JOIN \\r\\n    my_dime.infdime.quadro_09 AS q9\\r\\n  JOIN \\r\\n    usr_sat_ods.vw_ods_contrib c ON c.nu_ie = CAST(my_dime.infdime.nr_inscricao AS VARCHAR)\\r\\n  WHERE \\r\\n    q9.item.item = 998\\r\\n    AND my_dime.infdime.prd_ref_decl IN (202409, 202509)\\r\\n    AND my_dime.dime_ativa = 1\\r\\n  GROUP BY \\r\\n    c.nu_cnpj_grupo\\r\\n),\\r\\n\\r\\ncrescimento_saldo AS (\\r\\n  SELECT\\r\\n    nu_cnpj_grupo,\\r\\n    saldo_13m_atras,\\r\\n    saldo_atual,\\r\\n    COALESCE(saldo_atual, 0) - COALESCE(saldo_13m_atras, 0) AS crescimento_absoluto,\\r\\n    CASE \\r\\n      WHEN saldo_13m_atras > 0 THEN\\r\\n        ROUND(100.0 * (COALESCE(saldo_atual, 0) - saldo_13m_atras) / NULLIF(saldo_13m_atras, 0), 2)\\r\\n      ELSE 0\\r\\n    END AS crescimento_percentual\\r\\n  FROM \\r\\n    evolucao_saldo\\r\\n),\\r\\n\\r\\n-- Cr\\u00e9ditos presumidos\\r\\ncreditos_presumidos AS (\\r\\n  SELECT \\r\\n    dcip.nu_cnpj_grupo,\\r\\n    SUM(dcip.vl_credito) AS vl_cp_total_13m,\\r\\n    COUNT(DISTINCT dcip.cd_tipo_credito) AS qtde_tipos_cp\\r\\n  FROM \\r\\n    usr_sat_ods.vw_ods_dcip dcip\\r\\n  WHERE \\r\\n    dcip.cd_estado_decl = 1\\r\\n    AND dcip.sn_utilizada_dime = 1\\r\\n    AND dcip.cd_grupo_dcip = 3\\r\\n    AND dcip.nu_per_ref BETWEEN 202409 AND 202509\\r\\n  GROUP BY \\r\\n    dcip.nu_cnpj_grupo\\r\\n),\\r\\n\\r\\n-- Estat\\u00edsticas de cr\\u00e9ditos por empresa (\\u00faltimos 13 meses)\\r\\nestatisticas_creditos AS (\\r\\n  SELECT\\r\\n    nu_cnpj,\\r\\n    COUNT(DISTINCT nu_per_ref) AS qtde_meses_declarados,\\r\\n    AVG(vl_cred_mes_anterior) AS media_credito,\\r\\n    MIN(vl_cred_mes_anterior) AS min_credito,\\r\\n    MAX(vl_cred_mes_anterior) AS max_credito,\\r\\n    STDDEV(vl_cred_mes_anterior) AS desvio_padrao_credito\\r\\n  FROM dados_filtrados\\r\\n  WHERE nu_per_ref BETWEEN 202409 AND 202509\\r\\n  GROUP BY nu_cnpj\\r\\n)\\r\\n\\r\\nSELECT \\r\\n  df.nu_cnpj,\\r\\n  c.nm_razao_social,\\r\\n  c.nm_fantasia,\\r\\n  c.nm_sit_cadastral,\\r\\n  c.nm_gerfe,\\r\\n  c.de_cnae,\\r\\n  c.nu_cnpj_grupo,\\r\\n  \\r\\n  -- Padr\\u00f5es suspeitos\\r\\n  COALESCE(ci.contagem_periodos_iguais, 0) AS valor_igual_total_periodos,\\r\\n  COALESCE(seq.qtde_ultimos_meses_iguais, 0) AS qtde_ultimos_meses_iguais,\\r\\n  CAST(COALESCE(ci.primeiro_periodo_igual, 0) AS STRING) AS primeiro_periodo_valor_igual,\\r\\n  CAST(COALESCE(ci.ultimo_periodo_igual, 0) AS STRING) AS ultimo_periodo_valor_igual,\\r\\n  CAST(COALESCE(seq.periodo_inicial_seq, 0) AS STRING) AS periodo_inicial_sequencia_recente,\\r\\n  CAST(COALESCE(seq.periodo_final_seq, 0) AS STRING) AS periodo_final_sequencia_recente,\\r\\n  ROUND(COALESCE(seq.valor_sequencia, 0), 2) AS valor_sequencia_recente,\\r\\n  \\r\\n  -- Estat\\u00edsticas gerais\\r\\n  COALESCE(est.qtde_meses_declarados, 0) AS qtde_meses_declarados_13m,\\r\\n  ROUND(COALESCE(est.media_credito, 0), 2) AS media_credito_13m,\\r\\n  ROUND(COALESCE(est.min_credito, 0), 2) AS min_credito_13m,\\r\\n  ROUND(COALESCE(est.max_credito, 0), 2) AS max_credito_13m,\\r\\n  ROUND(COALESCE(est.desvio_padrao_credito, 0), 2) AS desvio_padrao_credito,\\r\\n  \\r\\n  -- Saldo credor (pode ser NULL)\\r\\n  COALESCE(saldo.saldo_credor_acumulado_atual, 0) AS saldo_credor_atual,\\r\\n  COALESCE(cresc.saldo_13m_atras, 0) AS saldo_13m_atras,\\r\\n  COALESCE(cresc.crescimento_absoluto, 0) AS crescimento_saldo_absoluto,\\r\\n  COALESCE(cresc.crescimento_percentual, 0) AS crescimento_saldo_percentual,\\r\\n  \\r\\n  -- Cr\\u00e9ditos presumidos\\r\\n  COALESCE(cp.vl_cp_total_13m, 0) AS vl_credito_presumido_13m,\\r\\n  COALESCE(cp.qtde_tipos_cp, 0) AS qtde_tipos_cp,\\r\\n  \\r\\n  -- SCORE DE RISCO (0-100)\\r\\n  (\\r\\n    -- Peso 1: Padr\\u00e3o repetitivo (0-40 pontos)\\r\\n    CASE \\r\\n      WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40\\r\\n      WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30\\r\\n      WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15\\r\\n      ELSE 0\\r\\n    END\\r\\n    +\\r\\n    -- Peso 2: Crescimento de saldo (0-30 pontos)\\r\\n    CASE\\r\\n      WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30\\r\\n      WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20\\r\\n      WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10\\r\\n      ELSE 0\\r\\n    END\\r\\n    +\\r\\n    -- Peso 3: Magnitude do saldo (0-20 pontos)\\r\\n    CASE\\r\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20\\r\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15\\r\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10\\r\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5\\r\\n      ELSE 0\\r\\n    END\\r\\n    +\\r\\n    -- Peso 4: Baixa variabilidade (desvio padr\\u00e3o pr\\u00f3ximo de zero = suspeito) (0-10 pontos)\\r\\n    CASE\\r\\n      WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10\\r\\n      WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5\\r\\n      ELSE 0\\r\\n    END\\r\\n  ) AS score_risco,\\r\\n  \\r\\n  -- CLASSIFICA\\u00c7\\u00c3O\\r\\n  CASE\\r\\n    WHEN (\\r\\n      CASE WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30 WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20 WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10 WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5 ELSE 0 END\\r\\n    ) >= 70 THEN 'CR\\u00cdTICO'\\r\\n    WHEN (\\r\\n      CASE WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30 WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20 WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10 WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5 ELSE 0 END\\r\\n    ) >= 50 THEN 'ALTO'\\r\\n    WHEN (\\r\\n      CASE WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30 WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20 WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10 WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5 ELSE 0 END\\r\\n    ) >= 30 THEN 'M\\u00c9DIO'\\r\\n    ELSE 'BAIXO'\\r\\n  END AS classificacao_risco\\r\\n  \\r\\nFROM \\r\\n  (SELECT DISTINCT nu_cnpj FROM dados_filtrados) df\\r\\nLEFT JOIN \\r\\n  usr_sat_ods.vw_ods_contrib c ON df.nu_cnpj = c.nu_cnpj\\r\\nLEFT JOIN \\r\\n  contagem_iguais ci ON df.nu_cnpj = ci.nu_cnpj\\r\\nLEFT JOIN \\r\\n  sequencia_ultimos_meses seq ON df.nu_cnpj = seq.nu_cnpj\\r\\nLEFT JOIN \\r\\n  estatisticas_creditos est ON df.nu_cnpj = est.nu_cnpj\\r\\nLEFT JOIN \\r\\n  saldo_credor_atual saldo ON df.nu_cnpj = saldo.nu_cnpj\\r\\nLEFT JOIN \\r\\n  crescimento_saldo cresc ON c.nu_cnpj_grupo = cresc.nu_cnpj_grupo\\r\\nLEFT JOIN \\r\\n  creditos_presumidos cp ON c.nu_cnpj_grupo = cp.nu_cnpj_grupo\\r\\nORDER BY \\r\\n  score_risco DESC, \\r\\n  qtde_ultimos_meses_iguais DESC,\\r\\n  valor_igual_total_periodos DESC;\", \"statementsList\": [\"DROP TABLE IF EXISTS teste.credito_dime_completo;\", \"\\r\\n\\r\\nCREATE TABLE IF NOT EXISTS teste.credito_dime_completo AS\\r\\n\\r\\nWITH periodos AS (\\r\\n  SELECT periodo AS nu_per_ref\\r\\n  FROM (\\r\\n    SELECT 202101 AS periodo UNION ALL SELECT 202102 UNION ALL SELECT 202103 UNION ALL SELECT 202104 UNION ALL\\r\\n    SELECT 202105 UNION ALL SELECT 202106 UNION ALL SELECT 202107 UNION ALL SELECT 202108 UNION ALL\\r\\n    SELECT 202109 UNION ALL SELECT 202110 UNION ALL SELECT 202111 UNION ALL SELECT 202112 UNION ALL\\r\\n    SELECT 202201 UNION ALL SELECT 202202 UNION ALL SELECT 202203 UNION ALL SELECT 202204 UNION ALL\\r\\n    SELECT 202205 UNION ALL SELECT 202206 UNION ALL SELECT 202207 UNION ALL SELECT 202208 UNION ALL\\r\\n    SELECT 202209 UNION ALL SELECT 202210 UNION ALL SELECT 202211 UNION ALL SELECT 202212 UNION ALL\\r\\n    SELECT 202301 UNION ALL SELECT 202302 UNION ALL SELECT 202303 UNION ALL SELECT 202304 UNION ALL\\r\\n    SELECT 202305 UNION ALL SELECT 202306 UNION ALL SELECT 202307 UNION ALL SELECT 202308 UNION ALL\\r\\n    SELECT 202309 UNION ALL SELECT 202310 UNION ALL SELECT 202311 UNION ALL SELECT 202312 UNION ALL\\r\\n    SELECT 202401 UNION ALL SELECT 202402 UNION ALL SELECT 202403 UNION ALL SELECT 202404 UNION ALL\\r\\n    SELECT 202405 UNION ALL SELECT 202406 UNION ALL SELECT 202407 UNION ALL SELECT 202408 UNION ALL\\r\\n    SELECT 202409 UNION ALL SELECT 202410 UNION ALL SELECT 202411 UNION ALL SELECT 202412 UNION ALL\\r\\n    SELECT 202501 UNION ALL SELECT 202502 UNION ALL SELECT 202503 UNION ALL SELECT 202504 UNION ALL\\r\\n    SELECT 202505 UNION ALL SELECT 202506 UNION ALL SELECT 202507 UNION ALL SELECT 202508 UNION ALL\\r\\n    SELECT 202509\\r\\n  ) p\\r\\n),\\r\\n\\r\\n-- Base: empresas com cr\\u00e9ditos na DIME\\r\\ndados_filtrados AS (\\r\\n  SELECT \\r\\n    d.nu_cnpj,\\r\\n    d.nu_per_ref,\\r\\n    d.vl_cred_mes_anterior,\\r\\n    d.vl_cred_mes_seguinte\\r\\n  FROM \\r\\n    usr_sat_ods.ods_decl_dime_raw d\\r\\n  WHERE \\r\\n    d.nu_per_ref IN (SELECT nu_per_ref FROM periodos)\\r\\n    AND d.vl_cred_mes_anterior > 0\\r\\n    AND d.vl_cred_mes_seguinte > 0\\r\\n),\\r\\n\\r\\n-- Padr\\u00e3o: valores iguais\\r\\nvalores_iguais_base AS (\\r\\n  SELECT\\r\\n    nu_cnpj,\\r\\n    nu_per_ref,\\r\\n    vl_cred_mes_anterior AS valor\\r\\n  FROM \\r\\n    dados_filtrados\\r\\n  WHERE \\r\\n    vl_cred_mes_anterior = vl_cred_mes_seguinte\\r\\n),\\r\\n\\r\\n-- Contagem total de per\\u00edodos com valores iguais\\r\\ncontagem_iguais AS (\\r\\n  SELECT\\r\\n    nu_cnpj,\\r\\n    COUNT(*) AS contagem_periodos_iguais,\\r\\n    AVG(valor) AS valor_medio_repetido,\\r\\n    MIN(nu_per_ref) AS primeiro_periodo_igual,\\r\\n    MAX(nu_per_ref) AS ultimo_periodo_igual\\r\\n  FROM \\r\\n    valores_iguais_base\\r\\n  GROUP BY \\r\\n    nu_cnpj\\r\\n),\\r\\n\\r\\n-- Sequ\\u00eancia dos \\u00faltimos meses\\r\\nsequencia_ultimos_meses AS (\\r\\n  SELECT\\r\\n    vi.nu_cnpj,\\r\\n    COUNT(*) AS qtde_ultimos_meses_iguais,\\r\\n    MIN(vi.nu_per_ref) AS periodo_inicial_seq,\\r\\n    MAX(vi.nu_per_ref) AS periodo_final_seq,\\r\\n    AVG(vi.valor) AS valor_sequencia\\r\\n  FROM \\r\\n    valores_iguais_base vi\\r\\n  WHERE \\r\\n    vi.nu_per_ref >= 202409  -- \\u00daltimos 13 meses\\r\\n  GROUP BY \\r\\n    vi.nu_cnpj\\r\\n  HAVING COUNT(*) >= 3  -- Pelo menos 3 meses seguidos\\r\\n),\\r\\n\\r\\n-- Saldo credor (OPCIONAL - pode n\\u00e3o existir)\\r\\nsaldo_credor_atual AS (\\r\\n  SELECT \\r\\n    c.nu_cnpj_grupo,\\r\\n    c.nu_cnpj,\\r\\n    SUM(q9.item.vlr) AS saldo_credor_acumulado_atual\\r\\n  FROM \\r\\n    dime.dime my_dime\\r\\n  JOIN \\r\\n    my_dime.infdime.quadro_09 AS q9\\r\\n  JOIN \\r\\n    usr_sat_ods.vw_ods_contrib c ON c.nu_ie = CAST(my_dime.infdime.nr_inscricao AS VARCHAR)\\r\\n  WHERE \\r\\n    q9.item.item = 998\\r\\n    AND my_dime.infdime.prd_ref_decl = 202509\\r\\n    AND my_dime.dime_ativa = 1\\r\\n  GROUP BY \\r\\n    c.nu_cnpj_grupo, c.nu_cnpj\\r\\n),\\r\\n\\r\\n-- Evolu\\u00e7\\u00e3o do saldo (se existir)\\r\\nevolucao_saldo AS (\\r\\n  SELECT \\r\\n    c.nu_cnpj_grupo,\\r\\n    MIN(CASE WHEN my_dime.infdime.prd_ref_decl = 202409 THEN q9.item.vlr END) AS saldo_13m_atras,\\r\\n    MAX(CASE WHEN my_dime.infdime.prd_ref_decl = 202509 THEN q9.item.vlr END) AS saldo_atual\\r\\n  FROM \\r\\n    dime.dime my_dime\\r\\n  JOIN \\r\\n    my_dime.infdime.quadro_09 AS q9\\r\\n  JOIN \\r\\n    usr_sat_ods.vw_ods_contrib c ON c.nu_ie = CAST(my_dime.infdime.nr_inscricao AS VARCHAR)\\r\\n  WHERE \\r\\n    q9.item.item = 998\\r\\n    AND my_dime.infdime.prd_ref_decl IN (202409, 202509)\\r\\n    AND my_dime.dime_ativa = 1\\r\\n  GROUP BY \\r\\n    c.nu_cnpj_grupo\\r\\n),\\r\\n\\r\\ncrescimento_saldo AS (\\r\\n  SELECT\\r\\n    nu_cnpj_grupo,\\r\\n    saldo_13m_atras,\\r\\n    saldo_atual,\\r\\n    COALESCE(saldo_atual, 0) - COALESCE(saldo_13m_atras, 0) AS crescimento_absoluto,\\r\\n    CASE \\r\\n      WHEN saldo_13m_atras > 0 THEN\\r\\n        ROUND(100.0 * (COALESCE(saldo_atual, 0) - saldo_13m_atras) / NULLIF(saldo_13m_atras, 0), 2)\\r\\n      ELSE 0\\r\\n    END AS crescimento_percentual\\r\\n  FROM \\r\\n    evolucao_saldo\\r\\n),\\r\\n\\r\\n-- Cr\\u00e9ditos presumidos\\r\\ncreditos_presumidos AS (\\r\\n  SELECT \\r\\n    dcip.nu_cnpj_grupo,\\r\\n    SUM(dcip.vl_credito) AS vl_cp_total_13m,\\r\\n    COUNT(DISTINCT dcip.cd_tipo_credito) AS qtde_tipos_cp\\r\\n  FROM \\r\\n    usr_sat_ods.vw_ods_dcip dcip\\r\\n  WHERE \\r\\n    dcip.cd_estado_decl = 1\\r\\n    AND dcip.sn_utilizada_dime = 1\\r\\n    AND dcip.cd_grupo_dcip = 3\\r\\n    AND dcip.nu_per_ref BETWEEN 202409 AND 202509\\r\\n  GROUP BY \\r\\n    dcip.nu_cnpj_grupo\\r\\n),\\r\\n\\r\\n-- Estat\\u00edsticas de cr\\u00e9ditos por empresa (\\u00faltimos 13 meses)\\r\\nestatisticas_creditos AS (\\r\\n  SELECT\\r\\n    nu_cnpj,\\r\\n    COUNT(DISTINCT nu_per_ref) AS qtde_meses_declarados,\\r\\n    AVG(vl_cred_mes_anterior) AS media_credito,\\r\\n    MIN(vl_cred_mes_anterior) AS min_credito,\\r\\n    MAX(vl_cred_mes_anterior) AS max_credito,\\r\\n    STDDEV(vl_cred_mes_anterior) AS desvio_padrao_credito\\r\\n  FROM dados_filtrados\\r\\n  WHERE nu_per_ref BETWEEN 202409 AND 202509\\r\\n  GROUP BY nu_cnpj\\r\\n)\\r\\n\\r\\nSELECT \\r\\n  df.nu_cnpj,\\r\\n  c.nm_razao_social,\\r\\n  c.nm_fantasia,\\r\\n  c.nm_sit_cadastral,\\r\\n  c.nm_gerfe,\\r\\n  c.de_cnae,\\r\\n  c.nu_cnpj_grupo,\\r\\n  \\r\\n  -- Padr\\u00f5es suspeitos\\r\\n  COALESCE(ci.contagem_periodos_iguais, 0) AS valor_igual_total_periodos,\\r\\n  COALESCE(seq.qtde_ultimos_meses_iguais, 0) AS qtde_ultimos_meses_iguais,\\r\\n  CAST(COALESCE(ci.primeiro_periodo_igual, 0) AS STRING) AS primeiro_periodo_valor_igual,\\r\\n  CAST(COALESCE(ci.ultimo_periodo_igual, 0) AS STRING) AS ultimo_periodo_valor_igual,\\r\\n  CAST(COALESCE(seq.periodo_inicial_seq, 0) AS STRING) AS periodo_inicial_sequencia_recente,\\r\\n  CAST(COALESCE(seq.periodo_final_seq, 0) AS STRING) AS periodo_final_sequencia_recente,\\r\\n  ROUND(COALESCE(seq.valor_sequencia, 0), 2) AS valor_sequencia_recente,\\r\\n  \\r\\n  -- Estat\\u00edsticas gerais\\r\\n  COALESCE(est.qtde_meses_declarados, 0) AS qtde_meses_declarados_13m,\\r\\n  ROUND(COALESCE(est.media_credito, 0), 2) AS media_credito_13m,\\r\\n  ROUND(COALESCE(est.min_credito, 0), 2) AS min_credito_13m,\\r\\n  ROUND(COALESCE(est.max_credito, 0), 2) AS max_credito_13m,\\r\\n  ROUND(COALESCE(est.desvio_padrao_credito, 0), 2) AS desvio_padrao_credito,\\r\\n  \\r\\n  -- Saldo credor (pode ser NULL)\\r\\n  COALESCE(saldo.saldo_credor_acumulado_atual, 0) AS saldo_credor_atual,\\r\\n  COALESCE(cresc.saldo_13m_atras, 0) AS saldo_13m_atras,\\r\\n  COALESCE(cresc.crescimento_absoluto, 0) AS crescimento_saldo_absoluto,\\r\\n  COALESCE(cresc.crescimento_percentual, 0) AS crescimento_saldo_percentual,\\r\\n  \\r\\n  -- Cr\\u00e9ditos presumidos\\r\\n  COALESCE(cp.vl_cp_total_13m, 0) AS vl_credito_presumido_13m,\\r\\n  COALESCE(cp.qtde_tipos_cp, 0) AS qtde_tipos_cp,\\r\\n  \\r\\n  -- SCORE DE RISCO (0-100)\\r\\n  (\\r\\n    -- Peso 1: Padr\\u00e3o repetitivo (0-40 pontos)\\r\\n    CASE \\r\\n      WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40\\r\\n      WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30\\r\\n      WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15\\r\\n      ELSE 0\\r\\n    END\\r\\n    +\\r\\n    -- Peso 2: Crescimento de saldo (0-30 pontos)\\r\\n    CASE\\r\\n      WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30\\r\\n      WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20\\r\\n      WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10\\r\\n      ELSE 0\\r\\n    END\\r\\n    +\\r\\n    -- Peso 3: Magnitude do saldo (0-20 pontos)\\r\\n    CASE\\r\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20\\r\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15\\r\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10\\r\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5\\r\\n      ELSE 0\\r\\n    END\\r\\n    +\\r\\n    -- Peso 4: Baixa variabilidade (desvio padr\\u00e3o pr\\u00f3ximo de zero = suspeito) (0-10 pontos)\\r\\n    CASE\\r\\n      WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10\\r\\n      WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5\\r\\n      ELSE 0\\r\\n    END\\r\\n  ) AS score_risco,\\r\\n  \\r\\n  -- CLASSIFICA\\u00c7\\u00c3O\\r\\n  CASE\\r\\n    WHEN (\\r\\n      CASE WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30 WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20 WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10 WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5 ELSE 0 END\\r\\n    ) >= 70 THEN 'CR\\u00cdTICO'\\r\\n    WHEN (\\r\\n      CASE WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30 WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20 WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10 WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5 ELSE 0 END\\r\\n    ) >= 50 THEN 'ALTO'\\r\\n    WHEN (\\r\\n      CASE WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30 WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20 WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10 WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5 ELSE 0 END\\r\\n    ) >= 30 THEN 'M\\u00c9DIO'\\r\\n    ELSE 'BAIXO'\\r\\n  END AS classificacao_risco\\r\\n  \\r\\nFROM \\r\\n  (SELECT DISTINCT nu_cnpj FROM dados_filtrados) df\\r\\nLEFT JOIN \\r\\n  usr_sat_ods.vw_ods_contrib c ON df.nu_cnpj = c.nu_cnpj\\r\\nLEFT JOIN \\r\\n  contagem_iguais ci ON df.nu_cnpj = ci.nu_cnpj\\r\\nLEFT JOIN \\r\\n  sequencia_ultimos_meses seq ON df.nu_cnpj = seq.nu_cnpj\\r\\nLEFT JOIN \\r\\n  estatisticas_creditos est ON df.nu_cnpj = est.nu_cnpj\\r\\nLEFT JOIN \\r\\n  saldo_credor_atual saldo ON df.nu_cnpj = saldo.nu_cnpj\\r\\nLEFT JOIN \\r\\n  crescimento_saldo cresc ON c.nu_cnpj_grupo = cresc.nu_cnpj_grupo\\r\\nLEFT JOIN \\r\\n  creditos_presumidos cp ON c.nu_cnpj_grupo = cp.nu_cnpj_grupo\\r\\nORDER BY \\r\\n  score_risco DESC, \\r\\n  qtde_ultimos_meses_iguais DESC,\\r\\n  valor_igual_total_periodos DESC;\"], \"aceSize\": 100, \"status\": \"available\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"DROP TABLE IF EXISTS teste.credito_dime_completo;\\r\\n\\r\\nCREATE TABLE IF NOT EXISTS teste.credito_dime_completo AS\\r\\n\\r\\nWITH periodos AS (\\r\\n  SELECT periodo AS nu_per_ref\\r\\n  FROM (\\r\\n    SELECT 202101 AS periodo UNION ALL SELECT 202102 UNION ALL SELECT 202103 UNION ALL SELECT 202104 UNION ALL\\r\\n    SELECT 202105 UNION ALL SELECT 202106 UNION ALL SELECT 202107 UNION ALL SELECT 202108 UNION ALL\\r\\n    SELECT 202109 UNION ALL SELECT 202110 UNION ALL SELECT 202111 UNION ALL SELECT 202112 UNION ALL\\r\\n    SELECT 202201 UNION ALL SELECT 202202 UNION ALL SELECT 202203 UNION ALL SELECT 202204 UNION ALL\\r\\n    SELECT 202205 UNION ALL SELECT 202206 UNION ALL SELECT 202207 UNION ALL SELECT 202208 UNION ALL\\r\\n    SELECT 202209 UNION ALL SELECT 202210 UNION ALL SELECT 202211 UNION ALL SELECT 202212 UNION ALL\\r\\n    SELECT 202301 UNION ALL SELECT 202302 UNION ALL SELECT 202303 UNION ALL SELECT 202304 UNION ALL\\r\\n    SELECT 202305 UNION ALL SELECT 202306 UNION ALL SELECT 202307 UNION ALL SELECT 202308 UNION ALL\\r\\n    SELECT 202309 UNION ALL SELECT 202310 UNION ALL SELECT 202311 UNION ALL SELECT 202312 UNION ALL\\r\\n    SELECT 202401 UNION ALL SELECT 202402 UNION ALL SELECT 202403 UNION ALL SELECT 202404 UNION ALL\\r\\n    SELECT 202405 UNION ALL SELECT 202406 UNION ALL SELECT 202407 UNION ALL SELECT 202408 UNION ALL\\r\\n    SELECT 202409 UNION ALL SELECT 202410 UNION ALL SELECT 202411 UNION ALL SELECT 202412 UNION ALL\\r\\n    SELECT 202501 UNION ALL SELECT 202502 UNION ALL SELECT 202503 UNION ALL SELECT 202504 UNION ALL\\r\\n    SELECT 202505 UNION ALL SELECT 202506 UNION ALL SELECT 202507 UNION ALL SELECT 202508 UNION ALL\\r\\n    SELECT 202509\\r\\n  ) p\\r\\n),\\r\\n\\r\\n-- Base: empresas com cr\\u00e9ditos na DIME\\r\\ndados_filtrados AS (\\r\\n  SELECT \\r\\n    d.nu_cnpj,\\r\\n    d.nu_per_ref,\\r\\n    d.vl_cred_mes_anterior,\\r\\n    d.vl_cred_mes_seguinte\\r\\n  FROM \\r\\n    usr_sat_ods.ods_decl_dime_raw d\\r\\n  WHERE \\r\\n    d.nu_per_ref IN (SELECT nu_per_ref FROM periodos)\\r\\n    AND d.vl_cred_mes_anterior > 0\\r\\n    AND d.vl_cred_mes_seguinte > 0\\r\\n),\\r\\n\\r\\n-- Padr\\u00e3o: valores iguais\\r\\nvalores_iguais_base AS (\\r\\n  SELECT\\r\\n    nu_cnpj,\\r\\n    nu_per_ref,\\r\\n    vl_cred_mes_anterior AS valor\\r\\n  FROM \\r\\n    dados_filtrados\\r\\n  WHERE \\r\\n    vl_cred_mes_anterior = vl_cred_mes_seguinte\\r\\n),\\r\\n\\r\\n-- Contagem total de per\\u00edodos com valores iguais\\r\\ncontagem_iguais AS (\\r\\n  SELECT\\r\\n    nu_cnpj,\\r\\n    COUNT(*) AS contagem_periodos_iguais,\\r\\n    AVG(valor) AS valor_medio_repetido,\\r\\n    MIN(nu_per_ref) AS primeiro_periodo_igual,\\r\\n    MAX(nu_per_ref) AS ultimo_periodo_igual\\r\\n  FROM \\r\\n    valores_iguais_base\\r\\n  GROUP BY \\r\\n    nu_cnpj\\r\\n),\\r\\n\\r\\n-- Sequ\\u00eancia dos \\u00faltimos meses\\r\\nsequencia_ultimos_meses AS (\\r\\n  SELECT\\r\\n    vi.nu_cnpj,\\r\\n    COUNT(*) AS qtde_ultimos_meses_iguais,\\r\\n    MIN(vi.nu_per_ref) AS periodo_inicial_seq,\\r\\n    MAX(vi.nu_per_ref) AS periodo_final_seq,\\r\\n    AVG(vi.valor) AS valor_sequencia\\r\\n  FROM \\r\\n    valores_iguais_base vi\\r\\n  WHERE \\r\\n    vi.nu_per_ref >= 202409  -- \\u00daltimos 13 meses\\r\\n  GROUP BY \\r\\n    vi.nu_cnpj\\r\\n  HAVING COUNT(*) >= 3  -- Pelo menos 3 meses seguidos\\r\\n),\\r\\n\\r\\n-- Saldo credor (OPCIONAL - pode n\\u00e3o existir)\\r\\nsaldo_credor_atual AS (\\r\\n  SELECT \\r\\n    c.nu_cnpj_grupo,\\r\\n    c.nu_cnpj,\\r\\n    SUM(q9.item.vlr) AS saldo_credor_acumulado_atual\\r\\n  FROM \\r\\n    dime.dime my_dime\\r\\n  JOIN \\r\\n    my_dime.infdime.quadro_09 AS q9\\r\\n  JOIN \\r\\n    usr_sat_ods.vw_ods_contrib c ON c.nu_ie = CAST(my_dime.infdime.nr_inscricao AS VARCHAR)\\r\\n  WHERE \\r\\n    q9.item.item = 998\\r\\n    AND my_dime.infdime.prd_ref_decl = 202509\\r\\n    AND my_dime.dime_ativa = 1\\r\\n  GROUP BY \\r\\n    c.nu_cnpj_grupo, c.nu_cnpj\\r\\n),\\r\\n\\r\\n-- Evolu\\u00e7\\u00e3o do saldo (se existir)\\r\\nevolucao_saldo AS (\\r\\n  SELECT \\r\\n    c.nu_cnpj_grupo,\\r\\n    MIN(CASE WHEN my_dime.infdime.prd_ref_decl = 202409 THEN q9.item.vlr END) AS saldo_13m_atras,\\r\\n    MAX(CASE WHEN my_dime.infdime.prd_ref_decl = 202509 THEN q9.item.vlr END) AS saldo_atual\\r\\n  FROM \\r\\n    dime.dime my_dime\\r\\n  JOIN \\r\\n    my_dime.infdime.quadro_09 AS q9\\r\\n  JOIN \\r\\n    usr_sat_ods.vw_ods_contrib c ON c.nu_ie = CAST(my_dime.infdime.nr_inscricao AS VARCHAR)\\r\\n  WHERE \\r\\n    q9.item.item = 998\\r\\n    AND my_dime.infdime.prd_ref_decl IN (202409, 202509)\\r\\n    AND my_dime.dime_ativa = 1\\r\\n  GROUP BY \\r\\n    c.nu_cnpj_grupo\\r\\n),\\r\\n\\r\\ncrescimento_saldo AS (\\r\\n  SELECT\\r\\n    nu_cnpj_grupo,\\r\\n    saldo_13m_atras,\\r\\n    saldo_atual,\\r\\n    COALESCE(saldo_atual, 0) - COALESCE(saldo_13m_atras, 0) AS crescimento_absoluto,\\r\\n    CASE \\r\\n      WHEN saldo_13m_atras > 0 THEN\\r\\n        ROUND(100.0 * (COALESCE(saldo_atual, 0) - saldo_13m_atras) / NULLIF(saldo_13m_atras, 0), 2)\\r\\n      ELSE 0\\r\\n    END AS crescimento_percentual\\r\\n  FROM \\r\\n    evolucao_saldo\\r\\n),\\r\\n\\r\\n-- Cr\\u00e9ditos presumidos\\r\\ncreditos_presumidos AS (\\r\\n  SELECT \\r\\n    dcip.nu_cnpj_grupo,\\r\\n    SUM(dcip.vl_credito) AS vl_cp_total_13m,\\r\\n    COUNT(DISTINCT dcip.cd_tipo_credito) AS qtde_tipos_cp\\r\\n  FROM \\r\\n    usr_sat_ods.vw_ods_dcip dcip\\r\\n  WHERE \\r\\n    dcip.cd_estado_decl = 1\\r\\n    AND dcip.sn_utilizada_dime = 1\\r\\n    AND dcip.cd_grupo_dcip = 3\\r\\n    AND dcip.nu_per_ref BETWEEN 202409 AND 202509\\r\\n  GROUP BY \\r\\n    dcip.nu_cnpj_grupo\\r\\n),\\r\\n\\r\\n-- Estat\\u00edsticas de cr\\u00e9ditos por empresa (\\u00faltimos 13 meses)\\r\\nestatisticas_creditos AS (\\r\\n  SELECT\\r\\n    nu_cnpj,\\r\\n    COUNT(DISTINCT nu_per_ref) AS qtde_meses_declarados,\\r\\n    AVG(vl_cred_mes_anterior) AS media_credito,\\r\\n    MIN(vl_cred_mes_anterior) AS min_credito,\\r\\n    MAX(vl_cred_mes_anterior) AS max_credito,\\r\\n    STDDEV(vl_cred_mes_anterior) AS desvio_padrao_credito\\r\\n  FROM dados_filtrados\\r\\n  WHERE nu_per_ref BETWEEN 202409 AND 202509\\r\\n  GROUP BY nu_cnpj\\r\\n)\\r\\n\\r\\nSELECT \\r\\n  df.nu_cnpj,\\r\\n  c.nm_razao_social,\\r\\n  c.nm_fantasia,\\r\\n  c.nm_sit_cadastral,\\r\\n  c.nm_gerfe,\\r\\n  c.de_cnae,\\r\\n  c.nu_cnpj_grupo,\\r\\n  \\r\\n  -- Padr\\u00f5es suspeitos\\r\\n  COALESCE(ci.contagem_periodos_iguais, 0) AS valor_igual_total_periodos,\\r\\n  COALESCE(seq.qtde_ultimos_meses_iguais, 0) AS qtde_ultimos_meses_iguais,\\r\\n  CAST(COALESCE(ci.primeiro_periodo_igual, 0) AS STRING) AS primeiro_periodo_valor_igual,\\r\\n  CAST(COALESCE(ci.ultimo_periodo_igual, 0) AS STRING) AS ultimo_periodo_valor_igual,\\r\\n  CAST(COALESCE(seq.periodo_inicial_seq, 0) AS STRING) AS periodo_inicial_sequencia_recente,\\r\\n  CAST(COALESCE(seq.periodo_final_seq, 0) AS STRING) AS periodo_final_sequencia_recente,\\r\\n  ROUND(COALESCE(seq.valor_sequencia, 0), 2) AS valor_sequencia_recente,\\r\\n  \\r\\n  -- Estat\\u00edsticas gerais\\r\\n  COALESCE(est.qtde_meses_declarados, 0) AS qtde_meses_declarados_13m,\\r\\n  ROUND(COALESCE(est.media_credito, 0), 2) AS media_credito_13m,\\r\\n  ROUND(COALESCE(est.min_credito, 0), 2) AS min_credito_13m,\\r\\n  ROUND(COALESCE(est.max_credito, 0), 2) AS max_credito_13m,\\r\\n  ROUND(COALESCE(est.desvio_padrao_credito, 0), 2) AS desvio_padrao_credito,\\r\\n  \\r\\n  -- Saldo credor (pode ser NULL)\\r\\n  COALESCE(saldo.saldo_credor_acumulado_atual, 0) AS saldo_credor_atual,\\r\\n  COALESCE(cresc.saldo_13m_atras, 0) AS saldo_13m_atras,\\r\\n  COALESCE(cresc.crescimento_absoluto, 0) AS crescimento_saldo_absoluto,\\r\\n  COALESCE(cresc.crescimento_percentual, 0) AS crescimento_saldo_percentual,\\r\\n  \\r\\n  -- Cr\\u00e9ditos presumidos\\r\\n  COALESCE(cp.vl_cp_total_13m, 0) AS vl_credito_presumido_13m,\\r\\n  COALESCE(cp.qtde_tipos_cp, 0) AS qtde_tipos_cp,\\r\\n  \\r\\n  -- SCORE DE RISCO (0-100)\\r\\n  (\\r\\n    -- Peso 1: Padr\\u00e3o repetitivo (0-40 pontos)\\r\\n    CASE \\r\\n      WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40\\r\\n      WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30\\r\\n      WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15\\r\\n      ELSE 0\\r\\n    END\\r\\n    +\\r\\n    -- Peso 2: Crescimento de saldo (0-30 pontos)\\r\\n    CASE\\r\\n      WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30\\r\\n      WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20\\r\\n      WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10\\r\\n      ELSE 0\\r\\n    END\\r\\n    +\\r\\n    -- Peso 3: Magnitude do saldo (0-20 pontos)\\r\\n    CASE\\r\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20\\r\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15\\r\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10\\r\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5\\r\\n      ELSE 0\\r\\n    END\\r\\n    +\\r\\n    -- Peso 4: Baixa variabilidade (desvio padr\\u00e3o pr\\u00f3ximo de zero = suspeito) (0-10 pontos)\\r\\n    CASE\\r\\n      WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10\\r\\n      WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5\\r\\n      ELSE 0\\r\\n    END\\r\\n  ) AS score_risco,\\r\\n  \\r\\n  -- CLASSIFICA\\u00c7\\u00c3O\\r\\n  CASE\\r\\n    WHEN (\\r\\n      CASE WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30 WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20 WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10 WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5 ELSE 0 END\\r\\n    ) >= 70 THEN 'CR\\u00cdTICO'\\r\\n    WHEN (\\r\\n      CASE WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30 WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20 WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10 WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5 ELSE 0 END\\r\\n    ) >= 50 THEN 'ALTO'\\r\\n    WHEN (\\r\\n      CASE WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30 WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20 WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10 WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5 ELSE 0 END\\r\\n    ) >= 30 THEN 'M\\u00c9DIO'\\r\\n    ELSE 'BAIXO'\\r\\n  END AS classificacao_risco\\r\\n  \\r\\nFROM \\r\\n  (SELECT DISTINCT nu_cnpj FROM dados_filtrados) df\\r\\nLEFT JOIN \\r\\n  usr_sat_ods.vw_ods_contrib c ON df.nu_cnpj = c.nu_cnpj\\r\\nLEFT JOIN \\r\\n  contagem_iguais ci ON df.nu_cnpj = ci.nu_cnpj\\r\\nLEFT JOIN \\r\\n  sequencia_ultimos_meses seq ON df.nu_cnpj = seq.nu_cnpj\\r\\nLEFT JOIN \\r\\n  estatisticas_creditos est ON df.nu_cnpj = est.nu_cnpj\\r\\nLEFT JOIN \\r\\n  saldo_credor_atual saldo ON df.nu_cnpj = saldo.nu_cnpj\\r\\nLEFT JOIN \\r\\n  crescimento_saldo cresc ON c.nu_cnpj_grupo = cresc.nu_cnpj_grupo\\r\\nLEFT JOIN \\r\\n  creditos_presumidos cp ON c.nu_cnpj_grupo = cp.nu_cnpj_grupo\\r\\nORDER BY \\r\\n  score_risco DESC, \\r\\n  qtde_ultimos_meses_iguais DESC,\\r\\n  valor_igual_total_periodos DESC;\", \"result\": {\"id\": \"74f624e3-035a-ab7a-ff53-c51b3c00576f\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"AnIV/ChmR2GmjNZx5pr+Bw==\", \"guid\": \"bIUbCRlDTrAAAAAAW6Tm3A==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"a14a96e02125e5fe:0e4a6eab4a1a89bd\", \"session_id\": 21447, \"session_type\": \"impala\", \"statement_id\": 1, \"has_more_statements\": false, \"statements_count\": 2, \"previous_statement_hash\": \"2a6384c603b2b9da8a47c3134dac1c170b56e1c0564e61e514113719\", \"start\": {\"row\": 2, \"column\": 0}, \"end\": {\"row\": 281, \"column\": 33}, \"statement\": \"CREATE TABLE IF NOT EXISTS teste.credito_dime_completo AS\\n\\nWITH periodos AS (\\n  SELECT periodo AS nu_per_ref\\n  FROM (\\n    SELECT 202101 AS periodo UNION ALL SELECT 202102 UNION ALL SELECT 202103 UNION ALL SELECT 202104 UNION ALL\\n    SELECT 202105 UNION ALL SELECT 202106 UNION ALL SELECT 202107 UNION ALL SELECT 202108 UNION ALL\\n    SELECT 202109 UNION ALL SELECT 202110 UNION ALL SELECT 202111 UNION ALL SELECT 202112 UNION ALL\\n    SELECT 202201 UNION ALL SELECT 202202 UNION ALL SELECT 202203 UNION ALL SELECT 202204 UNION ALL\\n    SELECT 202205 UNION ALL SELECT 202206 UNION ALL SELECT 202207 UNION ALL SELECT 202208 UNION ALL\\n    SELECT 202209 UNION ALL SELECT 202210 UNION ALL SELECT 202211 UNION ALL SELECT 202212 UNION ALL\\n    SELECT 202301 UNION ALL SELECT 202302 UNION ALL SELECT 202303 UNION ALL SELECT 202304 UNION ALL\\n    SELECT 202305 UNION ALL SELECT 202306 UNION ALL SELECT 202307 UNION ALL SELECT 202308 UNION ALL\\n    SELECT 202309 UNION ALL SELECT 202310 UNION ALL SELECT 202311 UNION ALL SELECT 202312 UNION ALL\\n    SELECT 202401 UNION ALL SELECT 202402 UNION ALL SELECT 202403 UNION ALL SELECT 202404 UNION ALL\\n    SELECT 202405 UNION ALL SELECT 202406 UNION ALL SELECT 202407 UNION ALL SELECT 202408 UNION ALL\\n    SELECT 202409 UNION ALL SELECT 202410 UNION ALL SELECT 202411 UNION ALL SELECT 202412 UNION ALL\\n    SELECT 202501 UNION ALL SELECT 202502 UNION ALL SELECT 202503 UNION ALL SELECT 202504 UNION ALL\\n    SELECT 202505 UNION ALL SELECT 202506 UNION ALL SELECT 202507 UNION ALL SELECT 202508 UNION ALL\\n    SELECT 202509\\n  ) p\\n),\\n\\n-- Base: empresas com cr\\u00e9ditos na DIME\\ndados_filtrados AS (\\n  SELECT \\n    d.nu_cnpj,\\n    d.nu_per_ref,\\n    d.vl_cred_mes_anterior,\\n    d.vl_cred_mes_seguinte\\n  FROM \\n    usr_sat_ods.ods_decl_dime_raw d\\n  WHERE \\n    d.nu_per_ref IN (SELECT nu_per_ref FROM periodos)\\n    AND d.vl_cred_mes_anterior > 0\\n    AND d.vl_cred_mes_seguinte > 0\\n),\\n\\n-- Padr\\u00e3o: valores iguais\\nvalores_iguais_base AS (\\n  SELECT\\n    nu_cnpj,\\n    nu_per_ref,\\n    vl_cred_mes_anterior AS valor\\n  FROM \\n    dados_filtrados\\n  WHERE \\n    vl_cred_mes_anterior = vl_cred_mes_seguinte\\n),\\n\\n-- Contagem total de per\\u00edodos com valores iguais\\ncontagem_iguais AS (\\n  SELECT\\n    nu_cnpj,\\n    COUNT(*) AS contagem_periodos_iguais,\\n    AVG(valor) AS valor_medio_repetido,\\n    MIN(nu_per_ref) AS primeiro_periodo_igual,\\n    MAX(nu_per_ref) AS ultimo_periodo_igual\\n  FROM \\n    valores_iguais_base\\n  GROUP BY \\n    nu_cnpj\\n),\\n\\n-- Sequ\\u00eancia dos \\u00faltimos meses\\nsequencia_ultimos_meses AS (\\n  SELECT\\n    vi.nu_cnpj,\\n    COUNT(*) AS qtde_ultimos_meses_iguais,\\n    MIN(vi.nu_per_ref) AS periodo_inicial_seq,\\n    MAX(vi.nu_per_ref) AS periodo_final_seq,\\n    AVG(vi.valor) AS valor_sequencia\\n  FROM \\n    valores_iguais_base vi\\n  WHERE \\n    vi.nu_per_ref >= 202409  -- \\u00daltimos 13 meses\\n  GROUP BY \\n    vi.nu_cnpj\\n  HAVING COUNT(*) >= 3  -- Pelo menos 3 meses seguidos\\n),\\n\\n-- Saldo credor (OPCIONAL - pode n\\u00e3o existir)\\nsaldo_credor_atual AS (\\n  SELECT \\n    c.nu_cnpj_grupo,\\n    c.nu_cnpj,\\n    SUM(q9.item.vlr) AS saldo_credor_acumulado_atual\\n  FROM \\n    dime.dime my_dime\\n  JOIN \\n    my_dime.infdime.quadro_09 AS q9\\n  JOIN \\n    usr_sat_ods.vw_ods_contrib c ON c.nu_ie = CAST(my_dime.infdime.nr_inscricao AS VARCHAR)\\n  WHERE \\n    q9.item.item = 998\\n    AND my_dime.infdime.prd_ref_decl = 202509\\n    AND my_dime.dime_ativa = 1\\n  GROUP BY \\n    c.nu_cnpj_grupo, c.nu_cnpj\\n),\\n\\n-- Evolu\\u00e7\\u00e3o do saldo (se existir)\\nevolucao_saldo AS (\\n  SELECT \\n    c.nu_cnpj_grupo,\\n    MIN(CASE WHEN my_dime.infdime.prd_ref_decl = 202409 THEN q9.item.vlr END) AS saldo_13m_atras,\\n    MAX(CASE WHEN my_dime.infdime.prd_ref_decl = 202509 THEN q9.item.vlr END) AS saldo_atual\\n  FROM \\n    dime.dime my_dime\\n  JOIN \\n    my_dime.infdime.quadro_09 AS q9\\n  JOIN \\n    usr_sat_ods.vw_ods_contrib c ON c.nu_ie = CAST(my_dime.infdime.nr_inscricao AS VARCHAR)\\n  WHERE \\n    q9.item.item = 998\\n    AND my_dime.infdime.prd_ref_decl IN (202409, 202509)\\n    AND my_dime.dime_ativa = 1\\n  GROUP BY \\n    c.nu_cnpj_grupo\\n),\\n\\ncrescimento_saldo AS (\\n  SELECT\\n    nu_cnpj_grupo,\\n    saldo_13m_atras,\\n    saldo_atual,\\n    COALESCE(saldo_atual, 0) - COALESCE(saldo_13m_atras, 0) AS crescimento_absoluto,\\n    CASE \\n      WHEN saldo_13m_atras > 0 THEN\\n        ROUND(100.0 * (COALESCE(saldo_atual, 0) - saldo_13m_atras) / NULLIF(saldo_13m_atras, 0), 2)\\n      ELSE 0\\n    END AS crescimento_percentual\\n  FROM \\n    evolucao_saldo\\n),\\n\\n-- Cr\\u00e9ditos presumidos\\ncreditos_presumidos AS (\\n  SELECT \\n    dcip.nu_cnpj_grupo,\\n    SUM(dcip.vl_credito) AS vl_cp_total_13m,\\n    COUNT(DISTINCT dcip.cd_tipo_credito) AS qtde_tipos_cp\\n  FROM \\n    usr_sat_ods.vw_ods_dcip dcip\\n  WHERE \\n    dcip.cd_estado_decl = 1\\n    AND dcip.sn_utilizada_dime = 1\\n    AND dcip.cd_grupo_dcip = 3\\n    AND dcip.nu_per_ref BETWEEN 202409 AND 202509\\n  GROUP BY \\n    dcip.nu_cnpj_grupo\\n),\\n\\n-- Estat\\u00edsticas de cr\\u00e9ditos por empresa (\\u00faltimos 13 meses)\\nestatisticas_creditos AS (\\n  SELECT\\n    nu_cnpj,\\n    COUNT(DISTINCT nu_per_ref) AS qtde_meses_declarados,\\n    AVG(vl_cred_mes_anterior) AS media_credito,\\n    MIN(vl_cred_mes_anterior) AS min_credito,\\n    MAX(vl_cred_mes_anterior) AS max_credito,\\n    STDDEV(vl_cred_mes_anterior) AS desvio_padrao_credito\\n  FROM dados_filtrados\\n  WHERE nu_per_ref BETWEEN 202409 AND 202509\\n  GROUP BY nu_cnpj\\n)\\n\\nSELECT \\n  df.nu_cnpj,\\n  c.nm_razao_social,\\n  c.nm_fantasia,\\n  c.nm_sit_cadastral,\\n  c.nm_gerfe,\\n  c.de_cnae,\\n  c.nu_cnpj_grupo,\\n  \\n  -- Padr\\u00f5es suspeitos\\n  COALESCE(ci.contagem_periodos_iguais, 0) AS valor_igual_total_periodos,\\n  COALESCE(seq.qtde_ultimos_meses_iguais, 0) AS qtde_ultimos_meses_iguais,\\n  CAST(COALESCE(ci.primeiro_periodo_igual, 0) AS STRING) AS primeiro_periodo_valor_igual,\\n  CAST(COALESCE(ci.ultimo_periodo_igual, 0) AS STRING) AS ultimo_periodo_valor_igual,\\n  CAST(COALESCE(seq.periodo_inicial_seq, 0) AS STRING) AS periodo_inicial_sequencia_recente,\\n  CAST(COALESCE(seq.periodo_final_seq, 0) AS STRING) AS periodo_final_sequencia_recente,\\n  ROUND(COALESCE(seq.valor_sequencia, 0), 2) AS valor_sequencia_recente,\\n  \\n  -- Estat\\u00edsticas gerais\\n  COALESCE(est.qtde_meses_declarados, 0) AS qtde_meses_declarados_13m,\\n  ROUND(COALESCE(est.media_credito, 0), 2) AS media_credito_13m,\\n  ROUND(COALESCE(est.min_credito, 0), 2) AS min_credito_13m,\\n  ROUND(COALESCE(est.max_credito, 0), 2) AS max_credito_13m,\\n  ROUND(COALESCE(est.desvio_padrao_credito, 0), 2) AS desvio_padrao_credito,\\n  \\n  -- Saldo credor (pode ser NULL)\\n  COALESCE(saldo.saldo_credor_acumulado_atual, 0) AS saldo_credor_atual,\\n  COALESCE(cresc.saldo_13m_atras, 0) AS saldo_13m_atras,\\n  COALESCE(cresc.crescimento_absoluto, 0) AS crescimento_saldo_absoluto,\\n  COALESCE(cresc.crescimento_percentual, 0) AS crescimento_saldo_percentual,\\n  \\n  -- Cr\\u00e9ditos presumidos\\n  COALESCE(cp.vl_cp_total_13m, 0) AS vl_credito_presumido_13m,\\n  COALESCE(cp.qtde_tipos_cp, 0) AS qtde_tipos_cp,\\n  \\n  -- SCORE DE RISCO (0-100)\\n  (\\n    -- Peso 1: Padr\\u00e3o repetitivo (0-40 pontos)\\n    CASE \\n      WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40\\n      WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30\\n      WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15\\n      ELSE 0\\n    END\\n    +\\n    -- Peso 2: Crescimento de saldo (0-30 pontos)\\n    CASE\\n      WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30\\n      WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20\\n      WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10\\n      ELSE 0\\n    END\\n    +\\n    -- Peso 3: Magnitude do saldo (0-20 pontos)\\n    CASE\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5\\n      ELSE 0\\n    END\\n    +\\n    -- Peso 4: Baixa variabilidade (desvio padr\\u00e3o pr\\u00f3ximo de zero = suspeito) (0-10 pontos)\\n    CASE\\n      WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10\\n      WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5\\n      ELSE 0\\n    END\\n  ) AS score_risco,\\n  \\n  -- CLASSIFICA\\u00c7\\u00c3O\\n  CASE\\n    WHEN (\\n      CASE WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15 ELSE 0 END +\\n      CASE WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30 WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20 WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10 ELSE 0 END +\\n      CASE WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5 ELSE 0 END +\\n      CASE WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10 WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5 ELSE 0 END\\n    ) >= 70 THEN 'CR\\u00cdTICO'\\n    WHEN (\\n      CASE WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15 ELSE 0 END +\\n      CASE WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30 WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20 WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10 ELSE 0 END +\\n      CASE WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5 ELSE 0 END +\\n      CASE WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10 WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5 ELSE 0 END\\n    ) >= 50 THEN 'ALTO'\\n    WHEN (\\n      CASE WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15 ELSE 0 END +\\n      CASE WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30 WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20 WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10 ELSE 0 END +\\n      CASE WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5 ELSE 0 END +\\n      CASE WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10 WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5 ELSE 0 END\\n    ) >= 30 THEN 'M\\u00c9DIO'\\n    ELSE 'BAIXO'\\n  END AS classificacao_risco\\n  \\nFROM \\n  (SELECT DISTINCT nu_cnpj FROM dados_filtrados) df\\nLEFT JOIN \\n  usr_sat_ods.vw_ods_contrib c ON df.nu_cnpj = c.nu_cnpj\\nLEFT JOIN \\n  contagem_iguais ci ON df.nu_cnpj = ci.nu_cnpj\\nLEFT JOIN \\n  sequencia_ultimos_meses seq ON df.nu_cnpj = seq.nu_cnpj\\nLEFT JOIN \\n  estatisticas_creditos est ON df.nu_cnpj = est.nu_cnpj\\nLEFT JOIN \\n  saldo_credor_atual saldo ON df.nu_cnpj = saldo.nu_cnpj\\nLEFT JOIN \\n  crescimento_saldo cresc ON c.nu_cnpj_grupo = cresc.nu_cnpj_grupo\\nLEFT JOIN \\n  creditos_presumidos cp ON c.nu_cnpj_grupo = cp.nu_cnpj_grupo\\nORDER BY \\n  score_risco DESC, \\n  qtde_ultimos_meses_iguais DESC,\\n  valor_igual_total_periodos DESC\"}, \"meta\": [], \"rows\": \"1\", \"hasMore\": false, \"statement_id\": 1, \"statement_range\": {\"start\": {\"row\": 2, \"column\": 0}, \"end\": {\"row\": 281, \"column\": 33}}, \"statements_count\": 2, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": 1, \"filteredMeta\": [{\"type\": \"int\", \"name\": \"\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 0}, {\"name\": \"summary\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 1}], \"fetchedOnce\": false, \"startTime\": \"2025-10-11T02:48:42.554Z\", \"endTime\": \"2025-10-11T02:48:47.758Z\", \"executionTime\": 5204, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 30, \"hasSomeResults\": true}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": 8246, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": \"summary\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": false, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"summary\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": 8429, \"getLogsTimeout\": 8450, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1760150922143, \"lastAceSelectionRowOffset\": 0, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"lastExecutedStatements\": \"DROP TABLE IF EXISTS teste.credito_dime_completo;\\r\\n\\r\\nCREATE TABLE IF NOT EXISTS teste.credito_dime_completo AS\\r\\n\\r\\nWITH periodos AS (\\r\\n  SELECT periodo AS nu_per_ref\\r\\n  FROM (\\r\\n    SELECT 202101 AS periodo UNION ALL SELECT 202102 UNION ALL SELECT 202103 UNION ALL SELECT 202104 UNION ALL\\r\\n    SELECT 202105 UNION ALL SELECT 202106 UNION ALL SELECT 202107 UNION ALL SELECT 202108 UNION ALL\\r\\n    SELECT 202109 UNION ALL SELECT 202110 UNION ALL SELECT 202111 UNION ALL SELECT 202112 UNION ALL\\r\\n    SELECT 202201 UNION ALL SELECT 202202 UNION ALL SELECT 202203 UNION ALL SELECT 202204 UNION ALL\\r\\n    SELECT 202205 UNION ALL SELECT 202206 UNION ALL SELECT 202207 UNION ALL SELECT 202208 UNION ALL\\r\\n    SELECT 202209 UNION ALL SELECT 202210 UNION ALL SELECT 202211 UNION ALL SELECT 202212 UNION ALL\\r\\n    SELECT 202301 UNION ALL SELECT 202302 UNION ALL SELECT 202303 UNION ALL SELECT 202304 UNION ALL\\r\\n    SELECT 202305 UNION ALL SELECT 202306 UNION ALL SELECT 202307 UNION ALL SELECT 202308 UNION ALL\\r\\n    SELECT 202309 UNION ALL SELECT 202310 UNION ALL SELECT 202311 UNION ALL SELECT 202312 UNION ALL\\r\\n    SELECT 202401 UNION ALL SELECT 202402 UNION ALL SELECT 202403 UNION ALL SELECT 202404 UNION ALL\\r\\n    SELECT 202405 UNION ALL SELECT 202406 UNION ALL SELECT 202407 UNION ALL SELECT 202408 UNION ALL\\r\\n    SELECT 202409 UNION ALL SELECT 202410 UNION ALL SELECT 202411 UNION ALL SELECT 202412 UNION ALL\\r\\n    SELECT 202501 UNION ALL SELECT 202502 UNION ALL SELECT 202503 UNION ALL SELECT 202504 UNION ALL\\r\\n    SELECT 202505 UNION ALL SELECT 202506 UNION ALL SELECT 202507 UNION ALL SELECT 202508 UNION ALL\\r\\n    SELECT 202509\\r\\n  ) p\\r\\n),\\r\\n\\r\\n-- Base: empresas com cr\\u00e9ditos na DIME\\r\\ndados_filtrados AS (\\r\\n  SELECT \\r\\n    d.nu_cnpj,\\r\\n    d.nu_per_ref,\\r\\n    d.vl_cred_mes_anterior,\\r\\n    d.vl_cred_mes_seguinte\\r\\n  FROM \\r\\n    usr_sat_ods.ods_decl_dime_raw d\\r\\n  WHERE \\r\\n    d.nu_per_ref IN (SELECT nu_per_ref FROM periodos)\\r\\n    AND d.vl_cred_mes_anterior > 0\\r\\n    AND d.vl_cred_mes_seguinte > 0\\r\\n),\\r\\n\\r\\n-- Padr\\u00e3o: valores iguais\\r\\nvalores_iguais_base AS (\\r\\n  SELECT\\r\\n    nu_cnpj,\\r\\n    nu_per_ref,\\r\\n    vl_cred_mes_anterior AS valor\\r\\n  FROM \\r\\n    dados_filtrados\\r\\n  WHERE \\r\\n    vl_cred_mes_anterior = vl_cred_mes_seguinte\\r\\n),\\r\\n\\r\\n-- Contagem total de per\\u00edodos com valores iguais\\r\\ncontagem_iguais AS (\\r\\n  SELECT\\r\\n    nu_cnpj,\\r\\n    COUNT(*) AS contagem_periodos_iguais,\\r\\n    AVG(valor) AS valor_medio_repetido,\\r\\n    MIN(nu_per_ref) AS primeiro_periodo_igual,\\r\\n    MAX(nu_per_ref) AS ultimo_periodo_igual\\r\\n  FROM \\r\\n    valores_iguais_base\\r\\n  GROUP BY \\r\\n    nu_cnpj\\r\\n),\\r\\n\\r\\n-- Sequ\\u00eancia dos \\u00faltimos meses\\r\\nsequencia_ultimos_meses AS (\\r\\n  SELECT\\r\\n    vi.nu_cnpj,\\r\\n    COUNT(*) AS qtde_ultimos_meses_iguais,\\r\\n    MIN(vi.nu_per_ref) AS periodo_inicial_seq,\\r\\n    MAX(vi.nu_per_ref) AS periodo_final_seq,\\r\\n    AVG(vi.valor) AS valor_sequencia\\r\\n  FROM \\r\\n    valores_iguais_base vi\\r\\n  WHERE \\r\\n    vi.nu_per_ref >= 202409  -- \\u00daltimos 13 meses\\r\\n  GROUP BY \\r\\n    vi.nu_cnpj\\r\\n  HAVING COUNT(*) >= 3  -- Pelo menos 3 meses seguidos\\r\\n),\\r\\n\\r\\n-- Saldo credor (OPCIONAL - pode n\\u00e3o existir)\\r\\nsaldo_credor_atual AS (\\r\\n  SELECT \\r\\n    c.nu_cnpj_grupo,\\r\\n    c.nu_cnpj,\\r\\n    SUM(q9.item.vlr) AS saldo_credor_acumulado_atual\\r\\n  FROM \\r\\n    dime.dime my_dime\\r\\n  JOIN \\r\\n    my_dime.infdime.quadro_09 AS q9\\r\\n  JOIN \\r\\n    usr_sat_ods.vw_ods_contrib c ON c.nu_ie = CAST(my_dime.infdime.nr_inscricao AS VARCHAR)\\r\\n  WHERE \\r\\n    q9.item.item = 998\\r\\n    AND my_dime.infdime.prd_ref_decl = 202509\\r\\n    AND my_dime.dime_ativa = 1\\r\\n  GROUP BY \\r\\n    c.nu_cnpj_grupo, c.nu_cnpj\\r\\n),\\r\\n\\r\\n-- Evolu\\u00e7\\u00e3o do saldo (se existir)\\r\\nevolucao_saldo AS (\\r\\n  SELECT \\r\\n    c.nu_cnpj_grupo,\\r\\n    MIN(CASE WHEN my_dime.infdime.prd_ref_decl = 202409 THEN q9.item.vlr END) AS saldo_13m_atras,\\r\\n    MAX(CASE WHEN my_dime.infdime.prd_ref_decl = 202509 THEN q9.item.vlr END) AS saldo_atual\\r\\n  FROM \\r\\n    dime.dime my_dime\\r\\n  JOIN \\r\\n    my_dime.infdime.quadro_09 AS q9\\r\\n  JOIN \\r\\n    usr_sat_ods.vw_ods_contrib c ON c.nu_ie = CAST(my_dime.infdime.nr_inscricao AS VARCHAR)\\r\\n  WHERE \\r\\n    q9.item.item = 998\\r\\n    AND my_dime.infdime.prd_ref_decl IN (202409, 202509)\\r\\n    AND my_dime.dime_ativa = 1\\r\\n  GROUP BY \\r\\n    c.nu_cnpj_grupo\\r\\n),\\r\\n\\r\\ncrescimento_saldo AS (\\r\\n  SELECT\\r\\n    nu_cnpj_grupo,\\r\\n    saldo_13m_atras,\\r\\n    saldo_atual,\\r\\n    COALESCE(saldo_atual, 0) - COALESCE(saldo_13m_atras, 0) AS crescimento_absoluto,\\r\\n    CASE \\r\\n      WHEN saldo_13m_atras > 0 THEN\\r\\n        ROUND(100.0 * (COALESCE(saldo_atual, 0) - saldo_13m_atras) / NULLIF(saldo_13m_atras, 0), 2)\\r\\n      ELSE 0\\r\\n    END AS crescimento_percentual\\r\\n  FROM \\r\\n    evolucao_saldo\\r\\n),\\r\\n\\r\\n-- Cr\\u00e9ditos presumidos\\r\\ncreditos_presumidos AS (\\r\\n  SELECT \\r\\n    dcip.nu_cnpj_grupo,\\r\\n    SUM(dcip.vl_credito) AS vl_cp_total_13m,\\r\\n    COUNT(DISTINCT dcip.cd_tipo_credito) AS qtde_tipos_cp\\r\\n  FROM \\r\\n    usr_sat_ods.vw_ods_dcip dcip\\r\\n  WHERE \\r\\n    dcip.cd_estado_decl = 1\\r\\n    AND dcip.sn_utilizada_dime = 1\\r\\n    AND dcip.cd_grupo_dcip = 3\\r\\n    AND dcip.nu_per_ref BETWEEN 202409 AND 202509\\r\\n  GROUP BY \\r\\n    dcip.nu_cnpj_grupo\\r\\n),\\r\\n\\r\\n-- Estat\\u00edsticas de cr\\u00e9ditos por empresa (\\u00faltimos 13 meses)\\r\\nestatisticas_creditos AS (\\r\\n  SELECT\\r\\n    nu_cnpj,\\r\\n    COUNT(DISTINCT nu_per_ref) AS qtde_meses_declarados,\\r\\n    AVG(vl_cred_mes_anterior) AS media_credito,\\r\\n    MIN(vl_cred_mes_anterior) AS min_credito,\\r\\n    MAX(vl_cred_mes_anterior) AS max_credito,\\r\\n    STDDEV(vl_cred_mes_anterior) AS desvio_padrao_credito\\r\\n  FROM dados_filtrados\\r\\n  WHERE nu_per_ref BETWEEN 202409 AND 202509\\r\\n  GROUP BY nu_cnpj\\r\\n)\\r\\n\\r\\nSELECT \\r\\n  df.nu_cnpj,\\r\\n  c.nm_razao_social,\\r\\n  c.nm_fantasia,\\r\\n  c.nm_sit_cadastral,\\r\\n  c.nm_gerfe,\\r\\n  c.de_cnae,\\r\\n  c.nu_cnpj_grupo,\\r\\n  \\r\\n  -- Padr\\u00f5es suspeitos\\r\\n  COALESCE(ci.contagem_periodos_iguais, 0) AS valor_igual_total_periodos,\\r\\n  COALESCE(seq.qtde_ultimos_meses_iguais, 0) AS qtde_ultimos_meses_iguais,\\r\\n  CAST(COALESCE(ci.primeiro_periodo_igual, 0) AS STRING) AS primeiro_periodo_valor_igual,\\r\\n  CAST(COALESCE(ci.ultimo_periodo_igual, 0) AS STRING) AS ultimo_periodo_valor_igual,\\r\\n  CAST(COALESCE(seq.periodo_inicial_seq, 0) AS STRING) AS periodo_inicial_sequencia_recente,\\r\\n  CAST(COALESCE(seq.periodo_final_seq, 0) AS STRING) AS periodo_final_sequencia_recente,\\r\\n  ROUND(COALESCE(seq.valor_sequencia, 0), 2) AS valor_sequencia_recente,\\r\\n  \\r\\n  -- Estat\\u00edsticas gerais\\r\\n  COALESCE(est.qtde_meses_declarados, 0) AS qtde_meses_declarados_13m,\\r\\n  ROUND(COALESCE(est.media_credito, 0), 2) AS media_credito_13m,\\r\\n  ROUND(COALESCE(est.min_credito, 0), 2) AS min_credito_13m,\\r\\n  ROUND(COALESCE(est.max_credito, 0), 2) AS max_credito_13m,\\r\\n  ROUND(COALESCE(est.desvio_padrao_credito, 0), 2) AS desvio_padrao_credito,\\r\\n  \\r\\n  -- Saldo credor (pode ser NULL)\\r\\n  COALESCE(saldo.saldo_credor_acumulado_atual, 0) AS saldo_credor_atual,\\r\\n  COALESCE(cresc.saldo_13m_atras, 0) AS saldo_13m_atras,\\r\\n  COALESCE(cresc.crescimento_absoluto, 0) AS crescimento_saldo_absoluto,\\r\\n  COALESCE(cresc.crescimento_percentual, 0) AS crescimento_saldo_percentual,\\r\\n  \\r\\n  -- Cr\\u00e9ditos presumidos\\r\\n  COALESCE(cp.vl_cp_total_13m, 0) AS vl_credito_presumido_13m,\\r\\n  COALESCE(cp.qtde_tipos_cp, 0) AS qtde_tipos_cp,\\r\\n  \\r\\n  -- SCORE DE RISCO (0-100)\\r\\n  (\\r\\n    -- Peso 1: Padr\\u00e3o repetitivo (0-40 pontos)\\r\\n    CASE \\r\\n      WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40\\r\\n      WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30\\r\\n      WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15\\r\\n      ELSE 0\\r\\n    END\\r\\n    +\\r\\n    -- Peso 2: Crescimento de saldo (0-30 pontos)\\r\\n    CASE\\r\\n      WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30\\r\\n      WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20\\r\\n      WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10\\r\\n      ELSE 0\\r\\n    END\\r\\n    +\\r\\n    -- Peso 3: Magnitude do saldo (0-20 pontos)\\r\\n    CASE\\r\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20\\r\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15\\r\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10\\r\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5\\r\\n      ELSE 0\\r\\n    END\\r\\n    +\\r\\n    -- Peso 4: Baixa variabilidade (desvio padr\\u00e3o pr\\u00f3ximo de zero = suspeito) (0-10 pontos)\\r\\n    CASE\\r\\n      WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10\\r\\n      WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5\\r\\n      ELSE 0\\r\\n    END\\r\\n  ) AS score_risco,\\r\\n  \\r\\n  -- CLASSIFICA\\u00c7\\u00c3O\\r\\n  CASE\\r\\n    WHEN (\\r\\n      CASE WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30 WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20 WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10 WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5 ELSE 0 END\\r\\n    ) >= 70 THEN 'CR\\u00cdTICO'\\r\\n    WHEN (\\r\\n      CASE WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30 WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20 WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10 WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5 ELSE 0 END\\r\\n    ) >= 50 THEN 'ALTO'\\r\\n    WHEN (\\r\\n      CASE WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30 WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20 WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10 WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5 ELSE 0 END\\r\\n    ) >= 30 THEN 'M\\u00c9DIO'\\r\\n    ELSE 'BAIXO'\\r\\n  END AS classificacao_risco\\r\\n  \\r\\nFROM \\r\\n  (SELECT DISTINCT nu_cnpj FROM dados_filtrados) df\\r\\nLEFT JOIN \\r\\n  usr_sat_ods.vw_ods_contrib c ON df.nu_cnpj = c.nu_cnpj\\r\\nLEFT JOIN \\r\\n  contagem_iguais ci ON df.nu_cnpj = ci.nu_cnpj\\r\\nLEFT JOIN \\r\\n  sequencia_ultimos_meses seq ON df.nu_cnpj = seq.nu_cnpj\\r\\nLEFT JOIN \\r\\n  estatisticas_creditos est ON df.nu_cnpj = est.nu_cnpj\\r\\nLEFT JOIN \\r\\n  saldo_credor_atual saldo ON df.nu_cnpj = saldo.nu_cnpj\\r\\nLEFT JOIN \\r\\n  crescimento_saldo cresc ON c.nu_cnpj_grupo = cresc.nu_cnpj_grupo\\r\\nLEFT JOIN \\r\\n  creditos_presumidos cp ON c.nu_cnpj_grupo = cp.nu_cnpj_grupo\\r\\nORDER BY \\r\\n  score_risco DESC, \\r\\n  qtde_ultimos_meses_iguais DESC,\\r\\n  valor_igual_total_periodos DESC;\", \"lastExecutedSelectionRange\": {\"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 281, \"column\": 34}}, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"aceAutoExpand\": false, \"lastCheckStatusRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"query_status\\\": {\\\"status\\\": \\\"available\\\"}}\", \"responseJSON\": {\"status\": 0, \"query_status\": {\"status\": \"available\"}}, \"status\": 200, \"statusText\": \"OK\"}, \"lastGetLogsRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"logs\\\": \\\"Query b04e4319091b856c:dce6a45b00000000 100% Complete (185 out of 185)\\\\nIgnoring ORDER BY clause without LIMIT or OFFSET: ORDER BY dcip.id_seq_ult_alt DESC.\\\\nAn ORDER BY appearing in a view, subquery, union operand, or an insert/ctas statement has no effect on the query result unless a LIMIT and/or OFFSET is used in conjunction with the ORDER BY.\\\\nIgnoring ORDER BY clause without LIMIT or OFFSET: ORDER BY score_risco DESC, qtde_ultimos_meses_iguais DESC, valor_igual_total_periodos DESC.\\\\nAn ORDER BY appearing in a view, subquery, union operand, or an insert/ctas statement has no effect on the query result unless a LIMIT and/or OFFSET is used in conjunction with the ORDER BY.\\\", \\\"progress\\\": 100, \\\"jobs\\\": [{\\\"name\\\": \\\"b04e4319091b856c:dce6a45b00000000\\\", \\\"url\\\": \\\"/hue/jobbrowser#!id=b04e4319091b856c:dce6a45b00000000\\\", \\\"started\\\": true, \\\"finished\\\": false, \\\"percentJob\\\": 100}], \\\"isFullLogs\\\": false}\", \"responseJSON\": {\"status\": 0, \"logs\": \"Query b04e4319091b856c:dce6a45b00000000 100% Complete (185 out of 185)\\nIgnoring ORDER BY clause without LIMIT or OFFSET: ORDER BY dcip.id_seq_ult_alt DESC.\\nAn ORDER BY appearing in a view, subquery, union operand, or an insert/ctas statement has no effect on the query result unless a LIMIT and/or OFFSET is used in conjunction with the ORDER BY.\\nIgnoring ORDER BY clause without LIMIT or OFFSET: ORDER BY score_risco DESC, qtde_ultimos_meses_iguais DESC, valor_igual_total_periodos DESC.\\nAn ORDER BY appearing in a view, subquery, union operand, or an insert/ctas statement has no effect on the query result unless a LIMIT and/or OFFSET is used in conjunction with the ORDER BY.\", \"progress\": 100, \"jobs\": [{\"name\": \"b04e4319091b856c:dce6a45b00000000\", \"url\": \"/hue/jobbrowser#!id=b04e4319091b856c:dce6a45b00000000\", \"started\": true, \"finished\": false, \"percentJob\": 100}], \"isFullLogs\": false}, \"status\": 200, \"statusText\": \"OK\"}}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 12419, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 119, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": true, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "DROP TABLE IF EXISTS teste.credito_dime_completo;\r\n\r\nCREATE TABLE IF NOT EXISTS teste.credito_dime_completo AS\r\n\r\nWITH periodos AS (\r\n  SELECT periodo AS nu_per_ref\r\n  FROM (\r\n    SELECT 202101 AS periodo UNION ALL SELECT 202102 UNION ALL SELECT 202103 UNION ALL SELECT 202104 UNION ALL\r\n    SELECT 202105 UNION ALL SELECT 202106 UNION ALL SELECT 202107 UNION ALL SELECT 202108 UNION ALL\r\n    SELECT 202109 UNION ALL SELECT 202110 UNION ALL SELECT 202111 UNION ALL SELECT 202112 UNION ALL\r\n    SELECT 202201 UNION ALL SELECT 202202 UNION ALL SELECT 202203 UNION ALL SELECT 202204 UNION ALL\r\n    SELECT 202205 UNION ALL SELECT 202206 UNION ALL SELECT 202207 UNION ALL SELECT 202208 UNION ALL\r\n    SELECT 202209 UNION ALL SELECT 202210 UNION ALL SELECT 202211 UNION ALL SELECT 202212 UNION ALL\r\n    SELECT 202301 UNION ALL SELECT 202302 UNION ALL SELECT 202303 UNION ALL SELECT 202304 UNION ALL\r\n    SELECT 202305 UNION ALL SELECT 202306 UNION ALL SELECT 202307 UNION ALL SELECT 202308 UNION ALL\r\n    SELECT 202309 UNION ALL SELECT 202310 UNION ALL SELECT 202311 UNION ALL SELECT 202312 UNION ALL\r\n    SELECT 202401 UNION ALL SELECT 202402 UNION ALL SELECT 202403 UNION ALL SELECT 202404 UNION ALL\r\n    SELECT 202405 UNION ALL SELECT 202406 UNION ALL SELECT 202407 UNION ALL SELECT 202408 UNION ALL\r\n    SELECT 202409 UNION ALL SELECT 202410 UNION ALL SELECT 202411 UNION ALL SELECT 202412 UNION ALL\r\n    SELECT 202501 UNION ALL SELECT 202502 UNION ALL SELECT 202503 UNION ALL SELECT 202504 UNION ALL\r\n    SELECT 202505 UNION ALL SELECT 202506 UNION ALL SELECT 202507 UNION ALL SELECT 202508 UNION ALL\r\n    SELECT 202509\r\n  ) p\r\n),\r\n\r\n-- Base: empresas com créditos na DIME\r\ndados_filtrados AS (\r\n  SELECT \r\n    d.nu_cnpj,\r\n    d.nu_per_ref,\r\n    d.vl_cred_mes_anterior,\r\n    d.vl_cred_mes_seguinte\r\n  FROM \r\n    usr_sat_ods.ods_decl_dime_raw d\r\n  WHERE \r\n    d.nu_per_ref IN (SELECT nu_per_ref FROM periodos)\r\n    AND d.vl_cred_mes_anterior > 0\r\n    AND d.vl_cred_mes_seguinte > 0\r\n),\r\n\r\n-- Padrão: va",
    "last_modified": "2025-10-10T23:49:09.092",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "98247874-ca8f-489a-b757-bbfeafccd369",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 162757,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "DIME CRED EFD: 1 Tabela Principal Completo",
    "description": "",
    "uuid": "a12b5193-f478-d587-8456-34830fc95bd5",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 162757, \"uuid\": \"62fed2ca-26cc-4c8c-b447-1ce356329049\", \"name\": \"DIME CRED EFD: 1 Tabela Principal Completo\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": \"a12b5193-f478-d587-8456-34830fc95bd5\", \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"306eeebd-86f2-3195-125c-ad10a4be3f61\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": {\"row\": 6, \"column\": 57}, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": true, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"default\", \"currentQueryTab\": \"queryResults\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 1, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"-- -----------------------------------------------------------------------------\\r\\n-- 1. TABELA PRINCIPAL - AN\\u00c1LISE GERAL (TODOS OS SETORES)\\r\\n-- -----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS teste.credito_dime_completo;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE IF NOT EXISTS teste.credito_dime_completo AS\\r\\n\\r\\nWITH periodos AS (\\r\\n  SELECT periodo AS nu_per_ref\\r\\n  FROM (\\r\\n    SELECT 202101 AS periodo UNION ALL SELECT 202102 UNION ALL SELECT 202103 UNION ALL SELECT 202104 UNION ALL\\r\\n    SELECT 202105 UNION ALL SELECT 202106 UNION ALL SELECT 202107 UNION ALL SELECT 202108 UNION ALL\\r\\n    SELECT 202109 UNION ALL SELECT 202110 UNION ALL SELECT 202111 UNION ALL SELECT 202112 UNION ALL\\r\\n    SELECT 202201 UNION ALL SELECT 202202 UNION ALL SELECT 202203 UNION ALL SELECT 202204 UNION ALL\\r\\n    SELECT 202205 UNION ALL SELECT 202206 UNION ALL SELECT 202207 UNION ALL SELECT 202208 UNION ALL\\r\\n    SELECT 202209 UNION ALL SELECT 202210 UNION ALL SELECT 202211 UNION ALL SELECT 202212 UNION ALL\\r\\n    SELECT 202301 UNION ALL SELECT 202302 UNION ALL SELECT 202303 UNION ALL SELECT 202304 UNION ALL\\r\\n    SELECT 202305 UNION ALL SELECT 202306 UNION ALL SELECT 202307 UNION ALL SELECT 202308 UNION ALL\\r\\n    SELECT 202309 UNION ALL SELECT 202310 UNION ALL SELECT 202311 UNION ALL SELECT 202312 UNION ALL\\r\\n    SELECT 202401 UNION ALL SELECT 202402 UNION ALL SELECT 202403 UNION ALL SELECT 202404 UNION ALL\\r\\n    SELECT 202405 UNION ALL SELECT 202406 UNION ALL SELECT 202407 UNION ALL SELECT 202408 UNION ALL\\r\\n    SELECT 202409 UNION ALL SELECT 202410 UNION ALL SELECT 202411 UNION ALL SELECT 202412 UNION ALL\\r\\n    SELECT 202501 UNION ALL SELECT 202502 UNION ALL SELECT 202503 UNION ALL SELECT 202504 UNION ALL\\r\\n    SELECT 202505 UNION ALL SELECT 202506 UNION ALL SELECT 202507 UNION ALL SELECT 202508 UNION ALL\\r\\n    SELECT 202509\\r\\n  ) p\\r\\n),\\r\\n\\r\\ndados_filtrados AS (\\r\\n  SELECT \\r\\n    d.nu_cnpj,\\r\\n    d.nu_per_ref,\\r\\n    d.vl_cred_mes_anterior,\\r\\n    d.vl_cred_mes_seguinte\\r\\n  FROM \\r\\n    usr_sat_ods.ods_decl_dime_raw d\\r\\n  WHERE \\r\\n    d.nu_per_ref IN (SELECT nu_per_ref FROM periodos)\\r\\n    AND d.vl_cred_mes_anterior > 0\\r\\n    AND d.vl_cred_mes_seguinte > 0\\r\\n),\\r\\n\\r\\nvalores_iguais_base AS (\\r\\n  SELECT\\r\\n    nu_cnpj,\\r\\n    nu_per_ref,\\r\\n    vl_cred_mes_anterior AS valor\\r\\n  FROM \\r\\n    dados_filtrados\\r\\n  WHERE \\r\\n    vl_cred_mes_anterior = vl_cred_mes_seguinte\\r\\n),\\r\\n\\r\\ncontagem_iguais AS (\\r\\n  SELECT\\r\\n    nu_cnpj,\\r\\n    COUNT(*) AS contagem_periodos_iguais,\\r\\n    AVG(valor) AS valor_medio_repetido,\\r\\n    MIN(nu_per_ref) AS primeiro_periodo_igual,\\r\\n    MAX(nu_per_ref) AS ultimo_periodo_igual\\r\\n  FROM \\r\\n    valores_iguais_base\\r\\n  GROUP BY \\r\\n    nu_cnpj\\r\\n),\\r\\n\\r\\nsequencia_ultimos_meses AS (\\r\\n  SELECT\\r\\n    vi.nu_cnpj,\\r\\n    COUNT(*) AS qtde_ultimos_meses_iguais,\\r\\n    MIN(vi.nu_per_ref) AS periodo_inicial_seq,\\r\\n    MAX(vi.nu_per_ref) AS periodo_final_seq,\\r\\n    AVG(vi.valor) AS valor_sequencia\\r\\n  FROM \\r\\n    valores_iguais_base vi\\r\\n  WHERE \\r\\n    vi.nu_per_ref >= 202409\\r\\n  GROUP BY \\r\\n    vi.nu_cnpj\\r\\n  HAVING COUNT(*) >= 3\\r\\n),\\r\\n\\r\\n-- SIMPLIFICADO: Usar apenas a tabela raw da DIME para saldo\\r\\nsaldo_credor_atual AS (\\r\\n  SELECT \\r\\n    c.nu_cnpj_grupo,\\r\\n    c.nu_cnpj,\\r\\n    MAX(d.vl_cred_mes_seguinte) AS saldo_credor_acumulado_atual\\r\\n  FROM \\r\\n    usr_sat_ods.ods_decl_dime_raw d\\r\\n  JOIN \\r\\n    usr_sat_ods.vw_ods_contrib c ON d.nu_cnpj = c.nu_cnpj\\r\\n  WHERE \\r\\n    d.nu_per_ref = 202509\\r\\n  GROUP BY \\r\\n    c.nu_cnpj_grupo, c.nu_cnpj\\r\\n),\\r\\n\\r\\nevolucao_saldo AS (\\r\\n  SELECT \\r\\n    c.nu_cnpj_grupo,\\r\\n    MAX(CASE WHEN d.nu_per_ref = 202409 THEN d.vl_cred_mes_seguinte ELSE NULL END) AS saldo_13m_atras,\\r\\n    MAX(CASE WHEN d.nu_per_ref = 202509 THEN d.vl_cred_mes_seguinte ELSE NULL END) AS saldo_atual\\r\\n  FROM \\r\\n    usr_sat_ods.ods_decl_dime_raw d\\r\\n  JOIN \\r\\n    usr_sat_ods.vw_ods_contrib c ON d.nu_cnpj = c.nu_cnpj\\r\\n  WHERE \\r\\n    d.nu_per_ref IN (202409, 202509)\\r\\n  GROUP BY \\r\\n    c.nu_cnpj_grupo\\r\\n),\\r\\n\\r\\ncrescimento_saldo AS (\\r\\n  SELECT\\r\\n    nu_cnpj_grupo,\\r\\n    saldo_13m_atras,\\r\\n    saldo_atual,\\r\\n    COALESCE(saldo_atual, 0) - COALESCE(saldo_13m_atras, 0) AS crescimento_absoluto,\\r\\n    CASE \\r\\n      WHEN saldo_13m_atras > 0 THEN\\r\\n        ROUND(100.0 * (COALESCE(saldo_atual, 0) - saldo_13m_atras) / NULLIF(saldo_13m_atras, 0), 2)\\r\\n      ELSE 0\\r\\n    END AS crescimento_percentual\\r\\n  FROM \\r\\n    evolucao_saldo\\r\\n),\\r\\n\\r\\ncreditos_presumidos AS (\\r\\n  SELECT \\r\\n    dcip.nu_cnpj_grupo,\\r\\n    SUM(dcip.vl_credito) AS vl_cp_total_13m,\\r\\n    COUNT(dcip.cd_tipo_credito) AS qtde_tipos_cp\\r\\n  FROM \\r\\n    usr_sat_ods.vw_ods_dcip dcip\\r\\n  WHERE \\r\\n    dcip.cd_estado_decl = 1\\r\\n    AND dcip.sn_utilizada_dime = 1\\r\\n    AND dcip.cd_grupo_dcip = 3\\r\\n    AND dcip.nu_per_ref BETWEEN 202409 AND 202509\\r\\n  GROUP BY \\r\\n    dcip.nu_cnpj_grupo\\r\\n),\\r\\n\\r\\nestatisticas_creditos AS (\\r\\n  SELECT\\r\\n    nu_cnpj,\\r\\n    COUNT(nu_per_ref) AS qtde_meses_declarados,\\r\\n    AVG(vl_cred_mes_anterior) AS media_credito,\\r\\n    MIN(vl_cred_mes_anterior) AS min_credito,\\r\\n    MAX(vl_cred_mes_anterior) AS max_credito,\\r\\n    STDDEV(vl_cred_mes_anterior) AS desvio_padrao_credito\\r\\n  FROM dados_filtrados\\r\\n  WHERE nu_per_ref BETWEEN 202409 AND 202509\\r\\n  GROUP BY nu_cnpj\\r\\n),\\r\\n\\r\\ncnpjs_unicos AS (\\r\\n  SELECT nu_cnpj \\r\\n  FROM dados_filtrados \\r\\n  GROUP BY nu_cnpj\\r\\n)\\r\\n\\r\\nSELECT \\r\\n  df.nu_cnpj,\\r\\n  c.nm_razao_social,\\r\\n  c.nm_fantasia,\\r\\n  c.nm_sit_cadastral,\\r\\n  c.nm_gerfe,\\r\\n  c.de_cnae,\\r\\n  c.nu_cnpj_grupo,\\r\\n  \\r\\n  COALESCE(ci.contagem_periodos_iguais, 0) AS valor_igual_total_periodos,\\r\\n  COALESCE(seq.qtde_ultimos_meses_iguais, 0) AS qtde_ultimos_meses_iguais,\\r\\n  CAST(COALESCE(ci.primeiro_periodo_igual, 0) AS STRING) AS primeiro_periodo_valor_igual,\\r\\n  CAST(COALESCE(ci.ultimo_periodo_igual, 0) AS STRING) AS ultimo_periodo_valor_igual,\\r\\n  CAST(COALESCE(seq.periodo_inicial_seq, 0) AS STRING) AS periodo_inicial_sequencia_recente,\\r\\n  CAST(COALESCE(seq.periodo_final_seq, 0) AS STRING) AS periodo_final_sequencia_recente,\\r\\n  ROUND(COALESCE(seq.valor_sequencia, 0), 2) AS valor_sequencia_recente,\\r\\n  \\r\\n  COALESCE(est.qtde_meses_declarados, 0) AS qtde_meses_declarados_13m,\\r\\n  ROUND(COALESCE(est.media_credito, 0), 2) AS media_credito_13m,\\r\\n  ROUND(COALESCE(est.min_credito, 0), 2) AS min_credito_13m,\\r\\n  ROUND(COALESCE(est.max_credito, 0), 2) AS max_credito_13m,\\r\\n  ROUND(COALESCE(est.desvio_padrao_credito, 0), 2) AS desvio_padrao_credito,\\r\\n  \\r\\n  COALESCE(saldo.saldo_credor_acumulado_atual, 0) AS saldo_credor_atual,\\r\\n  COALESCE(cresc.saldo_13m_atras, 0) AS saldo_13m_atras,\\r\\n  COALESCE(cresc.crescimento_absoluto, 0) AS crescimento_saldo_absoluto,\\r\\n  COALESCE(cresc.crescimento_percentual, 0) AS crescimento_saldo_percentual,\\r\\n  \\r\\n  COALESCE(cp.vl_cp_total_13m, 0) AS vl_credito_presumido_13m,\\r\\n  COALESCE(cp.qtde_tipos_cp, 0) AS qtde_tipos_cp,\\r\\n  \\r\\n  (\\r\\n    CASE \\r\\n      WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40\\r\\n      WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30\\r\\n      WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15\\r\\n      ELSE 0\\r\\n    END\\r\\n    +\\r\\n    CASE\\r\\n      WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30\\r\\n      WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20\\r\\n      WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10\\r\\n      ELSE 0\\r\\n    END\\r\\n    +\\r\\n    CASE\\r\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20\\r\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15\\r\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10\\r\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5\\r\\n      ELSE 0\\r\\n    END\\r\\n    +\\r\\n    CASE\\r\\n      WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10\\r\\n      WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5\\r\\n      ELSE 0\\r\\n    END\\r\\n  ) AS score_risco,\\r\\n  \\r\\n  CASE\\r\\n    WHEN (\\r\\n      CASE WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30 WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20 WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10 WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5 ELSE 0 END\\r\\n    ) >= 70 THEN 'CR\\u00cdTICO'\\r\\n    WHEN (\\r\\n      CASE WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30 WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20 WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10 WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5 ELSE 0 END\\r\\n    ) >= 50 THEN 'ALTO'\\r\\n    WHEN (\\r\\n      CASE WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30 WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20 WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10 WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5 ELSE 0 END\\r\\n    ) >= 30 THEN 'M\\u00c9DIO'\\r\\n    ELSE 'BAIXO'\\r\\n  END AS classificacao_risco\\r\\n  \\r\\nFROM \\r\\n  cnpjs_unicos df\\r\\nLEFT JOIN \\r\\n  usr_sat_ods.vw_ods_contrib c ON df.nu_cnpj = c.nu_cnpj\\r\\nLEFT JOIN \\r\\n  contagem_iguais ci ON df.nu_cnpj = ci.nu_cnpj\\r\\nLEFT JOIN \\r\\n  sequencia_ultimos_meses seq ON df.nu_cnpj = seq.nu_cnpj\\r\\nLEFT JOIN \\r\\n  estatisticas_creditos est ON df.nu_cnpj = est.nu_cnpj\\r\\nLEFT JOIN \\r\\n  saldo_credor_atual saldo ON df.nu_cnpj = saldo.nu_cnpj\\r\\nLEFT JOIN \\r\\n  crescimento_saldo cresc ON c.nu_cnpj_grupo = cresc.nu_cnpj_grupo\\r\\nLEFT JOIN \\r\\n  creditos_presumidos cp ON c.nu_cnpj_grupo = cp.nu_cnpj_grupo\\r\\nORDER BY \\r\\n  score_risco DESC, \\r\\n  qtde_ultimos_meses_iguais DESC,\\r\\n  valor_igual_total_periodos DESC;\\r\\n\", \"statementsList\": [\"-- -----------------------------------------------------------------------------\\r\\n-- 1. TABELA PRINCIPAL - AN\\u00c1LISE GERAL (TODOS OS SETORES)\\r\\n-- -----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS teste.credito_dime_completo;\", \"\\r\\nSET REQUEST_POOL = 'medium';\", \"\\r\\n\\r\\nCREATE TABLE IF NOT EXISTS teste.credito_dime_completo AS\\r\\n\\r\\nWITH periodos AS (\\r\\n  SELECT periodo AS nu_per_ref\\r\\n  FROM (\\r\\n    SELECT 202101 AS periodo UNION ALL SELECT 202102 UNION ALL SELECT 202103 UNION ALL SELECT 202104 UNION ALL\\r\\n    SELECT 202105 UNION ALL SELECT 202106 UNION ALL SELECT 202107 UNION ALL SELECT 202108 UNION ALL\\r\\n    SELECT 202109 UNION ALL SELECT 202110 UNION ALL SELECT 202111 UNION ALL SELECT 202112 UNION ALL\\r\\n    SELECT 202201 UNION ALL SELECT 202202 UNION ALL SELECT 202203 UNION ALL SELECT 202204 UNION ALL\\r\\n    SELECT 202205 UNION ALL SELECT 202206 UNION ALL SELECT 202207 UNION ALL SELECT 202208 UNION ALL\\r\\n    SELECT 202209 UNION ALL SELECT 202210 UNION ALL SELECT 202211 UNION ALL SELECT 202212 UNION ALL\\r\\n    SELECT 202301 UNION ALL SELECT 202302 UNION ALL SELECT 202303 UNION ALL SELECT 202304 UNION ALL\\r\\n    SELECT 202305 UNION ALL SELECT 202306 UNION ALL SELECT 202307 UNION ALL SELECT 202308 UNION ALL\\r\\n    SELECT 202309 UNION ALL SELECT 202310 UNION ALL SELECT 202311 UNION ALL SELECT 202312 UNION ALL\\r\\n    SELECT 202401 UNION ALL SELECT 202402 UNION ALL SELECT 202403 UNION ALL SELECT 202404 UNION ALL\\r\\n    SELECT 202405 UNION ALL SELECT 202406 UNION ALL SELECT 202407 UNION ALL SELECT 202408 UNION ALL\\r\\n    SELECT 202409 UNION ALL SELECT 202410 UNION ALL SELECT 202411 UNION ALL SELECT 202412 UNION ALL\\r\\n    SELECT 202501 UNION ALL SELECT 202502 UNION ALL SELECT 202503 UNION ALL SELECT 202504 UNION ALL\\r\\n    SELECT 202505 UNION ALL SELECT 202506 UNION ALL SELECT 202507 UNION ALL SELECT 202508 UNION ALL\\r\\n    SELECT 202509\\r\\n  ) p\\r\\n),\\r\\n\\r\\ndados_filtrados AS (\\r\\n  SELECT \\r\\n    d.nu_cnpj,\\r\\n    d.nu_per_ref,\\r\\n    d.vl_cred_mes_anterior,\\r\\n    d.vl_cred_mes_seguinte\\r\\n  FROM \\r\\n    usr_sat_ods.ods_decl_dime_raw d\\r\\n  WHERE \\r\\n    d.nu_per_ref IN (SELECT nu_per_ref FROM periodos)\\r\\n    AND d.vl_cred_mes_anterior > 0\\r\\n    AND d.vl_cred_mes_seguinte > 0\\r\\n),\\r\\n\\r\\nvalores_iguais_base AS (\\r\\n  SELECT\\r\\n    nu_cnpj,\\r\\n    nu_per_ref,\\r\\n    vl_cred_mes_anterior AS valor\\r\\n  FROM \\r\\n    dados_filtrados\\r\\n  WHERE \\r\\n    vl_cred_mes_anterior = vl_cred_mes_seguinte\\r\\n),\\r\\n\\r\\ncontagem_iguais AS (\\r\\n  SELECT\\r\\n    nu_cnpj,\\r\\n    COUNT(*) AS contagem_periodos_iguais,\\r\\n    AVG(valor) AS valor_medio_repetido,\\r\\n    MIN(nu_per_ref) AS primeiro_periodo_igual,\\r\\n    MAX(nu_per_ref) AS ultimo_periodo_igual\\r\\n  FROM \\r\\n    valores_iguais_base\\r\\n  GROUP BY \\r\\n    nu_cnpj\\r\\n),\\r\\n\\r\\nsequencia_ultimos_meses AS (\\r\\n  SELECT\\r\\n    vi.nu_cnpj,\\r\\n    COUNT(*) AS qtde_ultimos_meses_iguais,\\r\\n    MIN(vi.nu_per_ref) AS periodo_inicial_seq,\\r\\n    MAX(vi.nu_per_ref) AS periodo_final_seq,\\r\\n    AVG(vi.valor) AS valor_sequencia\\r\\n  FROM \\r\\n    valores_iguais_base vi\\r\\n  WHERE \\r\\n    vi.nu_per_ref >= 202409\\r\\n  GROUP BY \\r\\n    vi.nu_cnpj\\r\\n  HAVING COUNT(*) >= 3\\r\\n),\\r\\n\\r\\n-- SIMPLIFICADO: Usar apenas a tabela raw da DIME para saldo\\r\\nsaldo_credor_atual AS (\\r\\n  SELECT \\r\\n    c.nu_cnpj_grupo,\\r\\n    c.nu_cnpj,\\r\\n    MAX(d.vl_cred_mes_seguinte) AS saldo_credor_acumulado_atual\\r\\n  FROM \\r\\n    usr_sat_ods.ods_decl_dime_raw d\\r\\n  JOIN \\r\\n    usr_sat_ods.vw_ods_contrib c ON d.nu_cnpj = c.nu_cnpj\\r\\n  WHERE \\r\\n    d.nu_per_ref = 202509\\r\\n  GROUP BY \\r\\n    c.nu_cnpj_grupo, c.nu_cnpj\\r\\n),\\r\\n\\r\\nevolucao_saldo AS (\\r\\n  SELECT \\r\\n    c.nu_cnpj_grupo,\\r\\n    MAX(CASE WHEN d.nu_per_ref = 202409 THEN d.vl_cred_mes_seguinte ELSE NULL END) AS saldo_13m_atras,\\r\\n    MAX(CASE WHEN d.nu_per_ref = 202509 THEN d.vl_cred_mes_seguinte ELSE NULL END) AS saldo_atual\\r\\n  FROM \\r\\n    usr_sat_ods.ods_decl_dime_raw d\\r\\n  JOIN \\r\\n    usr_sat_ods.vw_ods_contrib c ON d.nu_cnpj = c.nu_cnpj\\r\\n  WHERE \\r\\n    d.nu_per_ref IN (202409, 202509)\\r\\n  GROUP BY \\r\\n    c.nu_cnpj_grupo\\r\\n),\\r\\n\\r\\ncrescimento_saldo AS (\\r\\n  SELECT\\r\\n    nu_cnpj_grupo,\\r\\n    saldo_13m_atras,\\r\\n    saldo_atual,\\r\\n    COALESCE(saldo_atual, 0) - COALESCE(saldo_13m_atras, 0) AS crescimento_absoluto,\\r\\n    CASE \\r\\n      WHEN saldo_13m_atras > 0 THEN\\r\\n        ROUND(100.0 * (COALESCE(saldo_atual, 0) - saldo_13m_atras) / NULLIF(saldo_13m_atras, 0), 2)\\r\\n      ELSE 0\\r\\n    END AS crescimento_percentual\\r\\n  FROM \\r\\n    evolucao_saldo\\r\\n),\\r\\n\\r\\ncreditos_presumidos AS (\\r\\n  SELECT \\r\\n    dcip.nu_cnpj_grupo,\\r\\n    SUM(dcip.vl_credito) AS vl_cp_total_13m,\\r\\n    COUNT(dcip.cd_tipo_credito) AS qtde_tipos_cp\\r\\n  FROM \\r\\n    usr_sat_ods.vw_ods_dcip dcip\\r\\n  WHERE \\r\\n    dcip.cd_estado_decl = 1\\r\\n    AND dcip.sn_utilizada_dime = 1\\r\\n    AND dcip.cd_grupo_dcip = 3\\r\\n    AND dcip.nu_per_ref BETWEEN 202409 AND 202509\\r\\n  GROUP BY \\r\\n    dcip.nu_cnpj_grupo\\r\\n),\\r\\n\\r\\nestatisticas_creditos AS (\\r\\n  SELECT\\r\\n    nu_cnpj,\\r\\n    COUNT(nu_per_ref) AS qtde_meses_declarados,\\r\\n    AVG(vl_cred_mes_anterior) AS media_credito,\\r\\n    MIN(vl_cred_mes_anterior) AS min_credito,\\r\\n    MAX(vl_cred_mes_anterior) AS max_credito,\\r\\n    STDDEV(vl_cred_mes_anterior) AS desvio_padrao_credito\\r\\n  FROM dados_filtrados\\r\\n  WHERE nu_per_ref BETWEEN 202409 AND 202509\\r\\n  GROUP BY nu_cnpj\\r\\n),\\r\\n\\r\\ncnpjs_unicos AS (\\r\\n  SELECT nu_cnpj \\r\\n  FROM dados_filtrados \\r\\n  GROUP BY nu_cnpj\\r\\n)\\r\\n\\r\\nSELECT \\r\\n  df.nu_cnpj,\\r\\n  c.nm_razao_social,\\r\\n  c.nm_fantasia,\\r\\n  c.nm_sit_cadastral,\\r\\n  c.nm_gerfe,\\r\\n  c.de_cnae,\\r\\n  c.nu_cnpj_grupo,\\r\\n  \\r\\n  COALESCE(ci.contagem_periodos_iguais, 0) AS valor_igual_total_periodos,\\r\\n  COALESCE(seq.qtde_ultimos_meses_iguais, 0) AS qtde_ultimos_meses_iguais,\\r\\n  CAST(COALESCE(ci.primeiro_periodo_igual, 0) AS STRING) AS primeiro_periodo_valor_igual,\\r\\n  CAST(COALESCE(ci.ultimo_periodo_igual, 0) AS STRING) AS ultimo_periodo_valor_igual,\\r\\n  CAST(COALESCE(seq.periodo_inicial_seq, 0) AS STRING) AS periodo_inicial_sequencia_recente,\\r\\n  CAST(COALESCE(seq.periodo_final_seq, 0) AS STRING) AS periodo_final_sequencia_recente,\\r\\n  ROUND(COALESCE(seq.valor_sequencia, 0), 2) AS valor_sequencia_recente,\\r\\n  \\r\\n  COALESCE(est.qtde_meses_declarados, 0) AS qtde_meses_declarados_13m,\\r\\n  ROUND(COALESCE(est.media_credito, 0), 2) AS media_credito_13m,\\r\\n  ROUND(COALESCE(est.min_credito, 0), 2) AS min_credito_13m,\\r\\n  ROUND(COALESCE(est.max_credito, 0), 2) AS max_credito_13m,\\r\\n  ROUND(COALESCE(est.desvio_padrao_credito, 0), 2) AS desvio_padrao_credito,\\r\\n  \\r\\n  COALESCE(saldo.saldo_credor_acumulado_atual, 0) AS saldo_credor_atual,\\r\\n  COALESCE(cresc.saldo_13m_atras, 0) AS saldo_13m_atras,\\r\\n  COALESCE(cresc.crescimento_absoluto, 0) AS crescimento_saldo_absoluto,\\r\\n  COALESCE(cresc.crescimento_percentual, 0) AS crescimento_saldo_percentual,\\r\\n  \\r\\n  COALESCE(cp.vl_cp_total_13m, 0) AS vl_credito_presumido_13m,\\r\\n  COALESCE(cp.qtde_tipos_cp, 0) AS qtde_tipos_cp,\\r\\n  \\r\\n  (\\r\\n    CASE \\r\\n      WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40\\r\\n      WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30\\r\\n      WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15\\r\\n      ELSE 0\\r\\n    END\\r\\n    +\\r\\n    CASE\\r\\n      WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30\\r\\n      WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20\\r\\n      WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10\\r\\n      ELSE 0\\r\\n    END\\r\\n    +\\r\\n    CASE\\r\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20\\r\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15\\r\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10\\r\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5\\r\\n      ELSE 0\\r\\n    END\\r\\n    +\\r\\n    CASE\\r\\n      WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10\\r\\n      WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5\\r\\n      ELSE 0\\r\\n    END\\r\\n  ) AS score_risco,\\r\\n  \\r\\n  CASE\\r\\n    WHEN (\\r\\n      CASE WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30 WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20 WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10 WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5 ELSE 0 END\\r\\n    ) >= 70 THEN 'CR\\u00cdTICO'\\r\\n    WHEN (\\r\\n      CASE WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30 WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20 WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10 WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5 ELSE 0 END\\r\\n    ) >= 50 THEN 'ALTO'\\r\\n    WHEN (\\r\\n      CASE WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30 WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20 WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10 WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5 ELSE 0 END\\r\\n    ) >= 30 THEN 'M\\u00c9DIO'\\r\\n    ELSE 'BAIXO'\\r\\n  END AS classificacao_risco\\r\\n  \\r\\nFROM \\r\\n  cnpjs_unicos df\\r\\nLEFT JOIN \\r\\n  usr_sat_ods.vw_ods_contrib c ON df.nu_cnpj = c.nu_cnpj\\r\\nLEFT JOIN \\r\\n  contagem_iguais ci ON df.nu_cnpj = ci.nu_cnpj\\r\\nLEFT JOIN \\r\\n  sequencia_ultimos_meses seq ON df.nu_cnpj = seq.nu_cnpj\\r\\nLEFT JOIN \\r\\n  estatisticas_creditos est ON df.nu_cnpj = est.nu_cnpj\\r\\nLEFT JOIN \\r\\n  saldo_credor_atual saldo ON df.nu_cnpj = saldo.nu_cnpj\\r\\nLEFT JOIN \\r\\n  crescimento_saldo cresc ON c.nu_cnpj_grupo = cresc.nu_cnpj_grupo\\r\\nLEFT JOIN \\r\\n  creditos_presumidos cp ON c.nu_cnpj_grupo = cp.nu_cnpj_grupo\\r\\nORDER BY \\r\\n  score_risco DESC, \\r\\n  qtde_ultimos_meses_iguais DESC,\\r\\n  valor_igual_total_periodos DESC;\"], \"aceSize\": 100, \"status\": \"available\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"\\r\\nSET REQUEST_POOL = 'medium';\", \"result\": {\"id\": \"a4718847-0294-8089-eaf9-86e28ab6db4a\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"AnIV/ChmR2GmjNZx5pr+Bw==\", \"guid\": \"mrUhC4bYSzMAAAAA2JoEtg==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"a14a96e02125e5fe:0e4a6eab4a1a89bd\", \"session_id\": 21447, \"session_type\": \"impala\", \"statement_id\": 2, \"has_more_statements\": false, \"statements_count\": 3, \"previous_statement_hash\": \"3b6c92eafe5bfd136146ecba198f7033ca91f7811ef3c6632106d263\", \"start\": {\"row\": 6, \"column\": 0}, \"end\": {\"row\": 266, \"column\": 33}, \"statement\": \"CREATE TABLE IF NOT EXISTS teste.credito_dime_completo AS\\n\\nWITH periodos AS (\\n  SELECT periodo AS nu_per_ref\\n  FROM (\\n    SELECT 202101 AS periodo UNION ALL SELECT 202102 UNION ALL SELECT 202103 UNION ALL SELECT 202104 UNION ALL\\n    SELECT 202105 UNION ALL SELECT 202106 UNION ALL SELECT 202107 UNION ALL SELECT 202108 UNION ALL\\n    SELECT 202109 UNION ALL SELECT 202110 UNION ALL SELECT 202111 UNION ALL SELECT 202112 UNION ALL\\n    SELECT 202201 UNION ALL SELECT 202202 UNION ALL SELECT 202203 UNION ALL SELECT 202204 UNION ALL\\n    SELECT 202205 UNION ALL SELECT 202206 UNION ALL SELECT 202207 UNION ALL SELECT 202208 UNION ALL\\n    SELECT 202209 UNION ALL SELECT 202210 UNION ALL SELECT 202211 UNION ALL SELECT 202212 UNION ALL\\n    SELECT 202301 UNION ALL SELECT 202302 UNION ALL SELECT 202303 UNION ALL SELECT 202304 UNION ALL\\n    SELECT 202305 UNION ALL SELECT 202306 UNION ALL SELECT 202307 UNION ALL SELECT 202308 UNION ALL\\n    SELECT 202309 UNION ALL SELECT 202310 UNION ALL SELECT 202311 UNION ALL SELECT 202312 UNION ALL\\n    SELECT 202401 UNION ALL SELECT 202402 UNION ALL SELECT 202403 UNION ALL SELECT 202404 UNION ALL\\n    SELECT 202405 UNION ALL SELECT 202406 UNION ALL SELECT 202407 UNION ALL SELECT 202408 UNION ALL\\n    SELECT 202409 UNION ALL SELECT 202410 UNION ALL SELECT 202411 UNION ALL SELECT 202412 UNION ALL\\n    SELECT 202501 UNION ALL SELECT 202502 UNION ALL SELECT 202503 UNION ALL SELECT 202504 UNION ALL\\n    SELECT 202505 UNION ALL SELECT 202506 UNION ALL SELECT 202507 UNION ALL SELECT 202508 UNION ALL\\n    SELECT 202509\\n  ) p\\n),\\n\\ndados_filtrados AS (\\n  SELECT \\n    d.nu_cnpj,\\n    d.nu_per_ref,\\n    d.vl_cred_mes_anterior,\\n    d.vl_cred_mes_seguinte\\n  FROM \\n    usr_sat_ods.ods_decl_dime_raw d\\n  WHERE \\n    d.nu_per_ref IN (SELECT nu_per_ref FROM periodos)\\n    AND d.vl_cred_mes_anterior > 0\\n    AND d.vl_cred_mes_seguinte > 0\\n),\\n\\nvalores_iguais_base AS (\\n  SELECT\\n    nu_cnpj,\\n    nu_per_ref,\\n    vl_cred_mes_anterior AS valor\\n  FROM \\n    dados_filtrados\\n  WHERE \\n    vl_cred_mes_anterior = vl_cred_mes_seguinte\\n),\\n\\ncontagem_iguais AS (\\n  SELECT\\n    nu_cnpj,\\n    COUNT(*) AS contagem_periodos_iguais,\\n    AVG(valor) AS valor_medio_repetido,\\n    MIN(nu_per_ref) AS primeiro_periodo_igual,\\n    MAX(nu_per_ref) AS ultimo_periodo_igual\\n  FROM \\n    valores_iguais_base\\n  GROUP BY \\n    nu_cnpj\\n),\\n\\nsequencia_ultimos_meses AS (\\n  SELECT\\n    vi.nu_cnpj,\\n    COUNT(*) AS qtde_ultimos_meses_iguais,\\n    MIN(vi.nu_per_ref) AS periodo_inicial_seq,\\n    MAX(vi.nu_per_ref) AS periodo_final_seq,\\n    AVG(vi.valor) AS valor_sequencia\\n  FROM \\n    valores_iguais_base vi\\n  WHERE \\n    vi.nu_per_ref >= 202409\\n  GROUP BY \\n    vi.nu_cnpj\\n  HAVING COUNT(*) >= 3\\n),\\n\\n-- SIMPLIFICADO: Usar apenas a tabela raw da DIME para saldo\\nsaldo_credor_atual AS (\\n  SELECT \\n    c.nu_cnpj_grupo,\\n    c.nu_cnpj,\\n    MAX(d.vl_cred_mes_seguinte) AS saldo_credor_acumulado_atual\\n  FROM \\n    usr_sat_ods.ods_decl_dime_raw d\\n  JOIN \\n    usr_sat_ods.vw_ods_contrib c ON d.nu_cnpj = c.nu_cnpj\\n  WHERE \\n    d.nu_per_ref = 202509\\n  GROUP BY \\n    c.nu_cnpj_grupo, c.nu_cnpj\\n),\\n\\nevolucao_saldo AS (\\n  SELECT \\n    c.nu_cnpj_grupo,\\n    MAX(CASE WHEN d.nu_per_ref = 202409 THEN d.vl_cred_mes_seguinte ELSE NULL END) AS saldo_13m_atras,\\n    MAX(CASE WHEN d.nu_per_ref = 202509 THEN d.vl_cred_mes_seguinte ELSE NULL END) AS saldo_atual\\n  FROM \\n    usr_sat_ods.ods_decl_dime_raw d\\n  JOIN \\n    usr_sat_ods.vw_ods_contrib c ON d.nu_cnpj = c.nu_cnpj\\n  WHERE \\n    d.nu_per_ref IN (202409, 202509)\\n  GROUP BY \\n    c.nu_cnpj_grupo\\n),\\n\\ncrescimento_saldo AS (\\n  SELECT\\n    nu_cnpj_grupo,\\n    saldo_13m_atras,\\n    saldo_atual,\\n    COALESCE(saldo_atual, 0) - COALESCE(saldo_13m_atras, 0) AS crescimento_absoluto,\\n    CASE \\n      WHEN saldo_13m_atras > 0 THEN\\n        ROUND(100.0 * (COALESCE(saldo_atual, 0) - saldo_13m_atras) / NULLIF(saldo_13m_atras, 0), 2)\\n      ELSE 0\\n    END AS crescimento_percentual\\n  FROM \\n    evolucao_saldo\\n),\\n\\ncreditos_presumidos AS (\\n  SELECT \\n    dcip.nu_cnpj_grupo,\\n    SUM(dcip.vl_credito) AS vl_cp_total_13m,\\n    COUNT(dcip.cd_tipo_credito) AS qtde_tipos_cp\\n  FROM \\n    usr_sat_ods.vw_ods_dcip dcip\\n  WHERE \\n    dcip.cd_estado_decl = 1\\n    AND dcip.sn_utilizada_dime = 1\\n    AND dcip.cd_grupo_dcip = 3\\n    AND dcip.nu_per_ref BETWEEN 202409 AND 202509\\n  GROUP BY \\n    dcip.nu_cnpj_grupo\\n),\\n\\nestatisticas_creditos AS (\\n  SELECT\\n    nu_cnpj,\\n    COUNT(nu_per_ref) AS qtde_meses_declarados,\\n    AVG(vl_cred_mes_anterior) AS media_credito,\\n    MIN(vl_cred_mes_anterior) AS min_credito,\\n    MAX(vl_cred_mes_anterior) AS max_credito,\\n    STDDEV(vl_cred_mes_anterior) AS desvio_padrao_credito\\n  FROM dados_filtrados\\n  WHERE nu_per_ref BETWEEN 202409 AND 202509\\n  GROUP BY nu_cnpj\\n),\\n\\ncnpjs_unicos AS (\\n  SELECT nu_cnpj \\n  FROM dados_filtrados \\n  GROUP BY nu_cnpj\\n)\\n\\nSELECT \\n  df.nu_cnpj,\\n  c.nm_razao_social,\\n  c.nm_fantasia,\\n  c.nm_sit_cadastral,\\n  c.nm_gerfe,\\n  c.de_cnae,\\n  c.nu_cnpj_grupo,\\n  \\n  COALESCE(ci.contagem_periodos_iguais, 0) AS valor_igual_total_periodos,\\n  COALESCE(seq.qtde_ultimos_meses_iguais, 0) AS qtde_ultimos_meses_iguais,\\n  CAST(COALESCE(ci.primeiro_periodo_igual, 0) AS STRING) AS primeiro_periodo_valor_igual,\\n  CAST(COALESCE(ci.ultimo_periodo_igual, 0) AS STRING) AS ultimo_periodo_valor_igual,\\n  CAST(COALESCE(seq.periodo_inicial_seq, 0) AS STRING) AS periodo_inicial_sequencia_recente,\\n  CAST(COALESCE(seq.periodo_final_seq, 0) AS STRING) AS periodo_final_sequencia_recente,\\n  ROUND(COALESCE(seq.valor_sequencia, 0), 2) AS valor_sequencia_recente,\\n  \\n  COALESCE(est.qtde_meses_declarados, 0) AS qtde_meses_declarados_13m,\\n  ROUND(COALESCE(est.media_credito, 0), 2) AS media_credito_13m,\\n  ROUND(COALESCE(est.min_credito, 0), 2) AS min_credito_13m,\\n  ROUND(COALESCE(est.max_credito, 0), 2) AS max_credito_13m,\\n  ROUND(COALESCE(est.desvio_padrao_credito, 0), 2) AS desvio_padrao_credito,\\n  \\n  COALESCE(saldo.saldo_credor_acumulado_atual, 0) AS saldo_credor_atual,\\n  COALESCE(cresc.saldo_13m_atras, 0) AS saldo_13m_atras,\\n  COALESCE(cresc.crescimento_absoluto, 0) AS crescimento_saldo_absoluto,\\n  COALESCE(cresc.crescimento_percentual, 0) AS crescimento_saldo_percentual,\\n  \\n  COALESCE(cp.vl_cp_total_13m, 0) AS vl_credito_presumido_13m,\\n  COALESCE(cp.qtde_tipos_cp, 0) AS qtde_tipos_cp,\\n  \\n  (\\n    CASE \\n      WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40\\n      WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30\\n      WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15\\n      ELSE 0\\n    END\\n    +\\n    CASE\\n      WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30\\n      WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20\\n      WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10\\n      ELSE 0\\n    END\\n    +\\n    CASE\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5\\n      ELSE 0\\n    END\\n    +\\n    CASE\\n      WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10\\n      WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5\\n      ELSE 0\\n    END\\n  ) AS score_risco,\\n  \\n  CASE\\n    WHEN (\\n      CASE WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15 ELSE 0 END +\\n      CASE WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30 WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20 WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10 ELSE 0 END +\\n      CASE WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5 ELSE 0 END +\\n      CASE WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10 WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5 ELSE 0 END\\n    ) >= 70 THEN 'CR\\u00cdTICO'\\n    WHEN (\\n      CASE WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15 ELSE 0 END +\\n      CASE WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30 WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20 WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10 ELSE 0 END +\\n      CASE WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5 ELSE 0 END +\\n      CASE WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10 WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5 ELSE 0 END\\n    ) >= 50 THEN 'ALTO'\\n    WHEN (\\n      CASE WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15 ELSE 0 END +\\n      CASE WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30 WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20 WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10 ELSE 0 END +\\n      CASE WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5 ELSE 0 END +\\n      CASE WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10 WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5 ELSE 0 END\\n    ) >= 30 THEN 'M\\u00c9DIO'\\n    ELSE 'BAIXO'\\n  END AS classificacao_risco\\n  \\nFROM \\n  cnpjs_unicos df\\nLEFT JOIN \\n  usr_sat_ods.vw_ods_contrib c ON df.nu_cnpj = c.nu_cnpj\\nLEFT JOIN \\n  contagem_iguais ci ON df.nu_cnpj = ci.nu_cnpj\\nLEFT JOIN \\n  sequencia_ultimos_meses seq ON df.nu_cnpj = seq.nu_cnpj\\nLEFT JOIN \\n  estatisticas_creditos est ON df.nu_cnpj = est.nu_cnpj\\nLEFT JOIN \\n  saldo_credor_atual saldo ON df.nu_cnpj = saldo.nu_cnpj\\nLEFT JOIN \\n  crescimento_saldo cresc ON c.nu_cnpj_grupo = cresc.nu_cnpj_grupo\\nLEFT JOIN \\n  creditos_presumidos cp ON c.nu_cnpj_grupo = cp.nu_cnpj_grupo\\nORDER BY \\n  score_risco DESC, \\n  qtde_ultimos_meses_iguais DESC,\\n  valor_igual_total_periodos DESC\"}, \"meta\": [], \"rows\": \"1\", \"hasMore\": false, \"statement_id\": 2, \"statement_range\": {\"start\": {\"row\": 6, \"column\": 0}, \"end\": {\"row\": 266, \"column\": 33}}, \"statements_count\": 3, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": 1, \"filteredMeta\": [{\"type\": \"int\", \"name\": \"\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 0}, {\"name\": \"summary\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 1}], \"fetchedOnce\": false, \"startTime\": \"2025-10-11T03:39:56.927Z\", \"endTime\": \"2025-10-11T03:40:02.149Z\", \"executionTime\": 5222, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 30, \"hasSomeResults\": true}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": 43923, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": \"summary\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": false, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"option\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": 44233, \"getLogsTimeout\": 44324, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1760153996563, \"lastAceSelectionRowOffset\": 0, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"lastExecutedStatements\": \"-- -----------------------------------------------------------------------------\\r\\n-- 1. TABELA PRINCIPAL - AN\\u00c1LISE GERAL (TODOS OS SETORES)\\r\\n-- -----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS teste.credito_dime_completo;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE IF NOT EXISTS teste.credito_dime_completo AS\\r\\n\\r\\nWITH periodos AS (\\r\\n  SELECT periodo AS nu_per_ref\\r\\n  FROM (\\r\\n    SELECT 202101 AS periodo UNION ALL SELECT 202102 UNION ALL SELECT 202103 UNION ALL SELECT 202104 UNION ALL\\r\\n    SELECT 202105 UNION ALL SELECT 202106 UNION ALL SELECT 202107 UNION ALL SELECT 202108 UNION ALL\\r\\n    SELECT 202109 UNION ALL SELECT 202110 UNION ALL SELECT 202111 UNION ALL SELECT 202112 UNION ALL\\r\\n    SELECT 202201 UNION ALL SELECT 202202 UNION ALL SELECT 202203 UNION ALL SELECT 202204 UNION ALL\\r\\n    SELECT 202205 UNION ALL SELECT 202206 UNION ALL SELECT 202207 UNION ALL SELECT 202208 UNION ALL\\r\\n    SELECT 202209 UNION ALL SELECT 202210 UNION ALL SELECT 202211 UNION ALL SELECT 202212 UNION ALL\\r\\n    SELECT 202301 UNION ALL SELECT 202302 UNION ALL SELECT 202303 UNION ALL SELECT 202304 UNION ALL\\r\\n    SELECT 202305 UNION ALL SELECT 202306 UNION ALL SELECT 202307 UNION ALL SELECT 202308 UNION ALL\\r\\n    SELECT 202309 UNION ALL SELECT 202310 UNION ALL SELECT 202311 UNION ALL SELECT 202312 UNION ALL\\r\\n    SELECT 202401 UNION ALL SELECT 202402 UNION ALL SELECT 202403 UNION ALL SELECT 202404 UNION ALL\\r\\n    SELECT 202405 UNION ALL SELECT 202406 UNION ALL SELECT 202407 UNION ALL SELECT 202408 UNION ALL\\r\\n    SELECT 202409 UNION ALL SELECT 202410 UNION ALL SELECT 202411 UNION ALL SELECT 202412 UNION ALL\\r\\n    SELECT 202501 UNION ALL SELECT 202502 UNION ALL SELECT 202503 UNION ALL SELECT 202504 UNION ALL\\r\\n    SELECT 202505 UNION ALL SELECT 202506 UNION ALL SELECT 202507 UNION ALL SELECT 202508 UNION ALL\\r\\n    SELECT 202509\\r\\n  ) p\\r\\n),\\r\\n\\r\\ndados_filtrados AS (\\r\\n  SELECT \\r\\n    d.nu_cnpj,\\r\\n    d.nu_per_ref,\\r\\n    d.vl_cred_mes_anterior,\\r\\n    d.vl_cred_mes_seguinte\\r\\n  FROM \\r\\n    usr_sat_ods.ods_decl_dime_raw d\\r\\n  WHERE \\r\\n    d.nu_per_ref IN (SELECT nu_per_ref FROM periodos)\\r\\n    AND d.vl_cred_mes_anterior > 0\\r\\n    AND d.vl_cred_mes_seguinte > 0\\r\\n),\\r\\n\\r\\nvalores_iguais_base AS (\\r\\n  SELECT\\r\\n    nu_cnpj,\\r\\n    nu_per_ref,\\r\\n    vl_cred_mes_anterior AS valor\\r\\n  FROM \\r\\n    dados_filtrados\\r\\n  WHERE \\r\\n    vl_cred_mes_anterior = vl_cred_mes_seguinte\\r\\n),\\r\\n\\r\\ncontagem_iguais AS (\\r\\n  SELECT\\r\\n    nu_cnpj,\\r\\n    COUNT(*) AS contagem_periodos_iguais,\\r\\n    AVG(valor) AS valor_medio_repetido,\\r\\n    MIN(nu_per_ref) AS primeiro_periodo_igual,\\r\\n    MAX(nu_per_ref) AS ultimo_periodo_igual\\r\\n  FROM \\r\\n    valores_iguais_base\\r\\n  GROUP BY \\r\\n    nu_cnpj\\r\\n),\\r\\n\\r\\nsequencia_ultimos_meses AS (\\r\\n  SELECT\\r\\n    vi.nu_cnpj,\\r\\n    COUNT(*) AS qtde_ultimos_meses_iguais,\\r\\n    MIN(vi.nu_per_ref) AS periodo_inicial_seq,\\r\\n    MAX(vi.nu_per_ref) AS periodo_final_seq,\\r\\n    AVG(vi.valor) AS valor_sequencia\\r\\n  FROM \\r\\n    valores_iguais_base vi\\r\\n  WHERE \\r\\n    vi.nu_per_ref >= 202409\\r\\n  GROUP BY \\r\\n    vi.nu_cnpj\\r\\n  HAVING COUNT(*) >= 3\\r\\n),\\r\\n\\r\\n-- SIMPLIFICADO: Usar apenas a tabela raw da DIME para saldo\\r\\nsaldo_credor_atual AS (\\r\\n  SELECT \\r\\n    c.nu_cnpj_grupo,\\r\\n    c.nu_cnpj,\\r\\n    MAX(d.vl_cred_mes_seguinte) AS saldo_credor_acumulado_atual\\r\\n  FROM \\r\\n    usr_sat_ods.ods_decl_dime_raw d\\r\\n  JOIN \\r\\n    usr_sat_ods.vw_ods_contrib c ON d.nu_cnpj = c.nu_cnpj\\r\\n  WHERE \\r\\n    d.nu_per_ref = 202509\\r\\n  GROUP BY \\r\\n    c.nu_cnpj_grupo, c.nu_cnpj\\r\\n),\\r\\n\\r\\nevolucao_saldo AS (\\r\\n  SELECT \\r\\n    c.nu_cnpj_grupo,\\r\\n    MAX(CASE WHEN d.nu_per_ref = 202409 THEN d.vl_cred_mes_seguinte ELSE NULL END) AS saldo_13m_atras,\\r\\n    MAX(CASE WHEN d.nu_per_ref = 202509 THEN d.vl_cred_mes_seguinte ELSE NULL END) AS saldo_atual\\r\\n  FROM \\r\\n    usr_sat_ods.ods_decl_dime_raw d\\r\\n  JOIN \\r\\n    usr_sat_ods.vw_ods_contrib c ON d.nu_cnpj = c.nu_cnpj\\r\\n  WHERE \\r\\n    d.nu_per_ref IN (202409, 202509)\\r\\n  GROUP BY \\r\\n    c.nu_cnpj_grupo\\r\\n),\\r\\n\\r\\ncrescimento_saldo AS (\\r\\n  SELECT\\r\\n    nu_cnpj_grupo,\\r\\n    saldo_13m_atras,\\r\\n    saldo_atual,\\r\\n    COALESCE(saldo_atual, 0) - COALESCE(saldo_13m_atras, 0) AS crescimento_absoluto,\\r\\n    CASE \\r\\n      WHEN saldo_13m_atras > 0 THEN\\r\\n        ROUND(100.0 * (COALESCE(saldo_atual, 0) - saldo_13m_atras) / NULLIF(saldo_13m_atras, 0), 2)\\r\\n      ELSE 0\\r\\n    END AS crescimento_percentual\\r\\n  FROM \\r\\n    evolucao_saldo\\r\\n),\\r\\n\\r\\ncreditos_presumidos AS (\\r\\n  SELECT \\r\\n    dcip.nu_cnpj_grupo,\\r\\n    SUM(dcip.vl_credito) AS vl_cp_total_13m,\\r\\n    COUNT(dcip.cd_tipo_credito) AS qtde_tipos_cp\\r\\n  FROM \\r\\n    usr_sat_ods.vw_ods_dcip dcip\\r\\n  WHERE \\r\\n    dcip.cd_estado_decl = 1\\r\\n    AND dcip.sn_utilizada_dime = 1\\r\\n    AND dcip.cd_grupo_dcip = 3\\r\\n    AND dcip.nu_per_ref BETWEEN 202409 AND 202509\\r\\n  GROUP BY \\r\\n    dcip.nu_cnpj_grupo\\r\\n),\\r\\n\\r\\nestatisticas_creditos AS (\\r\\n  SELECT\\r\\n    nu_cnpj,\\r\\n    COUNT(nu_per_ref) AS qtde_meses_declarados,\\r\\n    AVG(vl_cred_mes_anterior) AS media_credito,\\r\\n    MIN(vl_cred_mes_anterior) AS min_credito,\\r\\n    MAX(vl_cred_mes_anterior) AS max_credito,\\r\\n    STDDEV(vl_cred_mes_anterior) AS desvio_padrao_credito\\r\\n  FROM dados_filtrados\\r\\n  WHERE nu_per_ref BETWEEN 202409 AND 202509\\r\\n  GROUP BY nu_cnpj\\r\\n),\\r\\n\\r\\ncnpjs_unicos AS (\\r\\n  SELECT nu_cnpj \\r\\n  FROM dados_filtrados \\r\\n  GROUP BY nu_cnpj\\r\\n)\\r\\n\\r\\nSELECT \\r\\n  df.nu_cnpj,\\r\\n  c.nm_razao_social,\\r\\n  c.nm_fantasia,\\r\\n  c.nm_sit_cadastral,\\r\\n  c.nm_gerfe,\\r\\n  c.de_cnae,\\r\\n  c.nu_cnpj_grupo,\\r\\n  \\r\\n  COALESCE(ci.contagem_periodos_iguais, 0) AS valor_igual_total_periodos,\\r\\n  COALESCE(seq.qtde_ultimos_meses_iguais, 0) AS qtde_ultimos_meses_iguais,\\r\\n  CAST(COALESCE(ci.primeiro_periodo_igual, 0) AS STRING) AS primeiro_periodo_valor_igual,\\r\\n  CAST(COALESCE(ci.ultimo_periodo_igual, 0) AS STRING) AS ultimo_periodo_valor_igual,\\r\\n  CAST(COALESCE(seq.periodo_inicial_seq, 0) AS STRING) AS periodo_inicial_sequencia_recente,\\r\\n  CAST(COALESCE(seq.periodo_final_seq, 0) AS STRING) AS periodo_final_sequencia_recente,\\r\\n  ROUND(COALESCE(seq.valor_sequencia, 0), 2) AS valor_sequencia_recente,\\r\\n  \\r\\n  COALESCE(est.qtde_meses_declarados, 0) AS qtde_meses_declarados_13m,\\r\\n  ROUND(COALESCE(est.media_credito, 0), 2) AS media_credito_13m,\\r\\n  ROUND(COALESCE(est.min_credito, 0), 2) AS min_credito_13m,\\r\\n  ROUND(COALESCE(est.max_credito, 0), 2) AS max_credito_13m,\\r\\n  ROUND(COALESCE(est.desvio_padrao_credito, 0), 2) AS desvio_padrao_credito,\\r\\n  \\r\\n  COALESCE(saldo.saldo_credor_acumulado_atual, 0) AS saldo_credor_atual,\\r\\n  COALESCE(cresc.saldo_13m_atras, 0) AS saldo_13m_atras,\\r\\n  COALESCE(cresc.crescimento_absoluto, 0) AS crescimento_saldo_absoluto,\\r\\n  COALESCE(cresc.crescimento_percentual, 0) AS crescimento_saldo_percentual,\\r\\n  \\r\\n  COALESCE(cp.vl_cp_total_13m, 0) AS vl_credito_presumido_13m,\\r\\n  COALESCE(cp.qtde_tipos_cp, 0) AS qtde_tipos_cp,\\r\\n  \\r\\n  (\\r\\n    CASE \\r\\n      WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40\\r\\n      WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30\\r\\n      WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15\\r\\n      ELSE 0\\r\\n    END\\r\\n    +\\r\\n    CASE\\r\\n      WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30\\r\\n      WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20\\r\\n      WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10\\r\\n      ELSE 0\\r\\n    END\\r\\n    +\\r\\n    CASE\\r\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20\\r\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15\\r\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10\\r\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5\\r\\n      ELSE 0\\r\\n    END\\r\\n    +\\r\\n    CASE\\r\\n      WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10\\r\\n      WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5\\r\\n      ELSE 0\\r\\n    END\\r\\n  ) AS score_risco,\\r\\n  \\r\\n  CASE\\r\\n    WHEN (\\r\\n      CASE WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30 WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20 WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10 WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5 ELSE 0 END\\r\\n    ) >= 70 THEN 'CR\\u00cdTICO'\\r\\n    WHEN (\\r\\n      CASE WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30 WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20 WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10 WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5 ELSE 0 END\\r\\n    ) >= 50 THEN 'ALTO'\\r\\n    WHEN (\\r\\n      CASE WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30 WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20 WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10 WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5 ELSE 0 END\\r\\n    ) >= 30 THEN 'M\\u00c9DIO'\\r\\n    ELSE 'BAIXO'\\r\\n  END AS classificacao_risco\\r\\n  \\r\\nFROM \\r\\n  cnpjs_unicos df\\r\\nLEFT JOIN \\r\\n  usr_sat_ods.vw_ods_contrib c ON df.nu_cnpj = c.nu_cnpj\\r\\nLEFT JOIN \\r\\n  contagem_iguais ci ON df.nu_cnpj = ci.nu_cnpj\\r\\nLEFT JOIN \\r\\n  sequencia_ultimos_meses seq ON df.nu_cnpj = seq.nu_cnpj\\r\\nLEFT JOIN \\r\\n  estatisticas_creditos est ON df.nu_cnpj = est.nu_cnpj\\r\\nLEFT JOIN \\r\\n  saldo_credor_atual saldo ON df.nu_cnpj = saldo.nu_cnpj\\r\\nLEFT JOIN \\r\\n  crescimento_saldo cresc ON c.nu_cnpj_grupo = cresc.nu_cnpj_grupo\\r\\nLEFT JOIN \\r\\n  creditos_presumidos cp ON c.nu_cnpj_grupo = cp.nu_cnpj_grupo\\r\\nORDER BY \\r\\n  score_risco DESC, \\r\\n  qtde_ultimos_meses_iguais DESC,\\r\\n  valor_igual_total_periodos DESC;\\r\\n\", \"lastExecutedSelectionRange\": {\"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 267, \"column\": 0}}, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"lastCheckStatusRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"query_status\\\": {\\\"status\\\": \\\"available\\\"}}\", \"responseJSON\": {\"status\": 0, \"query_status\": {\"status\": \"available\"}}, \"status\": 200, \"statusText\": \"OK\"}, \"lastGetLogsRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"logs\\\": \\\"Query 334bd8860b21b59a:b6049ad800000000 100% Complete (63 out of 63)\\\\nIgnoring ORDER BY clause without LIMIT or OFFSET: ORDER BY dcip.id_seq_ult_alt DESC.\\\\nAn ORDER BY appearing in a view, subquery, union operand, or an insert/ctas statement has no effect on the query result unless a LIMIT and/or OFFSET is used in conjunction with the ORDER BY.\\\\nIgnoring ORDER BY clause without LIMIT or OFFSET: ORDER BY score_risco DESC, qtde_ultimos_meses_iguais DESC, valor_igual_total_periodos DESC.\\\\nAn ORDER BY appearing in a view, subquery, union operand, or an insert/ctas statement has no effect on the query result unless a LIMIT and/or OFFSET is used in conjunction with the ORDER BY.\\\", \\\"progress\\\": 100, \\\"jobs\\\": [{\\\"name\\\": \\\"334bd8860b21b59a:b6049ad800000000\\\", \\\"url\\\": \\\"/hue/jobbrowser#!id=334bd8860b21b59a:b6049ad800000000\\\", \\\"started\\\": true, \\\"finished\\\": false, \\\"percentJob\\\": 100}], \\\"isFullLogs\\\": false}\", \"responseJSON\": {\"status\": 0, \"logs\": \"Query 334bd8860b21b59a:b6049ad800000000 100% Complete (63 out of 63)\\nIgnoring ORDER BY clause without LIMIT or OFFSET: ORDER BY dcip.id_seq_ult_alt DESC.\\nAn ORDER BY appearing in a view, subquery, union operand, or an insert/ctas statement has no effect on the query result unless a LIMIT and/or OFFSET is used in conjunction with the ORDER BY.\\nIgnoring ORDER BY clause without LIMIT or OFFSET: ORDER BY score_risco DESC, qtde_ultimos_meses_iguais DESC, valor_igual_total_periodos DESC.\\nAn ORDER BY appearing in a view, subquery, union operand, or an insert/ctas statement has no effect on the query result unless a LIMIT and/or OFFSET is used in conjunction with the ORDER BY.\", \"progress\": 100, \"jobs\": [{\"name\": \"334bd8860b21b59a:b6049ad800000000\", \"url\": \"/hue/jobbrowser#!id=334bd8860b21b59a:b6049ad800000000\", \"started\": true, \"finished\": false, \"percentJob\": 100}], \"isFullLogs\": false}, \"status\": 200, \"statusText\": \"OK\"}}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 17120, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 118, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": true, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "-- -----------------------------------------------------------------------------\r\n-- 1. TABELA PRINCIPAL - ANÁLISE GERAL (TODOS OS SETORES)\r\n-- -----------------------------------------------------------------------------\r\nDROP TABLE IF EXISTS teste.credito_dime_completo;\r\nSET REQUEST_POOL = 'medium';\r\n\r\nCREATE TABLE IF NOT EXISTS teste.credito_dime_completo AS\r\n\r\nWITH periodos AS (\r\n  SELECT periodo AS nu_per_ref\r\n  FROM (\r\n    SELECT 202101 AS periodo UNION ALL SELECT 202102 UNION ALL SELECT 202103 UNION ALL SELECT 202104 UNION ALL\r\n    SELECT 202105 UNION ALL SELECT 202106 UNION ALL SELECT 202107 UNION ALL SELECT 202108 UNION ALL\r\n    SELECT 202109 UNION ALL SELECT 202110 UNION ALL SELECT 202111 UNION ALL SELECT 202112 UNION ALL\r\n    SELECT 202201 UNION ALL SELECT 202202 UNION ALL SELECT 202203 UNION ALL SELECT 202204 UNION ALL\r\n    SELECT 202205 UNION ALL SELECT 202206 UNION ALL SELECT 202207 UNION ALL SELECT 202208 UNION ALL\r\n    SELECT 202209 UNION ALL SELECT 202210 UNION ALL SELECT 202211 UNION ALL SELECT 202212 UNION ALL\r\n    SELECT 202301 UNION ALL SELECT 202302 UNION ALL SELECT 202303 UNION ALL SELECT 202304 UNION ALL\r\n    SELECT 202305 UNION ALL SELECT 202306 UNION ALL SELECT 202307 UNION ALL SELECT 202308 UNION ALL\r\n    SELECT 202309 UNION ALL SELECT 202310 UNION ALL SELECT 202311 UNION ALL SELECT 202312 UNION ALL\r\n    SELECT 202401 UNION ALL SELECT 202402 UNION ALL SELECT 202403 UNION ALL SELECT 202404 UNION ALL\r\n    SELECT 202405 UNION ALL SELECT 202406 UNION ALL SELECT 202407 UNION ALL SELECT 202408 UNION ALL\r\n    SELECT 202409 UNION ALL SELECT 202410 UNION ALL SELECT 202411 UNION ALL SELECT 202412 UNION ALL\r\n    SELECT 202501 UNION ALL SELECT 202502 UNION ALL SELECT 202503 UNION ALL SELECT 202504 UNION ALL\r\n    SELECT 202505 UNION ALL SELECT 202506 UNION ALL SELECT 202507 UNION ALL SELECT 202508 UNION ALL\r\n    SELECT 202509\r\n  ) p\r\n),\r\n\r\ndados_filtrados AS (\r\n  SELECT \r\n    d.nu_cnpj,\r\n    d.nu_per_ref,\r\n    d.vl_cred_mes_anterior,\r\n    d.vl_cred_mes",
    "last_modified": "2025-10-11T00:42:11.093",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "98247874-ca8f-489a-b757-bbfeafccd369",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 162763,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "DIME CRED EFD: 2 Têxtil",
    "description": "",
    "uuid": "ac2edf2f-6af0-205f-4742-a3a6e38c6be5",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 162763, \"uuid\": \"1f447fe6-693f-451c-8604-f368b81243dc\", \"name\": \"DIME CRED EFD: 2 T\\u00eaxtil\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": \"ac2edf2f-6af0-205f-4742-a3a6e38c6be5\", \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"bc0dbbaf-f3aa-23d3-3841-40c5ef638e89\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": {\"row\": 52, \"column\": 0}, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": true, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"default\", \"currentQueryTab\": \"queryResults\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 1, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"DROP TABLE IF EXISTS teste.credito_dime_textil;\\r\\n\\r\\nCREATE TABLE teste.credito_dime_textil STORED AS PARQUET AS\\r\\nWITH movimentacao_textil AS (\\r\\n  SELECT \\r\\n    my_efd.codigocnpj AS nu_cnpj,\\r\\n    SUM(CASE WHEN c170.cfop BETWEEN 1000 AND 3999 THEN c170.vl_item ELSE 0 END) AS vl_entradas_textil,\\r\\n    SUM(CASE WHEN c170.cfop BETWEEN 5000 AND 7999 THEN c170.vl_item ELSE 0 END) AS vl_saidas_textil,\\r\\n    COUNT(DISTINCT c100.dt_doc) AS dias_movimento_textil,\\r\\n    COUNT(DISTINCT r0200.cod_ncm) AS qtde_ncm_distintos_textil\\r\\n  FROM \\r\\n    efd.efd my_efd\\r\\n  JOIN \\r\\n    efd.efd_rc100 c100 ON my_efd.id_file = c100.id_file,\\r\\n    c100.listarc170_itensdocumento c170\\r\\n  JOIN \\r\\n    efd.efd_r0200 r0200 ON c100.id_file = r0200.id_file \\r\\n                        AND c170.cod_item = r0200.cod_item\\r\\n  WHERE \\r\\n    (my_efd.ano_referencia = 2024 OR \\r\\n     (my_efd.ano_referencia = 2025 AND my_efd.mes_referencia <= 9))\\r\\n    AND (r0200.cod_ncm LIKE '61%' OR r0200.cod_ncm LIKE '62%')\\r\\n  GROUP BY \\r\\n    my_efd.codigocnpj\\r\\n)\\r\\n\\r\\nSELECT \\r\\n  cd.*,\\r\\n  COALESCE(mov.vl_entradas_textil, 0) AS vl_entradas_textil,\\r\\n  COALESCE(mov.vl_saidas_textil, 0) AS vl_saidas_textil,\\r\\n  COALESCE(mov.dias_movimento_textil, 0) AS dias_movimento_textil,\\r\\n  COALESCE(mov.qtde_ncm_distintos_textil, 0) AS qtde_ncm_distintos_textil,\\r\\n  \\r\\n  CASE \\r\\n    WHEN mov.vl_saidas_textil > 0 THEN \\r\\n      ROUND(100.0 * mov.vl_entradas_textil / NULLIF(mov.vl_saidas_textil, 0), 2)\\r\\n    ELSE 0 \\r\\n  END AS indice_entrada_saida_textil,\\r\\n  \\r\\n  CASE \\r\\n    WHEN mov.vl_entradas_textil > 0 THEN\\r\\n      ROUND(cd.saldo_credor_atual / NULLIF(mov.vl_entradas_textil, 0), 4)\\r\\n    ELSE 0\\r\\n  END AS indice_saldo_entrada_textil,\\r\\n  \\r\\n  CASE WHEN mov.nu_cnpj IS NOT NULL THEN 1 ELSE 0 END AS flag_setor_textil,\\r\\n  \\r\\n  'T\\u00caXTIL' AS setor\\r\\n  \\r\\nFROM teste.credito_dime_completo cd\\r\\nLEFT JOIN movimentacao_textil mov ON cd.nu_cnpj = mov.nu_cnpj;\", \"statementsList\": [\"DROP TABLE IF EXISTS teste.credito_dime_textil;\", \"\\r\\n\\r\\nCREATE TABLE teste.credito_dime_textil STORED AS PARQUET AS\\r\\nWITH movimentacao_textil AS (\\r\\n  SELECT \\r\\n    my_efd.codigocnpj AS nu_cnpj,\\r\\n    SUM(CASE WHEN c170.cfop BETWEEN 1000 AND 3999 THEN c170.vl_item ELSE 0 END) AS vl_entradas_textil,\\r\\n    SUM(CASE WHEN c170.cfop BETWEEN 5000 AND 7999 THEN c170.vl_item ELSE 0 END) AS vl_saidas_textil,\\r\\n    COUNT(DISTINCT c100.dt_doc) AS dias_movimento_textil,\\r\\n    COUNT(DISTINCT r0200.cod_ncm) AS qtde_ncm_distintos_textil\\r\\n  FROM \\r\\n    efd.efd my_efd\\r\\n  JOIN \\r\\n    efd.efd_rc100 c100 ON my_efd.id_file = c100.id_file,\\r\\n    c100.listarc170_itensdocumento c170\\r\\n  JOIN \\r\\n    efd.efd_r0200 r0200 ON c100.id_file = r0200.id_file \\r\\n                        AND c170.cod_item = r0200.cod_item\\r\\n  WHERE \\r\\n    (my_efd.ano_referencia = 2024 OR \\r\\n     (my_efd.ano_referencia = 2025 AND my_efd.mes_referencia <= 9))\\r\\n    AND (r0200.cod_ncm LIKE '61%' OR r0200.cod_ncm LIKE '62%')\\r\\n  GROUP BY \\r\\n    my_efd.codigocnpj\\r\\n)\\r\\n\\r\\nSELECT \\r\\n  cd.*,\\r\\n  COALESCE(mov.vl_entradas_textil, 0) AS vl_entradas_textil,\\r\\n  COALESCE(mov.vl_saidas_textil, 0) AS vl_saidas_textil,\\r\\n  COALESCE(mov.dias_movimento_textil, 0) AS dias_movimento_textil,\\r\\n  COALESCE(mov.qtde_ncm_distintos_textil, 0) AS qtde_ncm_distintos_textil,\\r\\n  \\r\\n  CASE \\r\\n    WHEN mov.vl_saidas_textil > 0 THEN \\r\\n      ROUND(100.0 * mov.vl_entradas_textil / NULLIF(mov.vl_saidas_textil, 0), 2)\\r\\n    ELSE 0 \\r\\n  END AS indice_entrada_saida_textil,\\r\\n  \\r\\n  CASE \\r\\n    WHEN mov.vl_entradas_textil > 0 THEN\\r\\n      ROUND(cd.saldo_credor_atual / NULLIF(mov.vl_entradas_textil, 0), 4)\\r\\n    ELSE 0\\r\\n  END AS indice_saldo_entrada_textil,\\r\\n  \\r\\n  CASE WHEN mov.nu_cnpj IS NOT NULL THEN 1 ELSE 0 END AS flag_setor_textil,\\r\\n  \\r\\n  'T\\u00caXTIL' AS setor\\r\\n  \\r\\nFROM teste.credito_dime_completo cd\\r\\nLEFT JOIN movimentacao_textil mov ON cd.nu_cnpj = mov.nu_cnpj;\"], \"aceSize\": 100, \"status\": \"available\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"\\r\\n\\r\\nCREATE TABLE teste.credito_dime_textil STORED AS PARQUET AS\\r\\nWITH movimentacao_textil AS (\\r\\n  SELECT \\r\\n    my_efd.codigocnpj AS nu_cnpj,\\r\\n    SUM(CASE WHEN c170.cfop BETWEEN 1000 AND 3999 THEN c170.vl_item ELSE 0 END) AS vl_entradas_textil,\\r\\n    SUM(CASE WHEN c170.cfop BETWEEN 5000 AND 7999 THEN c170.vl_item ELSE 0 END) AS vl_saidas_textil,\\r\\n    COUNT(DISTINCT c100.dt_doc) AS dias_movimento_textil,\\r\\n    COUNT(DISTINCT r0200.cod_ncm) AS qtde_ncm_distintos_textil\\r\\n  FROM \\r\\n    efd.efd my_efd\\r\\n  JOIN \\r\\n    efd.efd_rc100 c100 ON my_efd.id_file = c100.id_file,\\r\\n    c100.listarc170_itensdocumento c170\\r\\n  JOIN \\r\\n    efd.efd_r0200 r0200 ON c100.id_file = r0200.id_file \\r\\n                        AND c170.cod_item = r0200.cod_item\\r\\n  WHERE \\r\\n    (my_efd.ano_referencia = 2024 OR \\r\\n     (my_efd.ano_referencia = 2025 AND my_efd.mes_referencia <= 9))\\r\\n    AND (r0200.cod_ncm LIKE '61%' OR r0200.cod_ncm LIKE '62%')\\r\\n  GROUP BY \\r\\n    my_efd.codigocnpj\\r\\n)\\r\\n\\r\\nSELECT \\r\\n  cd.*,\\r\\n  COALESCE(mov.vl_entradas_textil, 0) AS vl_entradas_textil,\\r\\n  COALESCE(mov.vl_saidas_textil, 0) AS vl_saidas_textil,\\r\\n  COALESCE(mov.dias_movimento_textil, 0) AS dias_movimento_textil,\\r\\n  COALESCE(mov.qtde_ncm_distintos_textil, 0) AS qtde_ncm_distintos_textil,\\r\\n  \\r\\n  CASE \\r\\n    WHEN mov.vl_saidas_textil > 0 THEN \\r\\n      ROUND(100.0 * mov.vl_entradas_textil / NULLIF(mov.vl_saidas_textil, 0), 2)\\r\\n    ELSE 0 \\r\\n  END AS indice_entrada_saida_textil,\\r\\n  \\r\\n  CASE \\r\\n    WHEN mov.vl_entradas_textil > 0 THEN\\r\\n      ROUND(cd.saldo_credor_atual / NULLIF(mov.vl_entradas_textil, 0), 4)\\r\\n    ELSE 0\\r\\n  END AS indice_saldo_entrada_textil,\\r\\n  \\r\\n  CASE WHEN mov.nu_cnpj IS NOT NULL THEN 1 ELSE 0 END AS flag_setor_textil,\\r\\n  \\r\\n  'T\\u00caXTIL' AS setor\\r\\n  \\r\\nFROM teste.credito_dime_completo cd\\r\\nLEFT JOIN movimentacao_textil mov ON cd.nu_cnpj = mov.nu_cnpj;\", \"result\": {\"id\": \"64c885b3-6b9f-38f8-40df-7ecfbae4fd7c\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"AnIV/ChmR2GmjNZx5pr+Bw==\", \"guid\": \"ZryHBWoqRw4AAAAAk2vWpQ==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"a14a96e02125e5fe:0e4a6eab4a1a89bd\", \"session_id\": 21447, \"session_type\": \"impala\", \"statement_id\": 0, \"has_more_statements\": false, \"statements_count\": 1, \"previous_statement_hash\": \"3fd778de607a4159c168518ed21fc4ca95a67bc1a771d0c28fcfe807\", \"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 0, \"column\": 99}, \"statement\": \"SELECT COUNT(*) as com_movimento_textil FROM teste.credito_dime_textil WHERE flag_setor_textil = 1\"}, \"meta\": [], \"rows\": 1, \"hasMore\": false, \"statement_id\": 0, \"statement_range\": {\"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 0, \"column\": 0}}, \"statements_count\": 1, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": 1, \"filteredMeta\": [{\"type\": \"int\", \"name\": \"\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 0}, {\"name\": \"com_movimento_textil\", \"type\": \"bigint\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 1}], \"fetchedOnce\": false, \"startTime\": \"2025-10-11T03:43:57.795Z\", \"endTime\": \"2025-10-11T03:43:57.986Z\", \"executionTime\": 191, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 3, \"hasSomeResults\": true}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": 7966, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": null, \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [\"com_movimento_textil\"], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": false, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": null, \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [\"total_textil\"], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": null, \"getLogsTimeout\": 9258, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1760154237567, \"lastAceSelectionRowOffset\": 54, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"lastExecutedStatements\": \"\\r\\nSELECT COUNT(*) as com_movimento_textil FROM teste.credito_dime_textil WHERE flag_setor_textil = 1;\", \"lastExecutedSelectionRange\": {\"start\": {\"row\": 54, \"column\": 59}, \"end\": {\"row\": 54, \"column\": 59}}, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"lastCheckStatusRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"query_status\\\": {\\\"status\\\": \\\"available\\\"}}\", \"responseJSON\": {\"status\": 0, \"query_status\": {\"status\": \"available\"}}, \"status\": 200, \"statusText\": \"OK\"}, \"lastGetLogsRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"logs\\\": \\\"Query 0e472a6a0587bc66:a5d66b9300000000 100% Complete (9 out of 9)\\\", \\\"progress\\\": 100, \\\"jobs\\\": [{\\\"name\\\": \\\"0e472a6a0587bc66:a5d66b9300000000\\\", \\\"url\\\": \\\"/hue/jobbrowser#!id=0e472a6a0587bc66:a5d66b9300000000\\\", \\\"started\\\": true, \\\"finished\\\": false, \\\"percentJob\\\": 100}], \\\"isFullLogs\\\": false}\", \"responseJSON\": {\"status\": 0, \"logs\": \"Query 0e472a6a0587bc66:a5d66b9300000000 100% Complete (9 out of 9)\", \"progress\": 100, \"jobs\": [{\"name\": \"0e472a6a0587bc66:a5d66b9300000000\", \"url\": \"/hue/jobbrowser#!id=0e472a6a0587bc66:a5d66b9300000000\", \"started\": true, \"finished\": false, \"percentJob\": 100}], \"isFullLogs\": false}, \"status\": 200, \"statusText\": \"OK\"}}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 7335, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 123, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": true, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false, \"is_history\": false}",
    "extra": "",
    "search": "DROP TABLE IF EXISTS teste.credito_dime_textil;\r\n\r\nCREATE TABLE teste.credito_dime_textil STORED AS PARQUET AS\r\nWITH movimentacao_textil AS (\r\n  SELECT \r\n    my_efd.codigocnpj AS nu_cnpj,\r\n    SUM(CASE WHEN c170.cfop BETWEEN 1000 AND 3999 THEN c170.vl_item ELSE 0 END) AS vl_entradas_textil,\r\n    SUM(CASE WHEN c170.cfop BETWEEN 5000 AND 7999 THEN c170.vl_item ELSE 0 END) AS vl_saidas_textil,\r\n    COUNT(DISTINCT c100.dt_doc) AS dias_movimento_textil,\r\n    COUNT(DISTINCT r0200.cod_ncm) AS qtde_ncm_distintos_textil\r\n  FROM \r\n    efd.efd my_efd\r\n  JOIN \r\n    efd.efd_rc100 c100 ON my_efd.id_file = c100.id_file,\r\n    c100.listarc170_itensdocumento c170\r\n  JOIN \r\n    efd.efd_r0200 r0200 ON c100.id_file = r0200.id_file \r\n                        AND c170.cod_item = r0200.cod_item\r\n  WHERE \r\n    (my_efd.ano_referencia = 2024 OR \r\n     (my_efd.ano_referencia = 2025 AND my_efd.mes_referencia <= 9))\r\n    AND (r0200.cod_ncm LIKE '61%' OR r0200.cod_ncm LIKE '62%')\r\n  GROUP BY \r\n    my_efd.codigocnpj\r\n)\r\n\r\nSELECT \r\n  cd.*,\r\n  COALESCE(mov.vl_entradas_textil, 0) AS vl_entradas_textil,\r\n  COALESCE(mov.vl_saidas_textil, 0) AS vl_saidas_textil,\r\n  COALESCE(mov.dias_movimento_textil, 0) AS dias_movimento_textil,\r\n  COALESCE(mov.qtde_ncm_distintos_textil, 0) AS qtde_ncm_distintos_textil,\r\n  \r\n  CASE \r\n    WHEN mov.vl_saidas_textil > 0 THEN \r\n      ROUND(100.0 * mov.vl_entradas_textil / NULLIF(mov.vl_saidas_textil, 0), 2)\r\n    ELSE 0 \r\n  END AS indice_entrada_saida_textil,\r\n  \r\n  CASE \r\n    WHEN mov.vl_entradas_textil > 0 THEN\r\n      ROUND(cd.saldo_credor_atual / NULLIF(mov.vl_entradas_textil, 0), 4)\r\n    ELSE 0\r\n  END AS indice_saldo_entrada_textil,\r\n  \r\n  CASE WHEN mov.nu_cnpj IS NOT NULL THEN 1 ELSE 0 END AS flag_setor_textil,\r\n  \r\n  'TÊXTIL' AS setor\r\n  \r\nFROM teste.credito_dime_completo cd\r\nLEFT JOIN movimentacao_textil mov ON cd.nu_cnpj = mov.nu_cnpj;",
    "last_modified": "2025-10-11T00:44:11.763",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "98247874-ca8f-489a-b757-bbfeafccd369",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 162764,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "DIME CRED EFD: 3 Metal",
    "description": "",
    "uuid": "c59cfd37-669c-6052-56b0-c8032037c562",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 162764, \"uuid\": \"afcc535f-2b78-4f70-a860-78f99385db54\", \"name\": \"DIME CRED EFD: 3 Metal\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": \"c59cfd37-669c-6052-56b0-c8032037c562\", \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"efa1a6af-6471-23ce-653c-d26c8e55e862\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": {\"row\": 60, \"column\": 64}, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": true, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"default\", \"currentQueryTab\": \"queryResults\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 1, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"DROP TABLE IF EXISTS teste.credito_dime_metalmec;\\r\\n\\r\\nCREATE TABLE teste.credito_dime_metalmec STORED AS PARQUET AS\\r\\nWITH movimentacao_metalmec AS (\\r\\n  SELECT \\r\\n    my_efd.codigocnpj AS nu_cnpj,\\r\\n    SUM(CASE WHEN c170.cfop BETWEEN 1000 AND 3999 THEN c170.vl_item ELSE 0 END) AS vl_entradas_metalmec,\\r\\n    SUM(CASE WHEN c170.cfop BETWEEN 5000 AND 7999 THEN c170.vl_item ELSE 0 END) AS vl_saidas_metalmec,\\r\\n    COUNT(DISTINCT c100.dt_doc) AS dias_movimento_metalmec,\\r\\n    COUNT(DISTINCT r0200.cod_ncm) AS qtde_ncm_distintos_metalmec,\\r\\n    SUM(CASE WHEN r0200.cod_ncm LIKE '84%' THEN c170.vl_item ELSE 0 END) AS vl_cap84,\\r\\n    SUM(CASE WHEN r0200.cod_ncm LIKE '85%' THEN c170.vl_item ELSE 0 END) AS vl_cap85\\r\\n  FROM \\r\\n    efd.efd my_efd\\r\\n  JOIN \\r\\n    efd.efd_rc100 c100 ON my_efd.id_file = c100.id_file,\\r\\n    c100.listarc170_itensdocumento c170\\r\\n  JOIN \\r\\n    efd.efd_r0200 r0200 ON c100.id_file = r0200.id_file \\r\\n                        AND c170.cod_item = r0200.cod_item\\r\\n  WHERE \\r\\n    (my_efd.ano_referencia = 2024 OR \\r\\n     (my_efd.ano_referencia = 2025 AND my_efd.mes_referencia <= 9))\\r\\n    AND (r0200.cod_ncm LIKE '84%' OR r0200.cod_ncm LIKE '85%')\\r\\n  GROUP BY \\r\\n    my_efd.codigocnpj\\r\\n)\\r\\n\\r\\nSELECT \\r\\n  cd.*,\\r\\n  COALESCE(mov.vl_entradas_metalmec, 0) AS vl_entradas_metalmec,\\r\\n  COALESCE(mov.vl_saidas_metalmec, 0) AS vl_saidas_metalmec,\\r\\n  COALESCE(mov.dias_movimento_metalmec, 0) AS dias_movimento_metalmec,\\r\\n  COALESCE(mov.qtde_ncm_distintos_metalmec, 0) AS qtde_ncm_distintos_metalmec,\\r\\n  COALESCE(mov.vl_cap84, 0) AS vl_capitulo_84,\\r\\n  COALESCE(mov.vl_cap85, 0) AS vl_capitulo_85,\\r\\n  \\r\\n  CASE \\r\\n    WHEN mov.vl_saidas_metalmec > 0 THEN \\r\\n      ROUND(100.0 * mov.vl_entradas_metalmec / NULLIF(mov.vl_saidas_metalmec, 0), 2)\\r\\n    ELSE 0 \\r\\n  END AS indice_entrada_saida_metalmec,\\r\\n  \\r\\n  CASE \\r\\n    WHEN mov.vl_entradas_metalmec > 0 THEN\\r\\n      ROUND(cd.saldo_credor_atual / NULLIF(mov.vl_entradas_metalmec, 0), 4)\\r\\n    ELSE 0\\r\\n  END AS indice_saldo_entrada_metalmec,\\r\\n  \\r\\n  CASE \\r\\n    WHEN (mov.vl_cap84 + mov.vl_cap85) > 0 THEN\\r\\n      ROUND(100.0 * mov.vl_cap84 / NULLIF(mov.vl_cap84 + mov.vl_cap85, 0), 2)\\r\\n    ELSE 0\\r\\n  END AS perc_cap84,\\r\\n  \\r\\n  CASE WHEN mov.nu_cnpj IS NOT NULL THEN 1 ELSE 0 END AS flag_setor_metalmec,\\r\\n  \\r\\n  'METAL-MEC\\u00c2NICO' AS setor\\r\\n  \\r\\nFROM teste.credito_dime_completo cd\\r\\nLEFT JOIN movimentacao_metalmec mov ON cd.nu_cnpj = mov.nu_cnpj;\", \"statementsList\": [\"DROP TABLE IF EXISTS teste.credito_dime_metalmec;\", \"\\r\\n\\r\\nCREATE TABLE teste.credito_dime_metalmec STORED AS PARQUET AS\\r\\nWITH movimentacao_metalmec AS (\\r\\n  SELECT \\r\\n    my_efd.codigocnpj AS nu_cnpj,\\r\\n    SUM(CASE WHEN c170.cfop BETWEEN 1000 AND 3999 THEN c170.vl_item ELSE 0 END) AS vl_entradas_metalmec,\\r\\n    SUM(CASE WHEN c170.cfop BETWEEN 5000 AND 7999 THEN c170.vl_item ELSE 0 END) AS vl_saidas_metalmec,\\r\\n    COUNT(DISTINCT c100.dt_doc) AS dias_movimento_metalmec,\\r\\n    COUNT(DISTINCT r0200.cod_ncm) AS qtde_ncm_distintos_metalmec,\\r\\n    SUM(CASE WHEN r0200.cod_ncm LIKE '84%' THEN c170.vl_item ELSE 0 END) AS vl_cap84,\\r\\n    SUM(CASE WHEN r0200.cod_ncm LIKE '85%' THEN c170.vl_item ELSE 0 END) AS vl_cap85\\r\\n  FROM \\r\\n    efd.efd my_efd\\r\\n  JOIN \\r\\n    efd.efd_rc100 c100 ON my_efd.id_file = c100.id_file,\\r\\n    c100.listarc170_itensdocumento c170\\r\\n  JOIN \\r\\n    efd.efd_r0200 r0200 ON c100.id_file = r0200.id_file \\r\\n                        AND c170.cod_item = r0200.cod_item\\r\\n  WHERE \\r\\n    (my_efd.ano_referencia = 2024 OR \\r\\n     (my_efd.ano_referencia = 2025 AND my_efd.mes_referencia <= 9))\\r\\n    AND (r0200.cod_ncm LIKE '84%' OR r0200.cod_ncm LIKE '85%')\\r\\n  GROUP BY \\r\\n    my_efd.codigocnpj\\r\\n)\\r\\n\\r\\nSELECT \\r\\n  cd.*,\\r\\n  COALESCE(mov.vl_entradas_metalmec, 0) AS vl_entradas_metalmec,\\r\\n  COALESCE(mov.vl_saidas_metalmec, 0) AS vl_saidas_metalmec,\\r\\n  COALESCE(mov.dias_movimento_metalmec, 0) AS dias_movimento_metalmec,\\r\\n  COALESCE(mov.qtde_ncm_distintos_metalmec, 0) AS qtde_ncm_distintos_metalmec,\\r\\n  COALESCE(mov.vl_cap84, 0) AS vl_capitulo_84,\\r\\n  COALESCE(mov.vl_cap85, 0) AS vl_capitulo_85,\\r\\n  \\r\\n  CASE \\r\\n    WHEN mov.vl_saidas_metalmec > 0 THEN \\r\\n      ROUND(100.0 * mov.vl_entradas_metalmec / NULLIF(mov.vl_saidas_metalmec, 0), 2)\\r\\n    ELSE 0 \\r\\n  END AS indice_entrada_saida_metalmec,\\r\\n  \\r\\n  CASE \\r\\n    WHEN mov.vl_entradas_metalmec > 0 THEN\\r\\n      ROUND(cd.saldo_credor_atual / NULLIF(mov.vl_entradas_metalmec, 0), 4)\\r\\n    ELSE 0\\r\\n  END AS indice_saldo_entrada_metalmec,\\r\\n  \\r\\n  CASE \\r\\n    WHEN (mov.vl_cap84 + mov.vl_cap85) > 0 THEN\\r\\n      ROUND(100.0 * mov.vl_cap84 / NULLIF(mov.vl_cap84 + mov.vl_cap85, 0), 2)\\r\\n    ELSE 0\\r\\n  END AS perc_cap84,\\r\\n  \\r\\n  CASE WHEN mov.nu_cnpj IS NOT NULL THEN 1 ELSE 0 END AS flag_setor_metalmec,\\r\\n  \\r\\n  'METAL-MEC\\u00c2NICO' AS setor\\r\\n  \\r\\nFROM teste.credito_dime_completo cd\\r\\nLEFT JOIN movimentacao_metalmec mov ON cd.nu_cnpj = mov.nu_cnpj;\"], \"aceSize\": 100, \"status\": \"available\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"DROP TABLE IF EXISTS teste.credito_dime_metalmec;\\r\\n\\r\\nCREATE TABLE teste.credito_dime_metalmec STORED AS PARQUET AS\\r\\nWITH movimentacao_metalmec AS (\\r\\n  SELECT \\r\\n    my_efd.codigocnpj AS nu_cnpj,\\r\\n    SUM(CASE WHEN c170.cfop BETWEEN 1000 AND 3999 THEN c170.vl_item ELSE 0 END) AS vl_entradas_metalmec,\\r\\n    SUM(CASE WHEN c170.cfop BETWEEN 5000 AND 7999 THEN c170.vl_item ELSE 0 END) AS vl_saidas_metalmec,\\r\\n    COUNT(DISTINCT c100.dt_doc) AS dias_movimento_metalmec,\\r\\n    COUNT(DISTINCT r0200.cod_ncm) AS qtde_ncm_distintos_metalmec,\\r\\n    SUM(CASE WHEN r0200.cod_ncm LIKE '84%' THEN c170.vl_item ELSE 0 END) AS vl_cap84,\\r\\n    SUM(CASE WHEN r0200.cod_ncm LIKE '85%' THEN c170.vl_item ELSE 0 END) AS vl_cap85\\r\\n  FROM \\r\\n    efd.efd my_efd\\r\\n  JOIN \\r\\n    efd.efd_rc100 c100 ON my_efd.id_file = c100.id_file,\\r\\n    c100.listarc170_itensdocumento c170\\r\\n  JOIN \\r\\n    efd.efd_r0200 r0200 ON c100.id_file = r0200.id_file \\r\\n                        AND c170.cod_item = r0200.cod_item\\r\\n  WHERE \\r\\n    (my_efd.ano_referencia = 2024 OR \\r\\n     (my_efd.ano_referencia = 2025 AND my_efd.mes_referencia <= 9))\\r\\n    AND (r0200.cod_ncm LIKE '84%' OR r0200.cod_ncm LIKE '85%')\\r\\n  GROUP BY \\r\\n    my_efd.codigocnpj\\r\\n)\\r\\n\\r\\nSELECT \\r\\n  cd.*,\\r\\n  COALESCE(mov.vl_entradas_metalmec, 0) AS vl_entradas_metalmec,\\r\\n  COALESCE(mov.vl_saidas_metalmec, 0) AS vl_saidas_metalmec,\\r\\n  COALESCE(mov.dias_movimento_metalmec, 0) AS dias_movimento_metalmec,\\r\\n  COALESCE(mov.qtde_ncm_distintos_metalmec, 0) AS qtde_ncm_distintos_metalmec,\\r\\n  COALESCE(mov.vl_cap84, 0) AS vl_capitulo_84,\\r\\n  COALESCE(mov.vl_cap85, 0) AS vl_capitulo_85,\\r\\n  \\r\\n  CASE \\r\\n    WHEN mov.vl_saidas_metalmec > 0 THEN \\r\\n      ROUND(100.0 * mov.vl_entradas_metalmec / NULLIF(mov.vl_saidas_metalmec, 0), 2)\\r\\n    ELSE 0 \\r\\n  END AS indice_entrada_saida_metalmec,\\r\\n  \\r\\n  CASE \\r\\n    WHEN mov.vl_entradas_metalmec > 0 THEN\\r\\n      ROUND(cd.saldo_credor_atual / NULLIF(mov.vl_entradas_metalmec, 0), 4)\\r\\n    ELSE 0\\r\\n  END AS indice_saldo_entrada_metalmec,\\r\\n  \\r\\n  CASE \\r\\n    WHEN (mov.vl_cap84 + mov.vl_cap85) > 0 THEN\\r\\n      ROUND(100.0 * mov.vl_cap84 / NULLIF(mov.vl_cap84 + mov.vl_cap85, 0), 2)\\r\\n    ELSE 0\\r\\n  END AS perc_cap84,\\r\\n  \\r\\n  CASE WHEN mov.nu_cnpj IS NOT NULL THEN 1 ELSE 0 END AS flag_setor_metalmec,\\r\\n  \\r\\n  'METAL-MEC\\u00c2NICO' AS setor\\r\\n  \\r\\nFROM teste.credito_dime_completo cd\\r\\nLEFT JOIN movimentacao_metalmec mov ON cd.nu_cnpj = mov.nu_cnpj;\", \"result\": {\"id\": \"c72bc54e-8210-e4dd-d510-4563398a7a61\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"AnIV/ChmR2GmjNZx5pr+Bw==\", \"guid\": \"9l7dqZHJTvMAAAAA9uv4LA==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"a14a96e02125e5fe:0e4a6eab4a1a89bd\", \"session_id\": 21447, \"session_type\": \"impala\", \"statement_id\": 1, \"has_more_statements\": false, \"statements_count\": 2, \"previous_statement_hash\": \"e639ff279313366d96fe7e0430d0c862a7359f00de0eb825cd7b0b06\", \"start\": {\"row\": 2, \"column\": 0}, \"end\": {\"row\": 60, \"column\": 63}, \"statement\": \"CREATE TABLE teste.credito_dime_metalmec STORED AS PARQUET AS\\nWITH movimentacao_metalmec AS (\\n  SELECT \\n    my_efd.codigocnpj AS nu_cnpj,\\n    SUM(CASE WHEN c170.cfop BETWEEN 1000 AND 3999 THEN c170.vl_item ELSE 0 END) AS vl_entradas_metalmec,\\n    SUM(CASE WHEN c170.cfop BETWEEN 5000 AND 7999 THEN c170.vl_item ELSE 0 END) AS vl_saidas_metalmec,\\n    COUNT(DISTINCT c100.dt_doc) AS dias_movimento_metalmec,\\n    COUNT(DISTINCT r0200.cod_ncm) AS qtde_ncm_distintos_metalmec,\\n    SUM(CASE WHEN r0200.cod_ncm LIKE '84%' THEN c170.vl_item ELSE 0 END) AS vl_cap84,\\n    SUM(CASE WHEN r0200.cod_ncm LIKE '85%' THEN c170.vl_item ELSE 0 END) AS vl_cap85\\n  FROM \\n    efd.efd my_efd\\n  JOIN \\n    efd.efd_rc100 c100 ON my_efd.id_file = c100.id_file,\\n    c100.listarc170_itensdocumento c170\\n  JOIN \\n    efd.efd_r0200 r0200 ON c100.id_file = r0200.id_file \\n                        AND c170.cod_item = r0200.cod_item\\n  WHERE \\n    (my_efd.ano_referencia = 2024 OR \\n     (my_efd.ano_referencia = 2025 AND my_efd.mes_referencia <= 9))\\n    AND (r0200.cod_ncm LIKE '84%' OR r0200.cod_ncm LIKE '85%')\\n  GROUP BY \\n    my_efd.codigocnpj\\n)\\n\\nSELECT \\n  cd.*,\\n  COALESCE(mov.vl_entradas_metalmec, 0) AS vl_entradas_metalmec,\\n  COALESCE(mov.vl_saidas_metalmec, 0) AS vl_saidas_metalmec,\\n  COALESCE(mov.dias_movimento_metalmec, 0) AS dias_movimento_metalmec,\\n  COALESCE(mov.qtde_ncm_distintos_metalmec, 0) AS qtde_ncm_distintos_metalmec,\\n  COALESCE(mov.vl_cap84, 0) AS vl_capitulo_84,\\n  COALESCE(mov.vl_cap85, 0) AS vl_capitulo_85,\\n  \\n  CASE \\n    WHEN mov.vl_saidas_metalmec > 0 THEN \\n      ROUND(100.0 * mov.vl_entradas_metalmec / NULLIF(mov.vl_saidas_metalmec, 0), 2)\\n    ELSE 0 \\n  END AS indice_entrada_saida_metalmec,\\n  \\n  CASE \\n    WHEN mov.vl_entradas_metalmec > 0 THEN\\n      ROUND(cd.saldo_credor_atual / NULLIF(mov.vl_entradas_metalmec, 0), 4)\\n    ELSE 0\\n  END AS indice_saldo_entrada_metalmec,\\n  \\n  CASE \\n    WHEN (mov.vl_cap84 + mov.vl_cap85) > 0 THEN\\n      ROUND(100.0 * mov.vl_cap84 / NULLIF(mov.vl_cap84 + mov.vl_cap85, 0), 2)\\n    ELSE 0\\n  END AS perc_cap84,\\n  \\n  CASE WHEN mov.nu_cnpj IS NOT NULL THEN 1 ELSE 0 END AS flag_setor_metalmec,\\n  \\n  'METAL-MEC\\u00c2NICO' AS setor\\n  \\nFROM teste.credito_dime_completo cd\\nLEFT JOIN movimentacao_metalmec mov ON cd.nu_cnpj = mov.nu_cnpj\"}, \"meta\": [], \"rows\": \"1\", \"hasMore\": false, \"statement_id\": 1, \"statement_range\": {\"start\": {\"row\": 2, \"column\": 0}, \"end\": {\"row\": 60, \"column\": 63}}, \"statements_count\": 2, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": 1, \"filteredMeta\": [{\"type\": \"int\", \"name\": \"\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 0}, {\"name\": \"summary\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 1}], \"fetchedOnce\": false, \"startTime\": \"2025-10-11T03:44:29.921Z\", \"endTime\": \"2025-10-11T03:47:55.843Z\", \"executionTime\": 205922, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 53, \"hasSomeResults\": true}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": 1190, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": \"summary\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": false, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"summary\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": 4843, \"getLogsTimeout\": 5492, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1760154269496, \"lastAceSelectionRowOffset\": 0, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"lastExecutedStatements\": \"DROP TABLE IF EXISTS teste.credito_dime_metalmec;\\r\\n\\r\\nCREATE TABLE teste.credito_dime_metalmec STORED AS PARQUET AS\\r\\nWITH movimentacao_metalmec AS (\\r\\n  SELECT \\r\\n    my_efd.codigocnpj AS nu_cnpj,\\r\\n    SUM(CASE WHEN c170.cfop BETWEEN 1000 AND 3999 THEN c170.vl_item ELSE 0 END) AS vl_entradas_metalmec,\\r\\n    SUM(CASE WHEN c170.cfop BETWEEN 5000 AND 7999 THEN c170.vl_item ELSE 0 END) AS vl_saidas_metalmec,\\r\\n    COUNT(DISTINCT c100.dt_doc) AS dias_movimento_metalmec,\\r\\n    COUNT(DISTINCT r0200.cod_ncm) AS qtde_ncm_distintos_metalmec,\\r\\n    SUM(CASE WHEN r0200.cod_ncm LIKE '84%' THEN c170.vl_item ELSE 0 END) AS vl_cap84,\\r\\n    SUM(CASE WHEN r0200.cod_ncm LIKE '85%' THEN c170.vl_item ELSE 0 END) AS vl_cap85\\r\\n  FROM \\r\\n    efd.efd my_efd\\r\\n  JOIN \\r\\n    efd.efd_rc100 c100 ON my_efd.id_file = c100.id_file,\\r\\n    c100.listarc170_itensdocumento c170\\r\\n  JOIN \\r\\n    efd.efd_r0200 r0200 ON c100.id_file = r0200.id_file \\r\\n                        AND c170.cod_item = r0200.cod_item\\r\\n  WHERE \\r\\n    (my_efd.ano_referencia = 2024 OR \\r\\n     (my_efd.ano_referencia = 2025 AND my_efd.mes_referencia <= 9))\\r\\n    AND (r0200.cod_ncm LIKE '84%' OR r0200.cod_ncm LIKE '85%')\\r\\n  GROUP BY \\r\\n    my_efd.codigocnpj\\r\\n)\\r\\n\\r\\nSELECT \\r\\n  cd.*,\\r\\n  COALESCE(mov.vl_entradas_metalmec, 0) AS vl_entradas_metalmec,\\r\\n  COALESCE(mov.vl_saidas_metalmec, 0) AS vl_saidas_metalmec,\\r\\n  COALESCE(mov.dias_movimento_metalmec, 0) AS dias_movimento_metalmec,\\r\\n  COALESCE(mov.qtde_ncm_distintos_metalmec, 0) AS qtde_ncm_distintos_metalmec,\\r\\n  COALESCE(mov.vl_cap84, 0) AS vl_capitulo_84,\\r\\n  COALESCE(mov.vl_cap85, 0) AS vl_capitulo_85,\\r\\n  \\r\\n  CASE \\r\\n    WHEN mov.vl_saidas_metalmec > 0 THEN \\r\\n      ROUND(100.0 * mov.vl_entradas_metalmec / NULLIF(mov.vl_saidas_metalmec, 0), 2)\\r\\n    ELSE 0 \\r\\n  END AS indice_entrada_saida_metalmec,\\r\\n  \\r\\n  CASE \\r\\n    WHEN mov.vl_entradas_metalmec > 0 THEN\\r\\n      ROUND(cd.saldo_credor_atual / NULLIF(mov.vl_entradas_metalmec, 0), 4)\\r\\n    ELSE 0\\r\\n  END AS indice_saldo_entrada_metalmec,\\r\\n  \\r\\n  CASE \\r\\n    WHEN (mov.vl_cap84 + mov.vl_cap85) > 0 THEN\\r\\n      ROUND(100.0 * mov.vl_cap84 / NULLIF(mov.vl_cap84 + mov.vl_cap85, 0), 2)\\r\\n    ELSE 0\\r\\n  END AS perc_cap84,\\r\\n  \\r\\n  CASE WHEN mov.nu_cnpj IS NOT NULL THEN 1 ELSE 0 END AS flag_setor_metalmec,\\r\\n  \\r\\n  'METAL-MEC\\u00c2NICO' AS setor\\r\\n  \\r\\nFROM teste.credito_dime_completo cd\\r\\nLEFT JOIN movimentacao_metalmec mov ON cd.nu_cnpj = mov.nu_cnpj;\", \"lastExecutedSelectionRange\": {\"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 60, \"column\": 64}}, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"lastCheckStatusRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"query_status\\\": {\\\"status\\\": \\\"available\\\"}}\", \"responseJSON\": {\"status\": 0, \"query_status\": {\"status\": \"available\"}}, \"status\": 200, \"statusText\": \"OK\"}, \"lastGetLogsRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"logs\\\": \\\"Query f34ec991a9dd5ef6:2cf8ebf600000000 100% Complete (8505 out of 8505)\\\", \\\"progress\\\": 100, \\\"jobs\\\": [{\\\"name\\\": \\\"f34ec991a9dd5ef6:2cf8ebf600000000\\\", \\\"url\\\": \\\"/hue/jobbrowser#!id=f34ec991a9dd5ef6:2cf8ebf600000000\\\", \\\"started\\\": true, \\\"finished\\\": false, \\\"percentJob\\\": 100}], \\\"isFullLogs\\\": false}\", \"responseJSON\": {\"status\": 0, \"logs\": \"Query f34ec991a9dd5ef6:2cf8ebf600000000 100% Complete (8505 out of 8505)\", \"progress\": 100, \"jobs\": [{\"name\": \"f34ec991a9dd5ef6:2cf8ebf600000000\", \"url\": \"/hue/jobbrowser#!id=f34ec991a9dd5ef6:2cf8ebf600000000\", \"started\": true, \"finished\": false, \"percentJob\": 100}], \"isFullLogs\": false}, \"status\": 200, \"statusText\": \"OK\"}}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 7125, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 123, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": true, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "DROP TABLE IF EXISTS teste.credito_dime_metalmec;\r\n\r\nCREATE TABLE teste.credito_dime_metalmec STORED AS PARQUET AS\r\nWITH movimentacao_metalmec AS (\r\n  SELECT \r\n    my_efd.codigocnpj AS nu_cnpj,\r\n    SUM(CASE WHEN c170.cfop BETWEEN 1000 AND 3999 THEN c170.vl_item ELSE 0 END) AS vl_entradas_metalmec,\r\n    SUM(CASE WHEN c170.cfop BETWEEN 5000 AND 7999 THEN c170.vl_item ELSE 0 END) AS vl_saidas_metalmec,\r\n    COUNT(DISTINCT c100.dt_doc) AS dias_movimento_metalmec,\r\n    COUNT(DISTINCT r0200.cod_ncm) AS qtde_ncm_distintos_metalmec,\r\n    SUM(CASE WHEN r0200.cod_ncm LIKE '84%' THEN c170.vl_item ELSE 0 END) AS vl_cap84,\r\n    SUM(CASE WHEN r0200.cod_ncm LIKE '85%' THEN c170.vl_item ELSE 0 END) AS vl_cap85\r\n  FROM \r\n    efd.efd my_efd\r\n  JOIN \r\n    efd.efd_rc100 c100 ON my_efd.id_file = c100.id_file,\r\n    c100.listarc170_itensdocumento c170\r\n  JOIN \r\n    efd.efd_r0200 r0200 ON c100.id_file = r0200.id_file \r\n                        AND c170.cod_item = r0200.cod_item\r\n  WHERE \r\n    (my_efd.ano_referencia = 2024 OR \r\n     (my_efd.ano_referencia = 2025 AND my_efd.mes_referencia <= 9))\r\n    AND (r0200.cod_ncm LIKE '84%' OR r0200.cod_ncm LIKE '85%')\r\n  GROUP BY \r\n    my_efd.codigocnpj\r\n)\r\n\r\nSELECT \r\n  cd.*,\r\n  COALESCE(mov.vl_entradas_metalmec, 0) AS vl_entradas_metalmec,\r\n  COALESCE(mov.vl_saidas_metalmec, 0) AS vl_saidas_metalmec,\r\n  COALESCE(mov.dias_movimento_metalmec, 0) AS dias_movimento_metalmec,\r\n  COALESCE(mov.qtde_ncm_distintos_metalmec, 0) AS qtde_ncm_distintos_metalmec,\r\n  COALESCE(mov.vl_cap84, 0) AS vl_capitulo_84,\r\n  COALESCE(mov.vl_cap85, 0) AS vl_capitulo_85,\r\n  \r\n  CASE \r\n    WHEN mov.vl_saidas_metalmec > 0 THEN \r\n      ROUND(100.0 * mov.vl_entradas_metalmec / NULLIF(mov.vl_saidas_metalmec, 0), 2)\r\n    ELSE 0 \r\n  END AS indice_entrada_saida_metalmec,\r\n  \r\n  CASE \r\n    WHEN mov.vl_entradas_metalmec > 0 THEN\r\n      ROUND(cd.saldo_credor_atual / NULLIF(mov.vl_entradas_metalmec, 0), 4)\r\n    ELSE 0\r\n  END AS indice_saldo_entrada_metalmec,\r\n  \r\n  CASE \r\n    WHEN (mov.vl_",
    "last_modified": "2025-10-11T00:48:06.593",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "98247874-ca8f-489a-b757-bbfeafccd369",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 162765,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "DIME CRED EFD: 4 Tech",
    "description": "",
    "uuid": "096ebce6-05b2-bcef-0b2b-b8311261d660",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 162765, \"uuid\": \"7f4be45c-373a-4689-9519-c1d7f648b195\", \"name\": \"DIME CRED EFD: 4 Tech\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": \"096ebce6-05b2-bcef-0b2b-b8311261d660\", \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"30a2e031-a075-14fb-2741-6765f0b000e0\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": {\"row\": 56, \"column\": 60}, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": true, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"default\", \"currentQueryTab\": \"queryResults\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 1, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"DROP TABLE IF EXISTS teste.credito_dime_tech;\\r\\n\\r\\nCREATE TABLE teste.credito_dime_tech STORED AS PARQUET AS\\r\\nWITH movimentacao_tech AS (\\r\\n  SELECT \\r\\n    my_efd.codigocnpj AS nu_cnpj,\\r\\n    SUM(CASE WHEN c170.cfop BETWEEN 1000 AND 3999 THEN c170.vl_item ELSE 0 END) AS vl_entradas_tech,\\r\\n    SUM(CASE WHEN c170.cfop BETWEEN 5000 AND 7999 THEN c170.vl_item ELSE 0 END) AS vl_saidas_tech,\\r\\n    COUNT(DISTINCT c100.dt_doc) AS dias_movimento_tech,\\r\\n    COUNT(DISTINCT r0200.cod_ncm) AS qtde_ncm_distintos_tech,\\r\\n    SUM(CASE WHEN r0200.cod_ncm LIKE '8471%' THEN c170.vl_item ELSE 0 END) AS vl_computadores,\\r\\n    SUM(CASE WHEN r0200.cod_ncm LIKE '8473%' THEN c170.vl_item ELSE 0 END) AS vl_partes_computadores,\\r\\n    SUM(CASE WHEN r0200.cod_ncm LIKE '8517%' THEN c170.vl_item ELSE 0 END) AS vl_telecom\\r\\n  FROM \\r\\n    efd.efd my_efd\\r\\n  JOIN \\r\\n    efd.efd_rc100 c100 ON my_efd.id_file = c100.id_file,\\r\\n    c100.listarc170_itensdocumento c170\\r\\n  JOIN \\r\\n    efd.efd_r0200 r0200 ON c100.id_file = r0200.id_file \\r\\n                        AND c170.cod_item = r0200.cod_item\\r\\n  WHERE \\r\\n    (my_efd.ano_referencia = 2024 OR \\r\\n     (my_efd.ano_referencia = 2025 AND my_efd.mes_referencia <= 9))\\r\\n    AND (r0200.cod_ncm LIKE '8471%' OR r0200.cod_ncm LIKE '8473%' OR r0200.cod_ncm LIKE '8517%')\\r\\n  GROUP BY \\r\\n    my_efd.codigocnpj\\r\\n)\\r\\n\\r\\nSELECT \\r\\n  cd.*,\\r\\n  COALESCE(mov.vl_entradas_tech, 0) AS vl_entradas_tech,\\r\\n  COALESCE(mov.vl_saidas_tech, 0) AS vl_saidas_tech,\\r\\n  COALESCE(mov.dias_movimento_tech, 0) AS dias_movimento_tech,\\r\\n  COALESCE(mov.qtde_ncm_distintos_tech, 0) AS qtde_ncm_distintos_tech,\\r\\n  COALESCE(mov.vl_computadores, 0) AS vl_computadores,\\r\\n  COALESCE(mov.vl_partes_computadores, 0) AS vl_partes_computadores,\\r\\n  COALESCE(mov.vl_telecom, 0) AS vl_telecom,\\r\\n  \\r\\n  CASE \\r\\n    WHEN mov.vl_saidas_tech > 0 THEN \\r\\n      ROUND(100.0 * mov.vl_entradas_tech / NULLIF(mov.vl_saidas_tech, 0), 2)\\r\\n    ELSE 0 \\r\\n  END AS indice_entrada_saida_tech,\\r\\n  \\r\\n  CASE \\r\\n    WHEN mov.vl_entradas_tech > 0 THEN\\r\\n      ROUND(cd.saldo_credor_atual / NULLIF(mov.vl_entradas_tech, 0), 4)\\r\\n    ELSE 0\\r\\n  END AS indice_saldo_entrada_tech,\\r\\n  \\r\\n  CASE WHEN mov.nu_cnpj IS NOT NULL THEN 1 ELSE 0 END AS flag_setor_tech,\\r\\n  \\r\\n  'TECNOLOGIA' AS setor\\r\\n  \\r\\nFROM teste.credito_dime_completo cd\\r\\nLEFT JOIN movimentacao_tech mov ON cd.nu_cnpj = mov.nu_cnpj;\", \"statementsList\": [\"DROP TABLE IF EXISTS teste.credito_dime_tech;\", \"\\r\\n\\r\\nCREATE TABLE teste.credito_dime_tech STORED AS PARQUET AS\\r\\nWITH movimentacao_tech AS (\\r\\n  SELECT \\r\\n    my_efd.codigocnpj AS nu_cnpj,\\r\\n    SUM(CASE WHEN c170.cfop BETWEEN 1000 AND 3999 THEN c170.vl_item ELSE 0 END) AS vl_entradas_tech,\\r\\n    SUM(CASE WHEN c170.cfop BETWEEN 5000 AND 7999 THEN c170.vl_item ELSE 0 END) AS vl_saidas_tech,\\r\\n    COUNT(DISTINCT c100.dt_doc) AS dias_movimento_tech,\\r\\n    COUNT(DISTINCT r0200.cod_ncm) AS qtde_ncm_distintos_tech,\\r\\n    SUM(CASE WHEN r0200.cod_ncm LIKE '8471%' THEN c170.vl_item ELSE 0 END) AS vl_computadores,\\r\\n    SUM(CASE WHEN r0200.cod_ncm LIKE '8473%' THEN c170.vl_item ELSE 0 END) AS vl_partes_computadores,\\r\\n    SUM(CASE WHEN r0200.cod_ncm LIKE '8517%' THEN c170.vl_item ELSE 0 END) AS vl_telecom\\r\\n  FROM \\r\\n    efd.efd my_efd\\r\\n  JOIN \\r\\n    efd.efd_rc100 c100 ON my_efd.id_file = c100.id_file,\\r\\n    c100.listarc170_itensdocumento c170\\r\\n  JOIN \\r\\n    efd.efd_r0200 r0200 ON c100.id_file = r0200.id_file \\r\\n                        AND c170.cod_item = r0200.cod_item\\r\\n  WHERE \\r\\n    (my_efd.ano_referencia = 2024 OR \\r\\n     (my_efd.ano_referencia = 2025 AND my_efd.mes_referencia <= 9))\\r\\n    AND (r0200.cod_ncm LIKE '8471%' OR r0200.cod_ncm LIKE '8473%' OR r0200.cod_ncm LIKE '8517%')\\r\\n  GROUP BY \\r\\n    my_efd.codigocnpj\\r\\n)\\r\\n\\r\\nSELECT \\r\\n  cd.*,\\r\\n  COALESCE(mov.vl_entradas_tech, 0) AS vl_entradas_tech,\\r\\n  COALESCE(mov.vl_saidas_tech, 0) AS vl_saidas_tech,\\r\\n  COALESCE(mov.dias_movimento_tech, 0) AS dias_movimento_tech,\\r\\n  COALESCE(mov.qtde_ncm_distintos_tech, 0) AS qtde_ncm_distintos_tech,\\r\\n  COALESCE(mov.vl_computadores, 0) AS vl_computadores,\\r\\n  COALESCE(mov.vl_partes_computadores, 0) AS vl_partes_computadores,\\r\\n  COALESCE(mov.vl_telecom, 0) AS vl_telecom,\\r\\n  \\r\\n  CASE \\r\\n    WHEN mov.vl_saidas_tech > 0 THEN \\r\\n      ROUND(100.0 * mov.vl_entradas_tech / NULLIF(mov.vl_saidas_tech, 0), 2)\\r\\n    ELSE 0 \\r\\n  END AS indice_entrada_saida_tech,\\r\\n  \\r\\n  CASE \\r\\n    WHEN mov.vl_entradas_tech > 0 THEN\\r\\n      ROUND(cd.saldo_credor_atual / NULLIF(mov.vl_entradas_tech, 0), 4)\\r\\n    ELSE 0\\r\\n  END AS indice_saldo_entrada_tech,\\r\\n  \\r\\n  CASE WHEN mov.nu_cnpj IS NOT NULL THEN 1 ELSE 0 END AS flag_setor_tech,\\r\\n  \\r\\n  'TECNOLOGIA' AS setor\\r\\n  \\r\\nFROM teste.credito_dime_completo cd\\r\\nLEFT JOIN movimentacao_tech mov ON cd.nu_cnpj = mov.nu_cnpj;\"], \"aceSize\": 100, \"status\": \"available\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"DROP TABLE IF EXISTS teste.credito_dime_tech;\\r\\n\\r\\nCREATE TABLE teste.credito_dime_tech STORED AS PARQUET AS\\r\\nWITH movimentacao_tech AS (\\r\\n  SELECT \\r\\n    my_efd.codigocnpj AS nu_cnpj,\\r\\n    SUM(CASE WHEN c170.cfop BETWEEN 1000 AND 3999 THEN c170.vl_item ELSE 0 END) AS vl_entradas_tech,\\r\\n    SUM(CASE WHEN c170.cfop BETWEEN 5000 AND 7999 THEN c170.vl_item ELSE 0 END) AS vl_saidas_tech,\\r\\n    COUNT(DISTINCT c100.dt_doc) AS dias_movimento_tech,\\r\\n    COUNT(DISTINCT r0200.cod_ncm) AS qtde_ncm_distintos_tech,\\r\\n    SUM(CASE WHEN r0200.cod_ncm LIKE '8471%' THEN c170.vl_item ELSE 0 END) AS vl_computadores,\\r\\n    SUM(CASE WHEN r0200.cod_ncm LIKE '8473%' THEN c170.vl_item ELSE 0 END) AS vl_partes_computadores,\\r\\n    SUM(CASE WHEN r0200.cod_ncm LIKE '8517%' THEN c170.vl_item ELSE 0 END) AS vl_telecom\\r\\n  FROM \\r\\n    efd.efd my_efd\\r\\n  JOIN \\r\\n    efd.efd_rc100 c100 ON my_efd.id_file = c100.id_file,\\r\\n    c100.listarc170_itensdocumento c170\\r\\n  JOIN \\r\\n    efd.efd_r0200 r0200 ON c100.id_file = r0200.id_file \\r\\n                        AND c170.cod_item = r0200.cod_item\\r\\n  WHERE \\r\\n    (my_efd.ano_referencia = 2024 OR \\r\\n     (my_efd.ano_referencia = 2025 AND my_efd.mes_referencia <= 9))\\r\\n    AND (r0200.cod_ncm LIKE '8471%' OR r0200.cod_ncm LIKE '8473%' OR r0200.cod_ncm LIKE '8517%')\\r\\n  GROUP BY \\r\\n    my_efd.codigocnpj\\r\\n)\\r\\n\\r\\nSELECT \\r\\n  cd.*,\\r\\n  COALESCE(mov.vl_entradas_tech, 0) AS vl_entradas_tech,\\r\\n  COALESCE(mov.vl_saidas_tech, 0) AS vl_saidas_tech,\\r\\n  COALESCE(mov.dias_movimento_tech, 0) AS dias_movimento_tech,\\r\\n  COALESCE(mov.qtde_ncm_distintos_tech, 0) AS qtde_ncm_distintos_tech,\\r\\n  COALESCE(mov.vl_computadores, 0) AS vl_computadores,\\r\\n  COALESCE(mov.vl_partes_computadores, 0) AS vl_partes_computadores,\\r\\n  COALESCE(mov.vl_telecom, 0) AS vl_telecom,\\r\\n  \\r\\n  CASE \\r\\n    WHEN mov.vl_saidas_tech > 0 THEN \\r\\n      ROUND(100.0 * mov.vl_entradas_tech / NULLIF(mov.vl_saidas_tech, 0), 2)\\r\\n    ELSE 0 \\r\\n  END AS indice_entrada_saida_tech,\\r\\n  \\r\\n  CASE \\r\\n    WHEN mov.vl_entradas_tech > 0 THEN\\r\\n      ROUND(cd.saldo_credor_atual / NULLIF(mov.vl_entradas_tech, 0), 4)\\r\\n    ELSE 0\\r\\n  END AS indice_saldo_entrada_tech,\\r\\n  \\r\\n  CASE WHEN mov.nu_cnpj IS NOT NULL THEN 1 ELSE 0 END AS flag_setor_tech,\\r\\n  \\r\\n  'TECNOLOGIA' AS setor\\r\\n  \\r\\nFROM teste.credito_dime_completo cd\\r\\nLEFT JOIN movimentacao_tech mov ON cd.nu_cnpj = mov.nu_cnpj;\", \"result\": {\"id\": \"b8b01c36-998f-2e3e-4836-6b49427acc06\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"AnIV/ChmR2GmjNZx5pr+Bw==\", \"guid\": \"sqty9pxhSRAAAAAAWGQuJQ==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"a14a96e02125e5fe:0e4a6eab4a1a89bd\", \"session_id\": 21447, \"session_type\": \"impala\", \"statement_id\": 1, \"has_more_statements\": false, \"statements_count\": 2, \"previous_statement_hash\": \"9660b59c5fb82dc4f7e1297bb225f4641d8cf44b1a1c6cf8858955bb\", \"start\": {\"row\": 2, \"column\": 0}, \"end\": {\"row\": 56, \"column\": 59}, \"statement\": \"CREATE TABLE teste.credito_dime_tech STORED AS PARQUET AS\\nWITH movimentacao_tech AS (\\n  SELECT \\n    my_efd.codigocnpj AS nu_cnpj,\\n    SUM(CASE WHEN c170.cfop BETWEEN 1000 AND 3999 THEN c170.vl_item ELSE 0 END) AS vl_entradas_tech,\\n    SUM(CASE WHEN c170.cfop BETWEEN 5000 AND 7999 THEN c170.vl_item ELSE 0 END) AS vl_saidas_tech,\\n    COUNT(DISTINCT c100.dt_doc) AS dias_movimento_tech,\\n    COUNT(DISTINCT r0200.cod_ncm) AS qtde_ncm_distintos_tech,\\n    SUM(CASE WHEN r0200.cod_ncm LIKE '8471%' THEN c170.vl_item ELSE 0 END) AS vl_computadores,\\n    SUM(CASE WHEN r0200.cod_ncm LIKE '8473%' THEN c170.vl_item ELSE 0 END) AS vl_partes_computadores,\\n    SUM(CASE WHEN r0200.cod_ncm LIKE '8517%' THEN c170.vl_item ELSE 0 END) AS vl_telecom\\n  FROM \\n    efd.efd my_efd\\n  JOIN \\n    efd.efd_rc100 c100 ON my_efd.id_file = c100.id_file,\\n    c100.listarc170_itensdocumento c170\\n  JOIN \\n    efd.efd_r0200 r0200 ON c100.id_file = r0200.id_file \\n                        AND c170.cod_item = r0200.cod_item\\n  WHERE \\n    (my_efd.ano_referencia = 2024 OR \\n     (my_efd.ano_referencia = 2025 AND my_efd.mes_referencia <= 9))\\n    AND (r0200.cod_ncm LIKE '8471%' OR r0200.cod_ncm LIKE '8473%' OR r0200.cod_ncm LIKE '8517%')\\n  GROUP BY \\n    my_efd.codigocnpj\\n)\\n\\nSELECT \\n  cd.*,\\n  COALESCE(mov.vl_entradas_tech, 0) AS vl_entradas_tech,\\n  COALESCE(mov.vl_saidas_tech, 0) AS vl_saidas_tech,\\n  COALESCE(mov.dias_movimento_tech, 0) AS dias_movimento_tech,\\n  COALESCE(mov.qtde_ncm_distintos_tech, 0) AS qtde_ncm_distintos_tech,\\n  COALESCE(mov.vl_computadores, 0) AS vl_computadores,\\n  COALESCE(mov.vl_partes_computadores, 0) AS vl_partes_computadores,\\n  COALESCE(mov.vl_telecom, 0) AS vl_telecom,\\n  \\n  CASE \\n    WHEN mov.vl_saidas_tech > 0 THEN \\n      ROUND(100.0 * mov.vl_entradas_tech / NULLIF(mov.vl_saidas_tech, 0), 2)\\n    ELSE 0 \\n  END AS indice_entrada_saida_tech,\\n  \\n  CASE \\n    WHEN mov.vl_entradas_tech > 0 THEN\\n      ROUND(cd.saldo_credor_atual / NULLIF(mov.vl_entradas_tech, 0), 4)\\n    ELSE 0\\n  END AS indice_saldo_entrada_tech,\\n  \\n  CASE WHEN mov.nu_cnpj IS NOT NULL THEN 1 ELSE 0 END AS flag_setor_tech,\\n  \\n  'TECNOLOGIA' AS setor\\n  \\nFROM teste.credito_dime_completo cd\\nLEFT JOIN movimentacao_tech mov ON cd.nu_cnpj = mov.nu_cnpj\"}, \"meta\": [], \"rows\": \"1\", \"hasMore\": false, \"statement_id\": 1, \"statement_range\": {\"start\": {\"row\": 2, \"column\": 0}, \"end\": {\"row\": 56, \"column\": 59}}, \"statements_count\": 2, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": 1, \"filteredMeta\": [{\"type\": \"int\", \"name\": \"\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 0}, {\"name\": \"summary\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 1}], \"fetchedOnce\": false, \"startTime\": \"2025-10-11T03:48:19.885Z\", \"endTime\": \"2025-10-11T03:48:49.190Z\", \"executionTime\": 29305, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 18, \"hasSomeResults\": true}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": 1351, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": \"summary\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": false, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"summary\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": 1580, \"getLogsTimeout\": 1613, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1760154499389, \"lastAceSelectionRowOffset\": 0, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"lastExecutedStatements\": \"DROP TABLE IF EXISTS teste.credito_dime_tech;\\r\\n\\r\\nCREATE TABLE teste.credito_dime_tech STORED AS PARQUET AS\\r\\nWITH movimentacao_tech AS (\\r\\n  SELECT \\r\\n    my_efd.codigocnpj AS nu_cnpj,\\r\\n    SUM(CASE WHEN c170.cfop BETWEEN 1000 AND 3999 THEN c170.vl_item ELSE 0 END) AS vl_entradas_tech,\\r\\n    SUM(CASE WHEN c170.cfop BETWEEN 5000 AND 7999 THEN c170.vl_item ELSE 0 END) AS vl_saidas_tech,\\r\\n    COUNT(DISTINCT c100.dt_doc) AS dias_movimento_tech,\\r\\n    COUNT(DISTINCT r0200.cod_ncm) AS qtde_ncm_distintos_tech,\\r\\n    SUM(CASE WHEN r0200.cod_ncm LIKE '8471%' THEN c170.vl_item ELSE 0 END) AS vl_computadores,\\r\\n    SUM(CASE WHEN r0200.cod_ncm LIKE '8473%' THEN c170.vl_item ELSE 0 END) AS vl_partes_computadores,\\r\\n    SUM(CASE WHEN r0200.cod_ncm LIKE '8517%' THEN c170.vl_item ELSE 0 END) AS vl_telecom\\r\\n  FROM \\r\\n    efd.efd my_efd\\r\\n  JOIN \\r\\n    efd.efd_rc100 c100 ON my_efd.id_file = c100.id_file,\\r\\n    c100.listarc170_itensdocumento c170\\r\\n  JOIN \\r\\n    efd.efd_r0200 r0200 ON c100.id_file = r0200.id_file \\r\\n                        AND c170.cod_item = r0200.cod_item\\r\\n  WHERE \\r\\n    (my_efd.ano_referencia = 2024 OR \\r\\n     (my_efd.ano_referencia = 2025 AND my_efd.mes_referencia <= 9))\\r\\n    AND (r0200.cod_ncm LIKE '8471%' OR r0200.cod_ncm LIKE '8473%' OR r0200.cod_ncm LIKE '8517%')\\r\\n  GROUP BY \\r\\n    my_efd.codigocnpj\\r\\n)\\r\\n\\r\\nSELECT \\r\\n  cd.*,\\r\\n  COALESCE(mov.vl_entradas_tech, 0) AS vl_entradas_tech,\\r\\n  COALESCE(mov.vl_saidas_tech, 0) AS vl_saidas_tech,\\r\\n  COALESCE(mov.dias_movimento_tech, 0) AS dias_movimento_tech,\\r\\n  COALESCE(mov.qtde_ncm_distintos_tech, 0) AS qtde_ncm_distintos_tech,\\r\\n  COALESCE(mov.vl_computadores, 0) AS vl_computadores,\\r\\n  COALESCE(mov.vl_partes_computadores, 0) AS vl_partes_computadores,\\r\\n  COALESCE(mov.vl_telecom, 0) AS vl_telecom,\\r\\n  \\r\\n  CASE \\r\\n    WHEN mov.vl_saidas_tech > 0 THEN \\r\\n      ROUND(100.0 * mov.vl_entradas_tech / NULLIF(mov.vl_saidas_tech, 0), 2)\\r\\n    ELSE 0 \\r\\n  END AS indice_entrada_saida_tech,\\r\\n  \\r\\n  CASE \\r\\n    WHEN mov.vl_entradas_tech > 0 THEN\\r\\n      ROUND(cd.saldo_credor_atual / NULLIF(mov.vl_entradas_tech, 0), 4)\\r\\n    ELSE 0\\r\\n  END AS indice_saldo_entrada_tech,\\r\\n  \\r\\n  CASE WHEN mov.nu_cnpj IS NOT NULL THEN 1 ELSE 0 END AS flag_setor_tech,\\r\\n  \\r\\n  'TECNOLOGIA' AS setor\\r\\n  \\r\\nFROM teste.credito_dime_completo cd\\r\\nLEFT JOIN movimentacao_tech mov ON cd.nu_cnpj = mov.nu_cnpj;\", \"lastExecutedSelectionRange\": {\"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 56, \"column\": 60}}, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"lastCheckStatusRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"query_status\\\": {\\\"status\\\": \\\"available\\\"}}\", \"responseJSON\": {\"status\": 0, \"query_status\": {\"status\": \"available\"}}, \"status\": 200, \"statusText\": \"OK\"}, \"lastGetLogsRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"logs\\\": \\\"Query 1049619cf672abb2:252e645800000000 100% Complete (8505 out of 8505)\\\", \\\"progress\\\": 100, \\\"jobs\\\": [{\\\"name\\\": \\\"1049619cf672abb2:252e645800000000\\\", \\\"url\\\": \\\"/hue/jobbrowser#!id=1049619cf672abb2:252e645800000000\\\", \\\"started\\\": true, \\\"finished\\\": false, \\\"percentJob\\\": 100}], \\\"isFullLogs\\\": false}\", \"responseJSON\": {\"status\": 0, \"logs\": \"Query 1049619cf672abb2:252e645800000000 100% Complete (8505 out of 8505)\", \"progress\": 100, \"jobs\": [{\"name\": \"1049619cf672abb2:252e645800000000\", \"url\": \"/hue/jobbrowser#!id=1049619cf672abb2:252e645800000000\", \"started\": true, \"finished\": false, \"percentJob\": 100}], \"isFullLogs\": false}, \"status\": 200, \"statusText\": \"OK\"}}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 7388, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 123, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": true, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "DROP TABLE IF EXISTS teste.credito_dime_tech;\r\n\r\nCREATE TABLE teste.credito_dime_tech STORED AS PARQUET AS\r\nWITH movimentacao_tech AS (\r\n  SELECT \r\n    my_efd.codigocnpj AS nu_cnpj,\r\n    SUM(CASE WHEN c170.cfop BETWEEN 1000 AND 3999 THEN c170.vl_item ELSE 0 END) AS vl_entradas_tech,\r\n    SUM(CASE WHEN c170.cfop BETWEEN 5000 AND 7999 THEN c170.vl_item ELSE 0 END) AS vl_saidas_tech,\r\n    COUNT(DISTINCT c100.dt_doc) AS dias_movimento_tech,\r\n    COUNT(DISTINCT r0200.cod_ncm) AS qtde_ncm_distintos_tech,\r\n    SUM(CASE WHEN r0200.cod_ncm LIKE '8471%' THEN c170.vl_item ELSE 0 END) AS vl_computadores,\r\n    SUM(CASE WHEN r0200.cod_ncm LIKE '8473%' THEN c170.vl_item ELSE 0 END) AS vl_partes_computadores,\r\n    SUM(CASE WHEN r0200.cod_ncm LIKE '8517%' THEN c170.vl_item ELSE 0 END) AS vl_telecom\r\n  FROM \r\n    efd.efd my_efd\r\n  JOIN \r\n    efd.efd_rc100 c100 ON my_efd.id_file = c100.id_file,\r\n    c100.listarc170_itensdocumento c170\r\n  JOIN \r\n    efd.efd_r0200 r0200 ON c100.id_file = r0200.id_file \r\n                        AND c170.cod_item = r0200.cod_item\r\n  WHERE \r\n    (my_efd.ano_referencia = 2024 OR \r\n     (my_efd.ano_referencia = 2025 AND my_efd.mes_referencia <= 9))\r\n    AND (r0200.cod_ncm LIKE '8471%' OR r0200.cod_ncm LIKE '8473%' OR r0200.cod_ncm LIKE '8517%')\r\n  GROUP BY \r\n    my_efd.codigocnpj\r\n)\r\n\r\nSELECT \r\n  cd.*,\r\n  COALESCE(mov.vl_entradas_tech, 0) AS vl_entradas_tech,\r\n  COALESCE(mov.vl_saidas_tech, 0) AS vl_saidas_tech,\r\n  COALESCE(mov.dias_movimento_tech, 0) AS dias_movimento_tech,\r\n  COALESCE(mov.qtde_ncm_distintos_tech, 0) AS qtde_ncm_distintos_tech,\r\n  COALESCE(mov.vl_computadores, 0) AS vl_computadores,\r\n  COALESCE(mov.vl_partes_computadores, 0) AS vl_partes_computadores,\r\n  COALESCE(mov.vl_telecom, 0) AS vl_telecom,\r\n  \r\n  CASE \r\n    WHEN mov.vl_saidas_tech > 0 THEN \r\n      ROUND(100.0 * mov.vl_entradas_tech / NULLIF(mov.vl_saidas_tech, 0), 2)\r\n    ELSE 0 \r\n  END AS indice_entrada_saida_tech,\r\n  \r\n  CASE \r\n    WHEN mov.vl_entradas_tech > 0 THEN\r\n      ROUND(cd",
    "last_modified": "2025-10-11T01:00:58.900",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "98247874-ca8f-489a-b757-bbfeafccd369",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 162775,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "CREDITO DIME EFD",
    "description": "",
    "uuid": "98247874-ca8f-489a-b757-bbfeafccd369",
    "type": "directory",
    "connector": null,
    "data": "{}",
    "extra": "",
    "search": null,
    "last_modified": "2025-10-11T00:48:53.805",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "a8280168-7cf2-40b1-bc5d-733014ae6ba9",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 162833,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "DIME CRED EFD: Análises",
    "description": "",
    "uuid": "253be236-7dac-7b8b-187b-32e82fb12e59",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 162833, \"uuid\": \"253be236-7dac-7b8b-187b-32e82fb12e59\", \"name\": \"DIME CRED EFD: An\\u00e1lises\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": null, \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"8c45731b-aaf8-58f7-d19a-61b444f3bdfc\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": {\"row\": 636, \"column\": 54}, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": true, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"default\", \"currentQueryTab\": \"queryResults\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 1, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"-- =============================================================================\\r\\n-- AN\\u00c1LISE COMPLETA DE CR\\u00c9DITOS ICMS ACUMULADOS\\r\\n-- Sistema de Consultas Modulares para An\\u00e1lise de Risco Fiscal\\r\\n-- Execute cada bloco SEPARADAMENTE, pausando entre execu\\u00e7\\u00f5es\\r\\n-- =============================================================================\\r\\n\\r\\n-- CONFIGURA\\u00c7\\u00c3O INICIAL\\r\\nSET REQUEST_POOL = 'medium';\\r\\nSET MEM_LIMIT = 8G;\\r\\n\\r\\n-- =============================================================================\\r\\n-- M\\u00d3DULO 1: VIS\\u00c3O GERAL DO SISTEMA\\r\\n-- Execute este bloco primeiro para ter o panorama geral\\r\\n-- =============================================================================\\r\\n\\r\\n-- 1.1 PANORAMA EXECUTIVO GERAL\\r\\nSELECT\\r\\n    'PANORAMA GERAL - CR\\u00c9DITOS ICMS' AS categoria,\\r\\n    -- M\\u00e9tricas de Volume\\r\\n    COUNT(DISTINCT nu_cnpj) AS total_empresas_monitoradas,\\r\\n    COUNT(DISTINCT nu_cnpj_grupo) AS total_grupos_economicos,\\r\\n    \\r\\n    -- Distribui\\u00e7\\u00e3o por Risco\\r\\n    COUNT(CASE WHEN classificacao_risco = 'CR\\u00cdTICO' THEN 1 END) AS empresas_criticas,\\r\\n    COUNT(CASE WHEN classificacao_risco = 'ALTO' THEN 1 END) AS empresas_alto_risco,\\r\\n    COUNT(CASE WHEN classificacao_risco = 'M\\u00c9DIO' THEN 1 END) AS empresas_medio_risco,\\r\\n    COUNT(CASE WHEN classificacao_risco = 'BAIXO' THEN 1 END) AS empresas_baixo_risco,\\r\\n    \\r\\n    -- Percentuais\\r\\n    ROUND(COUNT(CASE WHEN classificacao_risco IN ('CR\\u00cdTICO', 'ALTO') THEN 1 END) * 100.0 / \\r\\n          COUNT(*), 2) AS perc_prioridade_alta,\\r\\n    \\r\\n    -- M\\u00e9tricas Financeiras\\r\\n    ROUND(SUM(saldo_credor_atual), 2) AS total_credito_acumulado,\\r\\n    ROUND(AVG(saldo_credor_atual), 2) AS media_credito_empresa,\\r\\n    ROUND(SUM(CASE WHEN classificacao_risco = 'CR\\u00cdTICO' THEN saldo_credor_atual ELSE 0 END), 2) AS credito_critico,\\r\\n    \\r\\n    -- M\\u00e9tricas de Comportamento\\r\\n    ROUND(AVG(qtde_ultimos_meses_iguais), 2) AS media_meses_iguais,\\r\\n    ROUND(AVG(crescimento_saldo_percentual), 2) AS media_crescimento_perc,\\r\\n    COUNT(CASE WHEN qtde_ultimos_meses_iguais >= 12 THEN 1 END) AS empresas_congeladas_12m,\\r\\n    \\r\\n    -- Data de Atualiza\\u00e7\\u00e3o\\r\\n    CURRENT_TIMESTAMP() AS data_consulta\\r\\nFROM teste.credito_dime_completo;\\r\\n\\r\\n-- PAUSA AQUI - Analise os resultados antes de continuar\\r\\n\\r\\n-- =============================================================================\\r\\n-- 1.2 DISTRIBUI\\u00c7\\u00c3O POR FAIXAS DE SCORE\\r\\nSELECT\\r\\n    'DISTRIBUI\\u00c7\\u00c3O POR SCORE' AS categoria,\\r\\n    CASE \\r\\n        WHEN score_risco >= 80 THEN '80+ (Extremo)'\\r\\n        WHEN score_risco >= 70 THEN '70-79 (Cr\\u00edtico)'\\r\\n        WHEN score_risco >= 50 THEN '50-69 (Alto)'\\r\\n        WHEN score_risco >= 30 THEN '30-49 (M\\u00e9dio)'\\r\\n        ELSE '0-29 (Baixo)'\\r\\n    END AS faixa_score,\\r\\n    \\r\\n    COUNT(*) AS quantidade_empresas,\\r\\n    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) AS percentual,\\r\\n    ROUND(SUM(saldo_credor_atual), 2) AS total_credito_faixa,\\r\\n    ROUND(AVG(saldo_credor_atual), 2) AS media_credito_faixa,\\r\\n    ROUND(AVG(qtde_ultimos_meses_iguais), 2) AS media_meses_iguais,\\r\\n    ROUND(AVG(crescimento_saldo_percentual), 2) AS media_crescimento_perc\\r\\nFROM teste.credito_dime_completo\\r\\nGROUP BY\\r\\n    CASE \\r\\n        WHEN score_risco >= 80 THEN '80+ (Extremo)'\\r\\n        WHEN score_risco >= 70 THEN '70-79 (Cr\\u00edtico)'\\r\\n        WHEN score_risco >= 50 THEN '50-69 (Alto)'\\r\\n        WHEN score_risco >= 30 THEN '30-49 (M\\u00e9dio)'\\r\\n        ELSE '0-29 (Baixo)'\\r\\n    END\\r\\nORDER BY MIN(score_risco) DESC;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- 1.3 DISTRIBUI\\u00c7\\u00c3O POR GER\\u00caNCIA REGIONAL (GERFE)\\r\\nSELECT\\r\\n    'DISTRIBUI\\u00c7\\u00c3O POR GERFE' AS categoria,\\r\\n    nm_gerfe,\\r\\n    COUNT(*) AS total_empresas,\\r\\n    COUNT(CASE WHEN classificacao_risco IN ('CR\\u00cdTICO', 'ALTO') THEN 1 END) AS empresas_prioritarias,\\r\\n    ROUND(COUNT(CASE WHEN classificacao_risco IN ('CR\\u00cdTICO', 'ALTO') THEN 1 END) * 100.0 / COUNT(*), 2) AS perc_prioritarias,\\r\\n    ROUND(SUM(saldo_credor_atual), 2) AS total_credito,\\r\\n    ROUND(AVG(score_risco), 2) AS score_medio\\r\\nFROM teste.credito_dime_completo\\r\\nWHERE nm_gerfe IS NOT NULL\\r\\nGROUP BY nm_gerfe\\r\\nORDER BY empresas_prioritarias DESC, total_credito DESC;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- M\\u00d3DULO 2: AN\\u00c1LISE SETORIAL COMPARATIVA\\r\\n-- Compare os 3 setores analisados\\r\\n-- =============================================================================\\r\\n\\r\\n-- 2.1 COMPARA\\u00c7\\u00c3O GERAL ENTRE SETORES\\r\\nSELECT\\r\\n    'COMPARA\\u00c7\\u00c3O SETORIAL' AS categoria,\\r\\n    'T\\u00caXTIL' AS setor,\\r\\n    COUNT(*) AS qtde_empresas_total,\\r\\n    COUNT(CASE WHEN flag_setor_textil = 1 THEN 1 END) AS qtde_com_movimento,\\r\\n    ROUND(COUNT(CASE WHEN flag_setor_textil = 1 THEN 1 END) * 100.0 / COUNT(*), 2) AS perc_movimento,\\r\\n    ROUND(AVG(CASE WHEN flag_setor_textil = 1 THEN score_risco END), 2) AS score_medio_setor,\\r\\n    ROUND(SUM(CASE WHEN flag_setor_textil = 1 THEN saldo_credor_atual ELSE 0 END), 2) AS total_credito,\\r\\n    ROUND(SUM(CASE WHEN flag_setor_textil = 1 THEN vl_entradas_textil + vl_saidas_textil ELSE 0 END), 2) AS movimentacao_total,\\r\\n    COUNT(CASE WHEN flag_setor_textil = 1 AND classificacao_risco = 'CR\\u00cdTICO' THEN 1 END) AS qtde_criticos\\r\\nFROM teste.credito_dime_textil\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT\\r\\n    'COMPARA\\u00c7\\u00c3O SETORIAL' AS categoria,\\r\\n    'METAL-MEC\\u00c2NICO' AS setor,\\r\\n    COUNT(*) AS qtde_empresas_total,\\r\\n    COUNT(CASE WHEN flag_setor_metalmec = 1 THEN 1 END) AS qtde_com_movimento,\\r\\n    ROUND(COUNT(CASE WHEN flag_setor_metalmec = 1 THEN 1 END) * 100.0 / COUNT(*), 2) AS perc_movimento,\\r\\n    ROUND(AVG(CASE WHEN flag_setor_metalmec = 1 THEN score_risco END), 2) AS score_medio_setor,\\r\\n    ROUND(SUM(CASE WHEN flag_setor_metalmec = 1 THEN saldo_credor_atual ELSE 0 END), 2) AS total_credito,\\r\\n    ROUND(SUM(CASE WHEN flag_setor_metalmec = 1 THEN vl_entradas_metalmec + vl_saidas_metalmec ELSE 0 END), 2) AS movimentacao_total,\\r\\n    COUNT(CASE WHEN flag_setor_metalmec = 1 AND classificacao_risco = 'CR\\u00cdTICO' THEN 1 END) AS qtde_criticos\\r\\nFROM teste.credito_dime_metalmec\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT\\r\\n    'COMPARA\\u00c7\\u00c3O SETORIAL' AS categoria,\\r\\n    'TECNOLOGIA' AS setor,\\r\\n    COUNT(*) AS qtde_empresas_total,\\r\\n    COUNT(CASE WHEN flag_setor_tech = 1 THEN 1 END) AS qtde_com_movimento,\\r\\n    ROUND(COUNT(CASE WHEN flag_setor_tech = 1 THEN 1 END) * 100.0 / COUNT(*), 2) AS perc_movimento,\\r\\n    ROUND(AVG(CASE WHEN flag_setor_tech = 1 THEN score_risco END), 2) AS score_medio_setor,\\r\\n    ROUND(SUM(CASE WHEN flag_setor_tech = 1 THEN saldo_credor_atual ELSE 0 END), 2) AS total_credito,\\r\\n    ROUND(SUM(CASE WHEN flag_setor_tech = 1 THEN vl_entradas_tech + vl_saidas_tech ELSE 0 END), 2) AS movimentacao_total,\\r\\n    COUNT(CASE WHEN flag_setor_tech = 1 AND classificacao_risco = 'CR\\u00cdTICO' THEN 1 END) AS qtde_criticos\\r\\nFROM teste.credito_dime_tech;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- 2.2 EMPRESAS MULTI-SETORIAIS\\r\\nSELECT\\r\\n    'EMPRESAS MULTI-SETORIAIS' AS categoria,\\r\\n    txt.nu_cnpj,\\r\\n    txt.nm_razao_social,\\r\\n    txt.de_cnae,\\r\\n    txt.saldo_credor_atual,\\r\\n    txt.score_risco,\\r\\n    txt.classificacao_risco,\\r\\n    CASE WHEN txt.flag_setor_textil = 1 THEN 'SIM' ELSE 'N\\u00c3O' END AS opera_textil,\\r\\n    CASE WHEN mm.flag_setor_metalmec = 1 THEN 'SIM' ELSE 'N\\u00c3O' END AS opera_metalmec,\\r\\n    CASE WHEN tech.flag_setor_tech = 1 THEN 'SIM' ELSE 'N\\u00c3O' END AS opera_tech,\\r\\n    \\r\\n    (COALESCE(txt.flag_setor_textil, 0) + \\r\\n     COALESCE(mm.flag_setor_metalmec, 0) + \\r\\n     COALESCE(tech.flag_setor_tech, 0)) AS qtde_setores,\\r\\n    \\r\\n    (COALESCE(txt.vl_entradas_textil, 0) + COALESCE(txt.vl_saidas_textil, 0) +\\r\\n     COALESCE(mm.vl_entradas_metalmec, 0) + COALESCE(mm.vl_saidas_metalmec, 0) +\\r\\n     COALESCE(tech.vl_entradas_tech, 0) + COALESCE(tech.vl_saidas_tech, 0)) AS movimentacao_total\\r\\nFROM teste.credito_dime_textil txt\\r\\nLEFT JOIN teste.credito_dime_metalmec mm ON txt.nu_cnpj = mm.nu_cnpj\\r\\nLEFT JOIN teste.credito_dime_tech tech ON txt.nu_cnpj = tech.nu_cnpj\\r\\nWHERE (COALESCE(txt.flag_setor_textil, 0) + \\r\\n       COALESCE(mm.flag_setor_metalmec, 0) + \\r\\n       COALESCE(tech.flag_setor_tech, 0)) >= 2\\r\\nAND txt.saldo_credor_atual > 50000\\r\\nAND txt.classificacao_risco IN ('CR\\u00cdTICO', 'ALTO')\\r\\nORDER BY qtde_setores DESC, txt.saldo_credor_atual DESC\\r\\nLIMIT 50;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- M\\u00d3DULO 3: TOP EMPRESAS - RANKINGS GERAIS\\r\\n-- Identifique as empresas mais cr\\u00edticas\\r\\n-- =============================================================================\\r\\n\\r\\n-- 3.1 TOP 50 POR SCORE DE RISCO\\r\\nSELECT\\r\\n    'TOP 50 POR SCORE' AS categoria,\\r\\n    ROW_NUMBER() OVER (ORDER BY score_risco DESC, saldo_credor_atual DESC) AS ranking,\\r\\n    nu_cnpj,\\r\\n    nm_razao_social,\\r\\n    de_cnae,\\r\\n    nm_gerfe,\\r\\n    score_risco,\\r\\n    classificacao_risco,\\r\\n    saldo_credor_atual,\\r\\n    qtde_ultimos_meses_iguais,\\r\\n    crescimento_saldo_percentual,\\r\\n    vl_credito_presumido_13m\\r\\nFROM teste.credito_dime_completo\\r\\nWHERE classificacao_risco IN ('CR\\u00cdTICO', 'ALTO')\\r\\nORDER BY score_risco DESC, saldo_credor_atual DESC\\r\\nLIMIT 50;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- 3.2 TOP 50 POR SALDO CREDOR ACUMULADO\\r\\nSELECT\\r\\n    'TOP 50 POR SALDO CREDOR' AS categoria,\\r\\n    ROW_NUMBER() OVER (ORDER BY saldo_credor_atual DESC) AS ranking,\\r\\n    nu_cnpj,\\r\\n    nm_razao_social,\\r\\n    de_cnae,\\r\\n    nm_gerfe,\\r\\n    saldo_credor_atual,\\r\\n    score_risco,\\r\\n    classificacao_risco,\\r\\n    qtde_ultimos_meses_iguais,\\r\\n    crescimento_saldo_percentual,\\r\\n    vl_credito_presumido_13m\\r\\nFROM teste.credito_dime_completo\\r\\nWHERE saldo_credor_atual > 100000\\r\\nORDER BY saldo_credor_atual DESC\\r\\nLIMIT 50;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- 3.3 TOP 50 POR CRESCIMENTO PERCENTUAL\\r\\nSELECT\\r\\n    'TOP 50 POR CRESCIMENTO' AS categoria,\\r\\n    ROW_NUMBER() OVER (ORDER BY crescimento_saldo_percentual DESC) AS ranking,\\r\\n    nu_cnpj,\\r\\n    nm_razao_social,\\r\\n    de_cnae,\\r\\n    nm_gerfe,\\r\\n    crescimento_saldo_percentual,\\r\\n    saldo_13m_atras,\\r\\n    saldo_credor_atual,\\r\\n    crescimento_saldo_absoluto,\\r\\n    score_risco,\\r\\n    classificacao_risco\\r\\nFROM teste.credito_dime_completo\\r\\nWHERE crescimento_saldo_percentual > 100\\r\\nAND saldo_credor_atual > 10000\\r\\nORDER BY crescimento_saldo_percentual DESC\\r\\nLIMIT 50;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- 3.4 EMPRESAS \\\"FANTASMA\\\" - Alto Cr\\u00e9dito sem Movimenta\\u00e7\\u00e3o\\r\\nSELECT\\r\\n    'EMPRESAS FANTASMA' AS categoria,\\r\\n    cd.nu_cnpj,\\r\\n    cd.nm_razao_social,\\r\\n    cd.de_cnae,\\r\\n    cd.nm_sit_cadastral,\\r\\n    cd.saldo_credor_atual,\\r\\n    cd.score_risco,\\r\\n    cd.qtde_ultimos_meses_iguais,\\r\\n    cd.crescimento_saldo_percentual,\\r\\n    cd.vl_credito_presumido_13m,\\r\\n    (COALESCE(txt.vl_entradas_textil, 0) + COALESCE(txt.vl_saidas_textil, 0) +\\r\\n     COALESCE(mm.vl_entradas_metalmec, 0) + COALESCE(mm.vl_saidas_metalmec, 0) +\\r\\n     COALESCE(tech.vl_entradas_tech, 0) + COALESCE(tech.vl_saidas_tech, 0)) AS movto_total_3_setores\\r\\nFROM teste.credito_dime_completo cd\\r\\nLEFT JOIN teste.credito_dime_textil txt ON cd.nu_cnpj = txt.nu_cnpj\\r\\nLEFT JOIN teste.credito_dime_metalmec mm ON cd.nu_cnpj = mm.nu_cnpj\\r\\nLEFT JOIN teste.credito_dime_tech tech ON cd.nu_cnpj = tech.nu_cnpj\\r\\nWHERE cd.classificacao_risco IN ('CR\\u00cdTICO', 'ALTO')\\r\\nAND cd.saldo_credor_atual > 100000\\r\\nAND (COALESCE(txt.vl_entradas_textil, 0) + COALESCE(txt.vl_saidas_textil, 0) +\\r\\n     COALESCE(mm.vl_entradas_metalmec, 0) + COALESCE(mm.vl_saidas_metalmec, 0) +\\r\\n     COALESCE(tech.vl_entradas_tech, 0) + COALESCE(tech.vl_saidas_tech, 0)) < 10000\\r\\nORDER BY cd.saldo_credor_atual DESC\\r\\nLIMIT 50;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- M\\u00d3DULO 4: AN\\u00c1LISE DETALHADA - SETOR T\\u00caXTIL\\r\\n-- =============================================================================\\r\\n\\r\\n-- 4.1 OVERVIEW SETOR T\\u00caXTIL\\r\\nSELECT\\r\\n    'OVERVIEW T\\u00caXTIL' AS categoria,\\r\\n    classificacao_risco,\\r\\n    COUNT(*) AS qtde_empresas,\\r\\n    ROUND(SUM(saldo_credor_atual), 2) AS total_saldo_credor,\\r\\n    ROUND(AVG(saldo_credor_atual), 2) AS media_saldo_credor,\\r\\n    ROUND(SUM(vl_entradas_textil), 2) AS total_entradas,\\r\\n    ROUND(SUM(vl_saidas_textil), 2) AS total_saidas,\\r\\n    ROUND(AVG(dias_movimento_textil), 2) AS media_dias_movimento,\\r\\n    COUNT(CASE WHEN vl_saidas_textil = 0 AND vl_entradas_textil > 10000 THEN 1 END) AS qtde_so_compra\\r\\nFROM teste.credito_dime_textil\\r\\nWHERE flag_setor_textil = 1\\r\\nAND vl_entradas_textil > 1000\\r\\nGROUP BY classificacao_risco\\r\\nORDER BY\\r\\n    CASE classificacao_risco\\r\\n        WHEN 'CR\\u00cdTICO' THEN 1\\r\\n        WHEN 'ALTO' THEN 2\\r\\n        WHEN 'M\\u00c9DIO' THEN 3\\r\\n        WHEN 'BAIXO' THEN 4\\r\\n    END;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- 4.2 TOP 30 T\\u00caXTEIS CR\\u00cdTICAS\\r\\nSELECT\\r\\n    'TOP 30 T\\u00caXTIL' AS categoria,\\r\\n    nu_cnpj,\\r\\n    nm_razao_social,\\r\\n    de_cnae,\\r\\n    saldo_credor_atual,\\r\\n    vl_entradas_textil,\\r\\n    vl_saidas_textil,\\r\\n    dias_movimento_textil,\\r\\n    qtde_ncm_distintos_textil,\\r\\n    indice_entrada_saida_textil,\\r\\n    qtde_ultimos_meses_iguais,\\r\\n    crescimento_saldo_percentual,\\r\\n    score_risco,\\r\\n    classificacao_risco,\\r\\n    CASE \\r\\n        WHEN vl_saidas_textil = 0 THEN 'SO COMPRA'\\r\\n        WHEN vl_entradas_textil > vl_saidas_textil * 3 THEN 'COMPRA 3X+ VENDE'\\r\\n        WHEN vl_saidas_textil > vl_entradas_textil * 3 THEN 'VENDE 3X+ COMPRA'\\r\\n        ELSE 'EQUILIBRADO'\\r\\n    END AS padrao_movimento\\r\\nFROM teste.credito_dime_textil\\r\\nWHERE flag_setor_textil = 1\\r\\nAND vl_entradas_textil > 10000\\r\\nAND classificacao_risco IN ('CR\\u00cdTICO', 'ALTO')\\r\\nORDER BY score_risco DESC, saldo_credor_atual DESC\\r\\nLIMIT 30;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- 4.3 PADR\\u00d5ES DE MOVIMENTA\\u00c7\\u00c3O T\\u00caXTIL\\r\\nSELECT\\r\\n    'PADR\\u00d5ES T\\u00caXTIL' AS categoria,\\r\\n    CASE \\r\\n        WHEN vl_saidas_textil = 0 AND vl_entradas_textil > 10000 THEN '1. SO COMPRA (SUSPEITO)'\\r\\n        WHEN vl_entradas_textil = 0 AND vl_saidas_textil > 10000 THEN '2. SO VENDE (ST)'\\r\\n        WHEN vl_entradas_textil > vl_saidas_textil * 3 THEN '3. COMPRA 3X+ VENDE'\\r\\n        WHEN vl_saidas_textil > vl_entradas_textil * 3 THEN '4. VENDE 3X+ COMPRA'\\r\\n        ELSE '5. EQUILIBRADO'\\r\\n    END AS padrao,\\r\\n    COUNT(*) AS qtde_empresas,\\r\\n    ROUND(SUM(saldo_credor_atual), 2) AS total_saldo_credor,\\r\\n    ROUND(AVG(saldo_credor_atual), 2) AS media_saldo_credor,\\r\\n    ROUND(AVG(vl_entradas_textil), 2) AS media_entradas,\\r\\n    ROUND(AVG(vl_saidas_textil), 2) AS media_saidas,\\r\\n    COUNT(CASE WHEN classificacao_risco = 'CR\\u00cdTICO' THEN 1 END) AS qtde_criticos\\r\\nFROM teste.credito_dime_textil\\r\\nWHERE flag_setor_textil = 1\\r\\nAND (vl_entradas_textil > 1000 OR vl_saidas_textil > 1000)\\r\\nGROUP BY padrao\\r\\nORDER BY total_saldo_credor DESC;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- 4.4 T\\u00caXTEIS COM CR\\u00c9DITO DESPROPORCIONAL\\r\\nSELECT\\r\\n    'CR\\u00c9DITO DESPROPORCIONAL T\\u00caXTIL' AS categoria,\\r\\n    nu_cnpj,\\r\\n    nm_razao_social,\\r\\n    de_cnae,\\r\\n    saldo_credor_atual,\\r\\n    vl_entradas_textil,\\r\\n    vl_saidas_textil,\\r\\n    vl_credito_presumido_13m,\\r\\n    ROUND(vl_entradas_textil * 0.18, 2) AS credito_esperado_entradas,\\r\\n    ROUND(saldo_credor_atual - (vl_entradas_textil * 0.18), 2) AS credito_excedente,\\r\\n    ROUND(100.0 * (saldo_credor_atual - (vl_entradas_textil * 0.18)) / NULLIF(saldo_credor_atual, 0), 2) AS perc_credito_inexplicavel,\\r\\n    \\r\\n    indice_saldo_entrada_textil,\\r\\n    qtde_ultimos_meses_iguais,\\r\\n    score_risco,\\r\\n    classificacao_risco\\r\\nFROM teste.credito_dime_textil\\r\\nWHERE flag_setor_textil = 1\\r\\nAND vl_entradas_textil > 10000\\r\\nAND saldo_credor_atual > 50000\\r\\nAND saldo_credor_atual > (vl_entradas_textil * 0.18 * 2)\\r\\nAND classificacao_risco IN ('CR\\u00cdTICO', 'ALTO')\\r\\nORDER BY perc_credito_inexplicavel DESC\\r\\nLIMIT 30;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- M\\u00d3DULO 5: AN\\u00c1LISE DETALHADA - SETOR METAL-MEC\\u00c2NICO\\r\\n-- =============================================================================\\r\\n\\r\\n-- 5.1 OVERVIEW SETOR METAL-MEC\\u00c2NICO\\r\\nSELECT\\r\\n    'OVERVIEW METAL-MEC\\u00c2NICO' AS categoria,\\r\\n    classificacao_risco,\\r\\n    COUNT(*) AS qtde_empresas,\\r\\n    ROUND(SUM(saldo_credor_atual), 2) AS total_saldo_credor,\\r\\n    ROUND(AVG(saldo_credor_atual), 2) AS media_saldo_credor,\\r\\n    ROUND(SUM(vl_entradas_metalmec), 2) AS total_entradas,\\r\\n    ROUND(SUM(vl_saidas_metalmec), 2) AS total_saidas,\\r\\n    ROUND(AVG(dias_movimento_metalmec), 2) AS media_dias_movimento,\\r\\n    ROUND(AVG(perc_cap84), 2) AS media_perc_cap84,\\r\\n    COUNT(CASE WHEN vl_saidas_metalmec = 0 AND vl_entradas_metalmec > 10000 THEN 1 END) AS qtde_so_compra\\r\\nFROM teste.credito_dime_metalmec\\r\\nWHERE flag_setor_metalmec = 1\\r\\nAND vl_entradas_metalmec > 1000\\r\\nGROUP BY classificacao_risco\\r\\nORDER BY\\r\\n    CASE classificacao_risco\\r\\n        WHEN 'CR\\u00cdTICO' THEN 1\\r\\n        WHEN 'ALTO' THEN 2\\r\\n        WHEN 'M\\u00c9DIO' THEN 3\\r\\n        WHEN 'BAIXO' THEN 4\\r\\n    END;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- 5.2 TOP 30 METAL-MEC\\u00c2NICO CR\\u00cdTICAS\\r\\nSELECT\\r\\n    'TOP 30 METAL-MEC\\u00c2NICO' AS categoria,\\r\\n    nu_cnpj,\\r\\n    nm_razao_social,\\r\\n    de_cnae,\\r\\n    saldo_credor_atual,\\r\\n    vl_entradas_metalmec,\\r\\n    vl_saidas_metalmec,\\r\\n    vl_capitulo_84,\\r\\n    vl_capitulo_85,\\r\\n    perc_cap84,\\r\\n    dias_movimento_metalmec,\\r\\n    qtde_ncm_distintos_metalmec,\\r\\n    indice_entrada_saida_metalmec,\\r\\n    qtde_ultimos_meses_iguais,\\r\\n    crescimento_saldo_percentual,\\r\\n    score_risco,\\r\\n    classificacao_risco,\\r\\n    CASE \\r\\n        WHEN vl_saidas_metalmec = 0 THEN 'SO COMPRA'\\r\\n        WHEN vl_entradas_metalmec > vl_saidas_metalmec * 3 THEN 'COMPRA 3X+ VENDE'\\r\\n        WHEN vl_saidas_metalmec > vl_entradas_metalmec * 3 THEN 'VENDE 3X+ COMPRA'\\r\\n        ELSE 'EQUILIBRADO'\\r\\n    END AS padrao_movimento\\r\\nFROM teste.credito_dime_metalmec\\r\\nWHERE flag_setor_metalmec = 1\\r\\nAND vl_entradas_metalmec > 10000\\r\\nAND classificacao_risco IN ('CR\\u00cdTICO', 'ALTO')\\r\\nORDER BY score_risco DESC, saldo_credor_atual DESC\\r\\nLIMIT 30;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- 5.3 AN\\u00c1LISE CAP 84 vs CAP 85\\r\\nSELECT\\r\\n    'CAP 84 vs 85' AS categoria,\\r\\n    CASE \\r\\n        WHEN perc_cap84 > 80 THEN '1. PREDOMINANTE CAP 84 (MAQUINAS)'\\r\\n        WHEN perc_cap84 < 20 THEN '2. PREDOMINANTE CAP 85 (ELETRICOS)'\\r\\n        ELSE '3. MISTO'\\r\\n    END AS perfil_produto,\\r\\n    COUNT(*) AS qtde_empresas,\\r\\n    ROUND(AVG(saldo_credor_atual), 2) AS media_saldo_credor,\\r\\n    ROUND(SUM(vl_capitulo_84), 2) AS total_cap84,\\r\\n    ROUND(SUM(vl_capitulo_85), 2) AS total_cap85,\\r\\n    COUNT(CASE WHEN classificacao_risco = 'CR\\u00cdTICO' THEN 1 END) AS qtde_criticos\\r\\nFROM teste.credito_dime_metalmec\\r\\nWHERE flag_setor_metalmec = 1\\r\\nAND (vl_capitulo_84 + vl_capitulo_85) > 10000\\r\\nGROUP BY \\r\\n    CASE \\r\\n        WHEN perc_cap84 > 80 THEN '1. PREDOMINANTE CAP 84 (MAQUINAS)'\\r\\n        WHEN perc_cap84 < 20 THEN '2. PREDOMINANTE CAP 85 (ELETRICOS)'\\r\\n        ELSE '3. MISTO'\\r\\n    END\\r\\nORDER BY SUM(vl_capitulo_84) + SUM(vl_capitulo_85) DESC;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- M\\u00d3DULO 6: AN\\u00c1LISE DETALHADA - SETOR TECNOLOGIA\\r\\n-- =============================================================================\\r\\n\\r\\n-- 6.1 OVERVIEW SETOR TECNOLOGIA\\r\\nSELECT\\r\\n    'OVERVIEW TECNOLOGIA' AS categoria,\\r\\n    classificacao_risco,\\r\\n    COUNT(*) AS qtde_empresas,\\r\\n    ROUND(SUM(saldo_credor_atual), 2) AS total_saldo_credor,\\r\\n    ROUND(AVG(saldo_credor_atual), 2) AS media_saldo_credor,\\r\\n    ROUND(SUM(vl_entradas_tech), 2) AS total_entradas,\\r\\n    ROUND(SUM(vl_saidas_tech), 2) AS total_saidas,\\r\\n    ROUND(SUM(vl_computadores), 2) AS total_computadores,\\r\\n    ROUND(SUM(vl_telecom), 2) AS total_telecom,\\r\\n    ROUND(AVG(dias_movimento_tech), 2) AS media_dias_movimento,\\r\\n    COUNT(CASE WHEN vl_saidas_tech = 0 AND vl_entradas_tech > 10000 THEN 1 END) AS qtde_so_compra\\r\\nFROM teste.credito_dime_tech\\r\\nWHERE flag_setor_tech = 1\\r\\nAND vl_entradas_tech > 1000\\r\\nGROUP BY classificacao_risco\\r\\nORDER BY\\r\\n    CASE classificacao_risco\\r\\n        WHEN 'CR\\u00cdTICO' THEN 1\\r\\n        WHEN 'ALTO' THEN 2\\r\\n        WHEN 'M\\u00c9DIO' THEN 3\\r\\n        WHEN 'BAIXO' THEN 4\\r\\n    END;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- 6.2 TOP 30 TECNOLOGIA CR\\u00cdTICAS\\r\\nSELECT\\r\\n    'TOP 30 TECNOLOGIA' AS categoria,\\r\\n    nu_cnpj,\\r\\n    nm_razao_social,\\r\\n    de_cnae,\\r\\n    saldo_credor_atual,\\r\\n    vl_entradas_tech,\\r\\n    vl_saidas_tech,\\r\\n    vl_computadores,\\r\\n    vl_partes_computadores,\\r\\n    vl_telecom,\\r\\n    dias_movimento_tech,\\r\\n    qtde_ncm_distintos_tech,\\r\\n    indice_entrada_saida_tech,\\r\\n    qtde_ultimos_meses_iguais,\\r\\n    crescimento_saldo_percentual,\\r\\n    score_risco,\\r\\n    classificacao_risco,\\r\\n    CASE \\r\\n        WHEN vl_saidas_tech = 0 THEN 'SO COMPRA'\\r\\n        WHEN vl_entradas_tech > vl_saidas_tech * 3 THEN 'COMPRA 3X+ VENDE'\\r\\n        WHEN vl_saidas_tech > vl_entradas_tech * 3 THEN 'VENDE 3X+ COMPRA'\\r\\n        ELSE 'EQUILIBRADO'\\r\\n    END AS padrao_movimento\\r\\nFROM teste.credito_dime_tech\\r\\nWHERE flag_setor_tech = 1\\r\\nAND vl_entradas_tech > 10000\\r\\nAND classificacao_risco IN ('CR\\u00cdTICO', 'ALTO')\\r\\nORDER BY score_risco DESC, saldo_credor_atual DESC\\r\\nLIMIT 30;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- 6.3 PERFIL DE PRODUTOS TECH\\r\\nSELECT\\r\\n    'PERFIL PRODUTOS TECH' AS categoria,\\r\\n    CASE \\r\\n        WHEN vl_computadores > (vl_partes_computadores + vl_telecom) * 2 THEN '1. COMPUTADORES'\\r\\n        WHEN vl_telecom > (vl_computadores + vl_partes_computadores) * 2 THEN '2. TELECOM'\\r\\n        WHEN vl_partes_computadores > (vl_computadores + vl_telecom) * 2 THEN '3. PARTES/PERIFERICOS'\\r\\n        ELSE '4. MISTO'\\r\\n    END AS perfil_produto,\\r\\n    COUNT(*) AS qtde_empresas,\\r\\n    ROUND(AVG(saldo_credor_atual), 2) AS media_saldo_credor,\\r\\n    ROUND(SUM(vl_computadores), 2) AS total_computadores,\\r\\n    ROUND(SUM(vl_partes_computadores), 2) AS total_partes,\\r\\n    ROUND(SUM(vl_telecom), 2) AS total_telecom,\\r\\n    COUNT(CASE WHEN classificacao_risco = 'CR\\u00cdTICO' THEN 1 END) AS qtde_criticos\\r\\nFROM teste.credito_dime_tech\\r\\nWHERE flag_setor_tech = 1\\r\\nAND (vl_computadores + vl_partes_computadores + vl_telecom) > 10000\\r\\nGROUP BY perfil_produto\\r\\nORDER BY qtde_empresas DESC;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- M\\u00d3DULO 7: AN\\u00c1LISE INDIVIDUAL - TEMPLATE FICHA COMPLETA\\r\\n-- SUBSTITUA '00000000000000' PELO CNPJ DESEJADO\\r\\n-- =============================================================================\\r\\n\\r\\n-- 7.1 FICHA COMPLETA DE EMPRESA\\r\\nWITH empresa_base AS (\\r\\n    SELECT * FROM teste.credito_dime_completo WHERE nu_cnpj = '00000000000000'\\r\\n),\\r\\nempresa_textil AS (\\r\\n    SELECT * FROM teste.credito_dime_textil WHERE nu_cnpj = '00000000000000'\\r\\n),\\r\\nempresa_metalmec AS (\\r\\n    SELECT * FROM teste.credito_dime_metalmec WHERE nu_cnpj = '00000000000000'\\r\\n),\\r\\nempresa_tech AS (\\r\\n    SELECT * FROM teste.credito_dime_tech WHERE nu_cnpj = '00000000000000'\\r\\n)\\r\\nSELECT\\r\\n    'FICHA COMPLETA EMPRESA' AS categoria,\\r\\n    -- IDENTIFICA\\u00c7\\u00c3O\\r\\n    eb.nu_cnpj,\\r\\n    eb.nm_razao_social,\\r\\n    eb.nm_fantasia,\\r\\n    eb.de_cnae,\\r\\n    eb.nm_gerfe,\\r\\n    eb.nm_sit_cadastral,\\r\\n    -- RISCO\\r\\n    eb.score_risco,\\r\\n    eb.classificacao_risco,\\r\\n    ROW_NUMBER() OVER (ORDER BY eb.score_risco DESC) AS posicao_ranking_aprox,\\r\\n    -- CR\\u00c9DITO\\r\\n    eb.saldo_credor_atual,\\r\\n    eb.saldo_13m_atras,\\r\\n    eb.crescimento_saldo_absoluto,\\r\\n    eb.crescimento_saldo_percentual,\\r\\n    -- PADR\\u00c3O TEMPORAL\\r\\n    eb.qtde_ultimos_meses_iguais,\\r\\n    eb.valor_sequencia_recente,\\r\\n    eb.qtde_meses_declarados_13m,\\r\\n    eb.media_credito_13m,\\r\\n    eb.desvio_padrao_credito,\\r\\n    -- CR\\u00c9DITO PRESUMIDO\\r\\n    eb.vl_credito_presumido_13m,\\r\\n    eb.qtde_tipos_cp,\\r\\n    -- SETORES\\r\\n    CASE WHEN et.flag_setor_textil = 1 THEN 'SIM' ELSE 'NAO' END AS opera_textil,\\r\\n    et.vl_entradas_textil,\\r\\n    et.vl_saidas_textil,\\r\\n    et.dias_movimento_textil,\\r\\n    CASE WHEN em.flag_setor_metalmec = 1 THEN 'SIM' ELSE 'NAO' END AS opera_metalmec,\\r\\n    em.vl_entradas_metalmec,\\r\\n    em.vl_saidas_metalmec,\\r\\n    em.dias_movimento_metalmec,\\r\\n    CASE WHEN etch.flag_setor_tech = 1 THEN 'SIM' ELSE 'NAO' END AS opera_tech,\\r\\n    etch.vl_entradas_tech,\\r\\n    etch.vl_saidas_tech,\\r\\n    etch.dias_movimento_tech\\r\\nFROM empresa_base eb\\r\\nLEFT JOIN empresa_textil et ON eb.nu_cnpj = et.nu_cnpj\\r\\nLEFT JOIN empresa_metalmec em ON eb.nu_cnpj = em.nu_cnpj\\r\\nLEFT JOIN empresa_tech etch ON eb.nu_cnpj = etch.nu_cnpj;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- M\\u00d3DULO 8: ALERTAS E MONITORAMENTO\\r\\n-- Sistema de alertas autom\\u00e1ticos para a\\u00e7\\u00e3o imediata\\r\\n-- =============================================================================\\r\\n\\r\\n-- 8.1 DASHBOARD EXECUTIVO - M\\u00c9TRICAS DI\\u00c1RIAS\\r\\nSELECT\\r\\n    'DASHBOARD EXECUTIVO' AS categoria,\\r\\n    -- M\\u00e9tricas Principais\\r\\n    COUNT(DISTINCT nu_cnpj) AS total_empresas,\\r\\n    \\r\\n    -- Distribui\\u00e7\\u00e3o por Risco\\r\\n    COUNT(CASE WHEN classificacao_risco = 'CR\\u00cdTICO' THEN 1 END) AS empresas_criticas,\\r\\n    COUNT(CASE WHEN classificacao_risco = 'ALTO' THEN 1 END) AS empresas_alto_risco,\\r\\n    COUNT(CASE WHEN classificacao_risco = 'M\\u00c9DIO' THEN 1 END) AS empresas_medio_risco,\\r\\n    \\r\\n    -- Percentuais\\r\\n    ROUND(COUNT(CASE WHEN classificacao_risco IN ('CR\\u00cdTICO', 'ALTO') THEN 1 END) * 100.0 / \\r\\n          COUNT(*), 1) AS perc_prioritarios,\\r\\n    \\r\\n    -- M\\u00e9tricas Financeiras\\r\\n    ROUND(SUM(saldo_credor_atual), 2) AS receita_total_monitorada,\\r\\n    \\r\\n    -- Top Alertas\\r\\n    COUNT(CASE WHEN qtde_ultimos_meses_iguais >= 12 THEN 1 END) AS alertas_congelamento,\\r\\n    COUNT(CASE WHEN crescimento_saldo_percentual > 500 THEN 1 END) AS alertas_crescimento_explosivo,\\r\\n    COUNT(CASE WHEN desvio_padrao_credito = 0 AND media_credito_13m > 1000 THEN 1 END) AS alertas_variacao_zero,\\r\\n    \\r\\n    -- Timestamp\\r\\n    CURRENT_TIMESTAMP() AS data_atualizacao\\r\\nFROM teste.credito_dime_completo;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- 8.2 ALERTAS AUTOM\\u00c1TICOS PRIORIT\\u00c1RIOS\\r\\nSELECT\\r\\n    'ALERTAS AUTOM\\u00c1TICOS' AS categoria,\\r\\n    nu_cnpj,\\r\\n    nm_razao_social,\\r\\n    score_risco,\\r\\n    saldo_credor_atual,\\r\\n    -- Tipo de Alerta\\r\\n    CASE \\r\\n        WHEN score_risco >= 80 \\r\\n            THEN 'CR\\u00cdTICO: Score Extremo - Investiga\\u00e7\\u00e3o Imediata'\\r\\n        \\r\\n        WHEN qtde_ultimos_meses_iguais >= 12 AND desvio_padrao_credito < 100\\r\\n            THEN 'CR\\u00cdTICO: Valor Congelado h\\u00e1 12+ meses'\\r\\n        \\r\\n        WHEN crescimento_saldo_percentual > 1000\\r\\n            THEN 'CR\\u00cdTICO: Crescimento Explosivo 10X+'\\r\\n        \\r\\n        WHEN saldo_credor_atual > 1000000 AND qtde_ultimos_meses_iguais >= 6\\r\\n            THEN 'ALTO: Alto Cr\\u00e9dito + Estagna\\u00e7\\u00e3o'\\r\\n        \\r\\n        WHEN crescimento_saldo_percentual > 500 AND desvio_padrao_credito < 500\\r\\n            THEN 'ALTO: Crescimento An\\u00f4malo com Baixa Varia\\u00e7\\u00e3o'\\r\\n        \\r\\n        ELSE 'M\\u00c9DIO: Monitoramento Cont\\u00ednuo'\\r\\n    END AS tipo_alerta,\\r\\n    \\r\\n    -- Prioridade (1=Mais alta)\\r\\n    CASE \\r\\n        WHEN score_risco >= 80 OR qtde_ultimos_meses_iguais >= 12 THEN 1\\r\\n        WHEN crescimento_saldo_percentual > 1000 THEN 1\\r\\n        WHEN saldo_credor_atual > 1000000 AND qtde_ultimos_meses_iguais >= 6 THEN 2\\r\\n        WHEN crescimento_saldo_percentual > 500 THEN 2\\r\\n        ELSE 3\\r\\n    END AS prioridade,\\r\\n    \\r\\n    -- Dados de Contexto\\r\\n    qtde_ultimos_meses_iguais,\\r\\n    crescimento_saldo_percentual,\\r\\n    desvio_padrao_credito,\\r\\n    classificacao_risco\\r\\nFROM teste.credito_dime_completo\\r\\nWHERE (\\r\\n    score_risco >= 70 OR\\r\\n    qtde_ultimos_meses_iguais >= 6 OR\\r\\n    crescimento_saldo_percentual > 300 OR\\r\\n    (saldo_credor_atual > 500000 AND desvio_padrao_credito < 100)\\r\\n)\\r\\nORDER BY\\r\\n    CASE \\r\\n        WHEN score_risco >= 80 OR qtde_ultimos_meses_iguais >= 12 THEN 1\\r\\n        WHEN crescimento_saldo_percentual > 1000 THEN 1\\r\\n        WHEN saldo_credor_atual > 1000000 AND qtde_ultimos_meses_iguais >= 6 THEN 2\\r\\n        WHEN crescimento_saldo_percentual > 500 THEN 2\\r\\n        ELSE 3\\r\\n    END,\\r\\n    score_risco DESC\\r\\nLIMIT 100;\\r\\n\\r\\n\", \"statementsList\": [\"\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- 3.4 EMPRESAS \\\"FANTASMA\\\" - Alto Cr\\u00e9dito sem Movimenta\\u00e7\\u00e3o\\r\\nSELECT\\r\\n    'EMPRESAS FANTASMA' AS categoria,\\r\\n    cd.nu_cnpj,\\r\\n    cd.nm_razao_social,\\r\\n    cd.de_cnae,\\r\\n    cd.nm_sit_cadastral,\\r\\n    cd.saldo_credor_atual,\\r\\n    cd.score_risco,\\r\\n    cd.qtde_ultimos_meses_iguais,\\r\\n    cd.crescimento_saldo_percentual,\\r\\n    cd.vl_credito_presumido_13m,\\r\\n    (COALESCE(txt.vl_entradas_textil, 0) + COALESCE(txt.vl_saidas_textil, 0) +\\r\\n     COALESCE(mm.vl_entradas_metalmec, 0) + COALESCE(mm.vl_saidas_metalmec, 0) +\\r\\n     COALESCE(tech.vl_entradas_tech, 0) + COALESCE(tech.vl_saidas_tech, 0)) AS movto_total_3_setores\\r\\nFROM teste.credito_dime_completo cd\\r\\nLEFT JOIN teste.credito_dime_textil txt ON cd.nu_cnpj = txt.nu_cnpj\\r\\nLEFT JOIN teste.credito_dime_metalmec mm ON cd.nu_cnpj = mm.nu_cnpj\\r\\nLEFT JOIN teste.credito_dime_tech tech ON cd.nu_cnpj = tech.nu_cnpj\\r\\nWHERE cd.classificacao_risco IN ('CR\\u00cdTICO', 'ALTO')\\r\\nAND cd.saldo_credor_atual > 100000\\r\\nAND (COALESCE(txt.vl_entradas_textil, 0) + COALESCE(txt.vl_saidas_textil, 0) +\\r\\n     COALESCE(mm.vl_entradas_metalmec, 0) + COALESCE(mm.vl_saidas_metalmec, 0) +\\r\\n     COALESCE(tech.vl_entradas_tech, 0) + COALESCE(tech.vl_saidas_tech, 0)) < 10000\\r\\nORDER BY cd.saldo_credor_atual DESC\\r\\nLIMIT 50;\", \"\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- M\\u00d3DULO 4: AN\\u00c1LISE DETALHADA - SETOR T\\u00caXTIL\\r\\n-- =============================================================================\\r\\n\\r\\n-- 4.1 OVERVIEW SETOR T\\u00caXTIL\\r\\nSELECT\\r\\n    'OVERVIEW T\\u00caXTIL' AS categoria,\\r\\n    classificacao_risco,\\r\\n    COUNT(*) AS qtde_empresas,\\r\\n    ROUND(SUM(saldo_credor_atual), 2) AS total_saldo_credor,\\r\\n    ROUND(AVG(saldo_credor_atual), 2) AS media_saldo_credor,\\r\\n    ROUND(SUM(vl_entradas_textil), 2) AS total_entradas,\\r\\n    ROUND(SUM(vl_saidas_textil), 2) AS total_saidas,\\r\\n    ROUND(AVG(dias_movimento_textil), 2) AS media_dias_movimento,\\r\\n    COUNT(CASE WHEN vl_saidas_textil = 0 AND vl_entradas_textil > 10000 THEN 1 END) AS qtde_so_compra\\r\\nFROM teste.credito_dime_textil\\r\\nWHERE flag_setor_textil = 1\\r\\nAND vl_entradas_textil > 1000\\r\\nGROUP BY classificacao_risco\\r\\nORDER BY\\r\\n    CASE classificacao_risco\\r\\n        WHEN 'CR\\u00cdTICO' THEN 1\\r\\n        WHEN 'ALTO' THEN 2\\r\\n        WHEN 'M\\u00c9DIO' THEN 3\\r\\n        WHEN 'BAIXO' THEN 4\\r\\n    END;\", \"\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- 4.2 TOP 30 T\\u00caXTEIS CR\\u00cdTICAS\\r\\nSELECT\\r\\n    'TOP 30 T\\u00caXTIL' AS categoria,\\r\\n    nu_cnpj,\\r\\n    nm_razao_social,\\r\\n    de_cnae,\\r\\n    saldo_credor_atual,\\r\\n    vl_entradas_textil,\\r\\n    vl_saidas_textil,\\r\\n    dias_movimento_textil,\\r\\n    qtde_ncm_distintos_textil,\\r\\n    indice_entrada_saida_textil,\\r\\n    qtde_ultimos_meses_iguais,\\r\\n    crescimento_saldo_percentual,\\r\\n    score_risco,\\r\\n    classificacao_risco,\\r\\n    CASE \\r\\n        WHEN vl_saidas_textil = 0 THEN 'SO COMPRA'\\r\\n        WHEN vl_entradas_textil > vl_saidas_textil * 3 THEN 'COMPRA 3X+ VENDE'\\r\\n        WHEN vl_saidas_textil > vl_entradas_textil * 3 THEN 'VENDE 3X+ COMPRA'\\r\\n        ELSE 'EQUILIBRADO'\\r\\n    END AS padrao_movimento\\r\\nFROM teste.credito_dime_textil\\r\\nWHERE flag_setor_textil = 1\\r\\nAND vl_entradas_textil > 10000\\r\\nAND classificacao_risco IN ('CR\\u00cdTICO', 'ALTO')\\r\\nORDER BY score_risco DESC, saldo_credor_atual DESC\\r\\nLIMIT 30;\", \"\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- 4.3 PADR\\u00d5ES DE MOVIMENTA\\u00c7\\u00c3O T\\u00caXTIL\\r\\nSELECT\\r\\n    'PADR\\u00d5ES T\\u00caXTIL' AS categoria,\\r\\n    CASE \\r\\n        WHEN vl_saidas_textil = 0 AND vl_entradas_textil > 10000 THEN '1. SO COMPRA (SUSPEITO)'\\r\\n        WHEN vl_entradas_textil = 0 AND vl_saidas_textil > 10000 THEN '2. SO VENDE (ST)'\\r\\n        WHEN vl_entradas_textil > vl_saidas_textil * 3 THEN '3. COMPRA 3X+ VENDE'\\r\\n        WHEN vl_saidas_textil > vl_entradas_textil * 3 THEN '4. VENDE 3X+ COMPRA'\\r\\n        ELSE '5. EQUILIBRADO'\\r\\n    END AS padrao,\\r\\n    COUNT(*) AS qtde_empresas,\\r\\n    ROUND(SUM(saldo_credor_atual), 2) AS total_saldo_credor,\\r\\n    ROUND(AVG(saldo_credor_atual), 2) AS media_saldo_credor,\\r\\n    ROUND(AVG(vl_entradas_textil), 2) AS media_entradas,\\r\\n    ROUND(AVG(vl_saidas_textil), 2) AS media_saidas,\\r\\n    COUNT(CASE WHEN classificacao_risco = 'CR\\u00cdTICO' THEN 1 END) AS qtde_criticos\\r\\nFROM teste.credito_dime_textil\\r\\nWHERE flag_setor_textil = 1\\r\\nAND (vl_entradas_textil > 1000 OR vl_saidas_textil > 1000)\\r\\nGROUP BY padrao\\r\\nORDER BY total_saldo_credor DESC;\", \"\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- 4.4 T\\u00caXTEIS COM CR\\u00c9DITO DESPROPORCIONAL\\r\\nSELECT\\r\\n    'CR\\u00c9DITO DESPROPORCIONAL T\\u00caXTIL' AS categoria,\\r\\n    nu_cnpj,\\r\\n    nm_razao_social,\\r\\n    de_cnae,\\r\\n    saldo_credor_atual,\\r\\n    vl_entradas_textil,\\r\\n    vl_saidas_textil,\\r\\n    vl_credito_presumido_13m,\\r\\n    ROUND(vl_entradas_textil * 0.18, 2) AS credito_esperado_entradas,\\r\\n    ROUND(saldo_credor_atual - (vl_entradas_textil * 0.18), 2) AS credito_excedente,\\r\\n    ROUND(100.0 * (saldo_credor_atual - (vl_entradas_textil * 0.18)) / NULLIF(saldo_credor_atual, 0), 2) AS perc_credito_inexplicavel,\\r\\n    \\r\\n    indice_saldo_entrada_textil,\\r\\n    qtde_ultimos_meses_iguais,\\r\\n    score_risco,\\r\\n    classificacao_risco\\r\\nFROM teste.credito_dime_textil\\r\\nWHERE flag_setor_textil = 1\\r\\nAND vl_entradas_textil > 10000\\r\\nAND saldo_credor_atual > 50000\\r\\nAND saldo_credor_atual > (vl_entradas_textil * 0.18 * 2)\\r\\nAND classificacao_risco IN ('CR\\u00cdTICO', 'ALTO')\\r\\nORDER BY perc_credito_inexplicavel DESC\\r\\nLIMIT 30;\", \"\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- M\\u00d3DULO 5: AN\\u00c1LISE DETALHADA - SETOR METAL-MEC\\u00c2NICO\\r\\n-- =============================================================================\\r\\n\\r\\n-- 5.1 OVERVIEW SETOR METAL-MEC\\u00c2NICO\\r\\nSELECT\\r\\n    'OVERVIEW METAL-MEC\\u00c2NICO' AS categoria,\\r\\n    classificacao_risco,\\r\\n    COUNT(*) AS qtde_empresas,\\r\\n    ROUND(SUM(saldo_credor_atual), 2) AS total_saldo_credor,\\r\\n    ROUND(AVG(saldo_credor_atual), 2) AS media_saldo_credor,\\r\\n    ROUND(SUM(vl_entradas_metalmec), 2) AS total_entradas,\\r\\n    ROUND(SUM(vl_saidas_metalmec), 2) AS total_saidas,\\r\\n    ROUND(AVG(dias_movimento_metalmec), 2) AS media_dias_movimento,\\r\\n    ROUND(AVG(perc_cap84), 2) AS media_perc_cap84,\\r\\n    COUNT(CASE WHEN vl_saidas_metalmec = 0 AND vl_entradas_metalmec > 10000 THEN 1 END) AS qtde_so_compra\\r\\nFROM teste.credito_dime_metalmec\\r\\nWHERE flag_setor_metalmec = 1\\r\\nAND vl_entradas_metalmec > 1000\\r\\nGROUP BY classificacao_risco\\r\\nORDER BY\\r\\n    CASE classificacao_risco\\r\\n        WHEN 'CR\\u00cdTICO' THEN 1\\r\\n        WHEN 'ALTO' THEN 2\\r\\n        WHEN 'M\\u00c9DIO' THEN 3\\r\\n        WHEN 'BAIXO' THEN 4\\r\\n    END;\", \"\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- 5.2 TOP 30 METAL-MEC\\u00c2NICO CR\\u00cdTICAS\\r\\nSELECT\\r\\n    'TOP 30 METAL-MEC\\u00c2NICO' AS categoria,\\r\\n    nu_cnpj,\\r\\n    nm_razao_social,\\r\\n    de_cnae,\\r\\n    saldo_credor_atual,\\r\\n    vl_entradas_metalmec,\\r\\n    vl_saidas_metalmec,\\r\\n    vl_capitulo_84,\\r\\n    vl_capitulo_85,\\r\\n    perc_cap84,\\r\\n    dias_movimento_metalmec,\\r\\n    qtde_ncm_distintos_metalmec,\\r\\n    indice_entrada_saida_metalmec,\\r\\n    qtde_ultimos_meses_iguais,\\r\\n    crescimento_saldo_percentual,\\r\\n    score_risco,\\r\\n    classificacao_risco,\\r\\n    CASE \\r\\n        WHEN vl_saidas_metalmec = 0 THEN 'SO COMPRA'\\r\\n        WHEN vl_entradas_metalmec > vl_saidas_metalmec * 3 THEN 'COMPRA 3X+ VENDE'\\r\\n        WHEN vl_saidas_metalmec > vl_entradas_metalmec * 3 THEN 'VENDE 3X+ COMPRA'\\r\\n        ELSE 'EQUILIBRADO'\\r\\n    END AS padrao_movimento\\r\\nFROM teste.credito_dime_metalmec\\r\\nWHERE flag_setor_metalmec = 1\\r\\nAND vl_entradas_metalmec > 10000\\r\\nAND classificacao_risco IN ('CR\\u00cdTICO', 'ALTO')\\r\\nORDER BY score_risco DESC, saldo_credor_atual DESC\\r\\nLIMIT 30;\", \"\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- 5.3 AN\\u00c1LISE CAP 84 vs CAP 85\\r\\nSELECT\\r\\n    'CAP 84 vs 85' AS categoria,\\r\\n    CASE \\r\\n        WHEN perc_cap84 > 80 THEN '1. PREDOMINANTE CAP 84 (MAQUINAS)'\\r\\n        WHEN perc_cap84 < 20 THEN '2. PREDOMINANTE CAP 85 (ELETRICOS)'\\r\\n        ELSE '3. MISTO'\\r\\n    END AS perfil_produto,\\r\\n    COUNT(*) AS qtde_empresas,\\r\\n    ROUND(AVG(saldo_credor_atual), 2) AS media_saldo_credor,\\r\\n    ROUND(SUM(vl_capitulo_84), 2) AS total_cap84,\\r\\n    ROUND(SUM(vl_capitulo_85), 2) AS total_cap85,\\r\\n    COUNT(CASE WHEN classificacao_risco = 'CR\\u00cdTICO' THEN 1 END) AS qtde_criticos\\r\\nFROM teste.credito_dime_metalmec\\r\\nWHERE flag_setor_metalmec = 1\\r\\nAND (vl_capitulo_84 + vl_capitulo_85) > 10000\\r\\nGROUP BY \\r\\n    CASE \\r\\n        WHEN perc_cap84 > 80 THEN '1. PREDOMINANTE CAP 84 (MAQUINAS)'\\r\\n        WHEN perc_cap84 < 20 THEN '2. PREDOMINANTE CAP 85 (ELETRICOS)'\\r\\n        ELSE '3. MISTO'\\r\\n    END\\r\\nORDER BY SUM(vl_capitulo_84) + SUM(vl_capitulo_85) DESC;\", \"\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- M\\u00d3DULO 6: AN\\u00c1LISE DETALHADA - SETOR TECNOLOGIA\\r\\n-- =============================================================================\\r\\n\\r\\n-- 6.1 OVERVIEW SETOR TECNOLOGIA\\r\\nSELECT\\r\\n    'OVERVIEW TECNOLOGIA' AS categoria,\\r\\n    classificacao_risco,\\r\\n    COUNT(*) AS qtde_empresas,\\r\\n    ROUND(SUM(saldo_credor_atual), 2) AS total_saldo_credor,\\r\\n    ROUND(AVG(saldo_credor_atual), 2) AS media_saldo_credor,\\r\\n    ROUND(SUM(vl_entradas_tech), 2) AS total_entradas,\\r\\n    ROUND(SUM(vl_saidas_tech), 2) AS total_saidas,\\r\\n    ROUND(SUM(vl_computadores), 2) AS total_computadores,\\r\\n    ROUND(SUM(vl_telecom), 2) AS total_telecom,\\r\\n    ROUND(AVG(dias_movimento_tech), 2) AS media_dias_movimento,\\r\\n    COUNT(CASE WHEN vl_saidas_tech = 0 AND vl_entradas_tech > 10000 THEN 1 END) AS qtde_so_compra\\r\\nFROM teste.credito_dime_tech\\r\\nWHERE flag_setor_tech = 1\\r\\nAND vl_entradas_tech > 1000\\r\\nGROUP BY classificacao_risco\\r\\nORDER BY\\r\\n    CASE classificacao_risco\\r\\n        WHEN 'CR\\u00cdTICO' THEN 1\\r\\n        WHEN 'ALTO' THEN 2\\r\\n        WHEN 'M\\u00c9DIO' THEN 3\\r\\n        WHEN 'BAIXO' THEN 4\\r\\n    END;\", \"\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- 6.2 TOP 30 TECNOLOGIA CR\\u00cdTICAS\\r\\nSELECT\\r\\n    'TOP 30 TECNOLOGIA' AS categoria,\\r\\n    nu_cnpj,\\r\\n    nm_razao_social,\\r\\n    de_cnae,\\r\\n    saldo_credor_atual,\\r\\n    vl_entradas_tech,\\r\\n    vl_saidas_tech,\\r\\n    vl_computadores,\\r\\n    vl_partes_computadores,\\r\\n    vl_telecom,\\r\\n    dias_movimento_tech,\\r\\n    qtde_ncm_distintos_tech,\\r\\n    indice_entrada_saida_tech,\\r\\n    qtde_ultimos_meses_iguais,\\r\\n    crescimento_saldo_percentual,\\r\\n    score_risco,\\r\\n    classificacao_risco,\\r\\n    CASE \\r\\n        WHEN vl_saidas_tech = 0 THEN 'SO COMPRA'\\r\\n        WHEN vl_entradas_tech > vl_saidas_tech * 3 THEN 'COMPRA 3X+ VENDE'\\r\\n        WHEN vl_saidas_tech > vl_entradas_tech * 3 THEN 'VENDE 3X+ COMPRA'\\r\\n        ELSE 'EQUILIBRADO'\\r\\n    END AS padrao_movimento\\r\\nFROM teste.credito_dime_tech\\r\\nWHERE flag_setor_tech = 1\\r\\nAND vl_entradas_tech > 10000\\r\\nAND classificacao_risco IN ('CR\\u00cdTICO', 'ALTO')\\r\\nORDER BY score_risco DESC, saldo_credor_atual DESC\\r\\nLIMIT 30;\", \"\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- 6.3 PERFIL DE PRODUTOS TECH\\r\\nSELECT\\r\\n    'PERFIL PRODUTOS TECH' AS categoria,\\r\\n    CASE \\r\\n        WHEN vl_computadores > (vl_partes_computadores + vl_telecom) * 2 THEN '1. COMPUTADORES'\\r\\n        WHEN vl_telecom > (vl_computadores + vl_partes_computadores) * 2 THEN '2. TELECOM'\\r\\n        WHEN vl_partes_computadores > (vl_computadores + vl_telecom) * 2 THEN '3. PARTES/PERIFERICOS'\\r\\n        ELSE '4. MISTO'\\r\\n    END AS perfil_produto,\\r\\n    COUNT(*) AS qtde_empresas,\\r\\n    ROUND(AVG(saldo_credor_atual), 2) AS media_saldo_credor,\\r\\n    ROUND(SUM(vl_computadores), 2) AS total_computadores,\\r\\n    ROUND(SUM(vl_partes_computadores), 2) AS total_partes,\\r\\n    ROUND(SUM(vl_telecom), 2) AS total_telecom,\\r\\n    COUNT(CASE WHEN classificacao_risco = 'CR\\u00cdTICO' THEN 1 END) AS qtde_criticos\\r\\nFROM teste.credito_dime_tech\\r\\nWHERE flag_setor_tech = 1\\r\\nAND (vl_computadores + vl_partes_computadores + vl_telecom) > 10000\\r\\nGROUP BY perfil_produto\\r\\nORDER BY qtde_empresas DESC;\", \"\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- M\\u00d3DULO 7: AN\\u00c1LISE INDIVIDUAL - TEMPLATE FICHA COMPLETA\\r\\n-- SUBSTITUA '00000000000000' PELO CNPJ DESEJADO\\r\\n-- =============================================================================\\r\\n\\r\\n-- 7.1 FICHA COMPLETA DE EMPRESA\\r\\nWITH empresa_base AS (\\r\\n    SELECT * FROM teste.credito_dime_completo WHERE nu_cnpj = '00000000000000'\\r\\n),\\r\\nempresa_textil AS (\\r\\n    SELECT * FROM teste.credito_dime_textil WHERE nu_cnpj = '00000000000000'\\r\\n),\\r\\nempresa_metalmec AS (\\r\\n    SELECT * FROM teste.credito_dime_metalmec WHERE nu_cnpj = '00000000000000'\\r\\n),\\r\\nempresa_tech AS (\\r\\n    SELECT * FROM teste.credito_dime_tech WHERE nu_cnpj = '00000000000000'\\r\\n)\\r\\nSELECT\\r\\n    'FICHA COMPLETA EMPRESA' AS categoria,\\r\\n    -- IDENTIFICA\\u00c7\\u00c3O\\r\\n    eb.nu_cnpj,\\r\\n    eb.nm_razao_social,\\r\\n    eb.nm_fantasia,\\r\\n    eb.de_cnae,\\r\\n    eb.nm_gerfe,\\r\\n    eb.nm_sit_cadastral,\\r\\n    -- RISCO\\r\\n    eb.score_risco,\\r\\n    eb.classificacao_risco,\\r\\n    ROW_NUMBER() OVER (ORDER BY eb.score_risco DESC) AS posicao_ranking_aprox,\\r\\n    -- CR\\u00c9DITO\\r\\n    eb.saldo_credor_atual,\\r\\n    eb.saldo_13m_atras,\\r\\n    eb.crescimento_saldo_absoluto,\\r\\n    eb.crescimento_saldo_percentual,\\r\\n    -- PADR\\u00c3O TEMPORAL\\r\\n    eb.qtde_ultimos_meses_iguais,\\r\\n    eb.valor_sequencia_recente,\\r\\n    eb.qtde_meses_declarados_13m,\\r\\n    eb.media_credito_13m,\\r\\n    eb.desvio_padrao_credito,\\r\\n    -- CR\\u00c9DITO PRESUMIDO\\r\\n    eb.vl_credito_presumido_13m,\\r\\n    eb.qtde_tipos_cp,\\r\\n    -- SETORES\\r\\n    CASE WHEN et.flag_setor_textil = 1 THEN 'SIM' ELSE 'NAO' END AS opera_textil,\\r\\n    et.vl_entradas_textil,\\r\\n    et.vl_saidas_textil,\\r\\n    et.dias_movimento_textil,\\r\\n    CASE WHEN em.flag_setor_metalmec = 1 THEN 'SIM' ELSE 'NAO' END AS opera_metalmec,\\r\\n    em.vl_entradas_metalmec,\\r\\n    em.vl_saidas_metalmec,\\r\\n    em.dias_movimento_metalmec,\\r\\n    CASE WHEN etch.flag_setor_tech = 1 THEN 'SIM' ELSE 'NAO' END AS opera_tech,\\r\\n    etch.vl_entradas_tech,\\r\\n    etch.vl_saidas_tech,\\r\\n    etch.dias_movimento_tech\\r\\nFROM empresa_base eb\\r\\nLEFT JOIN empresa_textil et ON eb.nu_cnpj = et.nu_cnpj\\r\\nLEFT JOIN empresa_metalmec em ON eb.nu_cnpj = em.nu_cnpj\\r\\nLEFT JOIN empresa_tech etch ON eb.nu_cnpj = etch.nu_cnpj;\", \"\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- M\\u00d3DULO 8: ALERTAS E MONITORAMENTO\\r\\n-- Sistema de alertas autom\\u00e1ticos para a\\u00e7\\u00e3o imediata\\r\\n-- =============================================================================\\r\\n\\r\\n-- 8.1 DASHBOARD EXECUTIVO - M\\u00c9TRICAS DI\\u00c1RIAS\\r\\nSELECT\\r\\n    'DASHBOARD EXECUTIVO' AS categoria,\\r\\n    -- M\\u00e9tricas Principais\\r\\n    COUNT(DISTINCT nu_cnpj) AS total_empresas,\\r\\n    \\r\\n    -- Distribui\\u00e7\\u00e3o por Risco\\r\\n    COUNT(CASE WHEN classificacao_risco = 'CR\\u00cdTICO' THEN 1 END) AS empresas_criticas,\\r\\n    COUNT(CASE WHEN classificacao_risco = 'ALTO' THEN 1 END) AS empresas_alto_risco,\\r\\n    COUNT(CASE WHEN classificacao_risco = 'M\\u00c9DIO' THEN 1 END) AS empresas_medio_risco,\\r\\n    \\r\\n    -- Percentuais\\r\\n    ROUND(COUNT(CASE WHEN classificacao_risco IN ('CR\\u00cdTICO', 'ALTO') THEN 1 END) * 100.0 / \\r\\n          COUNT(*), 1) AS perc_prioritarios,\\r\\n    \\r\\n    -- M\\u00e9tricas Financeiras\\r\\n    ROUND(SUM(saldo_credor_atual), 2) AS receita_total_monitorada,\\r\\n    \\r\\n    -- Top Alertas\\r\\n    COUNT(CASE WHEN qtde_ultimos_meses_iguais >= 12 THEN 1 END) AS alertas_congelamento,\\r\\n    COUNT(CASE WHEN crescimento_saldo_percentual > 500 THEN 1 END) AS alertas_crescimento_explosivo,\\r\\n    COUNT(CASE WHEN desvio_padrao_credito = 0 AND media_credito_13m > 1000 THEN 1 END) AS alertas_variacao_zero,\\r\\n    \\r\\n    -- Timestamp\\r\\n    CURRENT_TIMESTAMP() AS data_atualizacao\\r\\nFROM teste.credito_dime_completo;\", \"\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- 8.2 ALERTAS AUTOM\\u00c1TICOS PRIORIT\\u00c1RIOS\\r\\nSELECT\\r\\n    'ALERTAS AUTOM\\u00c1TICOS' AS categoria,\\r\\n    nu_cnpj,\\r\\n    nm_razao_social,\\r\\n    score_risco,\\r\\n    saldo_credor_atual,\\r\\n    -- Tipo de Alerta\\r\\n    CASE \\r\\n        WHEN score_risco >= 80 \\r\\n            THEN 'CR\\u00cdTICO: Score Extremo - Investiga\\u00e7\\u00e3o Imediata'\\r\\n        \\r\\n        WHEN qtde_ultimos_meses_iguais >= 12 AND desvio_padrao_credito < 100\\r\\n            THEN 'CR\\u00cdTICO: Valor Congelado h\\u00e1 12+ meses'\\r\\n        \\r\\n        WHEN crescimento_saldo_percentual > 1000\\r\\n            THEN 'CR\\u00cdTICO: Crescimento Explosivo 10X+'\\r\\n        \\r\\n        WHEN saldo_credor_atual > 1000000 AND qtde_ultimos_meses_iguais >= 6\\r\\n            THEN 'ALTO: Alto Cr\\u00e9dito + Estagna\\u00e7\\u00e3o'\\r\\n        \\r\\n        WHEN crescimento_saldo_percentual > 500 AND desvio_padrao_credito < 500\\r\\n            THEN 'ALTO: Crescimento An\\u00f4malo com Baixa Varia\\u00e7\\u00e3o'\\r\\n        \\r\\n        ELSE 'M\\u00c9DIO: Monitoramento Cont\\u00ednuo'\\r\\n    END AS tipo_alerta,\\r\\n    \\r\\n    -- Prioridade (1=Mais alta)\\r\\n    CASE \\r\\n        WHEN score_risco >= 80 OR qtde_ultimos_meses_iguais >= 12 THEN 1\\r\\n        WHEN crescimento_saldo_percentual > 1000 THEN 1\\r\\n        WHEN saldo_credor_atual > 1000000 AND qtde_ultimos_meses_iguais >= 6 THEN 2\\r\\n        WHEN crescimento_saldo_percentual > 500 THEN 2\\r\\n        ELSE 3\\r\\n    END AS prioridade,\\r\\n    \\r\\n    -- Dados de Contexto\\r\\n    qtde_ultimos_meses_iguais,\\r\\n    crescimento_saldo_percentual,\\r\\n    desvio_padrao_credito,\\r\\n    classificacao_risco\\r\\nFROM teste.credito_dime_completo\\r\\nWHERE (\\r\\n    score_risco >= 70 OR\\r\\n    qtde_ultimos_meses_iguais >= 6 OR\\r\\n    crescimento_saldo_percentual > 300 OR\\r\\n    (saldo_credor_atual > 500000 AND desvio_padrao_credito < 100)\\r\\n)\\r\\nORDER BY\\r\\n    CASE \\r\\n        WHEN score_risco >= 80 OR qtde_ultimos_meses_iguais >= 12 THEN 1\\r\\n        WHEN crescimento_saldo_percentual > 1000 THEN 1\\r\\n        WHEN saldo_credor_atual > 1000000 AND qtde_ultimos_meses_iguais >= 6 THEN 2\\r\\n        WHEN crescimento_saldo_percentual > 500 THEN 2\\r\\n        ELSE 3\\r\\n    END,\\r\\n    score_risco DESC\\r\\nLIMIT 100;\"], \"aceSize\": 100, \"status\": \"available\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- 6.3 PERFIL DE PRODUTOS TECH\\r\\nSELECT\\r\\n    'PERFIL PRODUTOS TECH' AS categoria,\\r\\n    CASE \\r\\n        WHEN vl_computadores > (vl_partes_computadores + vl_telecom) * 2 THEN '1. COMPUTADORES'\\r\\n        WHEN vl_telecom > (vl_computadores + vl_partes_computadores) * 2 THEN '2. TELECOM'\\r\\n        WHEN vl_partes_computadores > (vl_computadores + vl_telecom) * 2 THEN '3. PARTES/PERIFERICOS'\\r\\n        ELSE '4. MISTO'\\r\\n    END AS perfil_produto,\\r\\n    COUNT(*) AS qtde_empresas,\\r\\n    ROUND(AVG(saldo_credor_atual), 2) AS media_saldo_credor,\\r\\n    ROUND(SUM(vl_computadores), 2) AS total_computadores,\\r\\n    ROUND(SUM(vl_partes_computadores), 2) AS total_partes,\\r\\n    ROUND(SUM(vl_telecom), 2) AS total_telecom,\\r\\n    COUNT(CASE WHEN classificacao_risco = 'CR\\u00cdTICO' THEN 1 END) AS qtde_criticos\\r\\nFROM teste.credito_dime_tech\\r\\nWHERE flag_setor_tech = 1\\r\\nAND (vl_computadores + vl_partes_computadores + vl_telecom) > 10000\\r\\nGROUP BY perfil_produto\\r\\nORDER BY qtde_empresas DESC;\", \"result\": {\"id\": \"9a7b571d-81f1-9388-b3ac-48a5ab5f77c0\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"AnIV/ChmR2GmjNZx5pr+Bw==\", \"guid\": \"gZyFpu/5TioAAAAAaawnow==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"a14a96e02125e5fe:0e4a6eab4a1a89bd\", \"session_id\": 21447, \"session_type\": \"impala\", \"statement_id\": 22, \"has_more_statements\": true, \"statements_count\": 24, \"previous_statement_hash\": \"0d64e9c1d6b08802e1476abebecf15200e1bb0315ef906e85f9dc414\", \"start\": {\"row\": 640, \"column\": 0}, \"end\": {\"row\": 672, \"column\": 33}, \"statement\": \"-- PAUSA AQUI\\n\\n-- =============================================================================\\n-- M\\u00d3DULO 8: ALERTAS E MONITORAMENTO\\n-- Sistema de alertas autom\\u00e1ticos para a\\u00e7\\u00e3o imediata\\n-- =============================================================================\\n\\n-- 8.1 DASHBOARD EXECUTIVO - M\\u00c9TRICAS DI\\u00c1RIAS\\nSELECT\\n    'DASHBOARD EXECUTIVO' AS categoria,\\n    -- M\\u00e9tricas Principais\\n    COUNT(DISTINCT nu_cnpj) AS total_empresas,\\n    \\n    -- Distribui\\u00e7\\u00e3o por Risco\\n    COUNT(CASE WHEN classificacao_risco = 'CR\\u00cdTICO' THEN 1 END) AS empresas_criticas,\\n    COUNT(CASE WHEN classificacao_risco = 'ALTO' THEN 1 END) AS empresas_alto_risco,\\n    COUNT(CASE WHEN classificacao_risco = 'M\\u00c9DIO' THEN 1 END) AS empresas_medio_risco,\\n    \\n    -- Percentuais\\n    ROUND(COUNT(CASE WHEN classificacao_risco IN ('CR\\u00cdTICO', 'ALTO') THEN 1 END) * 100.0 / \\n          COUNT(*), 1) AS perc_prioritarios,\\n    \\n    -- M\\u00e9tricas Financeiras\\n    ROUND(SUM(saldo_credor_atual), 2) AS receita_total_monitorada,\\n    \\n    -- Top Alertas\\n    COUNT(CASE WHEN qtde_ultimos_meses_iguais >= 12 THEN 1 END) AS alertas_congelamento,\\n    COUNT(CASE WHEN crescimento_saldo_percentual > 500 THEN 1 END) AS alertas_crescimento_explosivo,\\n    COUNT(CASE WHEN desvio_padrao_credito = 0 AND media_credito_13m > 1000 THEN 1 END) AS alertas_variacao_zero,\\n    \\n    -- Timestamp\\n    CURRENT_TIMESTAMP() AS data_atualizacao\\nFROM teste.credito_dime_completo\"}, \"meta\": [], \"rows\": 1, \"hasMore\": false, \"statement_id\": 22, \"statement_range\": {\"start\": {\"row\": 640, \"column\": 0}, \"end\": {\"row\": 672, \"column\": 33}}, \"statements_count\": 24, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": 11, \"filteredMeta\": [{\"type\": \"int\", \"name\": \"\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 0}, {\"name\": \"categoria\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 1}, {\"name\": \"total_empresas\", \"type\": \"bigint\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 2}, {\"name\": \"empresas_criticas\", \"type\": \"bigint\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 3}, {\"name\": \"empresas_alto_risco\", \"type\": \"bigint\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 4}, {\"name\": \"empresas_medio_risco\", \"type\": \"bigint\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 5}, {\"name\": \"perc_prioritarios\", \"type\": \"decimal\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 6}, {\"name\": \"receita_total_monitorada\", \"type\": \"decimal\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 7}, {\"name\": \"alertas_congelamento\", \"type\": \"bigint\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 8}, {\"name\": \"alertas_crescimento_explosivo\", \"type\": \"bigint\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 9}, {\"name\": \"alertas_variacao_zero\", \"type\": \"bigint\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 10}, {\"name\": \"data_atualizacao\", \"type\": \"timestamp\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 11}], \"fetchedOnce\": false, \"startTime\": \"2025-10-11T04:39:20.757Z\", \"endTime\": \"2025-10-11T04:39:22.093Z\", \"executionTime\": 1336, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 4, \"hasSomeResults\": true}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": 19244, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": \"categoria\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [\"empresas_criticas\"], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": true, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"categoria\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [\"posicao_ranking_aprox\"], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": 19295, \"getLogsTimeout\": 19391, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1760157560536, \"lastAceSelectionRowOffset\": 0, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"lastExecutedStatements\": \"-- =============================================================================\\r\\n-- AN\\u00c1LISE COMPLETA DE CR\\u00c9DITOS ICMS ACUMULADOS\\r\\n-- Sistema de Consultas Modulares para An\\u00e1lise de Risco Fiscal\\r\\n-- Execute cada bloco SEPARADAMENTE, pausando entre execu\\u00e7\\u00f5es\\r\\n-- =============================================================================\\r\\n\\r\\n-- CONFIGURA\\u00c7\\u00c3O INICIAL\\r\\nSET REQUEST_POOL = 'medium';\\r\\nSET MEM_LIMIT = 8G;\\r\\n\\r\\n-- =============================================================================\\r\\n-- M\\u00d3DULO 1: VIS\\u00c3O GERAL DO SISTEMA\\r\\n-- Execute este bloco primeiro para ter o panorama geral\\r\\n-- =============================================================================\\r\\n\\r\\n-- 1.1 PANORAMA EXECUTIVO GERAL\\r\\nSELECT\\r\\n    'PANORAMA GERAL - CR\\u00c9DITOS ICMS' AS categoria,\\r\\n    -- M\\u00e9tricas de Volume\\r\\n    COUNT(DISTINCT nu_cnpj) AS total_empresas_monitoradas,\\r\\n    COUNT(DISTINCT nu_cnpj_grupo) AS total_grupos_economicos,\\r\\n    \\r\\n    -- Distribui\\u00e7\\u00e3o por Risco\\r\\n    COUNT(CASE WHEN classificacao_risco = 'CR\\u00cdTICO' THEN 1 END) AS empresas_criticas,\\r\\n    COUNT(CASE WHEN classificacao_risco = 'ALTO' THEN 1 END) AS empresas_alto_risco,\\r\\n    COUNT(CASE WHEN classificacao_risco = 'M\\u00c9DIO' THEN 1 END) AS empresas_medio_risco,\\r\\n    COUNT(CASE WHEN classificacao_risco = 'BAIXO' THEN 1 END) AS empresas_baixo_risco,\\r\\n    \\r\\n    -- Percentuais\\r\\n    ROUND(COUNT(CASE WHEN classificacao_risco IN ('CR\\u00cdTICO', 'ALTO') THEN 1 END) * 100.0 / \\r\\n          COUNT(*), 2) AS perc_prioridade_alta,\\r\\n    \\r\\n    -- M\\u00e9tricas Financeiras\\r\\n    ROUND(SUM(saldo_credor_atual), 2) AS total_credito_acumulado,\\r\\n    ROUND(AVG(saldo_credor_atual), 2) AS media_credito_empresa,\\r\\n    ROUND(SUM(CASE WHEN classificacao_risco = 'CR\\u00cdTICO' THEN saldo_credor_atual ELSE 0 END), 2) AS credito_critico,\\r\\n    \\r\\n    -- M\\u00e9tricas de Comportamento\\r\\n    ROUND(AVG(qtde_ultimos_meses_iguais), 2) AS media_meses_iguais,\\r\\n    ROUND(AVG(crescimento_saldo_percentual), 2) AS media_crescimento_perc,\\r\\n    COUNT(CASE WHEN qtde_ultimos_meses_iguais >= 12 THEN 1 END) AS empresas_congeladas_12m,\\r\\n    \\r\\n    -- Data de Atualiza\\u00e7\\u00e3o\\r\\n    CURRENT_TIMESTAMP() AS data_consulta\\r\\nFROM teste.credito_dime_completo;\\r\\n\\r\\n-- PAUSA AQUI - Analise os resultados antes de continuar\\r\\n\\r\\n-- =============================================================================\\r\\n-- 1.2 DISTRIBUI\\u00c7\\u00c3O POR FAIXAS DE SCORE\\r\\nSELECT\\r\\n    'DISTRIBUI\\u00c7\\u00c3O POR SCORE' AS categoria,\\r\\n    CASE \\r\\n        WHEN score_risco >= 80 THEN '80+ (Extremo)'\\r\\n        WHEN score_risco >= 70 THEN '70-79 (Cr\\u00edtico)'\\r\\n        WHEN score_risco >= 50 THEN '50-69 (Alto)'\\r\\n        WHEN score_risco >= 30 THEN '30-49 (M\\u00e9dio)'\\r\\n        ELSE '0-29 (Baixo)'\\r\\n    END AS faixa_score,\\r\\n    \\r\\n    COUNT(*) AS quantidade_empresas,\\r\\n    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) AS percentual,\\r\\n    ROUND(SUM(saldo_credor_atual), 2) AS total_credito_faixa,\\r\\n    ROUND(AVG(saldo_credor_atual), 2) AS media_credito_faixa,\\r\\n    ROUND(AVG(qtde_ultimos_meses_iguais), 2) AS media_meses_iguais,\\r\\n    ROUND(AVG(crescimento_saldo_percentual), 2) AS media_crescimento_perc\\r\\nFROM teste.credito_dime_completo\\r\\nGROUP BY\\r\\n    CASE \\r\\n        WHEN score_risco >= 80 THEN '80+ (Extremo)'\\r\\n        WHEN score_risco >= 70 THEN '70-79 (Cr\\u00edtico)'\\r\\n        WHEN score_risco >= 50 THEN '50-69 (Alto)'\\r\\n        WHEN score_risco >= 30 THEN '30-49 (M\\u00e9dio)'\\r\\n        ELSE '0-29 (Baixo)'\\r\\n    END\\r\\nORDER BY MIN(score_risco) DESC;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- 1.3 DISTRIBUI\\u00c7\\u00c3O POR GER\\u00caNCIA REGIONAL (GERFE)\\r\\nSELECT\\r\\n    'DISTRIBUI\\u00c7\\u00c3O POR GERFE' AS categoria,\\r\\n    nm_gerfe,\\r\\n    COUNT(*) AS total_empresas,\\r\\n    COUNT(CASE WHEN classificacao_risco IN ('CR\\u00cdTICO', 'ALTO') THEN 1 END) AS empresas_prioritarias,\\r\\n    ROUND(COUNT(CASE WHEN classificacao_risco IN ('CR\\u00cdTICO', 'ALTO') THEN 1 END) * 100.0 / COUNT(*), 2) AS perc_prioritarias,\\r\\n    ROUND(SUM(saldo_credor_atual), 2) AS total_credito,\\r\\n    ROUND(AVG(score_risco), 2) AS score_medio\\r\\nFROM teste.credito_dime_completo\\r\\nWHERE nm_gerfe IS NOT NULL\\r\\nGROUP BY nm_gerfe\\r\\nORDER BY empresas_prioritarias DESC, total_credito DESC;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- M\\u00d3DULO 2: AN\\u00c1LISE SETORIAL COMPARATIVA\\r\\n-- Compare os 3 setores analisados\\r\\n-- =============================================================================\\r\\n\\r\\n-- 2.1 COMPARA\\u00c7\\u00c3O GERAL ENTRE SETORES\\r\\nSELECT\\r\\n    'COMPARA\\u00c7\\u00c3O SETORIAL' AS categoria,\\r\\n    'T\\u00caXTIL' AS setor,\\r\\n    COUNT(*) AS qtde_empresas_total,\\r\\n    COUNT(CASE WHEN flag_setor_textil = 1 THEN 1 END) AS qtde_com_movimento,\\r\\n    ROUND(COUNT(CASE WHEN flag_setor_textil = 1 THEN 1 END) * 100.0 / COUNT(*), 2) AS perc_movimento,\\r\\n    ROUND(AVG(CASE WHEN flag_setor_textil = 1 THEN score_risco END), 2) AS score_medio_setor,\\r\\n    ROUND(SUM(CASE WHEN flag_setor_textil = 1 THEN saldo_credor_atual ELSE 0 END), 2) AS total_credito,\\r\\n    ROUND(SUM(CASE WHEN flag_setor_textil = 1 THEN vl_entradas_textil + vl_saidas_textil ELSE 0 END), 2) AS movimentacao_total,\\r\\n    COUNT(CASE WHEN flag_setor_textil = 1 AND classificacao_risco = 'CR\\u00cdTICO' THEN 1 END) AS qtde_criticos\\r\\nFROM teste.credito_dime_textil\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT\\r\\n    'COMPARA\\u00c7\\u00c3O SETORIAL' AS categoria,\\r\\n    'METAL-MEC\\u00c2NICO' AS setor,\\r\\n    COUNT(*) AS qtde_empresas_total,\\r\\n    COUNT(CASE WHEN flag_setor_metalmec = 1 THEN 1 END) AS qtde_com_movimento,\\r\\n    ROUND(COUNT(CASE WHEN flag_setor_metalmec = 1 THEN 1 END) * 100.0 / COUNT(*), 2) AS perc_movimento,\\r\\n    ROUND(AVG(CASE WHEN flag_setor_metalmec = 1 THEN score_risco END), 2) AS score_medio_setor,\\r\\n    ROUND(SUM(CASE WHEN flag_setor_metalmec = 1 THEN saldo_credor_atual ELSE 0 END), 2) AS total_credito,\\r\\n    ROUND(SUM(CASE WHEN flag_setor_metalmec = 1 THEN vl_entradas_metalmec + vl_saidas_metalmec ELSE 0 END), 2) AS movimentacao_total,\\r\\n    COUNT(CASE WHEN flag_setor_metalmec = 1 AND classificacao_risco = 'CR\\u00cdTICO' THEN 1 END) AS qtde_criticos\\r\\nFROM teste.credito_dime_metalmec\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT\\r\\n    'COMPARA\\u00c7\\u00c3O SETORIAL' AS categoria,\\r\\n    'TECNOLOGIA' AS setor,\\r\\n    COUNT(*) AS qtde_empresas_total,\\r\\n    COUNT(CASE WHEN flag_setor_tech = 1 THEN 1 END) AS qtde_com_movimento,\\r\\n    ROUND(COUNT(CASE WHEN flag_setor_tech = 1 THEN 1 END) * 100.0 / COUNT(*), 2) AS perc_movimento,\\r\\n    ROUND(AVG(CASE WHEN flag_setor_tech = 1 THEN score_risco END), 2) AS score_medio_setor,\\r\\n    ROUND(SUM(CASE WHEN flag_setor_tech = 1 THEN saldo_credor_atual ELSE 0 END), 2) AS total_credito,\\r\\n    ROUND(SUM(CASE WHEN flag_setor_tech = 1 THEN vl_entradas_tech + vl_saidas_tech ELSE 0 END), 2) AS movimentacao_total,\\r\\n    COUNT(CASE WHEN flag_setor_tech = 1 AND classificacao_risco = 'CR\\u00cdTICO' THEN 1 END) AS qtde_criticos\\r\\nFROM teste.credito_dime_tech;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- 2.2 EMPRESAS MULTI-SETORIAIS\\r\\nSELECT\\r\\n    'EMPRESAS MULTI-SETORIAIS' AS categoria,\\r\\n    txt.nu_cnpj,\\r\\n    txt.nm_razao_social,\\r\\n    txt.de_cnae,\\r\\n    txt.saldo_credor_atual,\\r\\n    txt.score_risco,\\r\\n    txt.classificacao_risco,\\r\\n    CASE WHEN txt.flag_setor_textil = 1 THEN 'SIM' ELSE 'N\\u00c3O' END AS opera_textil,\\r\\n    CASE WHEN mm.flag_setor_metalmec = 1 THEN 'SIM' ELSE 'N\\u00c3O' END AS opera_metalmec,\\r\\n    CASE WHEN tech.flag_setor_tech = 1 THEN 'SIM' ELSE 'N\\u00c3O' END AS opera_tech,\\r\\n    \\r\\n    (COALESCE(txt.flag_setor_textil, 0) + \\r\\n     COALESCE(mm.flag_setor_metalmec, 0) + \\r\\n     COALESCE(tech.flag_setor_tech, 0)) AS qtde_setores,\\r\\n    \\r\\n    (COALESCE(txt.vl_entradas_textil, 0) + COALESCE(txt.vl_saidas_textil, 0) +\\r\\n     COALESCE(mm.vl_entradas_metalmec, 0) + COALESCE(mm.vl_saidas_metalmec, 0) +\\r\\n     COALESCE(tech.vl_entradas_tech, 0) + COALESCE(tech.vl_saidas_tech, 0)) AS movimentacao_total\\r\\nFROM teste.credito_dime_textil txt\\r\\nLEFT JOIN teste.credito_dime_metalmec mm ON txt.nu_cnpj = mm.nu_cnpj\\r\\nLEFT JOIN teste.credito_dime_tech tech ON txt.nu_cnpj = tech.nu_cnpj\\r\\nWHERE (COALESCE(txt.flag_setor_textil, 0) + \\r\\n       COALESCE(mm.flag_setor_metalmec, 0) + \\r\\n       COALESCE(tech.flag_setor_tech, 0)) >= 2\\r\\nAND txt.saldo_credor_atual > 50000\\r\\nAND txt.classificacao_risco IN ('CR\\u00cdTICO', 'ALTO')\\r\\nORDER BY qtde_setores DESC, txt.saldo_credor_atual DESC\\r\\nLIMIT 50;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- M\\u00d3DULO 3: TOP EMPRESAS - RANKINGS GERAIS\\r\\n-- Identifique as empresas mais cr\\u00edticas\\r\\n-- =============================================================================\\r\\n\\r\\n-- 3.1 TOP 50 POR SCORE DE RISCO\\r\\nSELECT\\r\\n    'TOP 50 POR SCORE' AS categoria,\\r\\n    ROW_NUMBER() OVER (ORDER BY score_risco DESC, saldo_credor_atual DESC) AS ranking,\\r\\n    nu_cnpj,\\r\\n    nm_razao_social,\\r\\n    de_cnae,\\r\\n    nm_gerfe,\\r\\n    score_risco,\\r\\n    classificacao_risco,\\r\\n    saldo_credor_atual,\\r\\n    qtde_ultimos_meses_iguais,\\r\\n    crescimento_saldo_percentual,\\r\\n    vl_credito_presumido_13m\\r\\nFROM teste.credito_dime_completo\\r\\nWHERE classificacao_risco IN ('CR\\u00cdTICO', 'ALTO')\\r\\nORDER BY score_risco DESC, saldo_credor_atual DESC\\r\\nLIMIT 50;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- 3.2 TOP 50 POR SALDO CREDOR ACUMULADO\\r\\nSELECT\\r\\n    'TOP 50 POR SALDO CREDOR' AS categoria,\\r\\n    ROW_NUMBER() OVER (ORDER BY saldo_credor_atual DESC) AS ranking,\\r\\n    nu_cnpj,\\r\\n    nm_razao_social,\\r\\n    de_cnae,\\r\\n    nm_gerfe,\\r\\n    saldo_credor_atual,\\r\\n    score_risco,\\r\\n    classificacao_risco,\\r\\n    qtde_ultimos_meses_iguais,\\r\\n    crescimento_saldo_percentual,\\r\\n    vl_credito_presumido_13m\\r\\nFROM teste.credito_dime_completo\\r\\nWHERE saldo_credor_atual > 100000\\r\\nORDER BY saldo_credor_atual DESC\\r\\nLIMIT 50;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- 3.3 TOP 50 POR CRESCIMENTO PERCENTUAL\\r\\nSELECT\\r\\n    'TOP 50 POR CRESCIMENTO' AS categoria,\\r\\n    ROW_NUMBER() OVER (ORDER BY crescimento_saldo_percentual DESC) AS ranking,\\r\\n    nu_cnpj,\\r\\n    nm_razao_social,\\r\\n    de_cnae,\\r\\n    nm_gerfe,\\r\\n    crescimento_saldo_percentual,\\r\\n    saldo_13m_atras,\\r\\n    saldo_credor_atual,\\r\\n    crescimento_saldo_absoluto,\\r\\n    score_risco,\\r\\n    classificacao_risco\\r\\nFROM teste.credito_dime_completo\\r\\nWHERE crescimento_saldo_percentual > 100\\r\\nAND saldo_credor_atual > 10000\\r\\nORDER BY crescimento_saldo_percentual DESC\\r\\nLIMIT 50;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- 3.4 EMPRESAS \\\"FANTASMA\\\" - Alto Cr\\u00e9dito sem Movimenta\\u00e7\\u00e3o\\r\\nSELECT\\r\\n    'EMPRESAS FANTASMA' AS categoria,\\r\\n    cd.nu_cnpj,\\r\\n    cd.nm_razao_social,\\r\\n    cd.de_cnae,\\r\\n    cd.nm_sit_cadastral,\\r\\n    cd.saldo_credor_atual,\\r\\n    cd.score_risco,\\r\\n    cd.qtde_ultimos_meses_iguais,\\r\\n    cd.crescimento_saldo_percentual,\\r\\n    cd.vl_credito_presumido_13m,\\r\\n    (COALESCE(txt.vl_entradas_textil, 0) + COALESCE(txt.vl_saidas_textil, 0) +\\r\\n     COALESCE(mm.vl_entradas_metalmec, 0) + COALESCE(mm.vl_saidas_metalmec, 0) +\\r\\n     COALESCE(tech.vl_entradas_tech, 0) + COALESCE(tech.vl_saidas_tech, 0)) AS movto_total_3_setores\\r\\nFROM teste.credito_dime_completo cd\\r\\nLEFT JOIN teste.credito_dime_textil txt ON cd.nu_cnpj = txt.nu_cnpj\\r\\nLEFT JOIN teste.credito_dime_metalmec mm ON cd.nu_cnpj = mm.nu_cnpj\\r\\nLEFT JOIN teste.credito_dime_tech tech ON cd.nu_cnpj = tech.nu_cnpj\\r\\nWHERE cd.classificacao_risco IN ('CR\\u00cdTICO', 'ALTO')\\r\\nAND cd.saldo_credor_atual > 100000\\r\\nAND (COALESCE(txt.vl_entradas_textil, 0) + COALESCE(txt.vl_saidas_textil, 0) +\\r\\n     COALESCE(mm.vl_entradas_metalmec, 0) + COALESCE(mm.vl_saidas_metalmec, 0) +\\r\\n     COALESCE(tech.vl_entradas_tech, 0) + COALESCE(tech.vl_saidas_tech, 0)) < 10000\\r\\nORDER BY cd.saldo_credor_atual DESC\\r\\nLIMIT 50;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- M\\u00d3DULO 4: AN\\u00c1LISE DETALHADA - SETOR T\\u00caXTIL\\r\\n-- =============================================================================\\r\\n\\r\\n-- 4.1 OVERVIEW SETOR T\\u00caXTIL\\r\\nSELECT\\r\\n    'OVERVIEW T\\u00caXTIL' AS categoria,\\r\\n    classificacao_risco,\\r\\n    COUNT(*) AS qtde_empresas,\\r\\n    ROUND(SUM(saldo_credor_atual), 2) AS total_saldo_credor,\\r\\n    ROUND(AVG(saldo_credor_atual), 2) AS media_saldo_credor,\\r\\n    ROUND(SUM(vl_entradas_textil), 2) AS total_entradas,\\r\\n    ROUND(SUM(vl_saidas_textil), 2) AS total_saidas,\\r\\n    ROUND(AVG(dias_movimento_textil), 2) AS media_dias_movimento,\\r\\n    COUNT(CASE WHEN vl_saidas_textil = 0 AND vl_entradas_textil > 10000 THEN 1 END) AS qtde_so_compra\\r\\nFROM teste.credito_dime_textil\\r\\nWHERE flag_setor_textil = 1\\r\\nAND vl_entradas_textil > 1000\\r\\nGROUP BY classificacao_risco\\r\\nORDER BY\\r\\n    CASE classificacao_risco\\r\\n        WHEN 'CR\\u00cdTICO' THEN 1\\r\\n        WHEN 'ALTO' THEN 2\\r\\n        WHEN 'M\\u00c9DIO' THEN 3\\r\\n        WHEN 'BAIXO' THEN 4\\r\\n    END;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- 4.2 TOP 30 T\\u00caXTEIS CR\\u00cdTICAS\\r\\nSELECT\\r\\n    'TOP 30 T\\u00caXTIL' AS categoria,\\r\\n    nu_cnpj,\\r\\n    nm_razao_social,\\r\\n    de_cnae,\\r\\n    saldo_credor_atual,\\r\\n    vl_entradas_textil,\\r\\n    vl_saidas_textil,\\r\\n    dias_movimento_textil,\\r\\n    qtde_ncm_distintos_textil,\\r\\n    indice_entrada_saida_textil,\\r\\n    qtde_ultimos_meses_iguais,\\r\\n    crescimento_saldo_percentual,\\r\\n    score_risco,\\r\\n    classificacao_risco,\\r\\n    CASE \\r\\n        WHEN vl_saidas_textil = 0 THEN 'SO COMPRA'\\r\\n        WHEN vl_entradas_textil > vl_saidas_textil * 3 THEN 'COMPRA 3X+ VENDE'\\r\\n        WHEN vl_saidas_textil > vl_entradas_textil * 3 THEN 'VENDE 3X+ COMPRA'\\r\\n        ELSE 'EQUILIBRADO'\\r\\n    END AS padrao_movimento\\r\\nFROM teste.credito_dime_textil\\r\\nWHERE flag_setor_textil = 1\\r\\nAND vl_entradas_textil > 10000\\r\\nAND classificacao_risco IN ('CR\\u00cdTICO', 'ALTO')\\r\\nORDER BY score_risco DESC, saldo_credor_atual DESC\\r\\nLIMIT 30;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- 4.3 PADR\\u00d5ES DE MOVIMENTA\\u00c7\\u00c3O T\\u00caXTIL\\r\\nSELECT\\r\\n    'PADR\\u00d5ES T\\u00caXTIL' AS categoria,\\r\\n    CASE \\r\\n        WHEN vl_saidas_textil = 0 AND vl_entradas_textil > 10000 THEN '1. SO COMPRA (SUSPEITO)'\\r\\n        WHEN vl_entradas_textil = 0 AND vl_saidas_textil > 10000 THEN '2. SO VENDE (ST)'\\r\\n        WHEN vl_entradas_textil > vl_saidas_textil * 3 THEN '3. COMPRA 3X+ VENDE'\\r\\n        WHEN vl_saidas_textil > vl_entradas_textil * 3 THEN '4. VENDE 3X+ COMPRA'\\r\\n        ELSE '5. EQUILIBRADO'\\r\\n    END AS padrao,\\r\\n    COUNT(*) AS qtde_empresas,\\r\\n    ROUND(SUM(saldo_credor_atual), 2) AS total_saldo_credor,\\r\\n    ROUND(AVG(saldo_credor_atual), 2) AS media_saldo_credor,\\r\\n    ROUND(AVG(vl_entradas_textil), 2) AS media_entradas,\\r\\n    ROUND(AVG(vl_saidas_textil), 2) AS media_saidas,\\r\\n    COUNT(CASE WHEN classificacao_risco = 'CR\\u00cdTICO' THEN 1 END) AS qtde_criticos\\r\\nFROM teste.credito_dime_textil\\r\\nWHERE flag_setor_textil = 1\\r\\nAND (vl_entradas_textil > 1000 OR vl_saidas_textil > 1000)\\r\\nGROUP BY padrao\\r\\nORDER BY total_saldo_credor DESC;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- 4.4 T\\u00caXTEIS COM CR\\u00c9DITO DESPROPORCIONAL\\r\\nSELECT\\r\\n    'CR\\u00c9DITO DESPROPORCIONAL T\\u00caXTIL' AS categoria,\\r\\n    nu_cnpj,\\r\\n    nm_razao_social,\\r\\n    de_cnae,\\r\\n    saldo_credor_atual,\\r\\n    vl_entradas_textil,\\r\\n    vl_saidas_textil,\\r\\n    vl_credito_presumido_13m,\\r\\n    ROUND(vl_entradas_textil * 0.18, 2) AS credito_esperado_entradas,\\r\\n    ROUND(saldo_credor_atual - (vl_entradas_textil * 0.18), 2) AS credito_excedente,\\r\\n    ROUND(100.0 * (saldo_credor_atual - (vl_entradas_textil * 0.18)) / NULLIF(saldo_credor_atual, 0), 2) AS perc_credito_inexplicavel,\\r\\n    \\r\\n    indice_saldo_entrada_textil,\\r\\n    qtde_ultimos_meses_iguais,\\r\\n    score_risco,\\r\\n    classificacao_risco\\r\\nFROM teste.credito_dime_textil\\r\\nWHERE flag_setor_textil = 1\\r\\nAND vl_entradas_textil > 10000\\r\\nAND saldo_credor_atual > 50000\\r\\nAND saldo_credor_atual > (vl_entradas_textil * 0.18 * 2)\\r\\nAND classificacao_risco IN ('CR\\u00cdTICO', 'ALTO')\\r\\nORDER BY perc_credito_inexplicavel DESC\\r\\nLIMIT 30;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- M\\u00d3DULO 5: AN\\u00c1LISE DETALHADA - SETOR METAL-MEC\\u00c2NICO\\r\\n-- =============================================================================\\r\\n\\r\\n-- 5.1 OVERVIEW SETOR METAL-MEC\\u00c2NICO\\r\\nSELECT\\r\\n    'OVERVIEW METAL-MEC\\u00c2NICO' AS categoria,\\r\\n    classificacao_risco,\\r\\n    COUNT(*) AS qtde_empresas,\\r\\n    ROUND(SUM(saldo_credor_atual), 2) AS total_saldo_credor,\\r\\n    ROUND(AVG(saldo_credor_atual), 2) AS media_saldo_credor,\\r\\n    ROUND(SUM(vl_entradas_metalmec), 2) AS total_entradas,\\r\\n    ROUND(SUM(vl_saidas_metalmec), 2) AS total_saidas,\\r\\n    ROUND(AVG(dias_movimento_metalmec), 2) AS media_dias_movimento,\\r\\n    ROUND(AVG(perc_cap84), 2) AS media_perc_cap84,\\r\\n    COUNT(CASE WHEN vl_saidas_metalmec = 0 AND vl_entradas_metalmec > 10000 THEN 1 END) AS qtde_so_compra\\r\\nFROM teste.credito_dime_metalmec\\r\\nWHERE flag_setor_metalmec = 1\\r\\nAND vl_entradas_metalmec > 1000\\r\\nGROUP BY classificacao_risco\\r\\nORDER BY\\r\\n    CASE classificacao_risco\\r\\n        WHEN 'CR\\u00cdTICO' THEN 1\\r\\n        WHEN 'ALTO' THEN 2\\r\\n        WHEN 'M\\u00c9DIO' THEN 3\\r\\n        WHEN 'BAIXO' THEN 4\\r\\n    END;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- 5.2 TOP 30 METAL-MEC\\u00c2NICO CR\\u00cdTICAS\\r\\nSELECT\\r\\n    'TOP 30 METAL-MEC\\u00c2NICO' AS categoria,\\r\\n    nu_cnpj,\\r\\n    nm_razao_social,\\r\\n    de_cnae,\\r\\n    saldo_credor_atual,\\r\\n    vl_entradas_metalmec,\\r\\n    vl_saidas_metalmec,\\r\\n    vl_capitulo_84,\\r\\n    vl_capitulo_85,\\r\\n    perc_cap84,\\r\\n    dias_movimento_metalmec,\\r\\n    qtde_ncm_distintos_metalmec,\\r\\n    indice_entrada_saida_metalmec,\\r\\n    qtde_ultimos_meses_iguais,\\r\\n    crescimento_saldo_percentual,\\r\\n    score_risco,\\r\\n    classificacao_risco,\\r\\n    CASE \\r\\n        WHEN vl_saidas_metalmec = 0 THEN 'SO COMPRA'\\r\\n        WHEN vl_entradas_metalmec > vl_saidas_metalmec * 3 THEN 'COMPRA 3X+ VENDE'\\r\\n        WHEN vl_saidas_metalmec > vl_entradas_metalmec * 3 THEN 'VENDE 3X+ COMPRA'\\r\\n        ELSE 'EQUILIBRADO'\\r\\n    END AS padrao_movimento\\r\\nFROM teste.credito_dime_metalmec\\r\\nWHERE flag_setor_metalmec = 1\\r\\nAND vl_entradas_metalmec > 10000\\r\\nAND classificacao_risco IN ('CR\\u00cdTICO', 'ALTO')\\r\\nORDER BY score_risco DESC, saldo_credor_atual DESC\\r\\nLIMIT 30;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- 5.3 AN\\u00c1LISE CAP 84 vs CAP 85\\r\\nSELECT\\r\\n    'CAP 84 vs 85' AS categoria,\\r\\n    CASE \\r\\n        WHEN perc_cap84 > 80 THEN '1. PREDOMINANTE CAP 84 (MAQUINAS)'\\r\\n        WHEN perc_cap84 < 20 THEN '2. PREDOMINANTE CAP 85 (ELETRICOS)'\\r\\n        ELSE '3. MISTO'\\r\\n    END AS perfil_produto,\\r\\n    COUNT(*) AS qtde_empresas,\\r\\n    ROUND(AVG(saldo_credor_atual), 2) AS media_saldo_credor,\\r\\n    ROUND(SUM(vl_capitulo_84), 2) AS total_cap84,\\r\\n    ROUND(SUM(vl_capitulo_85), 2) AS total_cap85,\\r\\n    COUNT(CASE WHEN classificacao_risco = 'CR\\u00cdTICO' THEN 1 END) AS qtde_criticos\\r\\nFROM teste.credito_dime_metalmec\\r\\nWHERE flag_setor_metalmec = 1\\r\\nAND (vl_capitulo_84 + vl_capitulo_85) > 10000\\r\\nGROUP BY \\r\\n    CASE \\r\\n        WHEN perc_cap84 > 80 THEN '1. PREDOMINANTE CAP 84 (MAQUINAS)'\\r\\n        WHEN perc_cap84 < 20 THEN '2. PREDOMINANTE CAP 85 (ELETRICOS)'\\r\\n        ELSE '3. MISTO'\\r\\n    END\\r\\nORDER BY SUM(vl_capitulo_84) + SUM(vl_capitulo_85) DESC;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- M\\u00d3DULO 6: AN\\u00c1LISE DETALHADA - SETOR TECNOLOGIA\\r\\n-- =============================================================================\\r\\n\\r\\n-- 6.1 OVERVIEW SETOR TECNOLOGIA\\r\\nSELECT\\r\\n    'OVERVIEW TECNOLOGIA' AS categoria,\\r\\n    classificacao_risco,\\r\\n    COUNT(*) AS qtde_empresas,\\r\\n    ROUND(SUM(saldo_credor_atual), 2) AS total_saldo_credor,\\r\\n    ROUND(AVG(saldo_credor_atual), 2) AS media_saldo_credor,\\r\\n    ROUND(SUM(vl_entradas_tech), 2) AS total_entradas,\\r\\n    ROUND(SUM(vl_saidas_tech), 2) AS total_saidas,\\r\\n    ROUND(SUM(vl_computadores), 2) AS total_computadores,\\r\\n    ROUND(SUM(vl_telecom), 2) AS total_telecom,\\r\\n    ROUND(AVG(dias_movimento_tech), 2) AS media_dias_movimento,\\r\\n    COUNT(CASE WHEN vl_saidas_tech = 0 AND vl_entradas_tech > 10000 THEN 1 END) AS qtde_so_compra\\r\\nFROM teste.credito_dime_tech\\r\\nWHERE flag_setor_tech = 1\\r\\nAND vl_entradas_tech > 1000\\r\\nGROUP BY classificacao_risco\\r\\nORDER BY\\r\\n    CASE classificacao_risco\\r\\n        WHEN 'CR\\u00cdTICO' THEN 1\\r\\n        WHEN 'ALTO' THEN 2\\r\\n        WHEN 'M\\u00c9DIO' THEN 3\\r\\n        WHEN 'BAIXO' THEN 4\\r\\n    END;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- 6.2 TOP 30 TECNOLOGIA CR\\u00cdTICAS\\r\\nSELECT\\r\\n    'TOP 30 TECNOLOGIA' AS categoria,\\r\\n    nu_cnpj,\\r\\n    nm_razao_social,\\r\\n    de_cnae,\\r\\n    saldo_credor_atual,\\r\\n    vl_entradas_tech,\\r\\n    vl_saidas_tech,\\r\\n    vl_computadores,\\r\\n    vl_partes_computadores,\\r\\n    vl_telecom,\\r\\n    dias_movimento_tech,\\r\\n    qtde_ncm_distintos_tech,\\r\\n    indice_entrada_saida_tech,\\r\\n    qtde_ultimos_meses_iguais,\\r\\n    crescimento_saldo_percentual,\\r\\n    score_risco,\\r\\n    classificacao_risco,\\r\\n    CASE \\r\\n        WHEN vl_saidas_tech = 0 THEN 'SO COMPRA'\\r\\n        WHEN vl_entradas_tech > vl_saidas_tech * 3 THEN 'COMPRA 3X+ VENDE'\\r\\n        WHEN vl_saidas_tech > vl_entradas_tech * 3 THEN 'VENDE 3X+ COMPRA'\\r\\n        ELSE 'EQUILIBRADO'\\r\\n    END AS padrao_movimento\\r\\nFROM teste.credito_dime_tech\\r\\nWHERE flag_setor_tech = 1\\r\\nAND vl_entradas_tech > 10000\\r\\nAND classificacao_risco IN ('CR\\u00cdTICO', 'ALTO')\\r\\nORDER BY score_risco DESC, saldo_credor_atual DESC\\r\\nLIMIT 30;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- 6.3 PERFIL DE PRODUTOS TECH\\r\\nSELECT\\r\\n    'PERFIL PRODUTOS TECH' AS categoria,\\r\\n    CASE \\r\\n        WHEN vl_computadores > (vl_partes_computadores + vl_telecom) * 2 THEN '1. COMPUTADORES'\\r\\n        WHEN vl_telecom > (vl_computadores + vl_partes_computadores) * 2 THEN '2. TELECOM'\\r\\n        WHEN vl_partes_computadores > (vl_computadores + vl_telecom) * 2 THEN '3. PARTES/PERIFERICOS'\\r\\n        ELSE '4. MISTO'\\r\\n    END AS perfil_produto,\\r\\n    COUNT(*) AS qtde_empresas,\\r\\n    ROUND(AVG(saldo_credor_atual), 2) AS media_saldo_credor,\\r\\n    ROUND(SUM(vl_computadores), 2) AS total_computadores,\\r\\n    ROUND(SUM(vl_partes_computadores), 2) AS total_partes,\\r\\n    ROUND(SUM(vl_telecom), 2) AS total_telecom,\\r\\n    COUNT(CASE WHEN classificacao_risco = 'CR\\u00cdTICO' THEN 1 END) AS qtde_criticos\\r\\nFROM teste.credito_dime_tech\\r\\nWHERE flag_setor_tech = 1\\r\\nAND (vl_computadores + vl_partes_computadores + vl_telecom) > 10000\\r\\nGROUP BY perfil_produto\\r\\nORDER BY qtde_empresas DESC;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- M\\u00d3DULO 7: AN\\u00c1LISE INDIVIDUAL - TEMPLATE FICHA COMPLETA\\r\\n-- SUBSTITUA '00000000000000' PELO CNPJ DESEJADO\\r\\n-- =============================================================================\\r\\n\\r\\n-- 7.1 FICHA COMPLETA DE EMPRESA\\r\\nWITH empresa_base AS (\\r\\n    SELECT * FROM teste.credito_dime_completo WHERE nu_cnpj = '00000000000000'\\r\\n),\\r\\nempresa_textil AS (\\r\\n    SELECT * FROM teste.credito_dime_textil WHERE nu_cnpj = '00000000000000'\\r\\n),\\r\\nempresa_metalmec AS (\\r\\n    SELECT * FROM teste.credito_dime_metalmec WHERE nu_cnpj = '00000000000000'\\r\\n),\\r\\nempresa_tech AS (\\r\\n    SELECT * FROM teste.credito_dime_tech WHERE nu_cnpj = '00000000000000'\\r\\n)\\r\\nSELECT\\r\\n    'FICHA COMPLETA EMPRESA' AS categoria,\\r\\n    -- IDENTIFICA\\u00c7\\u00c3O\\r\\n    eb.nu_cnpj,\\r\\n    eb.nm_razao_social,\\r\\n    eb.nm_fantasia,\\r\\n    eb.de_cnae,\\r\\n    eb.nm_gerfe,\\r\\n    eb.nm_sit_cadastral,\\r\\n    -- RISCO\\r\\n    eb.score_risco,\\r\\n    eb.classificacao_risco,\\r\\n    ROW_NUMBER() OVER (ORDER BY eb.score_risco DESC) AS posicao_ranking_aprox,\\r\\n    -- CR\\u00c9DITO\\r\\n    eb.saldo_credor_atual,\\r\\n    eb.saldo_13m_atras,\\r\\n    eb.crescimento_saldo_absoluto,\\r\\n    eb.crescimento_saldo_percentual,\\r\\n    -- PADR\\u00c3O TEMPORAL\\r\\n    eb.qtde_ultimos_meses_iguais,\\r\\n    eb.valor_sequencia_recente,\\r\\n    eb.qtde_meses_declarados_13m,\\r\\n    eb.media_credito_13m,\\r\\n    eb.desvio_padrao_credito,\\r\\n    -- CR\\u00c9DITO PRESUMIDO\\r\\n    eb.vl_credito_presumido_13m,\\r\\n    eb.qtde_tipos_cp,\\r\\n    -- SETORES\\r\\n    CASE WHEN et.flag_setor_textil = 1 THEN 'SIM' ELSE 'NAO' END AS opera_textil,\\r\\n    et.vl_entradas_textil,\\r\\n    et.vl_saidas_textil,\\r\\n    et.dias_movimento_textil,\\r\\n    CASE WHEN em.flag_setor_metalmec = 1 THEN 'SIM' ELSE 'NAO' END AS opera_metalmec,\\r\\n    em.vl_entradas_metalmec,\\r\\n    em.vl_saidas_metalmec,\\r\\n    em.dias_movimento_metalmec,\\r\\n    CASE WHEN etch.flag_setor_tech = 1 THEN 'SIM' ELSE 'NAO' END AS opera_tech,\\r\\n    etch.vl_entradas_tech,\\r\\n    etch.vl_saidas_tech,\\r\\n    etch.dias_movimento_tech\\r\\nFROM empresa_base eb\\r\\nLEFT JOIN empresa_textil et ON eb.nu_cnpj = et.nu_cnpj\\r\\nLEFT JOIN empresa_metalmec em ON eb.nu_cnpj = em.nu_cnpj\\r\\nLEFT JOIN empresa_tech etch ON eb.nu_cnpj = etch.nu_cnpj;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- M\\u00d3DULO 8: ALERTAS E MONITORAMENTO\\r\\n-- Sistema de alertas autom\\u00e1ticos para a\\u00e7\\u00e3o imediata\\r\\n-- =============================================================================\\r\\n\\r\\n-- 8.1 DASHBOARD EXECUTIVO - M\\u00c9TRICAS DI\\u00c1RIAS\\r\\nSELECT\\r\\n    'DASHBOARD EXECUTIVO' AS categoria,\\r\\n    -- M\\u00e9tricas Principais\\r\\n    COUNT(DISTINCT nu_cnpj) AS total_empresas,\\r\\n    \\r\\n    -- Distribui\\u00e7\\u00e3o por Risco\\r\\n    COUNT(CASE WHEN classificacao_risco = 'CR\\u00cdTICO' THEN 1 END) AS empresas_criticas,\\r\\n    COUNT(CASE WHEN classificacao_risco = 'ALTO' THEN 1 END) AS empresas_alto_risco,\\r\\n    COUNT(CASE WHEN classificacao_risco = 'M\\u00c9DIO' THEN 1 END) AS empresas_medio_risco,\\r\\n    \\r\\n    -- Percentuais\\r\\n    ROUND(COUNT(CASE WHEN classificacao_risco IN ('CR\\u00cdTICO', 'ALTO') THEN 1 END) * 100.0 / \\r\\n          COUNT(*), 1) AS perc_prioritarios,\\r\\n    \\r\\n    -- M\\u00e9tricas Financeiras\\r\\n    ROUND(SUM(saldo_credor_atual), 2) AS receita_total_monitorada,\\r\\n    \\r\\n    -- Top Alertas\\r\\n    COUNT(CASE WHEN qtde_ultimos_meses_iguais >= 12 THEN 1 END) AS alertas_congelamento,\\r\\n    COUNT(CASE WHEN crescimento_saldo_percentual > 500 THEN 1 END) AS alertas_crescimento_explosivo,\\r\\n    COUNT(CASE WHEN desvio_padrao_credito = 0 AND media_credito_13m > 1000 THEN 1 END) AS alertas_variacao_zero,\\r\\n    \\r\\n    -- Timestamp\\r\\n    CURRENT_TIMESTAMP() AS data_atualizacao\\r\\nFROM teste.credito_dime_completo;\\r\\n\\r\\n-- PAUSA AQUI\\r\\n\\r\\n-- =============================================================================\\r\\n-- 8.2 ALERTAS AUTOM\\u00c1TICOS PRIORIT\\u00c1RIOS\\r\\nSELECT\\r\\n    'ALERTAS AUTOM\\u00c1TICOS' AS categoria,\\r\\n    nu_cnpj,\\r\\n    nm_razao_social,\\r\\n    score_risco,\\r\\n    saldo_credor_atual,\\r\\n    -- Tipo de Alerta\\r\\n    CASE \\r\\n        WHEN score_risco >= 80 \\r\\n            THEN 'CR\\u00cdTICO: Score Extremo - Investiga\\u00e7\\u00e3o Imediata'\\r\\n        \\r\\n        WHEN qtde_ultimos_meses_iguais >= 12 AND desvio_padrao_credito < 100\\r\\n            THEN 'CR\\u00cdTICO: Valor Congelado h\\u00e1 12+ meses'\\r\\n        \\r\\n        WHEN crescimento_saldo_percentual > 1000\\r\\n            THEN 'CR\\u00cdTICO: Crescimento Explosivo 10X+'\\r\\n        \\r\\n        WHEN saldo_credor_atual > 1000000 AND qtde_ultimos_meses_iguais >= 6\\r\\n            THEN 'ALTO: Alto Cr\\u00e9dito + Estagna\\u00e7\\u00e3o'\\r\\n        \\r\\n        WHEN crescimento_saldo_percentual > 500 AND desvio_padrao_credito < 500\\r\\n            THEN 'ALTO: Crescimento An\\u00f4malo com Baixa Varia\\u00e7\\u00e3o'\\r\\n        \\r\\n        ELSE 'M\\u00c9DIO: Monitoramento Cont\\u00ednuo'\\r\\n    END AS tipo_alerta,\\r\\n    \\r\\n    -- Prioridade (1=Mais alta)\\r\\n    CASE \\r\\n        WHEN score_risco >= 80 OR qtde_ultimos_meses_iguais >= 12 THEN 1\\r\\n        WHEN crescimento_saldo_percentual > 1000 THEN 1\\r\\n        WHEN saldo_credor_atual > 1000000 AND qtde_ultimos_meses_iguais >= 6 THEN 2\\r\\n        WHEN crescimento_saldo_percentual > 500 THEN 2\\r\\n        ELSE 3\\r\\n    END AS prioridade,\\r\\n    \\r\\n    -- Dados de Contexto\\r\\n    qtde_ultimos_meses_iguais,\\r\\n    crescimento_saldo_percentual,\\r\\n    desvio_padrao_credito,\\r\\n    classificacao_risco\\r\\nFROM teste.credito_dime_completo\\r\\nWHERE (\\r\\n    score_risco >= 70 OR\\r\\n    qtde_ultimos_meses_iguais >= 6 OR\\r\\n    crescimento_saldo_percentual > 300 OR\\r\\n    (saldo_credor_atual > 500000 AND desvio_padrao_credito < 100)\\r\\n)\\r\\nORDER BY\\r\\n    CASE \\r\\n        WHEN score_risco >= 80 OR qtde_ultimos_meses_iguais >= 12 THEN 1\\r\\n        WHEN crescimento_saldo_percentual > 1000 THEN 1\\r\\n        WHEN saldo_credor_atual > 1000000 AND qtde_ultimos_meses_iguais >= 6 THEN 2\\r\\n        WHEN crescimento_saldo_percentual > 500 THEN 2\\r\\n        ELSE 3\\r\\n    END,\\r\\n    score_risco DESC\\r\\nLIMIT 100;\\r\\n\\r\\n\", \"lastExecutedSelectionRange\": {\"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 736, \"column\": 0}}, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"lastCheckStatusRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"query_status\\\": {\\\"status\\\": \\\"available\\\"}}\", \"responseJSON\": {\"status\": 0, \"query_status\": {\"status\": \"available\"}}, \"status\": 200, \"statusText\": \"OK\"}, \"lastGetLogsRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"logs\\\": \\\"Query 2a4ef9efa6859c81:a327ac6900000000 100% Complete (7 out of 7)\\\", \\\"progress\\\": 100, \\\"jobs\\\": [{\\\"name\\\": \\\"2a4ef9efa6859c81:a327ac6900000000\\\", \\\"url\\\": \\\"/hue/jobbrowser#!id=2a4ef9efa6859c81:a327ac6900000000\\\", \\\"started\\\": true, \\\"finished\\\": false, \\\"percentJob\\\": 100}], \\\"isFullLogs\\\": false}\", \"responseJSON\": {\"status\": 0, \"logs\": \"Query 2a4ef9efa6859c81:a327ac6900000000 100% Complete (7 out of 7)\", \"progress\": 100, \"jobs\": [{\"name\": \"2a4ef9efa6859c81:a327ac6900000000\", \"url\": \"/hue/jobbrowser#!id=2a4ef9efa6859c81:a327ac6900000000\", \"started\": true, \"finished\": false, \"percentJob\": 100}], \"isFullLogs\": false}, \"status\": 200, \"statusText\": \"OK\"}}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 14211, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 123, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": true, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "-- =============================================================================\r\n-- ANÁLISE COMPLETA DE CRÉDITOS ICMS ACUMULADOS\r\n-- Sistema de Consultas Modulares para Análise de Risco Fiscal\r\n-- Execute cada bloco SEPARADAMENTE, pausando entre execuções\r\n-- =============================================================================\r\n\r\n-- CONFIGURAÇÃO INICIAL\r\nSET REQUEST_POOL = 'medium';\r\nSET MEM_LIMIT = 8G;\r\n\r\n-- =============================================================================\r\n-- MÓDULO 1: VISÃO GERAL DO SISTEMA\r\n-- Execute este bloco primeiro para ter o panorama geral\r\n-- =============================================================================\r\n\r\n-- 1.1 PANORAMA EXECUTIVO GERAL\r\nSELECT\r\n    'PANORAMA GERAL - CRÉDITOS ICMS' AS categoria,\r\n    -- Métricas de Volume\r\n    COUNT(DISTINCT nu_cnpj) AS total_empresas_monitoradas,\r\n    COUNT(DISTINCT nu_cnpj_grupo) AS total_grupos_economicos,\r\n    \r\n    -- Distribuição por Risco\r\n    COUNT(CASE WHEN classificacao_risco = 'CRÍTICO' THEN 1 END) AS empresas_criticas,\r\n    COUNT(CASE WHEN classificacao_risco = 'ALTO' THEN 1 END) AS empresas_alto_risco,\r\n    COUNT(CASE WHEN classificacao_risco = 'MÉDIO' THEN 1 END) AS empresas_medio_risco,\r\n    COUNT(CASE WHEN classificacao_risco = 'BAIXO' THEN 1 END) AS empresas_baixo_risco,\r\n    \r\n    -- Percentuais\r\n    ROUND(COUNT(CASE WHEN classificacao_risco IN ('CRÍTICO', 'ALTO') THEN 1 END) * 100.0 / \r\n          COUNT(*), 2) AS perc_prioridade_alta,\r\n    \r\n    -- Métricas Financeiras\r\n    ROUND(SUM(saldo_credor_atual), 2) AS total_credito_acumulado,\r\n    ROUND(AVG(saldo_credor_atual), 2) AS media_credito_empresa,\r\n    ROUND(SUM(CASE WHEN classificacao_risco = 'CRÍTICO' THEN saldo_credor_atual ELSE 0 END), 2) AS credito_critico,\r\n    \r\n    -- Métricas de Comportamento\r\n    ROUND(AVG(qtde_ultimos_meses_iguais), 2) AS media_meses_iguais,\r\n    ROUND(AVG(crescimento_saldo_percentual), 2) AS media_crescimento_perc,\r\n    COUNT(CASE WHEN qtde_ultimos_meses_iguais >= 12 T",
    "last_modified": "2025-10-11T01:45:34.412",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "98247874-ca8f-489a-b757-bbfeafccd369",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 164785,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "CRED-CANCEL: Criar tbls",
    "description": "",
    "uuid": "a99854b1-ca82-b6f1-7b66-0db22d1c873e",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 164785, \"uuid\": \"a99854b1-ca82-b6f1-7b66-0db22d1c873e\", \"name\": \"CRED-CANCEL: Criar tbls\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": null, \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"f10e8361-4611-f368-4e6b-b090efe671dc\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": null, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": false, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"teste\", \"currentQueryTab\": \"queryHistory\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 1, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"-- =====================================================================\\r\\n-- AN\\u00c1LISE CONSOLIDADA DE CR\\u00c9DITO DIME COM ENRIQUECIMENTO INTEGRADO\\r\\n-- Vers\\u00e3o \\u00danica - Substitui c\\u00f3digos 1 e 2\\r\\n-- =====================================================================\\r\\n\\r\\n-- ---------------------------------------------------------------------\\r\\n-- 1. TABELA PRINCIPAL CONSOLIDADA - teste.credito_dime_completo\\r\\n-- ---------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS teste.credito_dime_completo;\\r\\nSET REQUEST_POOL = 'medium';\\r\\n\\r\\nCREATE TABLE IF NOT EXISTS teste.credito_dime_completo AS\\r\\n\\r\\nWITH periodos AS (\\r\\n  SELECT periodo AS nu_per_ref\\r\\n  FROM (\\r\\n    SELECT 202101 AS periodo UNION ALL SELECT 202102 UNION ALL SELECT 202103 UNION ALL SELECT 202104 UNION ALL\\r\\n    SELECT 202105 UNION ALL SELECT 202106 UNION ALL SELECT 202107 UNION ALL SELECT 202108 UNION ALL\\r\\n    SELECT 202109 UNION ALL SELECT 202110 UNION ALL SELECT 202111 UNION ALL SELECT 202112 UNION ALL\\r\\n    SELECT 202201 UNION ALL SELECT 202202 UNION ALL SELECT 202203 UNION ALL SELECT 202204 UNION ALL\\r\\n    SELECT 202205 UNION ALL SELECT 202206 UNION ALL SELECT 202207 UNION ALL SELECT 202208 UNION ALL\\r\\n    SELECT 202209 UNION ALL SELECT 202210 UNION ALL SELECT 202211 UNION ALL SELECT 202212 UNION ALL\\r\\n    SELECT 202301 UNION ALL SELECT 202302 UNION ALL SELECT 202303 UNION ALL SELECT 202304 UNION ALL\\r\\n    SELECT 202305 UNION ALL SELECT 202306 UNION ALL SELECT 202307 UNION ALL SELECT 202308 UNION ALL\\r\\n    SELECT 202309 UNION ALL SELECT 202310 UNION ALL SELECT 202311 UNION ALL SELECT 202312 UNION ALL\\r\\n    SELECT 202401 UNION ALL SELECT 202402 UNION ALL SELECT 202403 UNION ALL SELECT 202404 UNION ALL\\r\\n    SELECT 202405 UNION ALL SELECT 202406 UNION ALL SELECT 202407 UNION ALL SELECT 202408 UNION ALL\\r\\n    SELECT 202409 UNION ALL SELECT 202410 UNION ALL SELECT 202411 UNION ALL SELECT 202412 UNION ALL\\r\\n    SELECT 202501 UNION ALL SELECT 202502 UNION ALL SELECT 202503 UNION ALL SELECT 202504 UNION ALL\\r\\n    SELECT 202505 UNION ALL SELECT 202506 UNION ALL SELECT 202507 UNION ALL SELECT 202508 UNION ALL\\r\\n    SELECT 202509\\r\\n  ) p\\r\\n),\\r\\n\\r\\ndados_filtrados AS (\\r\\n  SELECT \\r\\n    d.nu_cnpj,\\r\\n    d.nu_per_ref,\\r\\n    d.vl_cred_mes_anterior,\\r\\n    d.vl_cred_mes_seguinte\\r\\n  FROM \\r\\n    usr_sat_ods.ods_decl_dime_raw d\\r\\n  WHERE \\r\\n    d.nu_per_ref IN (SELECT nu_per_ref FROM periodos)\\r\\n    AND d.vl_cred_mes_anterior > 0\\r\\n    AND d.vl_cred_mes_seguinte > 0\\r\\n),\\r\\n\\r\\nvalores_iguais_base AS (\\r\\n  SELECT\\r\\n    nu_cnpj,\\r\\n    nu_per_ref,\\r\\n    vl_cred_mes_anterior AS valor\\r\\n  FROM \\r\\n    dados_filtrados\\r\\n  WHERE \\r\\n    vl_cred_mes_anterior = vl_cred_mes_seguinte\\r\\n),\\r\\n\\r\\ncontagem_iguais AS (\\r\\n  SELECT\\r\\n    nu_cnpj,\\r\\n    COUNT(*) AS contagem_periodos_iguais,\\r\\n    AVG(valor) AS valor_medio_repetido,\\r\\n    MIN(nu_per_ref) AS primeiro_periodo_igual,\\r\\n    MAX(nu_per_ref) AS ultimo_periodo_igual\\r\\n  FROM \\r\\n    valores_iguais_base\\r\\n  GROUP BY \\r\\n    nu_cnpj\\r\\n),\\r\\n\\r\\nsequencia_ultimos_meses AS (\\r\\n  SELECT\\r\\n    vi.nu_cnpj,\\r\\n    COUNT(*) AS qtde_ultimos_meses_iguais,\\r\\n    MIN(vi.nu_per_ref) AS periodo_inicial_seq,\\r\\n    MAX(vi.nu_per_ref) AS periodo_final_seq,\\r\\n    AVG(vi.valor) AS valor_sequencia\\r\\n  FROM \\r\\n    valores_iguais_base vi\\r\\n  WHERE \\r\\n    vi.nu_per_ref >= 202409\\r\\n  GROUP BY \\r\\n    vi.nu_cnpj\\r\\n  HAVING COUNT(*) >= 3\\r\\n),\\r\\n\\r\\nsaldo_credor_atual AS (\\r\\n  SELECT \\r\\n    c.nu_cnpj_grupo,\\r\\n    c.nu_cnpj,\\r\\n    MAX(d.vl_cred_mes_seguinte) AS saldo_credor_acumulado_atual\\r\\n  FROM \\r\\n    usr_sat_ods.ods_decl_dime_raw d\\r\\n  JOIN \\r\\n    usr_sat_ods.vw_ods_contrib c ON d.nu_cnpj = c.nu_cnpj\\r\\n  WHERE \\r\\n    d.nu_per_ref = 202509\\r\\n  GROUP BY \\r\\n    c.nu_cnpj_grupo, c.nu_cnpj\\r\\n),\\r\\n\\r\\nevolucao_saldo AS (\\r\\n  SELECT \\r\\n    c.nu_cnpj_grupo,\\r\\n    MAX(CASE WHEN d.nu_per_ref = 202409 THEN d.vl_cred_mes_seguinte ELSE NULL END) AS saldo_13m_atras,\\r\\n    MAX(CASE WHEN d.nu_per_ref = 202509 THEN d.vl_cred_mes_seguinte ELSE NULL END) AS saldo_atual\\r\\n  FROM \\r\\n    usr_sat_ods.ods_decl_dime_raw d\\r\\n  JOIN \\r\\n    usr_sat_ods.vw_ods_contrib c ON d.nu_cnpj = c.nu_cnpj\\r\\n  WHERE \\r\\n    d.nu_per_ref IN (202409, 202509)\\r\\n  GROUP BY \\r\\n    c.nu_cnpj_grupo\\r\\n),\\r\\n\\r\\ncrescimento_saldo AS (\\r\\n  SELECT\\r\\n    nu_cnpj_grupo,\\r\\n    saldo_13m_atras,\\r\\n    saldo_atual,\\r\\n    COALESCE(saldo_atual, 0) - COALESCE(saldo_13m_atras, 0) AS crescimento_absoluto,\\r\\n    CASE \\r\\n      WHEN saldo_13m_atras > 0 THEN\\r\\n        ROUND(100.0 * (COALESCE(saldo_atual, 0) - saldo_13m_atras) / NULLIF(saldo_13m_atras, 0), 2)\\r\\n      ELSE 0\\r\\n    END AS crescimento_percentual\\r\\n  FROM \\r\\n    evolucao_saldo\\r\\n),\\r\\n\\r\\ncreditos_presumidos AS (\\r\\n  SELECT \\r\\n    dcip.nu_cnpj_grupo,\\r\\n    SUM(dcip.vl_credito) AS vl_cp_total_13m,\\r\\n    COUNT(dcip.cd_tipo_credito) AS qtde_tipos_cp\\r\\n  FROM \\r\\n    usr_sat_ods.vw_ods_dcip dcip\\r\\n  WHERE \\r\\n    dcip.cd_estado_decl = 1\\r\\n    AND dcip.sn_utilizada_dime = 1\\r\\n    AND dcip.cd_grupo_dcip = 3\\r\\n    AND dcip.nu_per_ref BETWEEN 202409 AND 202509\\r\\n  GROUP BY \\r\\n    dcip.nu_cnpj_grupo\\r\\n),\\r\\n\\r\\nestatisticas_creditos AS (\\r\\n  SELECT\\r\\n    nu_cnpj,\\r\\n    COUNT(nu_per_ref) AS qtde_meses_declarados,\\r\\n    AVG(vl_cred_mes_anterior) AS media_credito,\\r\\n    MIN(vl_cred_mes_anterior) AS min_credito,\\r\\n    MAX(vl_cred_mes_anterior) AS max_credito,\\r\\n    STDDEV(vl_cred_mes_anterior) AS desvio_padrao_credito\\r\\n  FROM dados_filtrados\\r\\n  WHERE nu_per_ref BETWEEN 202409 AND 202509\\r\\n  GROUP BY nu_cnpj\\r\\n),\\r\\n\\r\\n-- NOVOS CTEs: Dados de Cancelamento/Enriquecimento\\r\\ndados_recolhimento AS (\\r\\n  SELECT\\r\\n    REGEXP_REPLACE(TRIM(CAST(cnpj AS STRING)), '[^0-9]', '') AS cnpj_limpo,\\r\\n    MAX(COALESCE(quantidade_pagtos, 0)) AS quantidade_pagtos,\\r\\n    MAX(COALESCE(valor_pagtos, 0)) AS valor_pagtos\\r\\n  FROM teste.cancel_recolhimento\\r\\n  GROUP BY REGEXP_REPLACE(TRIM(CAST(cnpj AS STRING)), '[^0-9]', '')\\r\\n),\\r\\n\\r\\ndados_zero_normal AS (\\r\\n  SELECT\\r\\n    REGEXP_REPLACE(TRIM(CAST(nu_cnpj AS STRING)), '[^0-9]', '') AS cnpj_limpo,\\r\\n    MAX(nm_contador) AS contador_normal,\\r\\n    MAX(total_vl_faturamento) AS total_vl_faturamento,\\r\\n    MAX(total_vl_receita_bruta) AS total_vl_receita_bruta,\\r\\n    MAX(total_vl_tot_cred) AS total_vl_tot_cred,\\r\\n    MAX(total_vl_tot_deb) AS total_vl_tot_deb,\\r\\n    MAX(total_vl_deb_recolher) AS total_vl_deb_recolher,\\r\\n    MAX(dt_constituicao_empresa) AS dt_constituicao_normal,\\r\\n    MAX(total_nfes_emitidas) AS nfes_emitidas_normal,\\r\\n    MAX(periodos_omissos) AS periodos_omissos_normal,\\r\\n    MAX(periodos_zerados) AS periodos_zerados_normal,\\r\\n    MAX(total_periodos) AS total_periodos_normal,\\r\\n    MAX(periodos_declarados) AS periodos_declarados_normal\\r\\n  FROM teste.cancel_zero_normal\\r\\n  GROUP BY REGEXP_REPLACE(TRIM(CAST(nu_cnpj AS STRING)), '[^0-9]', '')\\r\\n),\\r\\n\\r\\ndados_zero_simples AS (\\r\\n  SELECT\\r\\n    REGEXP_REPLACE(TRIM(CAST(nu_cnpj AS STRING)), '[^0-9]', '') AS cnpj_limpo,\\r\\n    MAX(nm_contador) AS contador_simples,\\r\\n    MAX(total_vl_rec_bruta) AS total_vl_rec_bruta,\\r\\n    MAX(max_vl_rec_bruta_em_12m) AS max_vl_rec_bruta_em_12m,\\r\\n    MAX(total_vl_rec_bruta_no_ano) AS total_vl_rec_bruta_no_ano,\\r\\n    MAX(total_vl_icms_sc) AS total_vl_icms_sc,\\r\\n    MAX(dt_constituicao_empresa) AS dt_constituicao_simples,\\r\\n    MAX(total_nfes_emitidas) AS nfes_emitidas_simples,\\r\\n    MAX(periodos_omissos) AS periodos_omissos_simples,\\r\\n    MAX(periodos_zerados) AS periodos_zerados_simples,\\r\\n    MAX(total_periodos) AS total_periodos_simples,\\r\\n    MAX(periodos_declarados) AS periodos_declarados_simples\\r\\n  FROM teste.cancel_zero_simples\\r\\n  GROUP BY REGEXP_REPLACE(TRIM(CAST(nu_cnpj AS STRING)), '[^0-9]', '')\\r\\n),\\r\\n\\r\\ndados_suspeitas AS (\\r\\n  SELECT\\r\\n    REGEXP_REPLACE(TRIM(CAST(cnpj AS STRING)), '[^0-9]', '') AS cnpj_limpo,\\r\\n    MAX(cd_situacao_suspeita) AS cd_situacao_suspeita,\\r\\n    MAX(dt_situacao_suspeita) AS dt_situacao_suspeita,\\r\\n    MAX(nu_score) AS score_suspeita,\\r\\n    MAX(qt_motivos) AS qt_motivos,\\r\\n    MAX(cd_tipo_confirmacao) AS cd_tipo_confirmacao,\\r\\n    MAX(sn_cancelado_inex_inativ) AS sn_cancelado_inex_inativ,\\r\\n    MAX(dt_inicio_protoc_cancelamento) AS dt_inicio_protoc_cancelamento,\\r\\n    MAX(tx_obs_situacao_suspeita) AS tx_obs_situacao_suspeita,\\r\\n    MAX(nu_score_ia) AS nu_score_ia,\\r\\n    MAX(qt_meses_valores) AS qt_meses_valores,\\r\\n    MAX(vl_total_nfes_saida) AS vl_nfes_saida_suspeita,\\r\\n    MAX(vl_total_icms_nfes_saida) AS vl_total_icms_nfes_saida,\\r\\n    MAX(vl_total_nfes_entrada) AS vl_nfes_entrada_suspeita,\\r\\n    MAX(vl_total_icms_nfes_entrada) AS vl_total_icms_nfes_entrada,\\r\\n    MAX(vl_total_arrecadacao_grupo) AS vl_total_arrecadacao_grupo,\\r\\n    MAX(qt_clientes_noteiras) AS qt_clientes_noteiras,\\r\\n    MAX(qt_fornecedoras_noteiras) AS qt_fornecedoras_noteiras,\\r\\n    MAX(sn_suspenso_dfe) AS sn_suspenso_dfe,\\r\\n    MAX(dt_suspensao_dfe_suspeita) AS dt_suspensao_dfe_suspeita\\r\\n  FROM teste.cancel_suspeitas\\r\\n  GROUP BY REGEXP_REPLACE(TRIM(CAST(cnpj AS STRING)), '[^0-9]', '')\\r\\n),\\r\\n\\r\\ndados_indicios AS (\\r\\n  SELECT\\r\\n    REGEXP_REPLACE(TRIM(CAST(cnpj AS STRING)), '[^0-9]', '') AS cnpj_limpo,\\r\\n    COUNT(DISTINCT cd_indicio) AS qtde_indicios_fraude,\\r\\n    SUM(COALESCE(score_indicio, 0)) AS soma_score_indicios\\r\\n  FROM teste.cancel_suspeitas_score\\r\\n  GROUP BY REGEXP_REPLACE(TRIM(CAST(cnpj AS STRING)), '[^0-9]', '')\\r\\n),\\r\\n\\r\\ncnpjs_unicos AS (\\r\\n  SELECT nu_cnpj \\r\\n  FROM dados_filtrados \\r\\n  GROUP BY nu_cnpj\\r\\n)\\r\\n\\r\\nSELECT \\r\\n  -- Colunas originais\\r\\n  df.nu_cnpj,\\r\\n  c.nm_razao_social,\\r\\n  c.nm_fantasia,\\r\\n  c.nm_sit_cadastral,\\r\\n  c.nm_gerfe,\\r\\n  c.de_cnae,\\r\\n  c.nu_cnpj_grupo,\\r\\n  \\r\\n  COALESCE(ci.contagem_periodos_iguais, 0) AS valor_igual_total_periodos,\\r\\n  COALESCE(seq.qtde_ultimos_meses_iguais, 0) AS qtde_ultimos_meses_iguais,\\r\\n  CAST(COALESCE(ci.primeiro_periodo_igual, 0) AS STRING) AS primeiro_periodo_valor_igual,\\r\\n  CAST(COALESCE(ci.ultimo_periodo_igual, 0) AS STRING) AS ultimo_periodo_valor_igual,\\r\\n  CAST(COALESCE(seq.periodo_inicial_seq, 0) AS STRING) AS periodo_inicial_sequencia_recente,\\r\\n  CAST(COALESCE(seq.periodo_final_seq, 0) AS STRING) AS periodo_final_sequencia_recente,\\r\\n  ROUND(COALESCE(seq.valor_sequencia, 0), 2) AS valor_sequencia_recente,\\r\\n  \\r\\n  COALESCE(est.qtde_meses_declarados, 0) AS qtde_meses_declarados_13m,\\r\\n  ROUND(COALESCE(est.media_credito, 0), 2) AS media_credito_13m,\\r\\n  ROUND(COALESCE(est.min_credito, 0), 2) AS min_credito_13m,\\r\\n  ROUND(COALESCE(est.max_credito, 0), 2) AS max_credito_13m,\\r\\n  ROUND(COALESCE(est.desvio_padrao_credito, 0), 2) AS desvio_padrao_credito,\\r\\n  \\r\\n  COALESCE(saldo.saldo_credor_acumulado_atual, 0) AS saldo_credor_atual,\\r\\n  COALESCE(cresc.saldo_13m_atras, 0) AS saldo_13m_atras,\\r\\n  COALESCE(cresc.crescimento_absoluto, 0) AS crescimento_saldo_absoluto,\\r\\n  COALESCE(cresc.crescimento_percentual, 0) AS crescimento_saldo_percentual,\\r\\n  \\r\\n  COALESCE(cp.vl_cp_total_13m, 0) AS vl_credito_presumido_13m,\\r\\n  COALESCE(cp.qtde_tipos_cp, 0) AS qtde_tipos_cp,\\r\\n  \\r\\n  -- Score de risco original\\r\\n  (\\r\\n    CASE \\r\\n      WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40\\r\\n      WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30\\r\\n      WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15\\r\\n      ELSE 0\\r\\n    END\\r\\n    +\\r\\n    CASE\\r\\n      WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30\\r\\n      WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20\\r\\n      WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10\\r\\n      ELSE 0\\r\\n    END\\r\\n    +\\r\\n    CASE\\r\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20\\r\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15\\r\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10\\r\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5\\r\\n      ELSE 0\\r\\n    END\\r\\n    +\\r\\n    CASE\\r\\n      WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10\\r\\n      WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5\\r\\n      ELSE 0\\r\\n    END\\r\\n  ) AS score_risco,\\r\\n  \\r\\n  CASE\\r\\n    WHEN (\\r\\n      CASE WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30 WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20 WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10 WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5 ELSE 0 END\\r\\n    ) >= 70 THEN 'CR\\u00cdTICO'\\r\\n    WHEN (\\r\\n      CASE WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30 WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20 WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10 WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5 ELSE 0 END\\r\\n    ) >= 50 THEN 'ALTO'\\r\\n    WHEN (\\r\\n      CASE WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30 WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20 WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10 WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5 ELSE 0 END\\r\\n    ) >= 30 THEN 'M\\u00c9DIO'\\r\\n    ELSE 'BAIXO'\\r\\n  END AS classificacao_risco,\\r\\n  \\r\\n  -- NOVOS CAMPOS: Dados de Recolhimento\\r\\n  COALESCE(dr.quantidade_pagtos, 0) AS quantidade_pagtos,\\r\\n  COALESCE(dr.valor_pagtos, 0) AS valor_pagtos,\\r\\n  \\r\\n  -- Dados de Declara\\u00e7\\u00f5es Zeradas - NORMAL\\r\\n  dzn.contador_normal,\\r\\n  COALESCE(dzn.total_vl_faturamento, 0) AS total_vl_faturamento,\\r\\n  COALESCE(dzn.total_vl_receita_bruta, 0) AS total_vl_receita_bruta,\\r\\n  COALESCE(dzn.total_vl_tot_cred, 0) AS total_vl_tot_cred,\\r\\n  COALESCE(dzn.total_vl_tot_deb, 0) AS total_vl_tot_deb,\\r\\n  COALESCE(dzn.total_vl_deb_recolher, 0) AS total_vl_deb_recolher,\\r\\n  dzn.dt_constituicao_normal,\\r\\n  COALESCE(dzn.nfes_emitidas_normal, 0) AS nfes_emitidas_normal,\\r\\n  COALESCE(dzn.periodos_omissos_normal, 0) AS periodos_omissos_normal,\\r\\n  COALESCE(dzn.periodos_zerados_normal, 0) AS periodos_zerados_normal,\\r\\n  COALESCE(dzn.total_periodos_normal, 0) AS total_periodos_normal,\\r\\n  COALESCE(dzn.periodos_declarados_normal, 0) AS periodos_declarados_normal,\\r\\n  \\r\\n  -- Dados de Declara\\u00e7\\u00f5es Zeradas - SIMPLES\\r\\n  dzs.contador_simples,\\r\\n  COALESCE(dzs.total_vl_rec_bruta, 0) AS total_vl_rec_bruta,\\r\\n  COALESCE(dzs.max_vl_rec_bruta_em_12m, 0) AS max_vl_rec_bruta_em_12m,\\r\\n  COALESCE(dzs.total_vl_rec_bruta_no_ano, 0) AS total_vl_rec_bruta_no_ano,\\r\\n  COALESCE(dzs.total_vl_icms_sc, 0) AS total_vl_icms_sc,\\r\\n  dzs.dt_constituicao_simples,\\r\\n  COALESCE(dzs.nfes_emitidas_simples, 0) AS nfes_emitidas_simples,\\r\\n  COALESCE(dzs.periodos_omissos_simples, 0) AS periodos_omissos_simples,\\r\\n  COALESCE(dzs.periodos_zerados_simples, 0) AS periodos_zerados_simples,\\r\\n  COALESCE(dzs.total_periodos_simples, 0) AS total_periodos_simples,\\r\\n  COALESCE(dzs.periodos_declarados_simples, 0) AS periodos_declarados_simples,\\r\\n  \\r\\n  -- Dados de Suspeitas\\r\\n  ds.cd_situacao_suspeita,\\r\\n  ds.dt_situacao_suspeita,\\r\\n  COALESCE(ds.score_suspeita, 0) AS score_suspeita,\\r\\n  COALESCE(ds.qt_motivos, 0) AS qt_motivos,\\r\\n  ds.cd_tipo_confirmacao,\\r\\n  COALESCE(ds.sn_cancelado_inex_inativ, 0) AS sn_cancelado_inex_inativ,\\r\\n  ds.dt_inicio_protoc_cancelamento,\\r\\n  ds.tx_obs_situacao_suspeita,\\r\\n  COALESCE(ds.nu_score_ia, 0) AS nu_score_ia,\\r\\n  COALESCE(ds.qt_meses_valores, 0) AS qt_meses_valores,\\r\\n  COALESCE(ds.vl_nfes_saida_suspeita, 0) AS vl_nfes_saida_suspeita,\\r\\n  COALESCE(ds.vl_total_icms_nfes_saida, 0) AS vl_total_icms_nfes_saida,\\r\\n  COALESCE(ds.vl_nfes_entrada_suspeita, 0) AS vl_nfes_entrada_suspeita,\\r\\n  COALESCE(ds.vl_total_icms_nfes_entrada, 0) AS vl_total_icms_nfes_entrada,\\r\\n  COALESCE(ds.vl_total_arrecadacao_grupo, 0) AS vl_total_arrecadacao_grupo,\\r\\n  COALESCE(ds.qt_clientes_noteiras, 0) AS qt_clientes_noteiras,\\r\\n  COALESCE(ds.qt_fornecedoras_noteiras, 0) AS qt_fornecedoras_noteiras,\\r\\n  COALESCE(ds.sn_suspenso_dfe, 0) AS sn_suspenso_dfe,\\r\\n  ds.dt_suspensao_dfe_suspeita,\\r\\n  \\r\\n  -- Contagem de Ind\\u00edcios de Fraude\\r\\n  COALESCE(di.qtde_indicios_fraude, 0) AS qtde_indicios_fraude,\\r\\n  COALESCE(di.soma_score_indicios, 0) AS soma_score_indicios,\\r\\n  \\r\\n  -- NOVOS INDICADORES CONSOLIDADOS\\r\\n  CASE WHEN ds.cd_situacao_suspeita IS NOT NULL THEN 1 ELSE 0 END AS flag_empresa_suspeita,\\r\\n  CASE WHEN COALESCE(dr.quantidade_pagtos, 0) > 0 THEN 1 ELSE 0 END AS flag_tem_pagamentos,\\r\\n  CASE WHEN COALESCE(dzn.periodos_zerados_normal, 0) > 0 OR COALESCE(dzs.periodos_zerados_simples, 0) > 0 THEN 1 ELSE 0 END AS flag_tem_declaracoes_zeradas,\\r\\n  CASE WHEN COALESCE(dzn.periodos_omissos_normal, 0) > 0 OR COALESCE(dzs.periodos_omissos_simples, 0) > 0 THEN 1 ELSE 0 END AS flag_tem_omissoes,\\r\\n  \\r\\n  -- SCORE COMBINADO DE RISCO (original + enriquecimento)\\r\\n  (\\r\\n    -- Score original\\r\\n    (\\r\\n      CASE \\r\\n        WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40\\r\\n        WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30\\r\\n        WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15\\r\\n        ELSE 0\\r\\n      END\\r\\n      +\\r\\n      CASE\\r\\n        WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30\\r\\n        WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20\\r\\n        WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10\\r\\n        ELSE 0\\r\\n      END\\r\\n      +\\r\\n      CASE\\r\\n        WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20\\r\\n        WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15\\r\\n        WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10\\r\\n        WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5\\r\\n        ELSE 0\\r\\n      END\\r\\n      +\\r\\n      CASE\\r\\n        WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10\\r\\n        WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5\\r\\n        ELSE 0\\r\\n      END\\r\\n    )\\r\\n    +\\r\\n    -- Pontos adicionais de enriquecimento\\r\\n    CASE WHEN ds.cd_situacao_suspeita IS NOT NULL THEN 30 ELSE 0 END +\\r\\n    CASE WHEN COALESCE(ds.score_suspeita, 0) > 80 THEN 20 \\r\\n         WHEN COALESCE(ds.score_suspeita, 0) > 50 THEN 10 ELSE 0 END +\\r\\n    CASE WHEN COALESCE(dzn.periodos_zerados_normal, 0) >= 6 OR COALESCE(dzs.periodos_zerados_simples, 0) >= 6 THEN 15 ELSE 0 END +\\r\\n    CASE WHEN COALESCE(dzn.periodos_omissos_normal, 0) >= 3 OR COALESCE(dzs.periodos_omissos_simples, 0) >= 3 THEN 10 ELSE 0 END +\\r\\n    CASE WHEN COALESCE(ds.sn_cancelado_inex_inativ, 0) = 1 THEN 25 ELSE 0 END +\\r\\n    CASE WHEN COALESCE(di.qtde_indicios_fraude, 0) >= 5 THEN 20 \\r\\n         WHEN COALESCE(di.qtde_indicios_fraude, 0) >= 3 THEN 10 ELSE 0 END\\r\\n  ) AS score_risco_combinado\\r\\n  \\r\\nFROM \\r\\n  cnpjs_unicos df\\r\\nLEFT JOIN \\r\\n  usr_sat_ods.vw_ods_contrib c ON df.nu_cnpj = c.nu_cnpj\\r\\nLEFT JOIN \\r\\n  contagem_iguais ci ON df.nu_cnpj = ci.nu_cnpj\\r\\nLEFT JOIN \\r\\n  sequencia_ultimos_meses seq ON df.nu_cnpj = seq.nu_cnpj\\r\\nLEFT JOIN \\r\\n  estatisticas_creditos est ON df.nu_cnpj = est.nu_cnpj\\r\\nLEFT JOIN \\r\\n  saldo_credor_atual saldo ON df.nu_cnpj = saldo.nu_cnpj\\r\\nLEFT JOIN \\r\\n  crescimento_saldo cresc ON c.nu_cnpj_grupo = cresc.nu_cnpj_grupo\\r\\nLEFT JOIN \\r\\n  creditos_presumidos cp ON c.nu_cnpj_grupo = cp.nu_cnpj_grupo\\r\\nLEFT JOIN\\r\\n  dados_recolhimento dr ON REGEXP_REPLACE(TRIM(CAST(df.nu_cnpj AS STRING)), '[^0-9]', '') = dr.cnpj_limpo\\r\\nLEFT JOIN\\r\\n  dados_zero_normal dzn ON REGEXP_REPLACE(TRIM(CAST(df.nu_cnpj AS STRING)), '[^0-9]', '') = dzn.cnpj_limpo\\r\\nLEFT JOIN\\r\\n  dados_zero_simples dzs ON REGEXP_REPLACE(TRIM(CAST(df.nu_cnpj AS STRING)), '[^0-9]', '') = dzs.cnpj_limpo\\r\\nLEFT JOIN\\r\\n  dados_suspeitas ds ON REGEXP_REPLACE(TRIM(CAST(df.nu_cnpj AS STRING)), '[^0-9]', '') = ds.cnpj_limpo\\r\\nLEFT JOIN\\r\\n  dados_indicios di ON REGEXP_REPLACE(TRIM(CAST(df.nu_cnpj AS STRING)), '[^0-9]', '') = di.cnpj_limpo\\r\\n\\r\\nORDER BY \\r\\n  score_risco_combinado DESC, \\r\\n  score_risco DESC,\\r\\n  qtde_ultimos_meses_iguais DESC;\\r\\n\\r\\n\\r\\n-- ---------------------------------------------------------------------\\r\\n-- 2. TABELA CONSOLIDADA T\\u00caXTIL - teste.credito_dime_textil\\r\\n-- ---------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS teste.credito_dime_textil;\\r\\n\\r\\nCREATE TABLE teste.credito_dime_textil STORED AS PARQUET AS\\r\\nWITH movimentacao_textil AS (\\r\\n  SELECT \\r\\n    my_efd.codigocnpj AS nu_cnpj,\\r\\n    SUM(CASE WHEN c170.cfop BETWEEN 1000 AND 3999 THEN c170.vl_item ELSE 0 END) AS vl_entradas_textil,\\r\\n    SUM(CASE WHEN c170.cfop BETWEEN 5000 AND 7999 THEN c170.vl_item ELSE 0 END) AS vl_saidas_textil,\\r\\n    COUNT(DISTINCT c100.dt_doc) AS dias_movimento_textil,\\r\\n    COUNT(DISTINCT r0200.cod_ncm) AS qtde_ncm_distintos_textil\\r\\n  FROM \\r\\n    efd.efd my_efd\\r\\n  JOIN \\r\\n    efd.efd_rc100 c100 ON my_efd.id_file = c100.id_file,\\r\\n    c100.listarc170_itensdocumento c170\\r\\n  JOIN \\r\\n    efd.efd_r0200 r0200 ON c100.id_file = r0200.id_file \\r\\n                        AND c170.cod_item = r0200.cod_item\\r\\n  WHERE \\r\\n    (my_efd.ano_referencia = 2024 OR \\r\\n     (my_efd.ano_referencia = 2025 AND my_efd.mes_referencia <= 9))\\r\\n    AND (r0200.cod_ncm LIKE '61%' OR r0200.cod_ncm LIKE '62%')\\r\\n  GROUP BY \\r\\n    my_efd.codigocnpj\\r\\n)\\r\\n\\r\\nSELECT \\r\\n  cd.*,\\r\\n  COALESCE(mov.vl_entradas_textil, 0) AS vl_entradas_textil,\\r\\n  COALESCE(mov.vl_saidas_textil, 0) AS vl_saidas_textil,\\r\\n  COALESCE(mov.dias_movimento_textil, 0) AS dias_movimento_textil,\\r\\n  COALESCE(mov.qtde_ncm_distintos_textil, 0) AS qtde_ncm_distintos_textil,\\r\\n  \\r\\n  CASE \\r\\n    WHEN mov.vl_saidas_textil > 0 THEN \\r\\n      ROUND(100.0 * mov.vl_entradas_textil / NULLIF(mov.vl_saidas_textil, 0), 2)\\r\\n    ELSE 0 \\r\\n  END AS indice_entrada_saida_textil,\\r\\n  \\r\\n  CASE \\r\\n    WHEN mov.vl_entradas_textil > 0 THEN\\r\\n      ROUND(cd.saldo_credor_atual / NULLIF(mov.vl_entradas_textil, 0), 4)\\r\\n    ELSE 0\\r\\n  END AS indice_saldo_entrada_textil,\\r\\n  \\r\\n  CASE WHEN mov.nu_cnpj IS NOT NULL THEN 1 ELSE 0 END AS flag_setor_textil,\\r\\n  'T\\u00caXTIL' AS setor,\\r\\n  \\r\\n  -- Score Combinado Setorial\\r\\n  (\\r\\n    cd.score_risco + \\r\\n    CASE WHEN cd.flag_empresa_suspeita = 1 THEN 25 ELSE 0 END +\\r\\n    CASE WHEN cd.score_suspeita > 70 THEN 15 ELSE 0 END +\\r\\n    CASE WHEN cd.sn_cancelado_inex_inativ = 1 THEN 20 ELSE 0 END +\\r\\n    CASE WHEN cd.qtde_indicios_fraude >= 3 THEN 15 ELSE 0 END\\r\\n  ) AS score_risco_textil_combinado\\r\\n  \\r\\nFROM teste.credito_dime_completo cd\\r\\nLEFT JOIN movimentacao_textil mov ON cd.nu_cnpj = mov.nu_cnpj\\r\\n\\r\\nORDER BY score_risco_textil_combinado DESC;\\r\\n\\r\\n\\r\\n-- ---------------------------------------------------------------------\\r\\n-- 3. TABELA CONSOLIDADA METAL-MEC\\u00c2NICO - teste.credito_dime_metalmec\\r\\n-- ---------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS teste.credito_dime_metalmec;\\r\\n\\r\\nCREATE TABLE teste.credito_dime_metalmec STORED AS PARQUET AS\\r\\nWITH movimentacao_metalmec AS (\\r\\n  SELECT \\r\\n    my_efd.codigocnpj AS nu_cnpj,\\r\\n    SUM(CASE WHEN c170.cfop BETWEEN 1000 AND 3999 THEN c170.vl_item ELSE 0 END) AS vl_entradas_metalmec,\\r\\n    SUM(CASE WHEN c170.cfop BETWEEN 5000 AND 7999 THEN c170.vl_item ELSE 0 END) AS vl_saidas_metalmec,\\r\\n    COUNT(DISTINCT c100.dt_doc) AS dias_movimento_metalmec,\\r\\n    COUNT(DISTINCT r0200.cod_ncm) AS qtde_ncm_distintos_metalmec,\\r\\n    SUM(CASE WHEN r0200.cod_ncm LIKE '84%' THEN c170.vl_item ELSE 0 END) AS vl_cap84,\\r\\n    SUM(CASE WHEN r0200.cod_ncm LIKE '85%' THEN c170.vl_item ELSE 0 END) AS vl_cap85\\r\\n  FROM \\r\\n    efd.efd my_efd\\r\\n  JOIN \\r\\n    efd.efd_rc100 c100 ON my_efd.id_file = c100.id_file,\\r\\n    c100.listarc170_itensdocumento c170\\r\\n  JOIN \\r\\n    efd.efd_r0200 r0200 ON c100.id_file = r0200.id_file \\r\\n                        AND c170.cod_item = r0200.cod_item\\r\\n  WHERE \\r\\n    (my_efd.ano_referencia = 2024 OR \\r\\n     (my_efd.ano_referencia = 2025 AND my_efd.mes_referencia <= 9))\\r\\n    AND (r0200.cod_ncm LIKE '84%' OR r0200.cod_ncm LIKE '85%')\\r\\n  GROUP BY \\r\\n    my_efd.codigocnpj\\r\\n)\\r\\n\\r\\nSELECT \\r\\n  cd.*,\\r\\n  COALESCE(mov.vl_entradas_metalmec, 0) AS vl_entradas_metalmec,\\r\\n  COALESCE(mov.vl_saidas_metalmec, 0) AS vl_saidas_metalmec,\\r\\n  COALESCE(mov.dias_movimento_metalmec, 0) AS dias_movimento_metalmec,\\r\\n  COALESCE(mov.qtde_ncm_distintos_metalmec, 0) AS qtde_ncm_distintos_metalmec,\\r\\n  COALESCE(mov.vl_cap84, 0) AS vl_capitulo_84,\\r\\n  COALESCE(mov.vl_cap85, 0) AS vl_capitulo_85,\\r\\n  \\r\\n  CASE \\r\\n    WHEN mov.vl_saidas_metalmec > 0 THEN \\r\\n      ROUND(100.0 * mov.vl_entradas_metalmec / NULLIF(mov.vl_saidas_metalmec, 0), 2)\\r\\n    ELSE 0 \\r\\n  END AS indice_entrada_saida_metalmec,\\r\\n  \\r\\n  CASE \\r\\n    WHEN mov.vl_entradas_metalmec > 0 THEN\\r\\n      ROUND(cd.saldo_credor_atual / NULLIF(mov.vl_entradas_metalmec, 0), 4)\\r\\n    ELSE 0\\r\\n  END AS indice_saldo_entrada_metalmec,\\r\\n  \\r\\n  CASE \\r\\n    WHEN (mov.vl_cap84 + mov.vl_cap85) > 0 THEN\\r\\n      ROUND(100.0 * mov.vl_cap84 / NULLIF(mov.vl_cap84 + mov.vl_cap85, 0), 2)\\r\\n    ELSE 0\\r\\n  END AS perc_cap84,\\r\\n  \\r\\n  CASE WHEN mov.nu_cnpj IS NOT NULL THEN 1 ELSE 0 END AS flag_setor_metalmec,\\r\\n  'METAL-MEC\\u00c2NICO' AS setor,\\r\\n  \\r\\n  -- Score Combinado Setorial\\r\\n  (\\r\\n    cd.score_risco + \\r\\n    CASE WHEN cd.flag_empresa_suspeita = 1 THEN 25 ELSE 0 END +\\r\\n    CASE WHEN cd.score_suspeita > 70 THEN 15 ELSE 0 END +\\r\\n    CASE WHEN cd.sn_cancelado_inex_inativ = 1 THEN 20 ELSE 0 END +\\r\\n    CASE WHEN cd.qtde_indicios_fraude >= 3 THEN 15 ELSE 0 END\\r\\n  ) AS score_risco_metalmec_combinado\\r\\n  \\r\\nFROM teste.credito_dime_completo cd\\r\\nLEFT JOIN movimentacao_metalmec mov ON cd.nu_cnpj = mov.nu_cnpj\\r\\n\\r\\nORDER BY score_risco_metalmec_combinado DESC;\\r\\n\\r\\n\\r\\n-- ---------------------------------------------------------------------\\r\\n-- 4. TABELA CONSOLIDADA TECNOLOGIA - teste.credito_dime_tech\\r\\n-- ---------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS teste.credito_dime_tech;\\r\\n\\r\\nCREATE TABLE teste.credito_dime_tech STORED AS PARQUET AS\\r\\nWITH movimentacao_tech AS (\\r\\n  SELECT \\r\\n    my_efd.codigocnpj AS nu_cnpj,\\r\\n    SUM(CASE WHEN c170.cfop BETWEEN 1000 AND 3999 THEN c170.vl_item ELSE 0 END) AS vl_entradas_tech,\\r\\n    SUM(CASE WHEN c170.cfop BETWEEN 5000 AND 7999 THEN c170.vl_item ELSE 0 END) AS vl_saidas_tech,\\r\\n    COUNT(DISTINCT c100.dt_doc) AS dias_movimento_tech,\\r\\n    COUNT(DISTINCT r0200.cod_ncm) AS qtde_ncm_distintos_tech,\\r\\n    SUM(CASE WHEN r0200.cod_ncm LIKE '8471%' THEN c170.vl_item ELSE 0 END) AS vl_computadores,\\r\\n    SUM(CASE WHEN r0200.cod_ncm LIKE '8473%' THEN c170.vl_item ELSE 0 END) AS vl_partes_computadores,\\r\\n    SUM(CASE WHEN r0200.cod_ncm LIKE '8517%' THEN c170.vl_item ELSE 0 END) AS vl_telecom\\r\\n  FROM \\r\\n    efd.efd my_efd\\r\\n  JOIN \\r\\n    efd.efd_rc100 c100 ON my_efd.id_file = c100.id_file,\\r\\n    c100.listarc170_itensdocumento c170\\r\\n  JOIN \\r\\n    efd.efd_r0200 r0200 ON c100.id_file = r0200.id_file \\r\\n                        AND c170.cod_item = r0200.cod_item\\r\\n  WHERE \\r\\n    (my_efd.ano_referencia = 2024 OR \\r\\n     (my_efd.ano_referencia = 2025 AND my_efd.mes_referencia <= 9))\\r\\n    AND (r0200.cod_ncm LIKE '8471%' OR r0200.cod_ncm LIKE '8473%' OR r0200.cod_ncm LIKE '8517%')\\r\\n  GROUP BY \\r\\n    my_efd.codigocnpj\\r\\n)\\r\\n\\r\\nSELECT \\r\\n  cd.*,\\r\\n  COALESCE(mov.vl_entradas_tech, 0) AS vl_entradas_tech,\\r\\n  COALESCE(mov.vl_saidas_tech, 0) AS vl_saidas_tech,\\r\\n  COALESCE(mov.dias_movimento_tech, 0) AS dias_movimento_tech,\\r\\n  COALESCE(mov.qtde_ncm_distintos_tech, 0) AS qtde_ncm_distintos_tech,\\r\\n  COALESCE(mov.vl_computadores, 0) AS vl_computadores,\\r\\n  COALESCE(mov.vl_partes_computadores, 0) AS vl_partes_computadores,\\r\\n  COALESCE(mov.vl_telecom, 0) AS vl_telecom,\\r\\n  \\r\\n  CASE \\r\\n    WHEN mov.vl_saidas_tech > 0 THEN \\r\\n      ROUND(100.0 * mov.vl_entradas_tech / NULLIF(mov.vl_saidas_tech, 0), 2)\\r\\n    ELSE 0 \\r\\n  END AS indice_entrada_saida_tech,\\r\\n  \\r\\n  CASE \\r\\n    WHEN mov.vl_entradas_tech > 0 THEN\\r\\n      ROUND(cd.saldo_credor_atual / NULLIF(mov.vl_entradas_tech, 0), 4)\\r\\n    ELSE 0\\r\\n  END AS indice_saldo_entrada_tech,\\r\\n  \\r\\n  CASE WHEN mov.nu_cnpj IS NOT NULL THEN 1 ELSE 0 END AS flag_setor_tech,\\r\\n  'TECNOLOGIA' AS setor,\\r\\n  \\r\\n  -- Score Combinado Setorial\\r\\n  (\\r\\n    cd.score_risco + \\r\\n    CASE WHEN cd.flag_empresa_suspeita = 1 THEN 25 ELSE 0 END +\\r\\n    CASE WHEN cd.score_suspeita > 70 THEN 15 ELSE 0 END +\\r\\n    CASE WHEN cd.sn_cancelado_inex_inativ = 1 THEN 20 ELSE 0 END +\\r\\n    CASE WHEN cd.qtde_indicios_fraude >= 3 THEN 15 ELSE 0 END\\r\\n  ) AS score_risco_tech_combinado\\r\\n  \\r\\nFROM teste.credito_dime_completo cd\\r\\nLEFT JOIN movimentacao_tech mov ON cd.nu_cnpj = mov.nu_cnpj\\r\\n\\r\\nORDER BY score_risco_tech_combinado DESC;\", \"statementsList\": [\"-- =====================================================================\\r\\n-- AN\\u00c1LISE CONSOLIDADA DE CR\\u00c9DITO DIME COM ENRIQUECIMENTO INTEGRADO\\r\\n-- Vers\\u00e3o \\u00danica - Substitui c\\u00f3digos 1 e 2\\r\\n-- =====================================================================\\r\\n\\r\\n-- ---------------------------------------------------------------------\\r\\n-- 1. TABELA PRINCIPAL CONSOLIDADA - teste.credito_dime_completo\\r\\n-- ---------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS teste.credito_dime_completo;\", \"\\r\\nSET REQUEST_POOL = 'medium';\", \"\\r\\n\\r\\nCREATE TABLE IF NOT EXISTS teste.credito_dime_completo AS\\r\\n\\r\\nWITH periodos AS (\\r\\n  SELECT periodo AS nu_per_ref\\r\\n  FROM (\\r\\n    SELECT 202101 AS periodo UNION ALL SELECT 202102 UNION ALL SELECT 202103 UNION ALL SELECT 202104 UNION ALL\\r\\n    SELECT 202105 UNION ALL SELECT 202106 UNION ALL SELECT 202107 UNION ALL SELECT 202108 UNION ALL\\r\\n    SELECT 202109 UNION ALL SELECT 202110 UNION ALL SELECT 202111 UNION ALL SELECT 202112 UNION ALL\\r\\n    SELECT 202201 UNION ALL SELECT 202202 UNION ALL SELECT 202203 UNION ALL SELECT 202204 UNION ALL\\r\\n    SELECT 202205 UNION ALL SELECT 202206 UNION ALL SELECT 202207 UNION ALL SELECT 202208 UNION ALL\\r\\n    SELECT 202209 UNION ALL SELECT 202210 UNION ALL SELECT 202211 UNION ALL SELECT 202212 UNION ALL\\r\\n    SELECT 202301 UNION ALL SELECT 202302 UNION ALL SELECT 202303 UNION ALL SELECT 202304 UNION ALL\\r\\n    SELECT 202305 UNION ALL SELECT 202306 UNION ALL SELECT 202307 UNION ALL SELECT 202308 UNION ALL\\r\\n    SELECT 202309 UNION ALL SELECT 202310 UNION ALL SELECT 202311 UNION ALL SELECT 202312 UNION ALL\\r\\n    SELECT 202401 UNION ALL SELECT 202402 UNION ALL SELECT 202403 UNION ALL SELECT 202404 UNION ALL\\r\\n    SELECT 202405 UNION ALL SELECT 202406 UNION ALL SELECT 202407 UNION ALL SELECT 202408 UNION ALL\\r\\n    SELECT 202409 UNION ALL SELECT 202410 UNION ALL SELECT 202411 UNION ALL SELECT 202412 UNION ALL\\r\\n    SELECT 202501 UNION ALL SELECT 202502 UNION ALL SELECT 202503 UNION ALL SELECT 202504 UNION ALL\\r\\n    SELECT 202505 UNION ALL SELECT 202506 UNION ALL SELECT 202507 UNION ALL SELECT 202508 UNION ALL\\r\\n    SELECT 202509\\r\\n  ) p\\r\\n),\\r\\n\\r\\ndados_filtrados AS (\\r\\n  SELECT \\r\\n    d.nu_cnpj,\\r\\n    d.nu_per_ref,\\r\\n    d.vl_cred_mes_anterior,\\r\\n    d.vl_cred_mes_seguinte\\r\\n  FROM \\r\\n    usr_sat_ods.ods_decl_dime_raw d\\r\\n  WHERE \\r\\n    d.nu_per_ref IN (SELECT nu_per_ref FROM periodos)\\r\\n    AND d.vl_cred_mes_anterior > 0\\r\\n    AND d.vl_cred_mes_seguinte > 0\\r\\n),\\r\\n\\r\\nvalores_iguais_base AS (\\r\\n  SELECT\\r\\n    nu_cnpj,\\r\\n    nu_per_ref,\\r\\n    vl_cred_mes_anterior AS valor\\r\\n  FROM \\r\\n    dados_filtrados\\r\\n  WHERE \\r\\n    vl_cred_mes_anterior = vl_cred_mes_seguinte\\r\\n),\\r\\n\\r\\ncontagem_iguais AS (\\r\\n  SELECT\\r\\n    nu_cnpj,\\r\\n    COUNT(*) AS contagem_periodos_iguais,\\r\\n    AVG(valor) AS valor_medio_repetido,\\r\\n    MIN(nu_per_ref) AS primeiro_periodo_igual,\\r\\n    MAX(nu_per_ref) AS ultimo_periodo_igual\\r\\n  FROM \\r\\n    valores_iguais_base\\r\\n  GROUP BY \\r\\n    nu_cnpj\\r\\n),\\r\\n\\r\\nsequencia_ultimos_meses AS (\\r\\n  SELECT\\r\\n    vi.nu_cnpj,\\r\\n    COUNT(*) AS qtde_ultimos_meses_iguais,\\r\\n    MIN(vi.nu_per_ref) AS periodo_inicial_seq,\\r\\n    MAX(vi.nu_per_ref) AS periodo_final_seq,\\r\\n    AVG(vi.valor) AS valor_sequencia\\r\\n  FROM \\r\\n    valores_iguais_base vi\\r\\n  WHERE \\r\\n    vi.nu_per_ref >= 202409\\r\\n  GROUP BY \\r\\n    vi.nu_cnpj\\r\\n  HAVING COUNT(*) >= 3\\r\\n),\\r\\n\\r\\nsaldo_credor_atual AS (\\r\\n  SELECT \\r\\n    c.nu_cnpj_grupo,\\r\\n    c.nu_cnpj,\\r\\n    MAX(d.vl_cred_mes_seguinte) AS saldo_credor_acumulado_atual\\r\\n  FROM \\r\\n    usr_sat_ods.ods_decl_dime_raw d\\r\\n  JOIN \\r\\n    usr_sat_ods.vw_ods_contrib c ON d.nu_cnpj = c.nu_cnpj\\r\\n  WHERE \\r\\n    d.nu_per_ref = 202509\\r\\n  GROUP BY \\r\\n    c.nu_cnpj_grupo, c.nu_cnpj\\r\\n),\\r\\n\\r\\nevolucao_saldo AS (\\r\\n  SELECT \\r\\n    c.nu_cnpj_grupo,\\r\\n    MAX(CASE WHEN d.nu_per_ref = 202409 THEN d.vl_cred_mes_seguinte ELSE NULL END) AS saldo_13m_atras,\\r\\n    MAX(CASE WHEN d.nu_per_ref = 202509 THEN d.vl_cred_mes_seguinte ELSE NULL END) AS saldo_atual\\r\\n  FROM \\r\\n    usr_sat_ods.ods_decl_dime_raw d\\r\\n  JOIN \\r\\n    usr_sat_ods.vw_ods_contrib c ON d.nu_cnpj = c.nu_cnpj\\r\\n  WHERE \\r\\n    d.nu_per_ref IN (202409, 202509)\\r\\n  GROUP BY \\r\\n    c.nu_cnpj_grupo\\r\\n),\\r\\n\\r\\ncrescimento_saldo AS (\\r\\n  SELECT\\r\\n    nu_cnpj_grupo,\\r\\n    saldo_13m_atras,\\r\\n    saldo_atual,\\r\\n    COALESCE(saldo_atual, 0) - COALESCE(saldo_13m_atras, 0) AS crescimento_absoluto,\\r\\n    CASE \\r\\n      WHEN saldo_13m_atras > 0 THEN\\r\\n        ROUND(100.0 * (COALESCE(saldo_atual, 0) - saldo_13m_atras) / NULLIF(saldo_13m_atras, 0), 2)\\r\\n      ELSE 0\\r\\n    END AS crescimento_percentual\\r\\n  FROM \\r\\n    evolucao_saldo\\r\\n),\\r\\n\\r\\ncreditos_presumidos AS (\\r\\n  SELECT \\r\\n    dcip.nu_cnpj_grupo,\\r\\n    SUM(dcip.vl_credito) AS vl_cp_total_13m,\\r\\n    COUNT(dcip.cd_tipo_credito) AS qtde_tipos_cp\\r\\n  FROM \\r\\n    usr_sat_ods.vw_ods_dcip dcip\\r\\n  WHERE \\r\\n    dcip.cd_estado_decl = 1\\r\\n    AND dcip.sn_utilizada_dime = 1\\r\\n    AND dcip.cd_grupo_dcip = 3\\r\\n    AND dcip.nu_per_ref BETWEEN 202409 AND 202509\\r\\n  GROUP BY \\r\\n    dcip.nu_cnpj_grupo\\r\\n),\\r\\n\\r\\nestatisticas_creditos AS (\\r\\n  SELECT\\r\\n    nu_cnpj,\\r\\n    COUNT(nu_per_ref) AS qtde_meses_declarados,\\r\\n    AVG(vl_cred_mes_anterior) AS media_credito,\\r\\n    MIN(vl_cred_mes_anterior) AS min_credito,\\r\\n    MAX(vl_cred_mes_anterior) AS max_credito,\\r\\n    STDDEV(vl_cred_mes_anterior) AS desvio_padrao_credito\\r\\n  FROM dados_filtrados\\r\\n  WHERE nu_per_ref BETWEEN 202409 AND 202509\\r\\n  GROUP BY nu_cnpj\\r\\n),\\r\\n\\r\\n-- NOVOS CTEs: Dados de Cancelamento/Enriquecimento\\r\\ndados_recolhimento AS (\\r\\n  SELECT\\r\\n    REGEXP_REPLACE(TRIM(CAST(cnpj AS STRING)), '[^0-9]', '') AS cnpj_limpo,\\r\\n    MAX(COALESCE(quantidade_pagtos, 0)) AS quantidade_pagtos,\\r\\n    MAX(COALESCE(valor_pagtos, 0)) AS valor_pagtos\\r\\n  FROM teste.cancel_recolhimento\\r\\n  GROUP BY REGEXP_REPLACE(TRIM(CAST(cnpj AS STRING)), '[^0-9]', '')\\r\\n),\\r\\n\\r\\ndados_zero_normal AS (\\r\\n  SELECT\\r\\n    REGEXP_REPLACE(TRIM(CAST(nu_cnpj AS STRING)), '[^0-9]', '') AS cnpj_limpo,\\r\\n    MAX(nm_contador) AS contador_normal,\\r\\n    MAX(total_vl_faturamento) AS total_vl_faturamento,\\r\\n    MAX(total_vl_receita_bruta) AS total_vl_receita_bruta,\\r\\n    MAX(total_vl_tot_cred) AS total_vl_tot_cred,\\r\\n    MAX(total_vl_tot_deb) AS total_vl_tot_deb,\\r\\n    MAX(total_vl_deb_recolher) AS total_vl_deb_recolher,\\r\\n    MAX(dt_constituicao_empresa) AS dt_constituicao_normal,\\r\\n    MAX(total_nfes_emitidas) AS nfes_emitidas_normal,\\r\\n    MAX(periodos_omissos) AS periodos_omissos_normal,\\r\\n    MAX(periodos_zerados) AS periodos_zerados_normal,\\r\\n    MAX(total_periodos) AS total_periodos_normal,\\r\\n    MAX(periodos_declarados) AS periodos_declarados_normal\\r\\n  FROM teste.cancel_zero_normal\\r\\n  GROUP BY REGEXP_REPLACE(TRIM(CAST(nu_cnpj AS STRING)), '[^0-9]', '')\\r\\n),\\r\\n\\r\\ndados_zero_simples AS (\\r\\n  SELECT\\r\\n    REGEXP_REPLACE(TRIM(CAST(nu_cnpj AS STRING)), '[^0-9]', '') AS cnpj_limpo,\\r\\n    MAX(nm_contador) AS contador_simples,\\r\\n    MAX(total_vl_rec_bruta) AS total_vl_rec_bruta,\\r\\n    MAX(max_vl_rec_bruta_em_12m) AS max_vl_rec_bruta_em_12m,\\r\\n    MAX(total_vl_rec_bruta_no_ano) AS total_vl_rec_bruta_no_ano,\\r\\n    MAX(total_vl_icms_sc) AS total_vl_icms_sc,\\r\\n    MAX(dt_constituicao_empresa) AS dt_constituicao_simples,\\r\\n    MAX(total_nfes_emitidas) AS nfes_emitidas_simples,\\r\\n    MAX(periodos_omissos) AS periodos_omissos_simples,\\r\\n    MAX(periodos_zerados) AS periodos_zerados_simples,\\r\\n    MAX(total_periodos) AS total_periodos_simples,\\r\\n    MAX(periodos_declarados) AS periodos_declarados_simples\\r\\n  FROM teste.cancel_zero_simples\\r\\n  GROUP BY REGEXP_REPLACE(TRIM(CAST(nu_cnpj AS STRING)), '[^0-9]', '')\\r\\n),\\r\\n\\r\\ndados_suspeitas AS (\\r\\n  SELECT\\r\\n    REGEXP_REPLACE(TRIM(CAST(cnpj AS STRING)), '[^0-9]', '') AS cnpj_limpo,\\r\\n    MAX(cd_situacao_suspeita) AS cd_situacao_suspeita,\\r\\n    MAX(dt_situacao_suspeita) AS dt_situacao_suspeita,\\r\\n    MAX(nu_score) AS score_suspeita,\\r\\n    MAX(qt_motivos) AS qt_motivos,\\r\\n    MAX(cd_tipo_confirmacao) AS cd_tipo_confirmacao,\\r\\n    MAX(sn_cancelado_inex_inativ) AS sn_cancelado_inex_inativ,\\r\\n    MAX(dt_inicio_protoc_cancelamento) AS dt_inicio_protoc_cancelamento,\\r\\n    MAX(tx_obs_situacao_suspeita) AS tx_obs_situacao_suspeita,\\r\\n    MAX(nu_score_ia) AS nu_score_ia,\\r\\n    MAX(qt_meses_valores) AS qt_meses_valores,\\r\\n    MAX(vl_total_nfes_saida) AS vl_nfes_saida_suspeita,\\r\\n    MAX(vl_total_icms_nfes_saida) AS vl_total_icms_nfes_saida,\\r\\n    MAX(vl_total_nfes_entrada) AS vl_nfes_entrada_suspeita,\\r\\n    MAX(vl_total_icms_nfes_entrada) AS vl_total_icms_nfes_entrada,\\r\\n    MAX(vl_total_arrecadacao_grupo) AS vl_total_arrecadacao_grupo,\\r\\n    MAX(qt_clientes_noteiras) AS qt_clientes_noteiras,\\r\\n    MAX(qt_fornecedoras_noteiras) AS qt_fornecedoras_noteiras,\\r\\n    MAX(sn_suspenso_dfe) AS sn_suspenso_dfe,\\r\\n    MAX(dt_suspensao_dfe_suspeita) AS dt_suspensao_dfe_suspeita\\r\\n  FROM teste.cancel_suspeitas\\r\\n  GROUP BY REGEXP_REPLACE(TRIM(CAST(cnpj AS STRING)), '[^0-9]', '')\\r\\n),\\r\\n\\r\\ndados_indicios AS (\\r\\n  SELECT\\r\\n    REGEXP_REPLACE(TRIM(CAST(cnpj AS STRING)), '[^0-9]', '') AS cnpj_limpo,\\r\\n    COUNT(DISTINCT cd_indicio) AS qtde_indicios_fraude,\\r\\n    SUM(COALESCE(score_indicio, 0)) AS soma_score_indicios\\r\\n  FROM teste.cancel_suspeitas_score\\r\\n  GROUP BY REGEXP_REPLACE(TRIM(CAST(cnpj AS STRING)), '[^0-9]', '')\\r\\n),\\r\\n\\r\\ncnpjs_unicos AS (\\r\\n  SELECT nu_cnpj \\r\\n  FROM dados_filtrados \\r\\n  GROUP BY nu_cnpj\\r\\n)\\r\\n\\r\\nSELECT \\r\\n  -- Colunas originais\\r\\n  df.nu_cnpj,\\r\\n  c.nm_razao_social,\\r\\n  c.nm_fantasia,\\r\\n  c.nm_sit_cadastral,\\r\\n  c.nm_gerfe,\\r\\n  c.de_cnae,\\r\\n  c.nu_cnpj_grupo,\\r\\n  \\r\\n  COALESCE(ci.contagem_periodos_iguais, 0) AS valor_igual_total_periodos,\\r\\n  COALESCE(seq.qtde_ultimos_meses_iguais, 0) AS qtde_ultimos_meses_iguais,\\r\\n  CAST(COALESCE(ci.primeiro_periodo_igual, 0) AS STRING) AS primeiro_periodo_valor_igual,\\r\\n  CAST(COALESCE(ci.ultimo_periodo_igual, 0) AS STRING) AS ultimo_periodo_valor_igual,\\r\\n  CAST(COALESCE(seq.periodo_inicial_seq, 0) AS STRING) AS periodo_inicial_sequencia_recente,\\r\\n  CAST(COALESCE(seq.periodo_final_seq, 0) AS STRING) AS periodo_final_sequencia_recente,\\r\\n  ROUND(COALESCE(seq.valor_sequencia, 0), 2) AS valor_sequencia_recente,\\r\\n  \\r\\n  COALESCE(est.qtde_meses_declarados, 0) AS qtde_meses_declarados_13m,\\r\\n  ROUND(COALESCE(est.media_credito, 0), 2) AS media_credito_13m,\\r\\n  ROUND(COALESCE(est.min_credito, 0), 2) AS min_credito_13m,\\r\\n  ROUND(COALESCE(est.max_credito, 0), 2) AS max_credito_13m,\\r\\n  ROUND(COALESCE(est.desvio_padrao_credito, 0), 2) AS desvio_padrao_credito,\\r\\n  \\r\\n  COALESCE(saldo.saldo_credor_acumulado_atual, 0) AS saldo_credor_atual,\\r\\n  COALESCE(cresc.saldo_13m_atras, 0) AS saldo_13m_atras,\\r\\n  COALESCE(cresc.crescimento_absoluto, 0) AS crescimento_saldo_absoluto,\\r\\n  COALESCE(cresc.crescimento_percentual, 0) AS crescimento_saldo_percentual,\\r\\n  \\r\\n  COALESCE(cp.vl_cp_total_13m, 0) AS vl_credito_presumido_13m,\\r\\n  COALESCE(cp.qtde_tipos_cp, 0) AS qtde_tipos_cp,\\r\\n  \\r\\n  -- Score de risco original\\r\\n  (\\r\\n    CASE \\r\\n      WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40\\r\\n      WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30\\r\\n      WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15\\r\\n      ELSE 0\\r\\n    END\\r\\n    +\\r\\n    CASE\\r\\n      WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30\\r\\n      WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20\\r\\n      WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10\\r\\n      ELSE 0\\r\\n    END\\r\\n    +\\r\\n    CASE\\r\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20\\r\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15\\r\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10\\r\\n      WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5\\r\\n      ELSE 0\\r\\n    END\\r\\n    +\\r\\n    CASE\\r\\n      WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10\\r\\n      WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5\\r\\n      ELSE 0\\r\\n    END\\r\\n  ) AS score_risco,\\r\\n  \\r\\n  CASE\\r\\n    WHEN (\\r\\n      CASE WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30 WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20 WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10 WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5 ELSE 0 END\\r\\n    ) >= 70 THEN 'CR\\u00cdTICO'\\r\\n    WHEN (\\r\\n      CASE WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30 WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20 WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10 WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5 ELSE 0 END\\r\\n    ) >= 50 THEN 'ALTO'\\r\\n    WHEN (\\r\\n      CASE WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30 WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30 WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20 WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10 WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5 ELSE 0 END +\\r\\n      CASE WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10 WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5 ELSE 0 END\\r\\n    ) >= 30 THEN 'M\\u00c9DIO'\\r\\n    ELSE 'BAIXO'\\r\\n  END AS classificacao_risco,\\r\\n  \\r\\n  -- NOVOS CAMPOS: Dados de Recolhimento\\r\\n  COALESCE(dr.quantidade_pagtos, 0) AS quantidade_pagtos,\\r\\n  COALESCE(dr.valor_pagtos, 0) AS valor_pagtos,\\r\\n  \\r\\n  -- Dados de Declara\\u00e7\\u00f5es Zeradas - NORMAL\\r\\n  dzn.contador_normal,\\r\\n  COALESCE(dzn.total_vl_faturamento, 0) AS total_vl_faturamento,\\r\\n  COALESCE(dzn.total_vl_receita_bruta, 0) AS total_vl_receita_bruta,\\r\\n  COALESCE(dzn.total_vl_tot_cred, 0) AS total_vl_tot_cred,\\r\\n  COALESCE(dzn.total_vl_tot_deb, 0) AS total_vl_tot_deb,\\r\\n  COALESCE(dzn.total_vl_deb_recolher, 0) AS total_vl_deb_recolher,\\r\\n  dzn.dt_constituicao_normal,\\r\\n  COALESCE(dzn.nfes_emitidas_normal, 0) AS nfes_emitidas_normal,\\r\\n  COALESCE(dzn.periodos_omissos_normal, 0) AS periodos_omissos_normal,\\r\\n  COALESCE(dzn.periodos_zerados_normal, 0) AS periodos_zerados_normal,\\r\\n  COALESCE(dzn.total_periodos_normal, 0) AS total_periodos_normal,\\r\\n  COALESCE(dzn.periodos_declarados_normal, 0) AS periodos_declarados_normal,\\r\\n  \\r\\n  -- Dados de Declara\\u00e7\\u00f5es Zeradas - SIMPLES\\r\\n  dzs.contador_simples,\\r\\n  COALESCE(dzs.total_vl_rec_bruta, 0) AS total_vl_rec_bruta,\\r\\n  COALESCE(dzs.max_vl_rec_bruta_em_12m, 0) AS max_vl_rec_bruta_em_12m,\\r\\n  COALESCE(dzs.total_vl_rec_bruta_no_ano, 0) AS total_vl_rec_bruta_no_ano,\\r\\n  COALESCE(dzs.total_vl_icms_sc, 0) AS total_vl_icms_sc,\\r\\n  dzs.dt_constituicao_simples,\\r\\n  COALESCE(dzs.nfes_emitidas_simples, 0) AS nfes_emitidas_simples,\\r\\n  COALESCE(dzs.periodos_omissos_simples, 0) AS periodos_omissos_simples,\\r\\n  COALESCE(dzs.periodos_zerados_simples, 0) AS periodos_zerados_simples,\\r\\n  COALESCE(dzs.total_periodos_simples, 0) AS total_periodos_simples,\\r\\n  COALESCE(dzs.periodos_declarados_simples, 0) AS periodos_declarados_simples,\\r\\n  \\r\\n  -- Dados de Suspeitas\\r\\n  ds.cd_situacao_suspeita,\\r\\n  ds.dt_situacao_suspeita,\\r\\n  COALESCE(ds.score_suspeita, 0) AS score_suspeita,\\r\\n  COALESCE(ds.qt_motivos, 0) AS qt_motivos,\\r\\n  ds.cd_tipo_confirmacao,\\r\\n  COALESCE(ds.sn_cancelado_inex_inativ, 0) AS sn_cancelado_inex_inativ,\\r\\n  ds.dt_inicio_protoc_cancelamento,\\r\\n  ds.tx_obs_situacao_suspeita,\\r\\n  COALESCE(ds.nu_score_ia, 0) AS nu_score_ia,\\r\\n  COALESCE(ds.qt_meses_valores, 0) AS qt_meses_valores,\\r\\n  COALESCE(ds.vl_nfes_saida_suspeita, 0) AS vl_nfes_saida_suspeita,\\r\\n  COALESCE(ds.vl_total_icms_nfes_saida, 0) AS vl_total_icms_nfes_saida,\\r\\n  COALESCE(ds.vl_nfes_entrada_suspeita, 0) AS vl_nfes_entrada_suspeita,\\r\\n  COALESCE(ds.vl_total_icms_nfes_entrada, 0) AS vl_total_icms_nfes_entrada,\\r\\n  COALESCE(ds.vl_total_arrecadacao_grupo, 0) AS vl_total_arrecadacao_grupo,\\r\\n  COALESCE(ds.qt_clientes_noteiras, 0) AS qt_clientes_noteiras,\\r\\n  COALESCE(ds.qt_fornecedoras_noteiras, 0) AS qt_fornecedoras_noteiras,\\r\\n  COALESCE(ds.sn_suspenso_dfe, 0) AS sn_suspenso_dfe,\\r\\n  ds.dt_suspensao_dfe_suspeita,\\r\\n  \\r\\n  -- Contagem de Ind\\u00edcios de Fraude\\r\\n  COALESCE(di.qtde_indicios_fraude, 0) AS qtde_indicios_fraude,\\r\\n  COALESCE(di.soma_score_indicios, 0) AS soma_score_indicios,\\r\\n  \\r\\n  -- NOVOS INDICADORES CONSOLIDADOS\\r\\n  CASE WHEN ds.cd_situacao_suspeita IS NOT NULL THEN 1 ELSE 0 END AS flag_empresa_suspeita,\\r\\n  CASE WHEN COALESCE(dr.quantidade_pagtos, 0) > 0 THEN 1 ELSE 0 END AS flag_tem_pagamentos,\\r\\n  CASE WHEN COALESCE(dzn.periodos_zerados_normal, 0) > 0 OR COALESCE(dzs.periodos_zerados_simples, 0) > 0 THEN 1 ELSE 0 END AS flag_tem_declaracoes_zeradas,\\r\\n  CASE WHEN COALESCE(dzn.periodos_omissos_normal, 0) > 0 OR COALESCE(dzs.periodos_omissos_simples, 0) > 0 THEN 1 ELSE 0 END AS flag_tem_omissoes,\\r\\n  \\r\\n  -- SCORE COMBINADO DE RISCO (original + enriquecimento)\\r\\n  (\\r\\n    -- Score original\\r\\n    (\\r\\n      CASE \\r\\n        WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 12 THEN 40\\r\\n        WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 6 THEN 30\\r\\n        WHEN COALESCE(seq.qtde_ultimos_meses_iguais, 0) >= 3 THEN 15\\r\\n        ELSE 0\\r\\n      END\\r\\n      +\\r\\n      CASE\\r\\n        WHEN COALESCE(cresc.crescimento_percentual, 0) > 100 THEN 30\\r\\n        WHEN COALESCE(cresc.crescimento_percentual, 0) > 50 THEN 20\\r\\n        WHEN COALESCE(cresc.crescimento_percentual, 0) > 25 THEN 10\\r\\n        ELSE 0\\r\\n      END\\r\\n      +\\r\\n      CASE\\r\\n        WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 1000000 THEN 20\\r\\n        WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 500000 THEN 15\\r\\n        WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 100000 THEN 10\\r\\n        WHEN COALESCE(saldo.saldo_credor_acumulado_atual, 0) > 50000 THEN 5\\r\\n        ELSE 0\\r\\n      END\\r\\n      +\\r\\n      CASE\\r\\n        WHEN COALESCE(est.desvio_padrao_credito, 0) < 100 AND COALESCE(est.media_credito, 0) > 1000 THEN 10\\r\\n        WHEN COALESCE(est.desvio_padrao_credito, 0) < 500 AND COALESCE(est.media_credito, 0) > 5000 THEN 5\\r\\n        ELSE 0\\r\\n      END\\r\\n    )\\r\\n    +\\r\\n    -- Pontos adicionais de enriquecimento\\r\\n    CASE WHEN ds.cd_situacao_suspeita IS NOT NULL THEN 30 ELSE 0 END +\\r\\n    CASE WHEN COALESCE(ds.score_suspeita, 0) > 80 THEN 20 \\r\\n         WHEN COALESCE(ds.score_suspeita, 0) > 50 THEN 10 ELSE 0 END +\\r\\n    CASE WHEN COALESCE(dzn.periodos_zerados_normal, 0) >= 6 OR COALESCE(dzs.periodos_zerados_simples, 0) >= 6 THEN 15 ELSE 0 END +\\r\\n    CASE WHEN COALESCE(dzn.periodos_omissos_normal, 0) >= 3 OR COALESCE(dzs.periodos_omissos_simples, 0) >= 3 THEN 10 ELSE 0 END +\\r\\n    CASE WHEN COALESCE(ds.sn_cancelado_inex_inativ, 0) = 1 THEN 25 ELSE 0 END +\\r\\n    CASE WHEN COALESCE(di.qtde_indicios_fraude, 0) >= 5 THEN 20 \\r\\n         WHEN COALESCE(di.qtde_indicios_fraude, 0) >= 3 THEN 10 ELSE 0 END\\r\\n  ) AS score_risco_combinado\\r\\n  \\r\\nFROM \\r\\n  cnpjs_unicos df\\r\\nLEFT JOIN \\r\\n  usr_sat_ods.vw_ods_contrib c ON df.nu_cnpj = c.nu_cnpj\\r\\nLEFT JOIN \\r\\n  contagem_iguais ci ON df.nu_cnpj = ci.nu_cnpj\\r\\nLEFT JOIN \\r\\n  sequencia_ultimos_meses seq ON df.nu_cnpj = seq.nu_cnpj\\r\\nLEFT JOIN \\r\\n  estatisticas_creditos est ON df.nu_cnpj = est.nu_cnpj\\r\\nLEFT JOIN \\r\\n  saldo_credor_atual saldo ON df.nu_cnpj = saldo.nu_cnpj\\r\\nLEFT JOIN \\r\\n  crescimento_saldo cresc ON c.nu_cnpj_grupo = cresc.nu_cnpj_grupo\\r\\nLEFT JOIN \\r\\n  creditos_presumidos cp ON c.nu_cnpj_grupo = cp.nu_cnpj_grupo\\r\\nLEFT JOIN\\r\\n  dados_recolhimento dr ON REGEXP_REPLACE(TRIM(CAST(df.nu_cnpj AS STRING)), '[^0-9]', '') = dr.cnpj_limpo\\r\\nLEFT JOIN\\r\\n  dados_zero_normal dzn ON REGEXP_REPLACE(TRIM(CAST(df.nu_cnpj AS STRING)), '[^0-9]', '') = dzn.cnpj_limpo\\r\\nLEFT JOIN\\r\\n  dados_zero_simples dzs ON REGEXP_REPLACE(TRIM(CAST(df.nu_cnpj AS STRING)), '[^0-9]', '') = dzs.cnpj_limpo\\r\\nLEFT JOIN\\r\\n  dados_suspeitas ds ON REGEXP_REPLACE(TRIM(CAST(df.nu_cnpj AS STRING)), '[^0-9]', '') = ds.cnpj_limpo\\r\\nLEFT JOIN\\r\\n  dados_indicios di ON REGEXP_REPLACE(TRIM(CAST(df.nu_cnpj AS STRING)), '[^0-9]', '') = di.cnpj_limpo\\r\\n\\r\\nORDER BY \\r\\n  score_risco_combinado DESC, \\r\\n  score_risco DESC,\\r\\n  qtde_ultimos_meses_iguais DESC;\", \"\\r\\n\\r\\n\\r\\n-- ---------------------------------------------------------------------\\r\\n-- 2. TABELA CONSOLIDADA T\\u00caXTIL - teste.credito_dime_textil\\r\\n-- ---------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS teste.credito_dime_textil;\", \"\\r\\n\\r\\nCREATE TABLE teste.credito_dime_textil STORED AS PARQUET AS\\r\\nWITH movimentacao_textil AS (\\r\\n  SELECT \\r\\n    my_efd.codigocnpj AS nu_cnpj,\\r\\n    SUM(CASE WHEN c170.cfop BETWEEN 1000 AND 3999 THEN c170.vl_item ELSE 0 END) AS vl_entradas_textil,\\r\\n    SUM(CASE WHEN c170.cfop BETWEEN 5000 AND 7999 THEN c170.vl_item ELSE 0 END) AS vl_saidas_textil,\\r\\n    COUNT(DISTINCT c100.dt_doc) AS dias_movimento_textil,\\r\\n    COUNT(DISTINCT r0200.cod_ncm) AS qtde_ncm_distintos_textil\\r\\n  FROM \\r\\n    efd.efd my_efd\\r\\n  JOIN \\r\\n    efd.efd_rc100 c100 ON my_efd.id_file = c100.id_file,\\r\\n    c100.listarc170_itensdocumento c170\\r\\n  JOIN \\r\\n    efd.efd_r0200 r0200 ON c100.id_file = r0200.id_file \\r\\n                        AND c170.cod_item = r0200.cod_item\\r\\n  WHERE \\r\\n    (my_efd.ano_referencia = 2024 OR \\r\\n     (my_efd.ano_referencia = 2025 AND my_efd.mes_referencia <= 9))\\r\\n    AND (r0200.cod_ncm LIKE '61%' OR r0200.cod_ncm LIKE '62%')\\r\\n  GROUP BY \\r\\n    my_efd.codigocnpj\\r\\n)\\r\\n\\r\\nSELECT \\r\\n  cd.*,\\r\\n  COALESCE(mov.vl_entradas_textil, 0) AS vl_entradas_textil,\\r\\n  COALESCE(mov.vl_saidas_textil, 0) AS vl_saidas_textil,\\r\\n  COALESCE(mov.dias_movimento_textil, 0) AS dias_movimento_textil,\\r\\n  COALESCE(mov.qtde_ncm_distintos_textil, 0) AS qtde_ncm_distintos_textil,\\r\\n  \\r\\n  CASE \\r\\n    WHEN mov.vl_saidas_textil > 0 THEN \\r\\n      ROUND(100.0 * mov.vl_entradas_textil / NULLIF(mov.vl_saidas_textil, 0), 2)\\r\\n    ELSE 0 \\r\\n  END AS indice_entrada_saida_textil,\\r\\n  \\r\\n  CASE \\r\\n    WHEN mov.vl_entradas_textil > 0 THEN\\r\\n      ROUND(cd.saldo_credor_atual / NULLIF(mov.vl_entradas_textil, 0), 4)\\r\\n    ELSE 0\\r\\n  END AS indice_saldo_entrada_textil,\\r\\n  \\r\\n  CASE WHEN mov.nu_cnpj IS NOT NULL THEN 1 ELSE 0 END AS flag_setor_textil,\\r\\n  'T\\u00caXTIL' AS setor,\\r\\n  \\r\\n  -- Score Combinado Setorial\\r\\n  (\\r\\n    cd.score_risco + \\r\\n    CASE WHEN cd.flag_empresa_suspeita = 1 THEN 25 ELSE 0 END +\\r\\n    CASE WHEN cd.score_suspeita > 70 THEN 15 ELSE 0 END +\\r\\n    CASE WHEN cd.sn_cancelado_inex_inativ = 1 THEN 20 ELSE 0 END +\\r\\n    CASE WHEN cd.qtde_indicios_fraude >= 3 THEN 15 ELSE 0 END\\r\\n  ) AS score_risco_textil_combinado\\r\\n  \\r\\nFROM teste.credito_dime_completo cd\\r\\nLEFT JOIN movimentacao_textil mov ON cd.nu_cnpj = mov.nu_cnpj\\r\\n\\r\\nORDER BY score_risco_textil_combinado DESC;\", \"\\r\\n\\r\\n\\r\\n-- ---------------------------------------------------------------------\\r\\n-- 3. TABELA CONSOLIDADA METAL-MEC\\u00c2NICO - teste.credito_dime_metalmec\\r\\n-- ---------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS teste.credito_dime_metalmec;\", \"\\r\\n\\r\\nCREATE TABLE teste.credito_dime_metalmec STORED AS PARQUET AS\\r\\nWITH movimentacao_metalmec AS (\\r\\n  SELECT \\r\\n    my_efd.codigocnpj AS nu_cnpj,\\r\\n    SUM(CASE WHEN c170.cfop BETWEEN 1000 AND 3999 THEN c170.vl_item ELSE 0 END) AS vl_entradas_metalmec,\\r\\n    SUM(CASE WHEN c170.cfop BETWEEN 5000 AND 7999 THEN c170.vl_item ELSE 0 END) AS vl_saidas_metalmec,\\r\\n    COUNT(DISTINCT c100.dt_doc) AS dias_movimento_metalmec,\\r\\n    COUNT(DISTINCT r0200.cod_ncm) AS qtde_ncm_distintos_metalmec,\\r\\n    SUM(CASE WHEN r0200.cod_ncm LIKE '84%' THEN c170.vl_item ELSE 0 END) AS vl_cap84,\\r\\n    SUM(CASE WHEN r0200.cod_ncm LIKE '85%' THEN c170.vl_item ELSE 0 END) AS vl_cap85\\r\\n  FROM \\r\\n    efd.efd my_efd\\r\\n  JOIN \\r\\n    efd.efd_rc100 c100 ON my_efd.id_file = c100.id_file,\\r\\n    c100.listarc170_itensdocumento c170\\r\\n  JOIN \\r\\n    efd.efd_r0200 r0200 ON c100.id_file = r0200.id_file \\r\\n                        AND c170.cod_item = r0200.cod_item\\r\\n  WHERE \\r\\n    (my_efd.ano_referencia = 2024 OR \\r\\n     (my_efd.ano_referencia = 2025 AND my_efd.mes_referencia <= 9))\\r\\n    AND (r0200.cod_ncm LIKE '84%' OR r0200.cod_ncm LIKE '85%')\\r\\n  GROUP BY \\r\\n    my_efd.codigocnpj\\r\\n)\\r\\n\\r\\nSELECT \\r\\n  cd.*,\\r\\n  COALESCE(mov.vl_entradas_metalmec, 0) AS vl_entradas_metalmec,\\r\\n  COALESCE(mov.vl_saidas_metalmec, 0) AS vl_saidas_metalmec,\\r\\n  COALESCE(mov.dias_movimento_metalmec, 0) AS dias_movimento_metalmec,\\r\\n  COALESCE(mov.qtde_ncm_distintos_metalmec, 0) AS qtde_ncm_distintos_metalmec,\\r\\n  COALESCE(mov.vl_cap84, 0) AS vl_capitulo_84,\\r\\n  COALESCE(mov.vl_cap85, 0) AS vl_capitulo_85,\\r\\n  \\r\\n  CASE \\r\\n    WHEN mov.vl_saidas_metalmec > 0 THEN \\r\\n      ROUND(100.0 * mov.vl_entradas_metalmec / NULLIF(mov.vl_saidas_metalmec, 0), 2)\\r\\n    ELSE 0 \\r\\n  END AS indice_entrada_saida_metalmec,\\r\\n  \\r\\n  CASE \\r\\n    WHEN mov.vl_entradas_metalmec > 0 THEN\\r\\n      ROUND(cd.saldo_credor_atual / NULLIF(mov.vl_entradas_metalmec, 0), 4)\\r\\n    ELSE 0\\r\\n  END AS indice_saldo_entrada_metalmec,\\r\\n  \\r\\n  CASE \\r\\n    WHEN (mov.vl_cap84 + mov.vl_cap85) > 0 THEN\\r\\n      ROUND(100.0 * mov.vl_cap84 / NULLIF(mov.vl_cap84 + mov.vl_cap85, 0), 2)\\r\\n    ELSE 0\\r\\n  END AS perc_cap84,\\r\\n  \\r\\n  CASE WHEN mov.nu_cnpj IS NOT NULL THEN 1 ELSE 0 END AS flag_setor_metalmec,\\r\\n  'METAL-MEC\\u00c2NICO' AS setor,\\r\\n  \\r\\n  -- Score Combinado Setorial\\r\\n  (\\r\\n    cd.score_risco + \\r\\n    CASE WHEN cd.flag_empresa_suspeita = 1 THEN 25 ELSE 0 END +\\r\\n    CASE WHEN cd.score_suspeita > 70 THEN 15 ELSE 0 END +\\r\\n    CASE WHEN cd.sn_cancelado_inex_inativ = 1 THEN 20 ELSE 0 END +\\r\\n    CASE WHEN cd.qtde_indicios_fraude >= 3 THEN 15 ELSE 0 END\\r\\n  ) AS score_risco_metalmec_combinado\\r\\n  \\r\\nFROM teste.credito_dime_completo cd\\r\\nLEFT JOIN movimentacao_metalmec mov ON cd.nu_cnpj = mov.nu_cnpj\\r\\n\\r\\nORDER BY score_risco_metalmec_combinado DESC;\", \"\\r\\n\\r\\n\\r\\n-- ---------------------------------------------------------------------\\r\\n-- 4. TABELA CONSOLIDADA TECNOLOGIA - teste.credito_dime_tech\\r\\n-- ---------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS teste.credito_dime_tech;\", \"\\r\\n\\r\\nCREATE TABLE teste.credito_dime_tech STORED AS PARQUET AS\\r\\nWITH movimentacao_tech AS (\\r\\n  SELECT \\r\\n    my_efd.codigocnpj AS nu_cnpj,\\r\\n    SUM(CASE WHEN c170.cfop BETWEEN 1000 AND 3999 THEN c170.vl_item ELSE 0 END) AS vl_entradas_tech,\\r\\n    SUM(CASE WHEN c170.cfop BETWEEN 5000 AND 7999 THEN c170.vl_item ELSE 0 END) AS vl_saidas_tech,\\r\\n    COUNT(DISTINCT c100.dt_doc) AS dias_movimento_tech,\\r\\n    COUNT(DISTINCT r0200.cod_ncm) AS qtde_ncm_distintos_tech,\\r\\n    SUM(CASE WHEN r0200.cod_ncm LIKE '8471%' THEN c170.vl_item ELSE 0 END) AS vl_computadores,\\r\\n    SUM(CASE WHEN r0200.cod_ncm LIKE '8473%' THEN c170.vl_item ELSE 0 END) AS vl_partes_computadores,\\r\\n    SUM(CASE WHEN r0200.cod_ncm LIKE '8517%' THEN c170.vl_item ELSE 0 END) AS vl_telecom\\r\\n  FROM \\r\\n    efd.efd my_efd\\r\\n  JOIN \\r\\n    efd.efd_rc100 c100 ON my_efd.id_file = c100.id_file,\\r\\n    c100.listarc170_itensdocumento c170\\r\\n  JOIN \\r\\n    efd.efd_r0200 r0200 ON c100.id_file = r0200.id_file \\r\\n                        AND c170.cod_item = r0200.cod_item\\r\\n  WHERE \\r\\n    (my_efd.ano_referencia = 2024 OR \\r\\n     (my_efd.ano_referencia = 2025 AND my_efd.mes_referencia <= 9))\\r\\n    AND (r0200.cod_ncm LIKE '8471%' OR r0200.cod_ncm LIKE '8473%' OR r0200.cod_ncm LIKE '8517%')\\r\\n  GROUP BY \\r\\n    my_efd.codigocnpj\\r\\n)\\r\\n\\r\\nSELECT \\r\\n  cd.*,\\r\\n  COALESCE(mov.vl_entradas_tech, 0) AS vl_entradas_tech,\\r\\n  COALESCE(mov.vl_saidas_tech, 0) AS vl_saidas_tech,\\r\\n  COALESCE(mov.dias_movimento_tech, 0) AS dias_movimento_tech,\\r\\n  COALESCE(mov.qtde_ncm_distintos_tech, 0) AS qtde_ncm_distintos_tech,\\r\\n  COALESCE(mov.vl_computadores, 0) AS vl_computadores,\\r\\n  COALESCE(mov.vl_partes_computadores, 0) AS vl_partes_computadores,\\r\\n  COALESCE(mov.vl_telecom, 0) AS vl_telecom,\\r\\n  \\r\\n  CASE \\r\\n    WHEN mov.vl_saidas_tech > 0 THEN \\r\\n      ROUND(100.0 * mov.vl_entradas_tech / NULLIF(mov.vl_saidas_tech, 0), 2)\\r\\n    ELSE 0 \\r\\n  END AS indice_entrada_saida_tech,\\r\\n  \\r\\n  CASE \\r\\n    WHEN mov.vl_entradas_tech > 0 THEN\\r\\n      ROUND(cd.saldo_credor_atual / NULLIF(mov.vl_entradas_tech, 0), 4)\\r\\n    ELSE 0\\r\\n  END AS indice_saldo_entrada_tech,\\r\\n  \\r\\n  CASE WHEN mov.nu_cnpj IS NOT NULL THEN 1 ELSE 0 END AS flag_setor_tech,\\r\\n  'TECNOLOGIA' AS setor,\\r\\n  \\r\\n  -- Score Combinado Setorial\\r\\n  (\\r\\n    cd.score_risco + \\r\\n    CASE WHEN cd.flag_empresa_suspeita = 1 THEN 25 ELSE 0 END +\\r\\n    CASE WHEN cd.score_suspeita > 70 THEN 15 ELSE 0 END +\\r\\n    CASE WHEN cd.sn_cancelado_inex_inativ = 1 THEN 20 ELSE 0 END +\\r\\n    CASE WHEN cd.qtde_indicios_fraude >= 3 THEN 15 ELSE 0 END\\r\\n  ) AS score_risco_tech_combinado\\r\\n  \\r\\nFROM teste.credito_dime_completo cd\\r\\nLEFT JOIN movimentacao_tech mov ON cd.nu_cnpj = mov.nu_cnpj\\r\\n\\r\\nORDER BY score_risco_tech_combinado DESC;\"], \"aceSize\": 100, \"status\": \"ready\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"\\r\\n\\r\\nCREATE TABLE teste.credito_dime_tech STORED AS PARQUET AS\\r\\nWITH movimentacao_tech AS (\\r\\n  SELECT \\r\\n    my_efd.codigocnpj AS nu_cnpj,\\r\\n    SUM(CASE WHEN c170.cfop BETWEEN 1000 AND 3999 THEN c170.vl_item ELSE 0 END) AS vl_entradas_tech,\\r\\n    SUM(CASE WHEN c170.cfop BETWEEN 5000 AND 7999 THEN c170.vl_item ELSE 0 END) AS vl_saidas_tech,\\r\\n    COUNT(DISTINCT c100.dt_doc) AS dias_movimento_tech,\\r\\n    COUNT(DISTINCT r0200.cod_ncm) AS qtde_ncm_distintos_tech,\\r\\n    SUM(CASE WHEN r0200.cod_ncm LIKE '8471%' THEN c170.vl_item ELSE 0 END) AS vl_computadores,\\r\\n    SUM(CASE WHEN r0200.cod_ncm LIKE '8473%' THEN c170.vl_item ELSE 0 END) AS vl_partes_computadores,\\r\\n    SUM(CASE WHEN r0200.cod_ncm LIKE '8517%' THEN c170.vl_item ELSE 0 END) AS vl_telecom\\r\\n  FROM \\r\\n    efd.efd my_efd\\r\\n  JOIN \\r\\n    efd.efd_rc100 c100 ON my_efd.id_file = c100.id_file,\\r\\n    c100.listarc170_itensdocumento c170\\r\\n  JOIN \\r\\n    efd.efd_r0200 r0200 ON c100.id_file = r0200.id_file \\r\\n                        AND c170.cod_item = r0200.cod_item\\r\\n  WHERE \\r\\n    (my_efd.ano_referencia = 2024 OR \\r\\n     (my_efd.ano_referencia = 2025 AND my_efd.mes_referencia <= 9))\\r\\n    AND (r0200.cod_ncm LIKE '8471%' OR r0200.cod_ncm LIKE '8473%' OR r0200.cod_ncm LIKE '8517%')\\r\\n  GROUP BY \\r\\n    my_efd.codigocnpj\\r\\n)\\r\\n\\r\\nSELECT \\r\\n  cd.*,\\r\\n  COALESCE(mov.vl_entradas_tech, 0) AS vl_entradas_tech,\\r\\n  COALESCE(mov.vl_saidas_tech, 0) AS vl_saidas_tech,\\r\\n  COALESCE(mov.dias_movimento_tech, 0) AS dias_movimento_tech,\\r\\n  COALESCE(mov.qtde_ncm_distintos_tech, 0) AS qtde_ncm_distintos_tech,\\r\\n  COALESCE(mov.vl_computadores, 0) AS vl_computadores,\\r\\n  COALESCE(mov.vl_partes_computadores, 0) AS vl_partes_computadores,\\r\\n  COALESCE(mov.vl_telecom, 0) AS vl_telecom,\\r\\n  \\r\\n  CASE \\r\\n    WHEN mov.vl_saidas_tech > 0 THEN \\r\\n      ROUND(100.0 * mov.vl_entradas_tech / NULLIF(mov.vl_saidas_tech, 0), 2)\\r\\n    ELSE 0 \\r\\n  END AS indice_entrada_saida_tech,\\r\\n  \\r\\n  CASE \\r\\n    WHEN mov.vl_entradas_tech > 0 THEN\\r\\n      ROUND(cd.saldo_credor_atual / NULLIF(mov.vl_entradas_tech, 0), 4)\\r\\n    ELSE 0\\r\\n  END AS indice_saldo_entrada_tech,\\r\\n  \\r\\n  CASE WHEN mov.nu_cnpj IS NOT NULL THEN 1 ELSE 0 END AS flag_setor_tech,\\r\\n  'TECNOLOGIA' AS setor,\\r\\n  \\r\\n  -- Score Combinado Setorial\\r\\n  (\\r\\n    cd.score_risco + \\r\\n    CASE WHEN cd.flag_empresa_suspeita = 1 THEN 25 ELSE 0 END +\\r\\n    CASE WHEN cd.score_suspeita > 70 THEN 15 ELSE 0 END +\\r\\n    CASE WHEN cd.sn_cancelado_inex_inativ = 1 THEN 20 ELSE 0 END +\\r\\n    CASE WHEN cd.qtde_indicios_fraude >= 3 THEN 15 ELSE 0 END\\r\\n  ) AS score_risco_tech_combinado\\r\\n  \\r\\nFROM teste.credito_dime_completo cd\\r\\nLEFT JOIN movimentacao_tech mov ON cd.nu_cnpj = mov.nu_cnpj\\r\\n\\r\\nORDER BY score_risco_tech_combinado DESC;\", \"result\": {\"id\": \"31571636-9165-cd7a-9c93-bfb32c288ede\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {}, \"meta\": [], \"rows\": null, \"hasMore\": false, \"statement_id\": 0, \"statement_range\": {\"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 0, \"column\": 0}}, \"statements_count\": 1, \"previous_statement_hash\": null, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": -1, \"filteredMeta\": [], \"fetchedOnce\": false, \"startTime\": \"2025-10-15T20:05:36.098Z\", \"endTime\": \"2025-10-15T20:05:36.098Z\", \"executionTime\": 0, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 0, \"hasSomeResults\": false}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": -1, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": null, \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": false, \"previousChartOptions\": {}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": null, \"getLogsTimeout\": null, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 0, \"lastAceSelectionRowOffset\": 0, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 12197, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 141, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": false, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "-- =====================================================================\r\n-- ANÁLISE CONSOLIDADA DE CRÉDITO DIME COM ENRIQUECIMENTO INTEGRADO\r\n-- Versão Única - Substitui códigos 1 e 2\r\n-- =====================================================================\r\n\r\n-- ---------------------------------------------------------------------\r\n-- 1. TABELA PRINCIPAL CONSOLIDADA - teste.credito_dime_completo\r\n-- ---------------------------------------------------------------------\r\nDROP TABLE IF EXISTS teste.credito_dime_completo;\r\nSET REQUEST_POOL = 'medium';\r\n\r\nCREATE TABLE IF NOT EXISTS teste.credito_dime_completo AS\r\n\r\nWITH periodos AS (\r\n  SELECT periodo AS nu_per_ref\r\n  FROM (\r\n    SELECT 202101 AS periodo UNION ALL SELECT 202102 UNION ALL SELECT 202103 UNION ALL SELECT 202104 UNION ALL\r\n    SELECT 202105 UNION ALL SELECT 202106 UNION ALL SELECT 202107 UNION ALL SELECT 202108 UNION ALL\r\n    SELECT 202109 UNION ALL SELECT 202110 UNION ALL SELECT 202111 UNION ALL SELECT 202112 UNION ALL\r\n    SELECT 202201 UNION ALL SELECT 202202 UNION ALL SELECT 202203 UNION ALL SELECT 202204 UNION ALL\r\n    SELECT 202205 UNION ALL SELECT 202206 UNION ALL SELECT 202207 UNION ALL SELECT 202208 UNION ALL\r\n    SELECT 202209 UNION ALL SELECT 202210 UNION ALL SELECT 202211 UNION ALL SELECT 202212 UNION ALL\r\n    SELECT 202301 UNION ALL SELECT 202302 UNION ALL SELECT 202303 UNION ALL SELECT 202304 UNION ALL\r\n    SELECT 202305 UNION ALL SELECT 202306 UNION ALL SELECT 202307 UNION ALL SELECT 202308 UNION ALL\r\n    SELECT 202309 UNION ALL SELECT 202310 UNION ALL SELECT 202311 UNION ALL SELECT 202312 UNION ALL\r\n    SELECT 202401 UNION ALL SELECT 202402 UNION ALL SELECT 202403 UNION ALL SELECT 202404 UNION ALL\r\n    SELECT 202405 UNION ALL SELECT 202406 UNION ALL SELECT 202407 UNION ALL SELECT 202408 UNION ALL\r\n    SELECT 202409 UNION ALL SELECT 202410 UNION ALL SELECT 202411 UNION ALL SELECT 202412 UNION ALL\r\n    SELECT 202501 UNION ALL SELECT 202502 UNION ALL SELECT 202503 UNION ALL SELECT 202504 UNION",
    "last_modified": "2025-10-15T17:05:49.533",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "98247874-ca8f-489a-b757-bbfeafccd369",
      1,
      false
    ],
    "dependencies": []
  }
}
]
